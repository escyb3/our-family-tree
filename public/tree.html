<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ§¬ ××™×œ×Ÿ ××©×¤×—×ª×™</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/familytreejs@latest/familytree.css">
  <script src="https://cdn.jsdelivr.net/npm/familytreejs@latest/familytree.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #tree { width: 100%; height: 100vh; direction: ltr; }
  </style>
</head>
<body>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  // ×”×’×“×¨×•×ª Firebase ×©×œ×š
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
  };

  // ××ª×—×•×œ
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×”×¢×¥
  async function loadFamilyTree(user) {
    try {
      // ×§×‘×œ×ª ID Token ××”××©×ª××©
      const token = await user.getIdToken();

      // ×‘×§×©×” ×œ×©×¨×ª
      const res = await fetch("/api/tree", {
        headers: { "Authorization": `Bearer ${token}` },
      });

      if (!res.ok) {
        throw new Error("×‘×¢×™×” ×‘×”×¨×©××•×ª: " + res.status);
      }

      const data = await res.json();
      console.log("×§×‘×¦×™× ××•×¨×©×™×:", data.files);

      const container = document.getElementById("tree-container");
      container.innerHTML = ""; // ××™×¤×•×¡

      if (data.files && data.files.length > 0) {
        for (const file of data.files) {
          // ×˜×•×¢×Ÿ ××ª ×”Ö¾JSON ×©×œ ×”×¢×¥
          const treeData = await fetch(`/trees/${file}`).then(r => r.json());

          // ×”×¦×’×” â€“ ××¤×©×¨ ×œ×”×—×œ×™×£ ×‘×¤×•× ×§×¦×™×™×ª renderTree ×©×œ×š
          const treeDiv = document.createElement("pre");
          treeDiv.textContent = `×¢×¥: ${file}\n` + JSON.stringify(treeData, null, 2);
          container.appendChild(treeDiv);

          // ×× ×™×© ×œ×š ×¤×•× ×§×¦×™×” ×××™×ª×™×ª ×©××¦×™×™×¨×ª ×¢×¥:
          // renderTree(treeData);
        }
      } else {
        container.innerHTML = "<p>×œ× ×”×•×’×“×¨ ×¦×“ ××©×¤×—×ª×™ ×œ××©×ª××©.</p>";
      }
    } catch (err) {
      console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×¢×¥:", err);
      document.getElementById("tree-container").innerHTML = 
        "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¢×¥</p>";
    }
  }

  // × ×¢×§×•×‘ ××—×¨×™ ××¦×‘ ×”×”×ª×—×‘×¨×•×ª
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("××©×ª××© ××—×•×‘×¨:", user.email);
      loadFamilyTree(user);
    } else {
      console.log("××™×Ÿ ××©×ª××© ××—×•×‘×¨");
      document.getElementById("tree-container").innerHTML = 
        "<p>×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×¨××•×ª ××ª ×”×¢×¥</p>";
    }
  });
</script>
<div id="tree-container"></div>
  <div id="tree"></div>
</body>
</html>
