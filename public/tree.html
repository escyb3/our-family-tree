<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>К  砖驻转</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/familytreejs@latest/familytree.css">
  <script src="https://cdn.jsdelivr.net/npm/familytreejs@latest/familytree.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #controls { padding: 10px; background: #f9f9f9; }
    #tree { width: 100%; height: calc(100vh - 50px); direction: ltr; }
    input[type="text"] { padding: 5px; width: 200px; }
    /* 爪注 驻 爪 砖驻转 */
    .benAbou .node { background-color: #ffcccc !important; }
    .elharrar .node { background-color: #ccffcc !important; }
  </style>
</head>
<body>

<div id="controls">
  <input type="text" id="searchInput" placeholder="驻砖 砖...">
</div>
<div id="tree"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const app = initializeApp({});
const auth = getAuth(app);

let chart = null;

async function loadFamilyTree(user) {
  try {
    const token = await user.getIdToken(true);
    console.log("ID Token 砖砖 砖专转:", token);

    const res = await fetch("/api/tree", {
      headers: { "Authorization": `Bearer ${token}` },
    });

    if (!res.ok) throw new Error("注 专砖转: " + res.status);

    const data = await res.json();
    console.log("拽爪 专砖:", data.files);

    if (!data.files || data.files.length === 0) {
      document.getElementById("tree").innerHTML = "<p> 专 爪 砖驻转 砖转砖.</p>";
      return;
    }

    // 注 专拽 拽抓 专砖 驻 爪 砖转砖
    const file = data.files[0];
    const treeData = await fetch(`/trees/${file}`).then(r => r.json());

    // 爪专转 专祝 FamilyTreeJS
    chart = new FamilyTree(document.getElementById("tree"), {
      template: "hugo",
      enableSearch: false,
      nodeBinding: {
        field_0: "name",
        field_1: "details",
        img_0: "photo"
      },
      nodes: treeData.nodes || []
    });

    // Tooltip 注转 注专 注专
    chart.on('mouseover', function(sender, node){
      node.nodeContent = `${node.name}\n${node.details || ''}`;
    });

    //  注 爪
    chart.on('click', function(sender, node){
      let info = `砖: ${node.name}\n驻专: ${node.details || ' 驻专'}\nID: ${node.id}`;
      if(node.photo){
        const imgWin = window.open('', '_blank');
        imgWin.document.write(`<h3>${node.name}</h3><img src="${node.photo}" style="max-width:100%"><p>${node.details || ''}</p>`);
      } else {
        alert(info);
      }
    });

    // 爪注 驻 爪 砖驻转
    chart.nodes.forEach(n => {
      if(n.side === 'Ben Abou') n.tags = ['benAbou'];
      if(n.side === 'Elharrar') n.tags = ['elharrar'];
      if(n.side === 'Malka' ) n.tags = [ 'malka' ];
    });

    //  专
    chart.zoom(0.8);
    chart.center();

    // 驻砖 砖转
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", () => {
      const term = searchInput.value.toLowerCase();
      chart.search(term);
    });

    console.log("注抓 砖驻转 爪 爪");

  } catch (err) {
    console.error("砖 注转 注抓:", err);
    document.getElementById("tree").innerHTML =
      "<p>砖 注转 注抓  砖转砖  专</p>";
  }
}

onAuthStateChanged(auth, async (user) => {
  const container = document.getElementById("tree");
  if (user) {
    console.log("砖转砖 专:", user.email);
    container.innerHTML = "<p>注 注抓 砖驻转...</p>";
    await loadFamilyTree(user);
  } else {
    console.log(" 砖转砖 专");
    container.innerHTML = "<p> 转专  专转 转 注抓</p>";
  }
});
</script>

</body>
</html>
