<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קיר זיכרון משפחתי</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-family: 'Heebo', sans-serif; }
    </style>
    <!-- Firebase CDN scripts -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"></script>
    
          import firebaseConfig 
           apiKey: "AIzaSyDLdJ9QbuZ35ARRPg2oqSgq4raOqc8ygiU",
          authDomain: "memorials-ee781.firebaseapp.com",
         projectId: "memorials-ee781",
          storageBucket: "memorials-ee781.firebasestorage.app",
          messagingSenderId: "566419126995",
         appId: "1:566419126995:web:99291628f1baa4e9c87226",
        measurementId: "G-FGBNKRGQ6B"
        };
        
    <!-- React and ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Custom modal component for displaying messages
        const MessageModal = ({ message, onClose }) => (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm relative text-center">
              <h2 className="text-xl font-bold mb-4 text-gray-800">הודעה</h2>
              <p className="text-gray-600 mb-6">{message}</p>
              <button
                onClick={onClose}
                className="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition"
              >
                סגור
              </button>
            </div>
          </div>
        );

        // Hardcoded initial data for Frank
        const initialMemorials = [
          {
            id: "frank-van-der-velde",
            name: 'פרנק ון דר ולדה',
            years: '1943 - 2025',
            dedication: 'פרנק היה אדם אהוב, אבא, סבא, חבר, ונשמה חמה וטובה.',
            photoUrl: 'https://placehold.co/150x150/E9D5FF/5B21B6?text=פרנק',
            candles: 0,
            comments: [],
          },
        ];

        // Component for a single memorial card with interactive features
        const MemorialCard = ({ memorial, currentUserId, isFirebaseReady, app }) => {
          const [newComment, setNewComment] = useState('');
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

          // Handler for lighting a candle, updates Firestore
          const handleLightCandle = async () => {
            if (!isFirebaseReady) {
                console.error("Firebase is not ready.");
                return;
            }
            try {
                const db = firebase.firestore.getFirestore(app);
                const memorialRef = firebase.firestore.doc(db, 'artifacts', appId, 'public', 'data', 'memorials', memorial.id);
                await firebase.firestore.updateDoc(memorialRef, {
                    candles: (memorial.candles || 0) + 1,
                });
            } catch (error) {
                console.error('Error updating candle count:', error);
            }
          };

          // Handler for adding a comment, updates Firestore
          const handleAddComment = async (e) => {
              e.preventDefault();
              if (newComment.trim() === '') return;
              if (!isFirebaseReady) {
                  console.error("Firebase is not ready.");
                  return;
              }

              try {
                  const db = firebase.firestore.getFirestore(app);
                  const memorialRef = firebase.firestore.doc(db, 'artifacts', appId, 'public', 'data', 'memorials', memorial.id);
                  const docSnap = await firebase.firestore.getDoc(memorialRef);
                  const currentComments = docSnap.exists() ? docSnap.data().comments || [] : [];

                  const updatedComments = [
                      ...currentComments,
                      {
                          author: currentUserId, // Using the user ID as author
                          text: newComment,
                          timestamp: new Date().toLocaleString('he-IL'),
                      },
                  ];
                  await firebase.firestore.updateDoc(memorialRef, {
                      comments: updatedComments,
                  });
                  setNewComment('');
              } catch (error) {
                  console.error('Error adding comment:', error);
              }
          };

          return (
            <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center max-w-lg mx-auto transition-transform duration-300 hover:scale-105">
              <img
                src={memorial.photoUrl}
                alt={memorial.name}
                className="w-32 h-32 rounded-full object-cover mb-4 border-4 border-gray-200"
                onError={(e) => { e.target.src = 'https://placehold.co/150x150/E2E8F0/1A202C?text=N/A'; }}
              />
              <h3 className="text-3xl font-bold text-gray-800 mb-1">
                {memorial.name}
              </h3>
              <p className="text-gray-500 italic mb-4">
                {memorial.years}
              </p>
              <p className="text-gray-600 text-center mb-4">
                {memorial.dedication}
              </p>

              {/* Interactive Candle Section */}
              <div className="flex items-center gap-4 mt-4">
                <button
                  onClick={handleLightCandle}
                  className="bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-red-700 transition"
                  disabled={!isFirebaseReady}
                >
                  🕯️ הדלק נר לזכרו
                </button>
                <span className="text-gray-700 font-medium">
                  {(memorial.candles || 0)} נרות נשמה הודלקו
                </span>
              </div>

              {/* Comments Section */}
              <div className="w-full mt-8">
                <h4 className="text-xl font-bold mb-4 border-b pb-2 border-gray-200">
                  זיכרונות ותגובות
                </h4>
                <ul className="space-y-4 max-h-60 overflow-y-auto pr-2">
                  {memorial.comments?.length > 0 ? (
                    memorial.comments.map((comment, index) => (
                      <li key={index} className="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <p className="text-gray-800 text-sm">{comment.text}</p>
                        <div className="text-gray-400 text-xs mt-1">
                          <span>מאת: {comment.author}</span>
                          <span className="mr-2"> | {comment.timestamp}</span>
                        </div>
                      </li>
                    ))
                  ) : (
                    <p className="text-gray-500 text-center text-sm">עדיין אין תגובות. היה הראשון לשתף זיכרון.</p>
                  )}
                </ul>
                <form onSubmit={handleAddComment} className="mt-4 flex flex-col gap-2">
                  <textarea
                    value={newComment}
                    onChange={(e) => setNewComment(e.target.value)}
                    placeholder="שתף זיכרון או כתוב מסר..."
                    className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-right"
                    rows="3"
                    disabled={!isFirebaseReady}
                  ></textarea>
                  <button
                    type="submit"
                    className="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition disabled:bg-blue-300"
                    disabled={!isFirebaseReady}
                  >
                    פרסם תגובה
                  </button>
                </form>
              </div>
            </div>
          );
        };

        const App = () => {
          const [memorials, setMemorials] = useState([]);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [newMemorialData, setNewMemorialData] = useState({
            name: '',
            years: '',
            dedication: '',
            photoFile: null,
          });
          const [isLoading, setIsLoading] = useState(true);
          const [isUploading, setIsUploading] = useState(false);
          const [isGeneratingDedication, setIsGeneratingDedication] = useState(false);
          const [userId, setUserId] = useState('');
          const [errorMessage, setErrorMessage] = useState('');
          const [isFirebaseReady, setIsFirebaseReady] = useState(false);
          const [app, setApp] = useState(null);

          // Function to handle the Gemini API call for generating a dedication
          const handleGenerateDedication = async () => {
            if (!newMemorialData.name || !newMemorialData.years) {
              setErrorMessage("נא למלא את שם הנפטר/ת ושנות החיים לפני יצירת הקדשה.");
              return;
            }
            
            setIsGeneratingDedication(true);
            
            try {
              const prompt = `כתוב הקדשה קצרה ומרגשת עבור קיר זיכרון. הזיכרון הוא עבור אדם בשם "${newMemorialData.name}", שחי בין השנים "${newMemorialData.years}". ההקדשה צריכה להיות מכובדת, לבבית, ובשפה עברית. התמקד בחשיבות הזיכרון והערך שלו.`;
              let chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = { contents: chatHistory };
              const apiKey = "" 
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
              
              const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
              });

              if (response.status === 403) {
                throw new Error("Gemini API returned a 403 Forbidden error. Check if the API key is correctly configured.");
              }

              const result = await response.json();
              
              if (result.candidates && result.candidates.length > 0 &&
                  result.candidates[0].content && result.candidates[0].content.parts &&
                  result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                setNewMemorialData(prevData => ({ ...prevData, dedication: text }));
              } else {
                setErrorMessage("שגיאה ביצירת ההקדשה. אנא נסה שוב.");
              }
              
            } catch (error) {
              console.error("Error generating dedication:", error);
              setErrorMessage('הייתה בעיה בשליחה ל-Gemini API. אנא נסה שוב.');
            } finally {
              setIsGeneratingDedication(false);
            }
          };

          // Firebase initialization and authentication
          useEffect(() => {
            // Function to handle the initialization and data fetching
            const setupFirebase = async () => {
                console.log("Setting up Firebase...");
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (!firebaseConfig) {
                    setErrorMessage("שגיאה: קונפיגורציית Firebase לא נמצאה. אנא רענן את הדף.");
                    setIsLoading(false);
                    return;
                }

                try {
                  const initializedApp = firebase.initializeApp(firebaseConfig);
                  setApp(initializedApp);
                  const auth = firebase.auth.getAuth(initializedApp);
                  const db = firebase.firestore.getFirestore(initializedApp);
                  
                  let userCredential;
                  if (initialAuthToken) {
                    userCredential = await firebase.auth.signInWithCustomToken(auth, initialAuthToken);
                  } else {
                    userCredential = await firebase.auth.signInAnonymously(auth);
                  }
                  
                  const user = userCredential.user;
                  setUserId(user.uid);
                  
                  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                  const publicCollectionPath = `artifacts/${appId}/public/data/memorials`;
                  const memorialsCollection = firebase.firestore.collection(db, publicCollectionPath);

                  // Seed the database with initial memorials if they don't exist
                  for (const memorial of initialMemorials) {
                    const memorialRef = firebase.firestore.doc(db, publicCollectionPath, memorial.id);
                    const docSnap = await firebase.firestore.getDoc(memorialRef);
                    if (!docSnap.exists()) {
                      await firebase.firestore.setDoc(memorialRef, memorial);
                    }
                  }

                  // Listen for real-time updates
                  const unsubscribe = firebase.firestore.onSnapshot(memorialsCollection, (snapshot) => {
                    const fetchedMemorials = snapshot.docs.map(doc => ({
                      id: doc.id,
                      ...doc.data()
                    }));
                    setMemorials(fetchedMemorials);
                    setIsLoading(false);
                    setIsFirebaseReady(true); // Set ready flag after successful data fetch
                  }, (error) => {
                    console.error("Error fetching memorials:", error);
                    setErrorMessage("שגיאה: קריאת נתונים מ-Firestore נכשלה. אנא נסה שוב.");
                    setIsLoading(false);
                    setIsFirebaseReady(false);
                  });

                  return () => unsubscribe(); // Cleanup the listener on unmount
                } catch (error) {
                  console.error("Firebase Initialization or Auth Error:", error);
                  setErrorMessage("שגיאה: התחברות ל-Firebase נכשלה. אנא נסה שוב.");
                  setIsLoading(false);
                  setIsFirebaseReady(false);
                }
            };
            
            // We use a loop with setTimeout to poll for the Firebase libraries to be ready.
            const checkFirebaseReady = () => {
              // Check if all necessary Firebase libraries are loaded
              if (typeof firebase !== 'undefined' && 
                  typeof firebase.auth !== 'undefined' && 
                  typeof firebase.firestore !== 'undefined' && 
                  typeof firebase.storage !== 'undefined') {
                console.log("Firebase libraries are loaded. Starting setup...");
                setupFirebase();
              } else {
                console.log("Waiting for Firebase scripts to load...");
                setTimeout(checkFirebaseReady, 200);
              }
            };

            // Start the readiness check
            checkFirebaseReady();
          }, []);

          // Handler to update the form state as the user types
          const handleInputChange = (e) => {
            const { id, value } = e.target;
            setNewMemorialData(prevData => ({
              ...prevData,
              [id]: value
            }));
          };

          // New handler for file input, stores the file object
          const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
              if (file.size > 1024 * 1024 * 5) { // 5MB size limit
                setErrorMessage("הקובץ גדול מדי. נא לבחור תמונה קטנה יותר (עד 5MB).");
                e.target.value = '';
                return;
              }
              setNewMemorialData(prevData => ({
                ...prevData,
                photoFile: file,
              }));
            }
          };

          // Handler to submit the new memorial form, now handles file upload
          const handleAddMemorial = async (e) => {
            e.preventDefault();
            if (!newMemorialData.name || !newMemorialData.years) {
              setErrorMessage("יש למלא שם ושנות חיים.");
              return;
            }
            if (!isFirebaseReady) {
              console.error("Firebase is not ready.");
              setErrorMessage("האפליקציה עדיין מתחברת ל-Firebase. אנא המתן.");
              return;
            }

            setIsUploading(true);

            try {
              const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
              const db = firebase.firestore.getFirestore(app);
              const storage = firebase.storage.getStorage(app);

              let photoUrl = `https://placehold.co/150x150/E2E8F0/1A202C?text=${newMemorialData.name.charAt(0)}`;

              // If a file was selected, upload it to Firebase Storage
              if (newMemorialData.photoFile) {
                const storageRef = firebase.storage.ref(storage, `memorial-photos/${appId}/${Date.now()}-${newMemorialData.photoFile.name}`);
                const snapshot = await firebase.storage.uploadBytes(storageRef, newMemorialData.photoFile);
                photoUrl = await firebase.storage.getDownloadURL(snapshot.ref);
              }

              const newMemorial = {
                name: newMemorialData.name,
                years: newMemorialData.years,
                dedication: newMemorialData.dedication,
                candles: 0,
                comments: [],
                photoUrl: photoUrl,
              };

              const memorialsCollection = firebase.firestore.collection(db, 'artifacts', appId, 'public', 'data', 'memorials');
              await firebase.firestore.addDoc(memorialsCollection, newMemorial);

              setNewMemorialData({ name: '', years: '', dedication: '', photoFile: null });
              setIsModalOpen(false);

            } catch (error) {
              console.error("Error adding new memorial:", error);
              setErrorMessage('הייתה בעיה בשמירת הזיכרון. אנא נסה שוב.');
            } finally {
              setIsUploading(false);
            }
          };

          return (
            <div className="bg-gray-100 min-h-screen p-8 text-right font-heebo">
              <div className="text-center mb-10">
                <h1 className="text-5xl font-bold text-gray-800 mb-2">
                  קיר זיכרון משפחתי 🕯️
                </h1>
                <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                  "האנשים שאנו אוהבים אינם עוזבים אותנו באמת. הם הולכים איתנו, בכל רגע."
                </p>
                <button
                  onClick={() => setIsModalOpen(true)}
                  className="mt-6 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition"
                  disabled={!isFirebaseReady}
                >
                  ➕ הוסף זיכרון לקיר
                </button>
              </div>

              {isLoading ? (
                <p className="text-center text-gray-500">טוען זיכרונות...</p>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  {memorials.map(memorial => (
                    <MemorialCard key={memorial.id} memorial={memorial} currentUserId={userId} isFirebaseReady={isFirebaseReady} app={app} />
                  ))}
                </div>
              )}

              {/* The modal for adding a new memorial */}
              {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md relative">
                    <button
                      onClick={() => setIsModalOpen(false)}
                      className="absolute top-4 left-4 text-gray-500 hover:text-gray-800 text-2xl font-bold"
                    >
                      &times;
                    </button>
                    <h2 className="text-2xl font-bold mb-6 text-center">הוסף זיכרון חדש</h2>
                    <form onSubmit={handleAddMemorial} className="space-y-4 text-right">
                      <div>
                        <label htmlFor="name" className="block text-gray-700 font-medium mb-1">שם הנפטר/ת:</label>
                        <input
                          type="text"
                          id="name"
                          value={newMemorialData.name}
                          onChange={handleInputChange}
                          className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          required
                          disabled={!isFirebaseReady}
                        />
                      </div>
                      <div>
                        <label htmlFor="years" className="block text-gray-700 font-medium mb-1">שנות חיים (לדוגמה: 1943 - 2025):</label>
                        <input
                          type="text"
                          id="years"
                          value={newMemorialData.years}
                          onChange={handleInputChange}
                          className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          required
                          disabled={!isFirebaseReady}
                        />
                      </div>
                      <div>
                        <div className="flex items-center justify-between">
                          <label htmlFor="dedication" className="block text-gray-700 font-medium">הקדשה אישית (אופציונלי):</label>
                          <button
                            type="button"
                            onClick={handleGenerateDedication}
                            disabled={isGeneratingDedication || !isFirebaseReady}
                            className="text-sm text-blue-500 font-semibold hover:text-blue-700 transition disabled:text-gray-400"
                          >
                            {isGeneratingDedication ? 'יוצר...' : '✨ יצירת הקדשה'}
                          </button>
                        </div>
                        <textarea
                          id="dedication"
                          value={newMemorialData.dedication}
                          onChange={handleInputChange}
                          className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-1"
                          rows="3"
                          disabled={!isFirebaseReady}
                        ></textarea>
                      </div>
                      <div>
                        <label htmlFor="photoFile" className="block text-gray-700 font-medium mb-1">העלה תמונה (עד 5MB):</label>
                        <input
                          type="file"
                          id="photoFile"
                          onChange={handleFileChange}
                          className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          accept="image/*"
                          disabled={!isFirebaseReady}
                        />
                      </div>
                      <button
                        type="submit"
                        className="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition mt-4 disabled:bg-blue-300"
                        disabled={isUploading || !isFirebaseReady}
                      >
                        {isUploading ? 'מעלה תמונה...' : 'פרסם זיכרון'}
                      </button>
                    </form>
                  </div>
                </div>
              )}

              {/* Message Modal for errors and confirmations */}
              {errorMessage && (
                <MessageModal
                  message={errorMessage}
                  onClose={() => setErrorMessage('')}
                />
              )}
            </div>
          );
        };
        
        // This function checks if Firebase scripts are loaded and then renders the app.
        // This prevents race conditions where the app tries to use Firebase before it's ready.
        const checkFirebaseReady = () => {
          if (typeof firebase !== 'undefined' && 
              typeof firebase.auth !== 'undefined' && 
              typeof firebase.firestore !== 'undefined' && 
              typeof firebase.storage !== 'undefined') {
            console.log("Firebase libraries are loaded. Rendering App...");
            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
          } else {
            console.log("Waiting for Firebase scripts to load...");
            setTimeout(checkFirebaseReady, 200);
          }
        };

        // Start the readiness check once the DOM is ready
        window.onload = checkFirebaseReady;
    </script>
</body>
</html>

    
