<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ספר המשפחה: סטטוס וקישורים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* הגדרת גופן Inter כגופן הראשי */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* שכבת טעינה מלאה עם אנימציה ומעבר חלק */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(243, 244, 246, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 1;
            transition: opacity 0.5s ease-out; /* מעבר דעיכה חלק */
        }
        #loading-container.hidden {
            opacity: 0;
            pointer-events: none; /* מונע אינטראקציה עם האלמנט כשהוא נסתר */
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- שכבת טעינה מלאה -->
    <div id="loading-container" class="flex flex-col items-center justify-center">
        <svg id="loading-spinner" class="animate-spin h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-message" class="text-gray-600 mt-4 text-lg">טוען נתוני משתמש...</p>
    </div>

    <!-- Container לתוכן הראשי של האפליקציה -->
    <div id="main-content" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">ספר המשפחה: סטטוס וקישורים</h1>

            <!-- User Details Section (פרטי המשתמש שזוהו) -->
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6 text-right">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">פרטי המשתמש שלך:</h2>
                <p id="userName" class="text-lg text-gray-600 mb-2"><strong>שם:</strong> <span class="font-medium"></span></p>
                <p id="userFamilySide" class="text-lg text-gray-600">
                    <strong>צד משפחתי (ערך גולמי):</strong> 
                    <span class="font-medium text-gray-800"></span>
                </p>
            </div>

            <!-- Family Book Content Section (מציג את סיכום הסטטוס המפורט) -->
            <div id="familyBookContent" class="bg-white p-6 rounded-xl border border-gray-200 text-right min-h-[150px] shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">סיכום סטטוס טעינת גרסאות:</h3>
                <p class="text-gray-500">ממתין לטעינת הנתונים...</p>
            </div>
            
            <!-- Successful Links Area (קישורים לגרסאות שנטענו בהצלחה) -->
            <div id="successfulLinks" class="mt-8 text-sm text-center">
                <!-- קישורים יוצגו כאן -->
            </div>

            <!-- Status/Error Message Area (הודעת סיכום/הנחיות) -->
            <div id="statusMessage" class="mt-6 text-sm text-center">
                <!-- הודעת סיכום על סיום התהליך תוצג כאן -->
            </div>
        </div>
    </div>

    <script>
        /**
         * מנסה לטעון את גרסאות ספר המשפחה (V1, V2, ברירת מחדל) עבור צד משפחתי ספציפי.
         * @param {string} familySide - שם הצד המשפחתי (לדוגמה: "Bromberg").
         * @returns {Promise<{allAttempts: Array, successfulVersions: Array}>} - הבטחה לתוצאות הטעינה.
         */
        async function tryLoadBookVersions(familySide) {
            // הגדרת הגרסאות לטעינה עבור הצד המשפחתי הנוכחי
            const versions = [
                { id: 'V1', url: `books/${familySide}.html`, name: 'הגרסה הראשית' },
                { id: 'V2', url: `books2/${familySide}.html`, name: 'גרסה 2' },
                // גרסת ברירת המחדל טוענת קובץ גנרי ולא קשור לצד ספציפי (אך רצוי לבדוק אותה תמיד)
                { id: 'V3', url: `books/default.html`, name: 'גרסת ברירת מחדל (כללית)' }
            ];

            // יצירת מערך של הבטחות לטעינת התוכן של כל גרסה
            const fetchPromises = versions.map(v => 
                fetch(v.url)
                    .then(response => {
                        if (!response.ok) {
                            // זורק שגיאה עם מידע מפורט על הכשלון
                            throw new Error(`שגיאה ${response.status}`);
                        }
                        return response.text().then(content => ({ 
                            status: 'fulfilled', 
                            familySide: familySide, // שמירת הצד המשפחתי
                            version: v.id, 
                            name: v.name, 
                            url: v.url, 
                            content: content 
                        }));
                    })
                    .catch(reason => ({ 
                        status: 'rejected', 
                        familySide: familySide, // שמירת הצד המשפחתי גם בכשלון
                        version: v.id, 
                        name: v.name, 
                        url: v.url, 
                        reason: reason.message.replace('Failed to fetch', 'כשל ברשת/קובץ לא קיים') 
                    }))
            );

            // הפעלת כל הבקשות במקביל
            const allAttempts = await Promise.all(fetchPromises);

            const successfulVersions = allAttempts
                .filter(r => r.status === 'fulfilled')
                .map(r => ({ familySide: r.familySide, version: r.version, name: r.name, url: r.url }));
            
            // מחזיר את כל הניסיונות והרשימה המסוננת של ההצלחות
            return { allAttempts: allAttempts, successfulVersions: successfulVersions };
        }

        // שימוש ב-window.onload כדי להבטיח שה-DOM נטען במלואו לפני הרצת הסקריפט
        window.onload = async function() {
            const loadingContainer = document.getElementById('loading-container');
            const mainContent = document.getElementById('main-content');
            const loadingSpinner = document.getElementById('loading-spinner');
            const loadingMessage = document.getElementById('loading-message');
            const userNameSpan = document.querySelector('#userName span');
            const userFamilySideSpan = document.querySelector('#userFamilySide span');
            const familyBookContent = document.getElementById('familyBookContent');
            const statusMessageDiv = document.getElementById('statusMessage');
            const successfulLinksDiv = document.getElementById('successfulLinks');
            
            let rawFamilySide = "לא ידוע"; // משתנה לשמירת ערך גולמי

            try {
                // שלב 1: קבלת נתוני המשתמש מהשרת
                loadingMessage.textContent = "מזהה משתמש...";
                const response = await fetch('/api/user');

                if (!response.ok) {
                    throw new Error(`שגיאת HTTP: ${response.status} בעת טעינת פרטי משתמש.`);
                }

                const data = await response.json();
                const user = data.user;

                if (!user || !user.familySide) {
                    throw new Error("נתונים לא תקינים מהשרת: המאפיין familySide חסר או לא מוגדר.");
                }
                
                rawFamilySide = user.familySide;
                
                // הצגת פרטי המשתמש (מציג את הערך הגולמי, כולל פסיקים)
                userNameSpan.textContent = user.username || "לא זוהה";
                userFamilySideSpan.textContent = rawFamilySide;

                // פיצול הערך הגולמי לצדדים משפחתיים בודדים
                const familySides = rawFamilySide.split(',')
                    .map(s => s.trim()) // הסרת רווחים
                    .filter(s => s.length > 0); // סינון צדדים ריקים

                if (familySides.length === 0) {
                     throw new Error("לא זוהה אף צד משפחתי חוקי בערך שהתקבל.");
                }

                // שלב 2: טעינת תוכן ספר המשפחה עבור כל צד משפחתי
                loadingMessage.textContent = `מבצע ניסיונות טעינה עבור ${familySides.length} צדדים משפחתיים...`;
                
                // יצירת מערך הבטחות לטעינת כל הצדדים במקביל
                const loadingPromises = familySides.map(side => tryLoadBookVersions(side));
                
                const allResults = await Promise.all(loadingPromises);

                // איסוף כל הניסיונות והגרסאות המוצלחות מכל הצדדים
                let allAttempts = [];
                let successfulVersions = [];
                allResults.forEach(result => {
                    allAttempts = allAttempts.concat(result.allAttempts);
                    successfulVersions = successfulVersions.concat(result.successfulVersions);
                });


                // --- 1. הצגת סיכום סטטוס מפורט בתוך familyBookContent ---
                let statusHtml = '<ul class="space-y-3">';
                allAttempts.forEach(attempt => {
                    // קביעת סטטוס וסגנון לתצוגה
                    const isFulfilled = attempt.status === 'fulfilled';
                    const displayStatus = isFulfilled
                        ? { text: 'זוהה בהצלחה', color: 'text-green-600', icon: '✅' }
                        : { text: `כשלון: ${attempt.reason.split(' | ')[0]}`, color: 'text-red-600', icon: '❌' };
                        
                    const statusClass = isFulfilled ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                    
                    statusHtml += `
                        <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-xl border ${statusClass}">
                            <span class="font-bold text-gray-700 mb-1 sm:mb-0">
                                ${displayStatus.icon} ${attempt.familySide} - ${attempt.name}:
                            </span>
                            <span class="text-xs text-right text-gray-600 mt-1 sm:mt-0">
                                ${displayStatus.text}
                            </span>
                        </li>
                    `;
                });
                statusHtml += '</ul>';
                familyBookContent.innerHTML = statusHtml;

                // --- 2. הצגת קישורים לגרסאות שנטענו בהצלחה ---
                if (successfulVersions.length > 0) {
                    const linksHtml = successfulVersions.map(info => {
                        // הצגת הקישור עם שם הצד המשפחתי והגרסה
                        const linkText = `${info.familySide}: ${info.name}`;
                        return `<a href="${info.url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold underline transition duration-150 p-2 rounded-lg bg-blue-50 hover:bg-blue-100 whitespace-nowrap">${linkText}</a>`;
                    }).join('<span class="mx-3 text-gray-400">|</span>');

                    successfulLinksDiv.innerHTML = `
                        <div class="p-4 rounded-xl bg-blue-100 border border-blue-300 text-blue-900 text-right shadow-md">
                            <p class="font-bold mb-3 text-lg text-center">לחץ על הקישור לפתיחת הגרסה הרלוונטית:</p>
                            <div class="flex flex-wrap items-center justify-center gap-3">${linksHtml}</div>
                        </div>
                    `;
                    // הודעת סיכום חיובית
                    statusMessageDiv.innerHTML = `<div class="p-3 rounded-lg bg-green-100 text-green-800 border border-green-300">
                        <p class="font-medium">✅ הנתונים נטענו בהצלחה. כל הגרסאות הזמינות מופיעות למעלה.</p>
                    </div>`;
                } else {
                    // אם לא נמצאו גרסאות מוצלחות כלל
                    successfulLinksDiv.innerHTML = '';
                    statusMessageDiv.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 border border-red-300">
                        <p class="font-medium">❌ לא נמצאה אף גרסת ספר זמינה באף אחד מהצדדים. בדוק את סיכום הסטטוס המפורט.</p>
                    </div>`;
                }
                
                // הסתרת מסך הטעינה והצגת התוכן הראשי
                loadingContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                // טיפול בשגיאות קריטיות (כשל ב-fetch הראשוני או בנתוני המשתמש)
                console.error("שגיאה קריטית בטעינת הנתונים:", error);
                loadingSpinner.classList.add('hidden');
                
                // הצגת הודעת שגיאה קריטית במסך הטעינה
                loadingContainer.innerHTML = `<div class="p-6 rounded-xl bg-red-100 text-red-700 border border-red-300 shadow-md max-w-lg mx-auto text-right">
                    <p class="font-bold text-xl mb-2">אירעה שגיאה קריטית</p>
                    <p class="text-lg">${error.message}</p>
                    <p class="text-sm mt-3">צד המשפחה הגולמי שניסיתי לנתח היה: "${rawFamilySide}"</p>
                </div>`;
                return; // עוצר את ההרצה
            }
        };
    </script>
</body>
</html>
