<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>גלריית תמונות משפחתית</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        window.firebase = { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, updateDoc, query, where, orderBy, getStorage, ref, uploadBytes, getDownloadURL, deleteObject };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f0f4f8;
            direction: rtl;
            text-align: right;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .animate-scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Manual icon definitions
    const UploadCloud = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9M8 17l4 4 4-4"/>
        </svg>
    );
    const X = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
    );
    const Pencil = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
        </svg>
    );
    const Search = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
        </svg>
    );
    const Trash2 = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/>
        </svg>
    );
    const User = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2M12 7a4 4 0 1 0 0 8a4 4 0 0 0 0-8z"/>
        </svg>
    );
    const Users = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M7 11a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM19 19V17a4 4 0 0 0-4-4h-2M18 7a4 4 0 1 0 0-8a4 4 0 0 0 0 8z"/>
        </svg>
    );
    const Loader2 = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
      </svg>
    );
    const Sparkles = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M14.5 2l3 3m1-3l-3 3m3 3L16.5 9m-1-3l-3 3M17 19l-1-1m-4 4l-4-4m-3 3l-3-3m3 3L8.5 21m-2.5-3l-3-3m3 3L6.5 21M7 9l-1 1m-2 2l-2-2m-3 3l-3-3m3 3L5.5 14"/>
      </svg>
    );
    const Volume2 = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07M19.07 4.93a10 10 0 0 1 0 14.14"/>
      </svg>
    );

    function App() {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [storage, setStorage] = useState(null);
        const [userId, setUserId] = useState(null);
        const [photos, setPhotos] = useState([]);
        const [selectedPhoto, setSelectedPhoto] = useState(null);
        const [isInitializing, setIsInitializing] = useState(true);
        const [isUploadLoading, setIsUploadLoading] = useState(false);
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedFamily, setSelectedFamily] = useState('all');
        const [language, setLanguage] = useState('he');
        const [showImageModal, setShowImageModal] = useState(false);
        const [showStoryModal, setShowStoryModal] = useState(false);
        const [currentStory, setCurrentStory] = useState("");
        const [showEditModal, setShowEditModal] = useState(false);
        const [photoToEdit, setPhotoToEdit] = useState(null);
        const [showDeleteModal, setShowDeleteModal] = useState(false);
        const [photoToDelete, setPhotoToDelete] = useState(null);
        const [isGeminiLoading, setIsGeminiLoading] = useState(false);
        const fileInputRef = useRef(null);
        const peopleInputRef = useRef(null);

        const families = [
            'Ben Abou', 'Elharrar', 'Malka', 'Ben David', 'Bromberg', 'Barenbaum', 'Fass-Schneck',
            'Weinberger', 'Leibner', 'van der Velde', 'Behr', 'de Vries', 'Italiaander', 'Izaks',
            'Chapon', 'Elook', 'Groenstad'
        ];

        const translations = {
            he: {
                title: 'גלריית תמונות משפחתית',
                subtitle: 'שתפו רגעים יקרים וצרו סיפורים משותפים עם בני משפחה וחברים.',
                userIdLabel: 'מזהה משתמש:',
                uploadTitle: 'העלאת תמונה חדשה',
                chooseFile: 'בחר קובץ',
                peopleInPhoto: 'אנשים בתמונה (אופציונלי)',
                peoplePlaceholder: 'הפרד שמות בפסיק (לדוגמה: אבא, אמא)',
                uploadBtn: 'העלאה',
                uploading: 'מעלה...',
                allFamilies: 'כל המשפחות',
                noPhotos: 'אין עדיין תמונות בגלריה.',
                uploadFirst: 'העלה את התמונה הראשונה שלך כדי להתחיל.',
                showStory: 'הצג סיפור',
                editStory: 'ערוך סיפור',
                delete: 'מחק',
                imageModalTitle: 'תמונה מוגדלת',
                storyTitle: 'סיפור',
                storyModalTitle: 'סיפור התמונה',
                editStoryModalTitle: 'ערוך סיפור',
                saveBtn: 'שמור',
                cancelBtn: 'ביטול',
                deleteConfirmTitle: 'אישור מחיקה',
                deleteConfirmText: 'האם אתה בטוח שברצונך למחוק תמונה זו?',
                loading: 'טוען תמונות...',
                noStory: 'אין סיפור זמין.',
                errorAuth: 'שגיאה בהתחברות למערכת.',
                errorInit: 'שגיאה באתחול Firebase.',
                errorFetch: 'שגיאה בטעינת התמונות.',
                errorNoFile: 'אנא בחר קובץ להעלאה.',
                errorUpload: 'שגיאה בהעלאת התמונה.',
                errorDelete: 'שגיאה במחיקת התמונה.',
                errorEdit: 'שגיאה בעריכת הסיפור.',
                chooseFamily: 'בחר משפחה',
                generateStory: 'צור סיפור',
                storyGenerated: 'הסיפור נוצר בהצלחה!',
                errorGenerateStory: 'שגיאה ביצירת הסיפור. נסה שוב.',
                playStory: 'הקרא סיפור',
                playingAudio: 'מנגן...',
                errorPlayAudio: 'שגיאה בהשמעת הסיפור.',
                generatingStory: 'יוצר סיפור...',
                generatingAudio: 'מכין אודיו...',
                peopleLabel: 'אנשים:'
            },
            en: {
                title: 'Family Photo Gallery',
                subtitle: 'Share precious moments and create shared stories with family and friends.',
                userIdLabel: 'User ID:',
                uploadTitle: 'Upload a new photo',
                chooseFile: 'Choose file',
                peopleInPhoto: 'People in photo (optional)',
                peoplePlaceholder: 'Separate names with commas (e.g., Dad, Mom)',
                uploadBtn: 'Upload',
                uploading: 'Uploading...',
                allFamilies: 'All Families',
                noPhotos: 'There are no photos in the gallery yet.',
                uploadFirst: 'Upload your first photo to get started.',
                showStory: 'Show Story',
                editStory: 'Edit Story',
                delete: 'Delete',
                imageModalTitle: 'Enlarged Photo',
                storyTitle: 'Story',
                storyModalTitle: 'Photo Story',
                editStoryModalTitle: 'Edit Story',
                saveBtn: 'Save',
                cancelBtn: 'Cancel',
                deleteConfirmTitle: 'Confirm Deletion',
                deleteConfirmText: 'Are you sure you want to delete this photo?',
                loading: 'Loading photos...',
                noStory: 'No story available.',
                errorAuth: 'Error logging in to the system.',
                errorInit: 'Error initializing Firebase.',
                errorFetch: 'Error loading photos.',
                errorNoFile: 'Please select a file to upload.',
                errorUpload: 'Error uploading the photo.',
                errorDelete: 'Error deleting the photo.',
                errorEdit: 'Error editing the story.',
                chooseFamily: 'Choose a family',
                generateStory: 'Generate Story',
                storyGenerated: 'Story generated successfully!',
                errorGenerateStory: 'Error generating story. Please try again.',
                playStory: 'Play Story',
                playingAudio: 'Playing...',
                errorPlayAudio: 'Error playing story.',
                generatingStory: 'Generating story...',
                generatingAudio: 'Preparing audio...',
                peopleLabel: 'People:'
            }
        };

        const t = translations[language];

        // Firebase globals
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB99bQpokjpcuXilwu3usXoOFLmegkVnb4",
            authDomain: "family-gallery-d707d.firebaseapp.com",
            projectId: "family-gallery-d707d",
            storageBucket: "family-gallery-d707d.appspot.com",
            messagingSenderId: "227810040631",
            appId: "1:227810040631:web:6bc0dc9a983fac04e4d8b2",
            measurementId: "G-84CYX5S1F3"
        };
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase initialization
        useEffect(() => {
            try {
                const firebaseApp = window.firebase.initializeApp(firebaseConfig);
                const firestoreDb = window.firebase.getFirestore(firebaseApp);
                const firebaseAuth = window.firebase.getAuth(firebaseApp);
                const firebaseStorage = window.firebase.getStorage(firebaseApp);

                setDb(firestoreDb);
                setAuth(firebaseAuth);
                setStorage(firebaseStorage);

                const signIn = async () => {
                    try {
                        if (authToken) {
                            await window.firebase.signInWithCustomToken(firebaseAuth, authToken);
                        } else {
                            await window.firebase.signInAnonymously(firebaseAuth);
                        }
                    } catch (e) {
                        console.error("Firebase Auth Error: ", e);
                        setError(t.errorAuth);
                    } finally {
                        setIsInitializing(false);
                    }
                };
                signIn();

            } catch (e) {
                console.error("Firebase Initialization Error: ", e);
                setError(t.errorInit);
                setIsInitializing(false);
            }
        }, [t.errorAuth, t.errorInit, authToken, firebaseConfig]);

        // Listen for auth state changes
        useEffect(() => {
            if (auth) {
                const unsubscribe = window.firebase.onAuthStateChanged(auth, user => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null);
                    }
                });
                return () => unsubscribe();
            }
        }, [auth]);

        // Fetch photos from Firestore
        useEffect(() => {
            if (db && userId) {
                setIsLoading(true);
                const photosRef = window.firebase.collection(db, `/artifacts/${appId}/public/data/photos`);
                
                // Fetch all photos and sort them on the client-side to avoid index errors.
                const q = window.firebase.query(photosRef, window.firebase.orderBy("createdAt", "desc"));
                
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const allPhotos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        url: doc.data().url || 'https://placehold.co/600x400/ece9e9/78716c?text=No+Image' 
                    }));

                    // Filter photos based on the selected family on the client side.
                    const filteredPhotos = selectedFamily === 'all'
                        ? allPhotos
                        : allPhotos.filter(photo => photo.family === selectedFamily);

                    setPhotos(filteredPhotos);
                    setIsLoading(false);
                }, (e) => {
                    console.error("Firestore Error: ", e);
                    setError(t.errorFetch);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }
        }, [db, userId, appId, selectedFamily, t.errorFetch]);

        const handleUpload = async (event) => {
            event.preventDefault();
            const file = fileInputRef.current.files[0];
            const family = event.target.familySelect.value;
            const people = peopleInputRef.current.value.split(',').map(p => p.trim()).filter(p => p);
            
            if (!file) {
                setError(t.errorNoFile);
                return;
            }
            if (!family) {
                setError(t.chooseFamily);
                return;
            }

            try {
                setIsUploadLoading(true);
                const filePath = `/images/${family}/${Date.now()}_${file.name}`;
                const storageRef = window.firebase.ref(storage, filePath);
                const snapshot = await window.firebase.uploadBytes(storageRef, file);
                const downloadURL = await window.firebase.getDownloadURL(snapshot.ref);

                await window.firebase.addDoc(window.firebase.collection(db, `/artifacts/${appId}/public/data/photos`), {
                    userId,
                    url: downloadURL,
                    filePath: filePath,
                    family,
                    people,
                    createdAt: window.firebase.serverTimestamp(),
                    story: ""
                });
                
                fileInputRef.current.value = "";
                peopleInputRef.current.value = "";
                setIsUploadLoading(false);
            } catch (e) {
                console.error("Upload Error: ", e);
                setError(t.errorUpload);
                setIsUploadLoading(false);
            }
        };

        const confirmDelete = (photo) => {
            setPhotoToDelete(photo);
            setShowDeleteModal(true);
        };

        const handleDelete = async () => {
            if (!photoToDelete) return;

            try {
                setIsLoading(true);
                setShowDeleteModal(false);

                const storageRef = window.firebase.ref(storage, photoToDelete.filePath);
                await window.firebase.deleteObject(storageRef);

                await window.firebase.deleteDoc(window.firebase.doc(db, `/artifacts/${appId}/public/data/photos`, photoToDelete.id));

                setPhotoToDelete(null); 
                setIsLoading(false);
            } catch (e) {
                console.error("Delete Error: ", e);
                setError(t.errorDelete);
                setIsLoading(false);
            }
        };

        const openEditModal = (photo) => {
            setPhotoToEdit(photo);
            setCurrentStory(photo.story || "");
            setShowEditModal(true);
        };

        const handleEditStory = async () => {
            if (!photoToEdit) return;
            try {
                setShowEditModal(false);
                await window.firebase.updateDoc(window.firebase.doc(db, `/artifacts/${appId}/public/data/photos`, photoToEdit.id), {
                    story: currentStory,
                });
            } catch (e) {
                console.error("Edit Story Error: ", e);
                setError(t.errorEdit);
            }
        };

        const openImageModal = (photo) => {
            setSelectedPhoto(photo);
            setShowImageModal(true);
        };

        const openStoryModal = (story) => {
            setCurrentStory(story);
            setShowStoryModal(true);
        };

        // LLM features
        const generateStoryWithGemini = async (photo) => {
            setIsGeminiLoading(true);
            try {
                const response = await fetch(photo.url);
                if (!response.ok) throw new Error('Failed to fetch image');
                const imageBlob = await response.blob();
                const reader = new FileReader();
                reader.readAsDataURL(imageBlob);
                reader.onloadend = async () => {
                    const base64data = reader.result.split(',')[1];
                    const prompt = `Based on this photo, create a short, emotional and creative story in the ${language === 'he' ? 'Hebrew' : 'English'} language. The story should be no more than three sentences.`;

                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: base64data } }
                            ]
                        }]
                    };

                    let responseText = '';
                    let retries = 0;
                    const maxRetries = 5;
                    const delay = 1000;

                    while (retries < maxRetries) {
                        try {
                            const geminiResponse = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (!geminiResponse.ok) {
                                if (geminiResponse.status === 429) { // Too Many Requests
                                    retries++;
                                    await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                                    continue;
                                } else {
                                    throw new Error(`API error: ${geminiResponse.statusText}`);
                                }
                            }

                            const result = await geminiResponse.json();
                            responseText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (responseText) {
                                break;
                            } else {
                                throw new Error("No text generated from Gemini.");
                            }
                        } catch (e) {
                            console.error(`Gemini API call failed (retry ${retries + 1}):`, e);
                            retries++;
                            if (retries < maxRetries) {
                                await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                            } else {
                                throw e;
                            }
                        }
                    }

                    if (responseText) {
                        setCurrentStory(responseText);
                        await window.firebase.updateDoc(window.firebase.doc(db, `/artifacts/${appId}/public/data/photos`, photo.id), {
                            story: responseText,
                        });
                        setError(t.storyGenerated);
                        setShowEditModal(false);
                    } else {
                        throw new Error("Failed to generate story after multiple attempts.");
                    }

                };
            } catch (e) {
                console.error("Gemini Generate Story Error: ", e);
                setError(t.errorGenerateStory);
            } finally {
                setIsGeminiLoading(false);
            }
        };

        const playStoryWithGemini = async (story) => {
            if (!story) {
                setError(t.noStory);
                return;
            }

            setIsGeminiLoading(true);
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: story }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Puck" }
                            }
                        }
                    }
                };
                
                let audioData = null;
                let retries = 0;
                const maxRetries = 5;
                const delay = 1000;

                while (retries < maxRetries) {
                    try {
                        const geminiResponse = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!geminiResponse.ok) {
                            if (geminiResponse.status === 429) {
                                retries++;
                                await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                                continue;
                            } else {
                                throw new Error(`API error: ${geminiResponse.statusText}`);
                            }
                        }

                        const result = await geminiResponse.json();
                        audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                        if (audioData) {
                            break;
                        } else {
                            throw new Error("No audio generated from Gemini.");
                        }
                    } catch (e) {
                        console.error(`Gemini TTS call failed (retry ${retries + 1}):`, e);
                        retries++;
                        if (retries < maxRetries) {
                            await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                        } else {
                            throw e;
                        }
                    }
                }
                
                if (audioData) {
                    // Utility function to convert Base64 to ArrayBuffer
                    const base64ToArrayBuffer = (base64) => {
                        const binaryString = window.atob(base64);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        return bytes.buffer;
                    };

                    // Utility function to create a WAV blob from PCM data
                    const pcmToWav = (pcm16, sampleRate) => {
                        const buffer = new ArrayBuffer(44 + pcm16.length * 2);
                        const view = new DataView(buffer);
                        
                        // RIFF identifier
                        writeString(view, 0, 'RIFF');
                        // file length
                        view.setUint32(4, 36 + pcm16.length * 2, true);
                        // RIFF type
                        writeString(view, 8, 'WAVE');
                        // format chunk identifier
                        writeString(view, 12, 'fmt ');
                        // format chunk length
                        view.setUint32(16, 16, true);
                        // sample format (1 = PCM)
                        view.setUint16(20, 1, true);
                        // channel count
                        view.setUint16(22, 1, true);
                        // sample rate
                        view.setUint32(24, sampleRate, true);
                        // byte rate (sample rate * block align)
                        view.setUint32(28, sampleRate * 2, true);
                        // block align (bytes per sample)
                        view.setUint16(32, 2, true);
                        // bits per sample
                        view.setUint16(34, 16, true);
                        // data chunk identifier
                        writeString(view, 36, 'data');
                        // data chunk length
                        view.setUint32(40, pcm16.length * 2, true);
                        
                        // write the PCM data
                        let offset = 44;
                        for (let i = 0; i < pcm16.length; i++, offset += 2) {
                            view.setInt16(offset, pcm16[i], true);
                        }

                        return new Blob([view], { type: 'audio/wav' });
                    };

                    const writeString = (view, offset, string) => {
                        for (let i = 0; i < string.length; i++) {
                            view.setUint8(offset + i, string.charCodeAt(i));
                        }
                    };
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 16000); // Sample rate is 16kHz for gemini-2.5-flash-preview-tts
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        setIsGeminiLoading(false);
                    };

                } else {
                    throw new Error("Failed to get audio data after multiple attempts.");
                }

            } catch (e) {
                console.error("Gemini Play Story Error: ", e);
                setError(t.errorPlayAudio);
            } finally {
                setIsGeminiLoading(false);
            }
        };


        const Modal = ({ children, onClose, title }) => (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4 animate-fade-in">
                <div className="relative bg-white p-6 rounded-3xl shadow-2xl max-w-sm sm:max-w-lg md:max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-scale-in" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition">
                        <X className="h-6 w-6" />
                    </button>
                    {title && <h3 className="text-2xl font-bold text-gray-800 mb-4">{title}</h3>}
                    {children}
                </div>
            </div>
        );

        return (
            <div dir={language === 'he' ? 'rtl' : 'ltr'} className="container mx-auto px-2 sm:px-4 py-8">
                <div className="absolute top-4 left-4 z-50">
                    <button
                        onClick={() => setLanguage(language === 'he' ? 'en' : 'he')}
                        className="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-full shadow-lg hover:bg-gray-300 transition duration-300"
                    >
                        {language === 'he' ? 'English' : 'עברית'}
                    </button>
                </div>
                <header className="text-center mb-10">
                    <h1 className="text-5xl font-extrabold text-gray-800 mb-2">{t.title}</h1>
                    {userId && (
                        <p className="text-sm font-light text-gray-500 mb-4 flex items-center justify-center gap-2">
                           <User className="h-4 w-4 inline-block text-gray-500" /> {t.userIdLabel} {userId}
                        </p>
                    )}
                    <p className="text-lg text-gray-600 max-w-2xl mx-auto">{t.subtitle}</p>
                </header>

                <div className="bg-white p-6 rounded-3xl shadow-lg border border-gray-200 max-w-lg mx-auto mb-8">
                    <h2 className="text-xl font-bold mb-4 text-center">{t.uploadTitle}</h2>
                    <form onSubmit={handleUpload} className="space-y-4">
                        <div className="flex flex-col items-center">
                            <label htmlFor="file-upload" className="block text-sm font-medium text-gray-700 mb-2">
                                {t.chooseFile}
                            </label>
                            <input
                                id="file-upload"
                                type="file"
                                ref={fileInputRef}
                                required
                                className="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-sky-100 file:text-sky-700
                                hover:file:bg-sky-200 transition-colors duration-200"
                            />
                        </div>
                        <div className="flex flex-col items-center">
                            <label htmlFor="people-input" className="block text-sm font-medium text-gray-700 mb-2">
                                {t.peopleInPhoto}
                            </label>
                            <input
                                id="people-input"
                                type="text"
                                ref={peopleInputRef}
                                placeholder={t.peoplePlaceholder}
                                className="w-full px-4 py-2 rounded-full border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                            />
                        </div>
                        <div className="flex flex-col items-center">
                            <label htmlFor="family-select" className="block text-sm font-medium text-gray-700 mb-2">
                                {t.chooseFamily}
                            </label>
                            <select
                                id="family-select"
                                name="familySelect"
                                required
                                className="w-full px-4 py-2 rounded-full border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                            >
                                <option value="">{t.chooseFamily}...</option>
                                {families.map(family => (
                                    <option key={family} value={family}>{family}</option>
                                ))}
                            </select>
                        </div>
                        <div className="text-center">
                            <button
                                type="submit"
                                disabled={isUploadLoading}
                                className="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {isUploadLoading ? <Loader2 className="h-5 w-5 animate-spin-slow" /> : <UploadCloud className="h-5 w-5" />}
                                {isUploadLoading ? t.uploading : t.uploadBtn}
                            </button>
                        </div>
                    </form>
                </div>
                
                <div className="flex flex-wrap justify-center gap-2 mb-8">
                    <button
                        onClick={() => setSelectedFamily('all')}
                        className={`px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ${selectedFamily === 'all' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                        {t.allFamilies}
                    </button>
                    {families.map(family => (
                        <button
                            key={family}
                            onClick={() => setSelectedFamily(family)}
                            className={`px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ${selectedFamily === family ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                        >
                            {family}
                        </button>
                    ))}
                </div>

                {error && (
                    <div className="text-center text-red-600 font-semibold mb-6 p-4 bg-red-50 rounded-lg shadow-sm border border-red-200">
                        {error}
                    </div>
                )}
                
                {isInitializing || isLoading ? (
                    <div className="flex flex-col items-center justify-center text-gray-600 font-semibold mt-16">
                         <Loader2 className="h-10 w-10 text-blue-600 animate-spin-slow" />
                         <span className="mt-4">{t.loading}</span>
                    </div>
                ) : photos.length === 0 ? (
                    <div className="text-center text-gray-500 mt-16 p-8 bg-gray-100 rounded-xl shadow-inner">
                        <p className="text-xl font-semibold mb-2">{t.noPhotos}</p>
                        <p>{t.uploadFirst}</p>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {photos.map((photo) => (
                            <div key={photo.id} className="bg-white rounded-3xl shadow-xl border border-gray-200 overflow-hidden transform hover:scale-[1.02] transition-all duration-300 group">
                                <img
                                    src={photo.url}
                                    alt="Family Gallery Image"
                                    className="w-full h-56 object-cover cursor-pointer group-hover:brightness-95 transition-all"
                                    onClick={() => openImageModal(photo)}
                                />
                                <div className="p-5 flex flex-col items-center text-center">
                                    <p className="text-xs text-gray-400 mb-1">{photo.family}</p>
                                    <p className="text-sm text-gray-500 mb-3">{photo.createdAt ? new Date(photo.createdAt.seconds * 1000).toLocaleDateString(language === 'he' ? "he-IL" : "en-US") : ""}</p>
                                    {photo.people && photo.people.length > 0 && (
                                        <div className="flex items-center text-gray-600 mb-3 text-sm">
                                            <Users className="h-4 w-4 ml-1" />
                                            <p className="font-semibold">{t.peopleLabel} {photo.people.join(', ')}</p>
                                        </div>
                                    )}
                                    <div className="flex flex-wrap justify-center gap-2 mt-auto">
                                        {photo.story && (
                                            <button
                                                onClick={() => openStoryModal(photo.story || t.noStory)}
                                                className="flex-1 min-w-[120px] py-2 px-4 bg-sky-100 text-sky-700 font-medium rounded-full text-sm hover:bg-sky-200 transition flex items-center justify-center gap-2 shadow-sm"
                                            >
                                                <Search className="h-4 w-4" />
                                                {t.showStory}
                                            </button>
                                        )}
                                        {photo.story && (
                                             <button
                                                onClick={() => playStoryWithGemini(photo.story)}
                                                disabled={isGeminiLoading}
                                                className="flex-1 min-w-[120px] py-2 px-4 bg-green-100 text-green-700 font-medium rounded-full text-sm hover:bg-green-200 transition flex items-center justify-center gap-2 shadow-sm"
                                            >
                                                {isGeminiLoading ? <Loader2 className="h-4 w-4 animate-spin-slow" /> : <Volume2 className="h-4 w-4" />}
                                                {isGeminiLoading ? t.playingAudio : t.playStory}
                                            </button>
                                        )}
                                        <button
                                            onClick={() => openEditModal(photo)}
                                            className="flex-1 min-w-[120px] py-2 px-4 bg-teal-100 text-teal-700 font-medium rounded-full text-sm hover:bg-teal-200 transition flex items-center justify-center gap-2 shadow-sm"
                                        >
                                            <Pencil className="h-4 w-4" />
                                            {t.editStory}
                                        </button>
                                        <button
                                            onClick={() => confirmDelete(photo)}
                                            className="flex-1 min-w-[120px] py-2 px-4 bg-red-100 text-red-700 font-medium rounded-full text-sm hover:bg-red-200 transition flex items-center justify-center gap-2 shadow-sm"
                                        >
                                            <Trash2 className="h-4 w-4" />
                                            {t.delete}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {/* Image Modal */}
                {showImageModal && (
                    <Modal onClose={() => setShowImageModal(false)} title={t.imageModalTitle}>
                        <img src={selectedPhoto.url} alt="תמונה מוגדלת" className="rounded-xl w-full h-auto max-h-[70vh] object-contain shadow-lg" />
                        {selectedPhoto.people && selectedPhoto.people.length > 0 && (
                             <div className="mt-4 p-4 bg-gray-100 rounded-xl text-gray-700">
                                <h3 className="font-semibold text-lg mb-2">{t.peopleLabel}</h3>
                                <p className="whitespace-pre-wrap leading-relaxed">{selectedPhoto.people.join(', ')}</p>
                            </div>
                        )}
                        {selectedPhoto.story && (
                            <div className="mt-4 p-4 bg-gray-100 rounded-xl text-gray-700">
                                <h3 className="font-semibold text-lg mb-2">{t.storyTitle}</h3>
                                <p className="whitespace-pre-wrap leading-relaxed">{selectedPhoto.story}</p>
                            </div>
                        )}
                    </Modal>
                )}

                {/* Story modal */}
                {showStoryModal && (
                    <Modal onClose={() => setShowStoryModal(false)} title={t.storyModalTitle}>
                        <div className="prose max-w-none text-gray-700 whitespace-pre-wrap leading-relaxed">
                            {currentStory}
                        </div>
                    </Modal>
                )}

                {/* Edit story modal */}
                {showEditModal && (
                    <Modal onClose={() => setShowEditModal(false)} title={t.editStoryModalTitle}>
                        <textarea
                            value={currentStory}
                            onChange={(e) => setCurrentStory(e.target.value)}
                            className="w-full h-40 p-4 rounded-xl border border-gray-300 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                        />
                         <div className="flex flex-col sm:flex-row justify-end gap-2 sm:gap-4 mt-4">
                            <button
                                onClick={() => generateStoryWithGemini(photoToEdit)}
                                disabled={isGeminiLoading}
                                className="px-6 py-2 bg-purple-600 text-white font-bold rounded-full shadow-lg hover:bg-purple-700 transition duration-300 flex-1 sm:flex-none flex items-center justify-center gap-2"
                            >
                                {isGeminiLoading ? <Loader2 className="h-5 w-5 animate-spin-slow" /> : <Sparkles className="h-5 w-5" />}
                                {isGeminiLoading ? t.generatingStory : t.generateStory}
                            </button>
                            <button
                                onClick={handleEditStory}
                                className="px-6 py-2 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 flex-1 sm:flex-none"
                            >
                                {t.saveBtn}
                            </button>
                            <button
                                onClick={() => setShowEditModal(false)}
                                className="px-6 py-2 bg-gray-200 text-gray-700 font-bold rounded-full shadow-lg hover:bg-gray-300 transition duration-300 flex-1 sm:flex-none"
                            >
                                {t.cancelBtn}
                            </button>
                        </div>
                    </Modal>
                )}

                {/* Delete confirmation modal */}
                {showDeleteModal && (
                    <Modal onClose={() => setShowDeleteModal(false)} title={t.deleteConfirmTitle}>
                        <p className="text-gray-800 text-lg mb-6 text-center">{t.deleteConfirmText}</p>
                        <div className="flex justify-center gap-4">
                            <button
                                onClick={handleDelete}
                                className="px-6 py-2 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105"
                            >
                                {t.delete}
                            </button>
                            <button
                                onClick={() => setShowDeleteModal(false)}
                                className="px-6 py-2 bg-gray-200 text-gray-700 font-bold rounded-full shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-105"
                            >
                                {t.cancelBtn}
                            </button>
                        </div>
                    </Modal>
                )}
            </div>
        );
    }
    // Render the App component
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
</script>

</body>
</html>
