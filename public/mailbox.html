<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª ×“×•×"×œ ×¤× ×™××™×ª</title>
     <!-- Font Awesome for the checkmark icon and trash icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap');
        body {
            font-family: 'Heebo', sans-serif;
            direction: rtl; /* Set default direction to RTL for Hebrew */
        }
        .app-container {
            display: flex;
            height: 100vh;
            background-color: #f0f4f8;
            color: #334e68;
        }
        .rtl {
            direction: rtl;
        }
        .ltr {
            direction: ltr;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .login-bg {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #e2e8f0;
        }
        .checkmark {
            color: #10B981; /* Green color for the checkmark */
        }
    </style>
</head>
</head>
<body class="bg-gray-100">
  <div id="loadingPage" class="flex h-screen items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-md text-center">
      <h1 class="text-2xl font-bold" id="loadingText">××ª×—×‘×¨...</h1>
      <p id="loadingSubtext">×× × ×”××ª×Ÿ...</p>
    </div>
  </div>

  <div id="appPage" class="hidden h-screen flex">
    <aside class="w-1/4 bg-white p-4 shadow-md flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" id="mailboxTitle">×ª×™×‘×ª ×“×•××¨</h2>
        <button id="langToggle" class="bg-gray-200 text-sm px-2 py-1 rounded">EN</button>
      </div>
      <div class="flex items-center mb-4">
        <span class="text-green-600 font-bold">âœ”</span>
        <p id="userEmailDisplay" class="ml-2 text-gray-700"></p>
      </div>
      <button id="newEmailButton" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">×”×•×“×¢×” ×—×“×©×”</button>
      <button data-folder="inbox" class="folder-btn bg-blue-100 text-blue-800 px-3 py-2 rounded mb-1" id="inboxBtn">× ×›× ×¡</button>
      <button data-folder="sent" class="folder-btn px-3 py-2 rounded mb-1" id="sentBtn">× ×©×œ×—</button>
      <button data-folder="drafts" class="folder-btn px-3 py-2 rounded mb-1" id="draftsBtn">×˜×™×•×˜×•×ª</button>
      <button data-folder="trash" class="folder-btn px-3 py-2 rounded mb-1" id="trashBtn">×–×‘×œ</button>
      <ul id="draftsList" class="mt-4 text-sm text-gray-600"></ul>
    </aside>

    <main class="flex-1 p-6 overflow-y-auto">
      <div id="emptyState" class="text-center text-gray-500">
        ×‘×—×¨ ××™××™×™×œ ×œ×¦×¤×™×™×” ××• ×¦×•×¨ ×”×•×“×¢×” ×—×“×©×”.
      </div>
      <div id="emailView" class="hidden"></div>
      <div id="composeView" class="hidden">
        <h3 class="text-xl font-bold mb-4" id="newMessageTitle">×”×•×“×¢×” ×—×“×©×”</h3>
        <input id="composeTo" placeholder="××œ" class="w-full border p-2 mb-2 rounded" />
        <input id="composeSubject" placeholder="× ×•×©×" class="w-full border p-2 mb-2 rounded" />
        <textarea id="composeBody" placeholder="×ª×•×›×Ÿ" class="w-full border p-2 mb-2 rounded h-40"></textarea>
        <div class="flex space-x-2 space-x-reverse mt-2">
          <button id="sendButton" class="bg-green-500 text-white px-4 py-2 rounded">×©×œ×—</button>
          <button id="saveDraftButton" class="bg-yellow-500 text-white px-4 py-2 rounded">×©××•×¨ ×˜×™×•×˜×”</button>
          <button id="cancelButton" class="bg-gray-300 px-4 py-2 rounded">×‘×˜×œ</button>
          <button id="translateButton" class="bg-purple-500 text-white px-4 py-2 rounded">×ª×¨×’×</button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, deleteDoc, doc, onSnapshot, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAID_kPGA6Khczh0lIgd7E13LJS76JJ9nI",
      authDomain: "mailbox-e0ce2.firebaseapp.com",
      projectId: "mailbox-e0ce2",
      storageBucket: "mailbox-e0ce2.appspot.com",
      messagingSenderId: "199399854104",
      appId: "1:199399854104:web:6aec488e6aeee0dec3736d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loadingPage = document.getElementById("loadingPage");
    const appPage = document.getElementById("appPage");
    const userEmailDisplay = document.getElementById("userEmailDisplay");
    const newEmailButton = document.getElementById("newEmailButton");
    const composeView = document.getElementById("composeView");
    const emptyState = document.getElementById("emptyState");
    const sendButton = document.getElementById("sendButton");
    const saveDraftButton = document.getElementById("saveDraftButton");
    const cancelButton = document.getElementById("cancelButton");
    const translateButton = document.getElementById("translateButton");
    const composeTo = document.getElementById("composeTo");
    const composeSubject = document.getElementById("composeSubject");
    const composeBody = document.getElementById("composeBody");
    const draftsList = document.getElementById("draftsList");

    const mailboxTitle = document.getElementById("mailboxTitle");
    const inboxBtn = document.getElementById("inboxBtn");
    const sentBtn = document.getElementById("sentBtn");
    const draftsBtn = document.getElementById("draftsBtn");
    const trashBtn = document.getElementById("trashBtn");
    const newMessageTitle = document.getElementById("newMessageTitle");
    const langToggle = document.getElementById("langToggle");

    const translations = {
      he: {
        mailboxTitle: "×ª×™×‘×ª ×“×•××¨",
        newEmail: "×”×•×“×¢×” ×—×“×©×”",
        inbox: "× ×›× ×¡",
        sent: "× ×©×œ×—",
        drafts: "×˜×™×•×˜×•×ª",
        trash: "×–×‘×œ",
        emptyState: "×‘×—×¨ ××™××™×™×œ ×œ×¦×¤×™×™×” ××• ×¦×•×¨ ×”×•×“×¢×” ×—×“×©×”.",
        newMessageTitle: "×”×•×“×¢×” ×—×“×©×”",
        send: "×©×œ×—",
        saveDraft: "×©××•×¨ ×˜×™×•×˜×”",
        cancel: "×‘×˜×œ",
        translate: "×ª×¨×’×"
      },
      en: {
        mailboxTitle: "Mailbox",
        newEmail: "New Message",
        inbox: "Inbox",
        sent: "Sent",
        drafts: "Drafts",
        trash: "Trash",
        emptyState: "Select an email to view or create a new one.",
        newMessageTitle: "New Message",
        send: "Send",
        saveDraft: "Save Draft",
        cancel: "Cancel",
        translate: "Translate"
      }
    };

    let currentLang = "he";

    function applyTranslations() {
      const t = translations[currentLang];
      mailboxTitle.textContent = t.mailboxTitle;
      newEmailButton.textContent = t.newEmail;
      inboxBtn.textContent = t.inbox;
      sentBtn.textContent = t.sent;
      draftsBtn.textContent = t.drafts;
      trashBtn.textContent = t.trash;
      emptyState.textContent = t.emptyState;
      newMessageTitle.textContent = t.newMessageTitle;
      sendButton.textContent = t.send;
      saveDraftButton.textContent = t.saveDraft;
      cancelButton.textContent = t.cancel;
      translateButton.textContent = t.translate;
      langToggle.textContent = currentLang === "he" ? "EN" : "HE";
    }

    langToggle.addEventListener("click", () => {
      currentLang = currentLang === "he" ? "en" : "he";
      applyTranslations();
    });

    async function translateText(text, targetLang) {
      // ×“××• ×‘×œ×‘×“: ×”×•×¡×¤×ª ×ª×’×™×ª ×œ×¤×™ ×©×¤×”
      if (!text.trim()) return text;
      if (targetLang === "en") {
        return "[EN] " + text;
      } else {
        return "[HE] " + text;
      }
    }

    translateButton.addEventListener("click", async () => {
      composeSubject.value = await translateText(composeSubject.value, currentLang === "he" ? "en" : "he");
      composeBody.value = await translateText(composeBody.value, currentLang === "he" ? "en" : "he");
    });

    const state = {
      emailAddress: null,
      emails: [],
      currentFolder: "inbox",
      editingDraftId: null
    };

    async function fetchUser() {
      try {
        const res = await fetch("/api/user");
        if (!res.ok) throw new Error("×œ× ××—×•×‘×¨");
        const data = await res.json();
        let email = data.user.email;
        if (email.endsWith("@family.local")) {
          state.emailAddress = email;
        } else {
          const username = email.split("@")[0];
          state.emailAddress = `${username}@family.local`;
        }
        userEmailDisplay.textContent = `××—×•×‘×¨ ×›- ${state.emailAddress}`;
        loadingPage.classList.add("hidden");
        appPage.classList.remove("hidden");
        listenToEmails();
        listenToDrafts();
        applyTranslations();
      } catch (err) {
        document.getElementById("loadingText").textContent = "×©×’×™××”";
        document.getElementById("loadingSubtext").textContent = "×™×© ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª";
        console.error(err);
      }
    }

    function listenToEmails() {
      const emailsRef = collection(db, "emails");
      onSnapshot(emailsRef, (snapshot) => {
        state.emails = [];
        snapshot.forEach(docSnap => {
          state.emails.push({ id: docSnap.id, ...docSnap.data() });
        });
        console.log("Emails:", state.emails);
      });
    }

    function listenToDrafts() {
      const draftsRef = query(collection(db, "emails"), where("folder", "==", "drafts"), where("sender", "==", state.emailAddress));
      onSnapshot(draftsRef, (snapshot) => {
        draftsList.innerHTML = "";
        snapshot.forEach(docSnap => {
          const draft = docSnap.data();
          const li = document.createElement("li");
          li.classList.add("flex", "justify-between", "items-center", "mb-1");

          const span = document.createElement("span");
          span.textContent = draft.subject || (currentLang === "he" ? "(×œ×œ× × ×•×©×)" : "(No Subject)");
          span.classList.add("cursor-pointer", "hover:text-blue-600");
          span.addEventListener("click", () => {
            composeTo.value = draft.recipient || "";
            composeSubject.value = draft.subject || "";
            composeBody.value = draft.body || "";
            state.editingDraftId = docSnap.id;
            emptyState.classList.add("hidden");
            composeView.classList.remove("hidden");
          });

          const delBtn = document.createElement("button");
          delBtn.textContent = "ğŸ—‘ï¸";
          delBtn.classList.add("text-red-500", "ml-2");
          delBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (confirm(currentLang === "he" ? "×”×× ×œ××—×•×§ ×˜×™×•×˜×” ×–×•?" : "Delete this draft?")) {
              await deleteDoc(doc(db, "emails", docSnap.id));
            }
          });

          li.appendChild(span);
          li.appendChild(delBtn);
          draftsList.appendChild(li);
        });
      });
    }

    newEmailButton.addEventListener("click", () => {
      emptyState.classList.add("hidden");
      composeView.classList.remove("hidden");
      state.editingDraftId = null;
      composeTo.value = "";
      composeSubject.value = "";
      composeBody.value = "";
    });

    cancelButton.addEventListener("click", () => {
      composeView.classList.add("hidden");
      emptyState.classList.remove("hidden");
      state.editingDraftId = null;
    });

    sendButton.addEventListener("click", async () => {
      try {
        await addDoc(collection(db, "emails"), {
          sender: state.emailAddress,
          recipient: composeTo.value.trim(),
          subject: composeSubject.value.trim(),
          body: composeBody.value.trim(),
          timestamp: Timestamp.now(),
          deleted: false,
          folder: "sent"
        });
        composeTo.value = "";
        composeSubject.value = "";
        composeBody.value = "";
        composeView.classList.add("hidden");
        emptyState.classList.remove("hidden");
        state.editingDraftId = null;
      } catch (err) {
        console.error("Send error", err);
      }
    });

    saveDraftButton.addEventListener("click", async () => {
      try {
        if (state.editingDraftId) {
          await setDoc(doc(db, "emails", state.editingDraftId), {
            sender: state.emailAddress,
            recipient: composeTo.value.trim(),
            subject: composeSubject.value.trim(),
            body: composeBody.value.trim(),
            timestamp: Timestamp.now(),
            deleted: false,
            folder: "drafts"
          });
        } else {
          await addDoc(collection(db, "emails"), {
            sender: state.emailAddress,
            recipient: composeTo.value.trim(),
            subject: composeSubject.value.trim(),
            body: composeBody.value.trim(),
            timestamp: Timestamp.now(),
            deleted: false,
            folder: "drafts"
          });
        }
        composeView.classList.add("hidden");
        emptyState.classList.remove("hidden");
        state.editingDraftId = null;
      } catch (err) {
        console.error("Draft save error", err);
      }
    });

    fetchUser();
  </script>
</body>
</html>

