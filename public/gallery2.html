<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>גלריית תמונות משפחתית</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

window.firebase = { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, updateDoc, query, orderBy };
</script>
<style>
body { font-family: 'Heebo', sans-serif; background-color:#f0f4f8; direction:rtl; text-align:right; }
.animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
</style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [photos, setPhotos] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [selectedFamily, setSelectedFamily] = useState('all');
    const fileInputRef = useRef(null);

    const families = ['Ben Abou','Elharrar','Malka','Ben David','Bromberg','Barenbaum','Fass-Schneck','Weinberger','Leibner','van der Velde','Behr','de Vries','Italiaander','Izaks','Chapon'];

    const firebaseConfig = {
        apiKey: "AIzaSyB99bQpokjpcuXilwu3usXoOFLmegkVnb4",
        authDomain: "family-gallery-d707d.firebaseapp.com",
        projectId: "family-gallery-d707d"
    };

    useEffect(() => {
        const app = window.firebase.initializeApp(firebaseConfig);
        const firestoreDb = window.firebase.getFirestore(app);
        const firebaseAuth = window.firebase.getAuth(app);

        setDb(firestoreDb);
        setAuth(firebaseAuth);

        const signIn = async () => {
            try {
                await window.firebase.signInAnonymously(firebaseAuth);
            } catch (e) { setError('שגיאה בהתחברות למערכת'); }
        };
        signIn();

        const unsubscribe = window.firebase.onAuthStateChanged(firebaseAuth, user => {
            if(user) setUserId(user.uid);
        });

        return () => unsubscribe();
    }, []);

    useEffect(() => {
        if(db && userId){
            const photosRef = window.firebase.collection(db, 'photos');
            const q = window.firebase.query(photosRef, window.firebase.orderBy('createdAt','desc'));
            const unsubscribe = window.firebase.onSnapshot(q, snapshot => {
                const allPhotos = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                setPhotos(selectedFamily==='all' ? allPhotos : allPhotos.filter(p=>p.family===selectedFamily));
                setIsLoading(false);
            });
            return () => unsubscribe();
        }
    }, [db, userId, selectedFamily]);

    const handleUpload = async (event) => {
        event.preventDefault();
        const url = fileInputRef.current.value.trim();
        const family = event.target.familySelect.value;
        if(!url){ setError('אנא הכנס URL של תמונה'); return; }
        if(!family){ setError('בחר משפחה'); return; }
        try {
            await window.firebase.addDoc(window.firebase.collection(db,'photos'), {
                userId,
                url,
                family,
                createdAt: window.firebase.serverTimestamp(),
                story: ''
            });
            fileInputRef.current.value = '';
        } catch(e){ setError('שגיאה בהוספת התמונה'); }
    };

    return (
        <div className="container mx-auto px-2 sm:px-4 py-8">
            <h1 className="text-center text-5xl font-extrabold mb-8">גלריית תמונות משפחתית</h1>

            <form onSubmit={handleUpload} className="mb-8">
                <input type="text" placeholder="הכנס URL של תמונה" ref={fileInputRef} className="w-full p-2 rounded mb-2 border"/>
                <select name="familySelect" className="w-full p-2 rounded mb-2 border">
                    <option value="">בחר משפחה</option>
                    {families.map(f=> <option key={f} value={f}>{f}</option>)}
                </select>
                <button type="submit" className="w-full py-2 bg-blue-600 text-white rounded">העלה תמונה</button>
            </form>

            {error && <div className="text-red-600 mb-4">{error}</div>}

            {isLoading ? <p>טוען תמונות...</p> :
                photos.length===0 ? <p>אין תמונות להצגה</p> :
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {photos.map(p=>(
                        <div key={p.id} className="bg-white p-2 rounded shadow">
                            <img src={p.url} alt="" className="w-full h-48 object-cover rounded"/>
                            <p className="text-sm mt-1">{p.family}</p>
                        </div>
                    ))}
                </div>
            }
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
</script>
</body>
</html>
