<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×¤×•×¨×•× ×”××©×¤×—×”</title>
  <script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@tailwindcss/forms"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    .mention { color: #2563eb; font-weight: bold; cursor: pointer; }
    .badge { background-color: #f59e0b; color: white; padding: 2px 6px; border-radius: 6px; margin-right: 4px; font-size: 0.75rem; }
    .reply-box { margin-top: 1rem; background: #f9fafb; border-radius: 8px; padding: 1rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">ğŸŒ³ ×¤×•×¨×•× ×”××©×¤×—×” ×”×’× ××•×œ×•×’×™</h1>

    <!-- ×›×¤×ª×•×¨ ×¤×ª×™×—×ª ×“×™×•×Ÿ -->
    <div class="text-right mb-4">
      <button id="open-thread-btn" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded">â• ×¤×ª×— ×“×™×•×Ÿ ×—×“×©</button>
    </div>

    <!-- ×˜×•×¤×¡ ×“×™×•×Ÿ ×—×“×© -->
    <section id="new-thread-form" class="hidden bg-white p-4 rounded shadow mb-6">
      <h2 class="text-xl font-semibold mb-2">×“×™×•×Ÿ ×—×“×©</h2>
      <form id="thread-form" enctype="multipart/form-data">
        <input type="text" id="thread-title" placeholder="×›×•×ª×¨×ª ×”×“×™×•×Ÿ" required class="w-full p-2 border rounded mb-2"/>
        <textarea id="thread-content" placeholder="×ª×•×›×Ÿ ×”×“×™×•×Ÿ (××¤×©×¨ ×œ×”×©×ª××© ×‘Ö¾@×©× ×œ××–×›×•×¨)" required class="w-full p-2 border rounded mb-2"></textarea>
        <input type="file" id="thread-file" accept="image/*" class="mb-2"/>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ğŸ“ ×¤×¨×¡× ×“×™×•×Ÿ</button>
      </form>
    </section>

    <!-- ×©××œ×•×ª × ×¤×•×¦×•×ª -->
    <details class="mb-6 bg-yellow-100 p-4 rounded">
      <summary class="cursor-pointer font-bold">â“ ×©××œ×•×ª × ×¤×•×¦×•×ª ×’× ××•×œ×•×’×™×•×ª</summary>
      <ul class="list-disc list-inside mt-2">
        <li>××™×š ××–×”×™× ×§×¨×‘×” ×‘×™×Ÿ ×©× ×™ ×‘× ×™ ××©×¤×—×”?</li>
        <li>××” ×”×”×‘×“×œ ×‘×™×Ÿ ××™×œ×Ÿ ××©×¤×—×” ×œ×§×•×‘×¥ GEDCOM?</li>
        <li>××™×š ××•×¡×™×¤×™× ×¦×™×œ×•××™× ×œ××¡××›×™×?</li>
      </ul>
    </details>

    <!-- ×ª×¦×•×’×ª ×“×™×•× ×™× -->
    <section id="threads-container"></section>
  </div>

  <script>
    const mentionRegex = /@([\u0590-\u05FF\w]+)/g;

    document.getElementById('open-thread-btn').onclick = () => {
      document.getElementById('new-thread-form').classList.toggle('hidden');
    };

    document.getElementById('thread-form').onsubmit = async (e) => {
      e.preventDefault();
      const title = document.getElementById('thread-title').value.trim();
      const content = document.getElementById('thread-content').value.trim();
      const file = document.getElementById('thread-file').files[0];

      const formData = new FormData();
      formData.append("title", title);
      formData.append("content", content);
      if (file) formData.append("file", file);

      try {
        await axios.post('/api/forum/threads', formData);
        location.reload();
      } catch (err) {
        alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×“×™×•×Ÿ");
      }
    };

    const formatContent = (text) => {
      return text.replace(mentionRegex, (_, user) =>
        `<span class="mention" onclick="alert('×”××©×ª××© @${user} ×§×™×‘×œ ×”×ª×¨××”!')">@${user}</span>`
      );
    };

    const renderReplies = (replies) => {
      if (!replies || !replies.length) return '';
      return replies.map(reply => `
        <div class="ml-4 mt-2 bg-white p-2 rounded border">
          <div class="text-sm">${formatContent(reply.content)}</div>
          <small class="text-gray-500">× ×›×ª×‘ ×¢×œ ×™×“×™: ${reply.author || "×× ×•× ×™××™"}</small>
        </div>
      `).join('');
    };

    const renderThread = (thread) => {
      return `
        <div class="bg-white p-4 rounded shadow mb-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-xl font-bold">${thread.title}</h3>
            <span class="badge">${thread.badge || "××©×ª××© ×—×“×©"}</span>
          </div>
          ${thread.imageUrl ? `<img src="${thread.imageUrl}" class="max-w-xs rounded mb-2">` : ''}
          <p>${formatContent(thread.content)}</p>
          <small class="text-gray-500">× ×›×ª×‘ ×¢×œ ×™×“×™: ${thread.author || '×× ×•× ×™××™'}</small>

          <!-- ×ª×’×•×‘×•×ª -->
          <div class="reply-box mt-4">
            <form onsubmit="submitReply(event, '${thread._id}')">
              <textarea placeholder="×”×’×‘ ×œ×“×™×•×Ÿ..." class="w-full p-2 border rounded mb-2" required></textarea>
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">ğŸ’¬ ×”×’×‘</button>
            </form>
            <div>${renderReplies(thread.replies)}</div>
          </div>
        </div>
      `;
    };

    async function loadThreads() {
      const container = document.getElementById("threads-container");
      try {
        const res = await axios.get("/api/forum/threads");
        container.innerHTML = res.data.map(renderThread).join('');
      } catch (e) {
        container.innerHTML = `<p class="text-red-600">×©×’×™××” ×‘×˜×¢×™× ×ª ×“×™×•× ×™×</p>`;
      }
    }

    async function submitReply(e, threadId) {
      e.preventDefault();
      const textarea = e.target.querySelector("textarea");
      const content = textarea.value.trim();
      if (!content) return;

      try {
        await axios.post(`/api/forum/threads/${threadId}/replies`, { content });
        loadThreads(); // ×¨×¢× ×•×Ÿ ×ª×’×•×‘×•×ª
      } catch (err) {
        alert("×©×’×™××” ×‘×©×œ×™×—×ª ×ª×’×•×‘×”");
      }
    }

    loadThreads();
    <script src="/forum.js"></script>
  </script>
</body>
</html>
