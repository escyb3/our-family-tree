
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×•×¨×•× ××©×¤×—×ª×™</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --main-bg: #f3f4f6;
            --card-bg-light: rgba(255, 255, 255, 0.4);
            --card-bg-dark: rgba(31, 41, 55, 0.4);
            --text-color: #1f2937;
            --primary-color: #4f46e5;
            --secondary-color: #6b7280;
            --border-color: rgba(255, 255, 255, 0.2);
            --dark-border-color: rgba(75, 85, 99, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --main-bg: #111827;
            --text-color: #e5e7eb;
            --primary-color: #818cf8;
            --secondary-color: #d1d5db;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-color);
            transition: background-color 0.5s, color 0.5s;
            background-image: linear-gradient(135deg, #d1d5db 0%, #a5b4fc 50%, #f3f4f6 100%);
        }

        .dark-mode body {
            background-image: linear-gradient(135deg, #374151 0%, #1e293b 50%, #111827 100%);
        }

        h1, h2, h3 {
            font-weight: 700;
        }

        .glassmorphism-container {
            background-color: var(--card-bg-light);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 12px 40px 0 var(--shadow-color);
            transition: background-color 0.5s, border-color 0.5s;
        }

        .dark-mode .glassmorphism-container {
            background-color: var(--card-bg-dark);
            border: 1px solid var(--dark-border-color);
        }

        input, textarea, select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text-color);
            transition: all 0.3s;
        }
        
        .dark-mode input, .dark-mode textarea, .dark-mode select {
            background-color: rgba(31, 41, 55, 0.1);
            color: #e5e7eb;
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        input:focus, textarea:focus, select:focus {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }
        
        .dark-mode input:focus, .dark-mode textarea:focus, .dark-mode select:focus {
            background-color: rgba(31, 41, 55, 0.2);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3);
        }

        .thread {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }

        .thread:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -2px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.7);
        }
        .dark-mode .thread:hover {
             background-color: rgba(31, 41, 55, 0.7);
        }

        .favorite-btn:hover {
            transform: scale(1.3) rotate(15deg);
        }

        /* Gradient for buttons */
        .gradient-btn {
            background-image: linear-gradient(45deg, #6b46e5, #8a57ea);
            box-shadow: 0 4px 15px 0 rgba(107, 70, 229, 0.6);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .gradient-btn:hover {
            background-image: linear-gradient(45deg, #5a3bc9, #7948c9);
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 8px 25px 0 rgba(107, 70, 229, 0.8);
        }

        .outline-btn {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
            transition: all 0.3s;
        }

        .outline-btn:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.4);
        }

        .reply-form button {
            transition: transform 0.2s, background-color 0.2s;
        }

        .reply-form button:hover {
            transform: scale(1.1);
            background-color: #4c37b0;
        }

        .disabled-btn {
            opacity: 0.7;
            cursor: not-allowed;
            background-image: none;
            background-color: #9ca3af;
            box-shadow: none;
            transform: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.8s ease-out forwards;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-8 max-w-4xl glassmorphism-container rounded-[2rem] shadow-2xl my-10">
        
        <!-- Header -->
        <header class="text-center pb-8 border-b border-gray-200 dark:border-gray-700 mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 dark:text-indigo-400" data-lang-key="title">ğŸ—£ï¸ ×¤×•×¨×•× ××©×¤×—×ª× ×•</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2 text-lg" data-lang-key="subtitle">××§×•× ×œ×”×ª×¢×“×›×Ÿ, ×œ×©××•×œ ×•×œ×—×œ×•×§ ×–×™×›×¨×•× ×•×ª ××©×¤×—×ª×™×™×.</p>
        </header>

        <!-- User & App Info Section -->
        <div class="flex items-center justify-between flex-wrap gap-4 mb-6 text-sm text-gray-500 dark:text-gray-400">
            <span id="userIdDisplay" class="truncate flex items-center gap-1">
                <span class="font-mono text-gray-700 dark:text-gray-300 font-semibold text-lg" id="userIdValue">×˜×•×¢×Ÿ...</span>
                <span id="userName" class="text-gray-600 dark:text-gray-400 font-medium"></span>
                <button id="copyUserIdBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors duration-200" title="×”×¢×ª×§ ××–×”×” ××©×ª××©">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
            </span>
            <div id="copySuccessMsg" class="absolute bg-green-500 text-white text-xs px-3 py-1 rounded-md opacity-0 transition-opacity duration-300">×”×•×¢×ª×§!</div>
            <div class="flex items-center gap-3">
                <button id="darkModeToggle" class="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full text-sm font-medium transition-colors duration-200">
                    <span id="darkModeIcon">ğŸŒ“</span> <span data-lang-key="darkModeBtn">××¦×‘ ×›×”×”</span>
                </button>
                <button id="langToggle" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full text-sm font-medium transition-colors duration-200">
                    English
                </button>
            </div>
        </div>
        
        <!-- User Name Section -->
        <div class="glassmorphism-container rounded-2xl p-6 mb-8 flex flex-col sm:flex-row items-center gap-4 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2 sm:mb-0" data-lang-key="userNameSection">ğŸ‘¤ ×©× ×”××©×ª××© ×©×œ×š</h2>
            <div class="flex flex-grow gap-2 w-full">
                <input type="text" id="userNameInput" placeholder="×”×›× ×¡ ××ª ×©××š" class="flex-grow px-4 py-2 border rounded-full focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all duration-200" data-lang-key="userNamePlaceholder">
                <button id="saveUserNameBtn" class="gradient-btn text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500" data-lang-key="saveBtn">
                    ×©××•×¨
                </button>
            </div>
        </div>

        <!-- Search & Filter Section -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <input type="text" id="searchInput" placeholder="ğŸ” ×—×¤×© ×©×¨×©×•×¨..." class="w-full sm:w-2/3 px-4 py-2 border rounded-full focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all duration-200" data-lang-key="searchPlaceholder">
            <select id="categoryFilter" class="w-full sm:w-1/3 px-4 py-2 border rounded-full focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all duration-200">
                <option value="all" data-lang-key="allCategories">×›×œ ×”× ×•×©××™×</option>
                <option value="×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª" data-lang-key="categoryHistory">×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª</option>
                <option value="×©××œ×•×ª" data-lang-key="categoryQuestions">×©××œ×•×ª</option>
                <option value="×¢×“×›×•× ×™×" data-lang-key="categoryUpdates">×¢×“×›×•× ×™×</option>
            </select>
        </div>

        <!-- New Thread Form -->
        <div class="glassmorphism-container rounded-[2rem] p-8 mb-8 shadow-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-300" data-lang-key="newThreadHeader">âœï¸ ×¤×¨×¡× ×©×¨×©×•×¨ ×—×“×©</h2>
            <form id="newThreadForm" class="space-y-4">
                <input type="text" id="newThreadTitle" placeholder="×›×•×ª×¨×ª ×”×©×¨×©×•×¨" required class="w-full px-4 py-3 border rounded-xl focus:ring focus:ring-indigo-300 focus:outline-none" data-lang-key="titlePlaceholder">
                <textarea id="newThreadContent" rows="4" placeholder="×©×ª×£ ××ª ××—×©×‘×•×ª×™×š..." required class="w-full px-4 py-3 border rounded-xl focus:ring focus:ring-indigo-300 focus:outline-none" data-lang-key="contentPlaceholder"></textarea>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button type="button" id="improveTextBtn" class="w-full sm:w-1/2 outline-btn font-bold py-3 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500" data-lang-key="improveBtn">
                        âœ¨ ×©×¤×¨ ××ª ×”× ×™×¡×•×—
                    </button>
     <div class="relative w-full sm:w-1/2">
  <button id="categoryDropdownBtn" type="button" aria-haspopup="listbox" aria-expanded="false"
          class="w-full px-4 py-3 border rounded-lg text-left flex items-center justify-between bg-transparent focus:ring focus:ring-indigo-300">
    <span id="selectedCategoryLabel" class="truncate">×‘×—×¨ ×§×˜×’×•×¨×™×”...</span>
    <i class="fas fa-chevron-down text-sm"></i>
  </button>

  <ul id="categoryDropdownList" role="listbox" tabindex="-1"
      class="hidden absolute right-0 left-0 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-50 overflow-auto max-h-48 text-right">
    <li role="option" data-value="×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª" class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª</li>
    <li role="option" data-value="×©××œ×•×ª" class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">×©××œ×•×ª</li>
    <li role="option" data-value="×¢×“×›×•× ×™×" class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">×¢×“×›×•× ×™×</li>
  </ul>

  <!-- select × ×¡×ª×¨ ×œ×©××™×¨×” ×¢×œ ×”×ª××™×›×” ×‘×§×•×“ ×”×§×™×™× -->
  <select id="newThreadCategory" class="sr-only" aria-hidden="true">
    <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”...</option>
    <option value="×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª">×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª</option>
    <option value="×©××œ×•×ª">×©××œ×•×ª</option>
    <option value="×¢×“×›×•× ×™×">×¢×“×›×•× ×™×</option>
  </select>
</div>


<button type="submit" id="submitThreadBtn" 
        class="w-full gradient-btn text-white font-bold py-3 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled-btn" 
        disabled>
    <span id="submitBtnText" data-lang-key="submitBtn">ğŸ“¤ ×¤×¨×¡× ×©×¨×©×•×¨</span>
    <div id="loadingSpinner" class="hidden animate-spin h-6 w-6 text-white mx-auto">
        <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" 
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
                        </svg>
                    </div>
                </button>
            </form>
        </div>

        <!-- Threads Section -->
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300" data-lang-key="threadsHeader">ğŸ—‚ï¸ ×›×œ ×”×©×¨×©×•×¨×™×</h2>
            <div id="threadList" class="min-h-[200px]">
                <p id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 mt-10" data-lang-key="loadingMsg">×˜×•×¢×Ÿ ×©×¨×©×•×¨×™×...</p>
                <!-- Threads will be dynamically inserted here -->
            </div>
            <p id="noThreadsMessage" class="text-center text-gray-500 dark:text-gray-400 hidden" data-lang-key="noThreadsMsg">××™×Ÿ ×©×¨×©×•×¨×™× ×¢×“×™×™×Ÿ. ×”×™×” ×”×¨××©×•×Ÿ ×œ×¤×¨×¡×!</p>
        </div>

    </div>

    <!-- JavaScript and Firebase Logic -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration and app ID
        const firebaseConfig = {
            apiKey: "AIzaSyBw7yfBRTDFiMRlWfuekISDD3EHnmNAuDk",
            authDomain: "family-forum-d088e.firebaseapp.com",
            projectId: "family-forum-d088e",
            storageBucket: "family-forum-d088e.firebasestorage.app",
            messagingSenderId: "159839212196",
            appId: "1:159839212196:web:20992695be32d2b14a8c31",
            measurementId: "G-XX7T3N2X7C"
        };
        const appId = firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const threadList = document.getElementById('threadList');
        const newThreadForm = document.getElementById('newThreadForm');
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const langToggle = document.getElementById('langToggle');
        const loadingMessage = document.getElementById('loadingMessage');
        const noThreadsMessage = document.getElementById('noThreadsMessage');
        const userIdDisplay = document.getElementById('userIdValue');
        const userNameDisplay = document.getElementById('userName');
        const copyUserIdBtn = document.getElementById('copyUserIdBtn');
        const copySuccessMsg = document.getElementById('copySuccessMsg');
        const submitBtnText = document.getElementById('submitBtnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const improveTextBtn = document.getElementById('improveTextBtn');
        const newThreadContent = document.getElementById('newThreadContent');
        const userNameInput = document.getElementById('userNameInput');
        const saveUserNameBtn = document.getElementById('saveUserNameBtn');
        const submitThreadBtn = document.getElementById('submitThreadBtn');
        const newThreadTitle = document.getElementById('newThreadTitle');
        const newThreadCategory = document.getElementById('newThreadCategory');


        // Firebase Initialization
        let db, auth;
        let userId;
        let userName = 'Anonymous'; // Default user name

        // Language Strings
        const languageStrings = {
            'he': {
                'title': 'ğŸ—£ï¸ ×¤×•×¨×•× ××©×¤×—×ª× ×•',
                'subtitle': '××§×•× ×œ×”×ª×¢×“×›×Ÿ, ×œ×©××•×œ ×•×œ×—×œ×•×§ ×–×™×›×¨×•× ×•×ª ××©×¤×—×ª×™×™×.',
                'welcomeMsg': '×©×œ×•×, ',
                'anonymousUser': '××©×ª××© ×× ×•× ×™××™',
                'userIdLabel': '××–×”×” ××©×ª××©:',
                'darkModeBtn': '××¦×‘ ×›×”×”',
                'searchPlaceholder': 'ğŸ” ×—×¤×© ×©×¨×©×•×¨...',
                'allCategories': '×›×œ ×”× ×•×©××™×',
                'categoryHistory': '×”×™×¡×˜×•×¨×™×” ××©×¤×—×ª×™×ª',
                'categoryQuestions': '×©××œ×•×ª',
                'categoryUpdates': '×¢×“×›×•× ×™×',
                'userNameSection': 'ğŸ‘¤ ×©× ×”××©×ª××© ×©×œ×š',
                'userNamePlaceholder': '×”×›× ×¡ ××ª ×©××š',
                'saveBtn': '×©××•×¨',
                'newThreadHeader': 'âœï¸ ×¤×¨×¡× ×©×¨×©×•×¨ ×—×“×©',
                'titlePlaceholder': '×›×•×ª×¨×ª ×”×©×¨×©×•×¨',
                'contentPlaceholder': '×©×ª×£ ××ª ××—×©×‘×•×ª×™×š...',
                'improveBtn': 'âœ¨ ×©×¤×¨ ××ª ×”× ×™×¡×•×—',
                'selectCategoryPlaceholder': '×‘×—×¨ ×§×˜×’×•×¨×™×”...',
                'selectCategoryOption': '×‘×—×¨ ×§×˜×’×•×¨×™×”...',
                'submitBtn': 'ğŸ“¤ ×¤×¨×¡× ×©×¨×©×•×¨',
                'threadsHeader': 'ğŸ—‚ï¸ ×›×œ ×”×©×¨×©×•×¨×™×',
                'loadingMsg': '×˜×•×¢×Ÿ ×©×¨×©×•×¨×™×...',
                'noThreadsMsg': '××™×Ÿ ×©×¨×©×•×¨×™× ×¢×“×™×™×Ÿ. ×”×™×” ×”×¨××©×•×Ÿ ×œ×¤×¨×¡×!',
                'copySuccessMsg': '×”×•×¢×ª×§!',
                'threadCategory': '×§×˜×’×•×¨×™×”:',
                'threadPostedBy': '×¤×•×¨×¡× ×¢×œ ×™×“×™:',
                'threadDateNotAvailable': '×ª××¨×™×š ×œ× ×–××™×Ÿ',
                'threadRepliesHeader': '×ª×’×•×‘×•×ª',
                'replyPlaceholder': '×”×•×¡×£ ×ª×’×•×‘×”...',
                'loadingText': '×˜×•×¢×Ÿ...',
                'nameSaveSuccess': '×”×©× × ×©××¨ ×‘×”×¦×œ×—×”!'
            },
            'en': {
                'title': 'ğŸ—£ï¸ Our Family Forum',
                'subtitle': 'A place to get updates, ask questions, and share family memories.',
                'welcomeMsg': 'Hello, ',
                'anonymousUser': 'Anonymous User',
                'userIdLabel': 'User ID:',
                'darkModeBtn': 'Dark Mode',
                'searchPlaceholder': 'ğŸ” Search thread...',
                'allCategories': 'All Topics',
                'categoryHistory': 'Family History',
                'categoryQuestions': 'Questions',
                'categoryUpdates': 'Updates',
                'userNameSection': 'ğŸ‘¤ Your User Name',
                'userNamePlaceholder': 'Enter your name',
                'saveBtn': 'Save',
                'newThreadHeader': 'âœï¸ Post a New Thread',
                'titlePlaceholder': 'Thread Title',
                'contentPlaceholder': 'Share your thoughts...',
                'improveBtn': 'âœ¨ Improve Writing',
                'selectCategoryPlaceholder': 'Select a category...',
                'selectCategoryOption': 'Select a category...',
                'submitBtn': 'ğŸ“¤ Post Thread',
                'threadsHeader': 'ğŸ—‚ï¸ All Threads',
                'loadingMsg': 'Loading threads...',
                'noThreadsMsg': 'No threads yet. Be the first to post!',
                'copySuccessMsg': 'Copied!',
                'threadCategory': 'Category:',
                'threadPostedBy': 'Posted by:',
                'threadDateNotAvailable': 'Date not available',
                'threadRepliesHeader': 'Replies',
                'replyPlaceholder': 'Add a reply...',
                'loadingText': 'Loading...',
                'nameSaveSuccess': 'Name saved successfully!'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'he';
        langToggle.textContent = currentLang === 'he' ? 'English' : '×¢×‘×¨×™×ª';
        document.documentElement.setAttribute('dir', currentLang === 'he' ? 'rtl' : 'ltr');

        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in anonymously if no user is found
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                    }

                    userIdDisplay.textContent = userId;
                    
                    // Fetch user name from Firestore
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (userDocSnap.exists() && userDocSnap.data().name) {
                        userName = userDocSnap.data().name;
                        userNameDisplay.textContent = `(${languageStrings[currentLang].welcomeMsg} ${userName})`;
                        userNameInput.value = userName;
                    } else {
                         userName = languageStrings[currentLang].anonymousUser;
                         userNameDisplay.textContent = `(${languageStrings[currentLang].welcomeMsg} ${userName})`;
                    }

                    // Update UI based on initial language
                    updateUI(currentLang);

                    // Start listening for threads once authenticated
                    fetchThreads();
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingMessage.textContent = languageStrings[currentLang].loadingMsg;
            }
        };

        const updateUI = (lang) => {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.setAttribute('dir', lang === 'he' ? 'rtl' : 'ltr');

            // Update all elements with data-lang-key attribute
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (languageStrings[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = languageStrings[lang][key];
                    } else if (el.tagName === 'OPTION') {
                        el.textContent = languageStrings[lang][key];
                    } else {
                        el.textContent = languageStrings[lang][key];
                    }
                }
            });

            // Specific updates
            langToggle.textContent = lang === 'he' ? 'English' : '×¢×‘×¨×™×ª';
            copySuccessMsg.textContent = languageStrings[lang].copySuccessMsg;
            userNameDisplay.textContent = `(${languageStrings[currentLang].welcomeMsg} ${userName})`;

            // Re-render threads to update dynamic content
            fetchThreads();
        };
        
        // --- Gemini API Functionality ---
        const generateSummaryAndSuggestions = async (threadTitle, threadContent) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // We use a custom system instruction to give Gemini a specific persona and task.
            const systemPrompt = "××ª×” ×¢×•×–×¨ ×•×™×¨×˜×•××œ×™ ×œ×¤×•×¨×•× ××©×¤×—×ª×™. ××˜×¨×ª×š ×œ×¡×›× ×©×¨×©×•×¨×™× ×—×“×©×™× ×•×œ×”×¦×™×¢ × ×•×©××™× ×¨×œ×•×•× ×˜×™×™× × ×•×¡×¤×™× ×œ×“×™×•×Ÿ. ×›×ª×•×‘ ×ª×’×•×‘×” ×§×¦×¨×” (×¢×“ 70 ××™×œ×™×), ××ª×•××¦×ª×ª, ×•×™×“×™×“×•×ª×™×ª. ×”×©×ª××© ×‘×˜×•×Ÿ ×“×™×‘×•×¨ ××©×¤×—×ª×™. ×”×ª×—×œ ×ª××™×“ ××ª ×”×ª×’×•×‘×” ×¢× '×”×“×•×¨ ×”×‘× âœ¨:'"
            const userQuery = `×‘×¡×¡ ××ª ×”×¡×™×›×•× ×•×”×”×¦×¢×•×ª ×©×œ×š ×¢×œ ×”× ×•×©× ×”×‘×: ×›×•×ª×¨×ª: "${threadTitle}", ×ª×•×›×Ÿ: "${threadContent}"`
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || '×©×’×™××” ×‘×§×¨×™××” ×œ-API ×©×œ ×’×³××™× ×™.';
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return '×©×’×™××” ×‘×§×¨×™××” ×œ-API ×©×œ ×’×³××™× ×™.';
            }
        };

        const improvePostText = async (originalText) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // System instruction for improving the text
            const systemPrompt = "××ª×” ×¢×•×¨×š ×œ×©×•× ×™ ×™×“×™×“×•×ª×™ ×•××¡×™×™×¢. ××˜×¨×ª×š ×œ×§×‘×œ ×˜×§×¡×˜ ×××©×ª××©×™× ×‘×¤×•×¨×•× ××©×¤×—×ª×™ ×•×œ×©×¤×¨ ××ª ×”× ×™×¡×•×— ×©×œ×•. ×ª×§×Ÿ ×©×’×™××•×ª ×›×ª×™×‘ ×•×“×§×“×•×§, ×©×¤×¨ ××ª ×©×˜×£ ×”×§×¨×™××” ×•×”×¤×•×š ××ª ×”×˜×§×¡×˜ ×œ×‘×¨×•×¨ ×™×•×ª×¨. ×”×©××¨ ××ª ×”×ª×•×›×Ÿ ×”××§×•×¨×™. ×”×©×™×‘ ×¨×§ ×¢× ×”×˜×§×¡×˜ ×”××©×•×¤×¨, ×œ×œ× ×”×¡×‘×¨ × ×•×¡×£."
            const userQuery = `×©×¤×¨ ××ª ×”×˜×§×¡×˜ ×”×‘× ×œ×¤×¨×¡×•× ×‘×¤×•×¨×•× ××©×¤×—×ª×™: "${originalText}"`
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || originalText;
            } catch (error) {
                console.error("Error calling Gemini API for text improvement:", error);
                return originalText;
            }
        };

        // --- UI Events ---
        improveTextBtn.addEventListener('click', async () => {
            const originalText = newThreadContent.value;
            if (originalText.trim() === '') return;

            improveTextBtn.textContent = languageStrings[currentLang].loadingText;
            improveTextBtn.disabled = true;

            const improvedText = await improvePostText(originalText);
            newThreadContent.value = improvedText;

            improveTextBtn.textContent = languageStrings[currentLang].improveBtn;
            improveTextBtn.disabled = false;
        });

        // Save User Name
        saveUserNameBtn.addEventListener('click', async () => {
            const newName = userNameInput.value.trim();
            if (newName === '') return;

            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await setDoc(userDocRef, { name: newName });
                userName = newName;
                userNameDisplay.textContent = `(${languageStrings[currentLang].welcomeMsg} ${userName})`;
                console.log('User name saved successfully!');
            } catch (error) {
                console.error("Error saving user name: ", error);
            }
        });

        // Copy User ID to clipboard
        copyUserIdBtn.addEventListener('click', () => {
            const tempInput = document.createElement('input');
            tempInput.value = userIdDisplay.textContent;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            copySuccessMsg.classList.remove('opacity-0');
            setTimeout(() => copySuccessMsg.classList.add('opacity-0'), 2000);
        });

        // Dark Mode Toggle
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        // Language Toggle
        langToggle.addEventListener('click', () => {
            const newLang = currentLang === 'he' ? 'en' : 'he';
            updateUI(newLang);
        });
        
        // Function to check if all form fields are valid and enable/disable the submit button
        const updateSubmitButtonState = () => {
            // Get the trimmed values of the input fields and the selected category.
            const title = newThreadTitle.value.trim();
            const content = newThreadContent.value.trim();
            const category = newThreadCategory.value;

            // The button is only enabled when all three fields have valid input.
            // An empty string in JavaScript is "falsy", so this condition works well.
            if (title && content && category) {
                submitThreadBtn.disabled = false;
                submitThreadBtn.classList.remove('disabled-btn');
                submitThreadBtn.classList.add('gradient-btn');
            } else {
                submitThreadBtn.disabled = true;
                submitThreadBtn.classList.add('disabled-btn');
                submitThreadBtn.classList.remove('gradient-btn');
            }
        };

        // Event listeners for form fields to update button state
        newThreadTitle.addEventListener('input', updateSubmitButtonState);
        newThreadContent.addEventListener('input', updateSubmitButtonState);
        newThreadCategory.addEventListener('change', updateSubmitButtonState);


        // --- Firestore Operations and Data Handling ---

        // Function to render a single thread
        const renderThread = (doc) => {
            const data = doc.data();
            const threadId = doc.id;
            const isFavorite = data.favorites?.includes(userId) || false;
            const favoriteIconClass = isFavorite ? 'text-yellow-400' : 'text-gray-400';
            const displayAuthor = data.authorName || data.authorId;

            const threadElement = document.createElement('div');
            threadElement.className = `thread p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-200 dark:border-gray-700 transition-all hover:shadow-lg animate-fadeIn`;
            threadElement.setAttribute('data-thread-id', threadId);
            threadElement.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${data.title}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" data-lang-key="threadCategory">${languageStrings[currentLang].threadCategory} <span class="font-semibold">${data.category}</span></p>
                    </div>
                    <button class="favorite-btn transform transition-transform duration-200" data-thread-id="${threadId}" title="×¡××Ÿ ×›××•×¢×“×£">
                        <i class="fas fa-star text-lg ${favoriteIconClass}"></i>
                    </button>
                </div>
                <p class="mt-4 text-gray-700 dark:text-gray-300 leading-relaxed">${data.content}</p>
                <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mt-4 border-t border-dashed border-gray-300 dark:border-gray-600 pt-4">
                    <p data-lang-key="threadPostedBy">${languageStrings[currentLang].threadPostedBy} <span class="font-semibold">${displayAuthor}</span></p>
                    <p>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US') : languageStrings[currentLang].threadDateNotAvailable}</p>
                </div>
                <!-- Replies section -->
                <div class="replies mt-4 border-t border-dashed border-gray-300 dark:border-gray-600 pt-4">
                    <h4 class="font-bold text-gray-600 dark:text-gray-300 mb-2">${languageStrings[currentLang].threadRepliesHeader} (${data.replies ? data.replies.length : 0})</h4>
                    <div class="space-y-3">
                        ${(data.replies || []).map(reply => {
                            const replyAuthor = reply.authorId === 'gemini-bot' ? 'Gemini-Bot âœ¨' : (reply.authorName || reply.authorId);
                            const replyDate = new Date(reply.timestamp.toDate()).toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US');
                            return `
                                <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm shadow-sm">
                                    <p class="text-gray-700 dark:text-gray-200">${reply.content}</p>
                                    <div class="flex justify-between items-center text-xs mt-1 text-gray-500 dark:text-gray-400">
                                        <span class="font-mono">${replyAuthor}</span>
                                        <span>${replyDate}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <!-- Reply form -->
                    <form class="reply-form mt-4 flex gap-2">
                        <input type="text" placeholder="${languageStrings[currentLang].replyPlaceholder}" required class="w-full px-4 py-2 text-sm border rounded-full focus:ring focus:ring-indigo-300 focus:outline-none">
                        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full transition-colors duration-200" title="×©×œ×— ×ª×’×•×‘×”">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                            </svg>
                        </button>
                    </form>
                </div>
            `;
            return threadElement;
        };

        // Function to fetch and listen to real-time updates from Firestore
        const fetchThreads = () => {
            const threadsCol = collection(db, `artifacts/${appId}/public/data/threads`);
            
            onSnapshot(threadsCol, (querySnapshot) => {
                const threads = [];
                querySnapshot.forEach(doc => threads.push(doc));
                
                // Filtering and sorting
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value;

                const filteredThreads = threads
                    .filter(doc => {
                        const data = doc.data();
                        const matchesSearch = data.title.toLowerCase().includes(searchTerm) || data.content.toLowerCase().includes(searchTerm);
                        const matchesCategory = selectedCategory === 'all' || data.category === selectedCategory;
                        return matchesSearch && matchesCategory;
                    })
                    .sort((a, b) => b.data().timestamp.toDate() - a.data().timestamp.toDate());
                
                threadList.innerHTML = '';
                loadingMessage.classList.add('hidden');
                
                if (filteredThreads.length === 0) {
                    noThreadsMessage.classList.remove('hidden');
                } else {
                    noThreadsMessage.classList.add('hidden');
                    filteredThreads.forEach(doc => {
                        const threadElement = renderThread(doc);
                        threadList.appendChild(threadElement);
                    });
                }
            });
        };

        // Event listener for adding a new thread
        newThreadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitBtnText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const title = document.getElementById('newThreadTitle').value;
            const content = document.getElementById('newThreadContent').value;
            const category = document.getElementById('newThreadCategory').value;

            try {
                const threadsCol = collection(db, `artifacts/${appId}/public/data/threads`);
                const newThreadRef = await addDoc(threadsCol, {
                    title: title,
                    content: content,
                    category: category,
                    authorId: userId,
                    authorName: userName,
                    timestamp: serverTimestamp(),
                    replies: [],
                    favorites: []
                });

                // Generate a summary and a suggestion from the LLM and add it as a reply.
                const summaryReply = await generateSummaryAndSuggestions(title, content);
                await updateDoc(newThreadRef, {
                    replies: arrayUnion({
                        content: summaryReply,
                        authorId: 'gemini-bot',
                        timestamp: serverTimestamp()
                    })
                });

                newThreadForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            } finally {
                submitBtnText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                updateSubmitButtonState();
            }
        });

        // Delegated event listener for replies and favorites
        threadList.addEventListener('click', async (e) => {
            const favoriteBtn = e.target.closest('.favorite-btn');
            
            if (favoriteBtn) {
                const threadId = favoriteBtn.dataset.threadId;
                const threadRef = doc(db, `artifacts/${appId}/public/data/threads`, threadId);
                
                // FIX: Check if the user ID exists in the favorites array before adding/removing
                const threadDoc = await getDoc(threadRef);
                const favorites = threadDoc.data().favorites || [];
                const isFavorited = favorites.includes(userId);

                try {
                    if (isFavorited) {
                        await updateDoc(threadRef, { favorites: arrayRemove(userId) });
                    } else {
                        await updateDoc(threadRef, { favorites: arrayUnion(userId) });
                    }
                } catch (error) {
                    console.error("Error toggling favorite: ", error);
                }
            }
        });

        threadList.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('reply-form')) {
                e.preventDefault();
                const form = e.target;
                const input = form.querySelector('input');
                const content = input.value;
                const threadElement = form.closest('.thread');
                const threadId = threadElement.dataset.threadId;

                if (content.trim() === '') return;

                const threadRef = doc(db, `artifacts/${appId}/public/data/threads`, threadId);
                
                try {
                    await updateDoc(threadRef, {
                        replies: arrayUnion({
                            content: content,
                            authorId: userId,
                            authorName: userName,
                            timestamp: serverTimestamp()
                        })
                    });
                    input.value = '';
                } catch (error) {
                    console.error("Error adding reply: ", error);
                }
            }
        });

        // Event listeners for search and filter
        searchInput.addEventListener('input', fetchThreads);
        categoryFilter.addEventListener('change', fetchThreads);

        // Initialize the app on window load
        window.onload = () => {
            initializeFirebase();
            updateSubmitButtonState(); // Initial check on page load
        };
        // --- Custom dropdown behavior for categories ---
(function(){
const categoryDropdownBtn = document.getElementById('categoryDropdownBtn');
const categoryDropdownList = document.getElementById('categoryDropdownList');
const selectedCategoryLabel = document.getElementById('selectedCategoryLabel');
const hiddenCategorySelect = document.getElementById('newThreadCategory');

if (!categoryDropdownBtn || !categoryDropdownList || !selectedCategoryLabel || !hiddenCategorySelect) return;

// ×¤×•×ª×—/×¡×•×’×¨
categoryDropdownBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = categoryDropdownBtn.getAttribute('aria-expanded') === 'true';
    categoryDropdownBtn.setAttribute('aria-expanded', String(!isOpen));
    categoryDropdownList.classList.toggle('hidden');
});

// ×‘×—×™×¨×ª ××¤×©×¨×•×ª
categoryDropdownList.addEventListener('click', (e) => {
    const li = e.target.closest('[role="option"]');
    if (!li) return;
    const value = li.dataset.value;
    const label = li.textContent.trim();
    selectedCategoryLabel.textContent = label;
    hiddenCategorySelect.value = value; // ×¢×“×›×•×Ÿ ×”Ö¾select ×”× ×¡×ª×¨
    categoryDropdownList.classList.add('hidden');
    categoryDropdownBtn.setAttribute('aria-expanded', 'false');
    hiddenCategorySelect.dispatchEvent(new Event('change', { bubbles: true }));
});

// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×‘×—×•×¥
document.addEventListener('click', (e) => {
    if (!categoryDropdownBtn.contains(e.target) && !categoryDropdownList.contains(e.target)) {
        categoryDropdownList.classList.add('hidden');
        categoryDropdownBtn.setAttribute('aria-expanded', 'false');
    }
});
})();

    </script>
</body>
</html>
