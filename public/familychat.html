<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אפליקציית צ'אט משפחתית רב-לשונית</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Firebase CDNs -->
    <script type="module">
        // Import Firebase modules for use in the script below
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase modules to the global scope for the React script
        window.firebase = {
            initializeApp,
            getAuth,
            signInWithCustomToken,
            signInAnonymously,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            getFirestore,
            doc,
            onSnapshot,
            collection,
            query,
            orderBy,
            addDoc,
            serverTimestamp,
            setDoc,
            updateDoc,
            deleteDoc,
            getDoc
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        // The main React component for the chat application
        const App = () => {
            const { useState, useEffect, useRef } = React;
            
            // Access Firebase modules from the global scope
            const {
                initializeApp, getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged,
                createUserWithEmailAndPassword, signInWithEmailAndPassword, getFirestore, doc, onSnapshot, collection, query,
                orderBy, addDoc, serverTimestamp, setDoc, updateDoc, deleteDoc, getDoc
            } = window.firebase;
            
            // Use the global variables provided by the environment
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "AIzaSyACQMHrUlPMwu_co8Wg7rgpzWneq1VmyP0",
                authDomain: "family-chat-c5f57.firebaseapp.com",
                projectId: "family-chat-c5f57",
                storageBucket: "family-chat-c5f57.firebasestorage.app",
                messagingSenderId: "735954675901",
                appId: "1:735954675901:web:8f70eb1d08f760b2b1efd4",
                measurementId: "G-8FDJ49T13K"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            // Initialize Firebase services
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
        
            // State management
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [displayName, setDisplayName] = useState('');
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);
            const [users, setUsers] = useState([]);
            const [statusMessage, setStatusMessage] = useState('');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isPublicChat, setIsPublicChat] = useState(true);
            const [selectedChatPartner, setSelectedChatPartner] = useState(null);
            const [editingMessage, setEditingMessage] = useState(null);
            const [language, setLanguage] = useState('he');
            const [darkMode, setDarkMode] = useState(false);
            const messageContainerRef = useRef(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [username, setUsername] = useState('');
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [loadingGemini, setLoadingGemini] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [audioRecorder, setAudioRecorder] = useState(null);
            const [audioChunks, setAudioChunks] = useState([]);
            const [lastSeenStatus, setLastSeenStatus] = useState('');
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [messageToDelete, setMessageToDelete] = useState(null);
        
            // Effect to toggle dark mode class on HTML element
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // Translation object for UI texts
            const translations = {
                he: {
                    title: 'אפליקציית צ׳אט',
                    connectedUsers: 'משתמשים מחוברים',
                    publicChat: 'צ׳אט ציבורי',
                    privateChats: 'צ׳אטים פרטיים',
                    noOtherUsers: 'אין משתמשים אחרים זמינים.',
                    connectedAs: 'מחובר כ:',
                    uid: 'UID:',
                    chatWith: 'צ\'אט עם',
                    startConversation: 'התחל שיחה.',
                    isTyping: 'מקליד...',
                    editMessagePlaceholder: 'ערוך הודעה...',
                    typeMessagePlaceholder: 'הקלד הודעה...',
                    sendMessage: 'שלח הודעה',
                    logout: 'התנתק',
                    confirmDelete: 'בטוח שברצונך למחוק את ההודעה?',
                    edit: 'ערוך',
                    delete: 'מחק',
                    edited: '(נערך)',
                    loading: 'טוען...',
                    login: 'התחבר',
                    signup: 'הירשם',
                    or: 'או',
                    toggleLogin: 'התחבר עם חשבון קיים',
                    toggleSignup: 'צור חשבון חדש',
                    email: 'אימייל',
                    password: 'סיסמה',
                    username: 'שם משתמש',
                    loginSuccess: 'התחברת בהצלחה!',
                    signupSuccess: 'נרשמת בהצלחה!',
                    loginError: 'שגיאת התחברות: ',
                    signupError: 'שגיאת הרשמה: ',
                    welcome: 'ברוכים הבאים! אנא התחבר או הירשם כדי להתחיל.',
                    generateSmartReply: '✨ הצע תגובה חכמה',
                    generateSmartRewrite: '✨ שכתב חכם',
                    smartReplyLoading: 'מייצר תגובה חכמה...',
                    smartRewriteLoading: 'מייצר שכתוב חכם...',
                    online: 'מחובר כעת',
                    lastSeen: 'נראה לאחרונה ב-',
                    today: 'היום',
                    yesterday: 'אתמול',
                    deleteMessage: 'מחק הודעה',
                    cancel: 'בטל',
                    ok: 'אישור',
                },
                en: {
                    title: 'Chat Application',
                    connectedUsers: 'Connected Users',
                    publicChat: 'Public Chat',
                    privateChats: 'Private Chats',
                    noOtherUsers: 'No other users available.',
                    connectedAs: 'Connected as:',
                    uid: 'UID:',
                    chatWith: 'Chat with',
                    startConversation: 'Start a conversation.',
                    isTyping: 'is typing...',
                    editMessagePlaceholder: 'Edit message...',
                    typeMessagePlaceholder: 'Type a message...',
                    sendMessage: 'Send Message',
                    logout: 'Logout',
                    confirmDelete: 'Are you sure you want to delete this message?',
                    edit: 'Edit',
                    delete: 'Delete',
                    edited: '(edited)',
                    loading: 'Loading...',
                    login: 'Log In',
                    signup: 'Sign Up',
                    or: 'or',
                    toggleLogin: 'Log in with an existing account',
                    toggleSignup: 'Create a new account',
                    email: 'Email',
                    password: 'Password',
                    username: 'Username',
                    loginSuccess: 'Logged in successfully!',
                    signupSuccess: 'Signed up successfully!',
                    loginError: 'Login Error: ',
                    signupError: 'Signup Error: ',
                    welcome: 'Welcome! Please log in or sign up to get started.',
                    generateSmartReply: '✨ Generate Smart Reply',
                    generateSmartRewrite: '✨ Smart Rewrite',
                    smartReplyLoading: 'Generating smart reply...',
                    smartRewriteLoading: 'Generating smart rewrite...',
                    online: 'Online',
                    lastSeen: 'Last seen at',
                    today: 'Today',
                    yesterday: 'Yesterday',
                    deleteMessage: 'Delete Message',
                    cancel: 'Cancel',
                    ok: 'OK',
                },
                fr: {
                    title: 'Application de chat',
                    connectedUsers: 'Utilisateurs connectés',
                    publicChat: 'Chat public',
                    privateChats: 'Chats privés',
                    noOtherUsers: 'Aucun autre utilisateur disponible.',
                    connectedAs: 'Connecté en tant que :',
                    uid: 'UID :',
                    chatWith: 'Chat with',
                    startConversation: 'Commencez une conversation.',
                    isTyping: 'écrit...',
                    editMessagePlaceholder: 'Modifier le message...',
                    typeMessagePlaceholder: 'Tapez un message...',
                    sendMessage: 'Envoyer le message',
                    logout: 'Déconnexion',
                    confirmDelete: 'Êtes-vous sûr de vouloir supprimer ce message ?',
                    edit: 'Modifier',
                    delete: 'Supprimer',
                    edited: '(modifié)',
                    loading: 'Chargement...',
                    login: 'Connexion',
                    signup: 'Inscription',
                    or: 'ou',
                    toggleLogin: 'Connectez-vous avec un compte existant',
                    toggleSignup: 'Créer un nouveau compte',
                    email: 'E-mail',
                    password: 'Mot de passe',
                    username: 'Nom d\'utilisateur',
                    loginSuccess: 'Connecté avec succès!',
                    signupSuccess: 'Inscrit avec succès!',
                    loginError: 'Erreur de connexion: ',
                    signupError: 'Erreur d\'inscription: ',
                    welcome: 'Bienvenue! Veuillez vous connecter ou vous inscrire pour commencer.',
                    generateSmartReply: '✨ Générer une réponse intelligente',
                    generateSmartRewrite: '✨ Réécriture intelligente',
                    smartReplyLoading: 'Génération de la réponse intelligente...',
                    smartRewriteLoading: 'Génération de la réécriture intelligente...',
                    online: 'En ligne',
                    lastSeen: 'Vu pour la dernière fois à',
                    today: 'Aujourd\'hui',
                    yesterday: 'Hier',
                    deleteMessage: 'Supprimer le message',
                    cancel: 'Annuler',
                    ok: 'OK',
                },
                yi: {
                    title: 'שמועס אַפּליקאַציע',
                    connectedUsers: 'פֿאַרבונדענע באַניצערס',
                    publicChat: 'עפֿנטלעכע שמועס',
                    privateChats: 'פּריוואַטע שמועסן',
                    noOtherUsers: 'קיין אַנדערע באַניצערס זײַנען נישט בנימצא.',
                    connectedAs: 'פֿאַרבונדן אַלס:',
                    uid: 'באַנוצער-קאָד:',
                    chatWith: 'שמועס מיט',
                    startConversation: 'הייבט אָן אַ שמועס.',
                    isTyping: 'שרײַבט...',
                    editMessagePlaceholder: 'רעדאַקטירן מעלדונג...',
                    typeMessagePlaceholder: 'שרײַבט אַ מעלדונג...',
                    sendMessage: 'שיק מעלדונג',
                    logout: 'אױסלאָגן',
                    confirmDelete: 'זענט איר זיכער צו לײַשן די מעלדונג?',
                    edit: 'רעדאַקטירן',
                    delete: 'לײַשן',
                    edited: '(רעדאַקטירט)',
                    loading: 'לוידן...',
                    login: 'אײַנלאָגן',
                    signup: 'רעגיסטרירן',
                    or: 'אָדער',
                    toggleLogin: 'אײַנלאָגן מיט אַן עקזיסטירנדיקן קאנטע',
                    toggleSignup: 'שאַפֿן אַ נײַעם קאנטע',
                    email: 'בליצפּאָסט',
                    password: 'פּאַראָל',
                    username: 'באַניצער נאָמען',
                    loginSuccess: 'געראָטן אײַנלאָגן!',
                    signupSuccess: 'געראָטן רעגיסטרירט!',
                    loginError: 'אײַנלאָגן פֿעלער: ',
                    signupError: 'רעגיסטראַציע פֿעלער: ',
                    welcome: 'ברוכים הבאים! ביטע אײַנלאָגן אָדער רעגיסטרירן צו אָנהייבן.',
                    generateSmartReply: '✨ שאַפֿן אַ קלוגע ענטפֿער',
                    generateSmartRewrite: '✨ קלוג שרײַבן איבער',
                    smartReplyLoading: 'שאַפֿן קלוגע ענטפֿער...',
                    smartRewriteLoading: 'שאַפֿן קלוג איבערשרײַבן...',
                    online: 'אָנלײַן',
                    lastSeen: 'לעצטנס געזען בײַ',
                    today: 'היינט',
                    yesterday: 'נעכטן',
                    deleteMessage: 'לײַשן מעלדונג',
                    cancel: 'קענסלען',
                    ok: 'אָקעי',
                },
                de: {
                    title: 'Chat-Anwendung',
                    connectedUsers: 'Verbundene Benutzer',
                    publicChat: 'Öffentlicher Chat',
                    privateChats: 'Private Chats',
                    noOtherUsers: 'Keine anderen Benutzer verfügbar.',
                    connectedAs: 'Verbunden als:',
                    uid: 'UID:',
                    chatWith: 'Chatten mit',
                    startConversation: 'Beginnen Sie eine Unterhaltung.',
                    isTyping: 'tippt...',
                    editMessagePlaceholder: 'Nachricht bearbeiten...',
                    typeMessagePlaceholder: 'Nachricht eingeben...',
                    sendMessage: 'Nachricht senden',
                    logout: 'Abmelden',
                    confirmDelete: 'Sind Sie sicher, dass Sie diese Nachricht löschen möchten?',
                    edit: 'Bearbeiten',
                    delete: 'Löschen',
                    edited: '(bearbeitet)',
                    loading: 'Lädt...',
                    login: 'Anmelden',
                    signup: 'Registrieren',
                    or: 'oder',
                    toggleLogin: 'Mit einem bestehenden Konto anmelden',
                    toggleSignup: 'Ein neues Konto erstellen',
                    email: 'E-Mail',
                    password: 'Passwort',
                    username: 'Benutzername',
                    loginSuccess: 'Erfolgreich angemeldet!',
                    signupSuccess: 'Erfolgreich registriert!',
                    loginError: 'Anmeldefehler: ',
                    signupError: 'Registrierungsfehler: ',
                    welcome: 'Willkommen! Bitte melden Sie sich an oder registrieren Sie sich, um zu beginnen.',
                    generateSmartReply: '✨ Intelligente Antwort generieren',
                    generateSmartRewrite: '✨ Intelligentes Umschreiben',
                    smartReplyLoading: 'Generiere intelligente Antwort...',
                    smartRewriteLoading: 'Generiere intelligente Umschreibung...',
                    online: 'Online',
                    lastSeen: 'Zuletzt gesehen um',
                    today: 'Heute',
                    yesterday: 'Gestern',
                    deleteMessage: 'Nachricht löschen',
                    cancel: 'Abbrechen',
                    ok: 'OK',
                },
                nl: {
                    title: 'Chat-applicatie',
                    connectedUsers: 'Verbonden gebruikers',
                    publicChat: 'Openbare chat',
                    privateChats: 'Privé-chats',
                    noOtherUsers: 'Geen andere gebruikers beschikbaar.',
                    connectedAs: 'Verbonden als:',
                    uid: 'UID:',
                    chatWith: 'Chat met',
                    startConversation: 'Start een gesprek.',
                    isTyping: 'typt...',
                    editMessagePlaceholder: 'Bericht bewerken...',
                    typeMessagePlaceholder: 'Typ een bericht...',
                    sendMessage: 'Verzend bericht',
                    logout: 'Uitloggen',
                    confirmDelete: 'Weet u zeker dat u dit bericht wilt verwijderen?',
                    edit: 'Bewerken',
                    delete: 'Verwijderen',
                    edited: '(bewerkt)',
                    loading: 'Laden...',
                    login: 'Inloggen',
                    signup: 'Aanmelden',
                    or: 'of',
                    toggleLogin: 'Inloggen met een bestaand account',
                    toggleSignup: 'Een nieuw account aanmaken',
                    email: 'E-mail',
                    password: 'Wachtwoord',
                    username: 'Gebruikersnaam',
                    loginSuccess: 'Succesvol ingelogd!',
                    signupSuccess: 'Succesvol aangemeld!',
                    loginError: 'Inlogfout: ',
                    signupError: 'Aanmeldfout: ',
                    welcome: 'Welkom! Log in of meld u aan om te beginnen.',
                    generateSmartReply: '✨ Genereer slim antwoord',
                    generateSmartRewrite: '✨ Slimme herschrijving',
                    smartReplyLoading: 'Slim antwoord genereren...',
                    smartRewriteLoading: 'Slimme herschrijving genereren...',
                    online: 'Online',
                    lastSeen: 'Laatst gezien om',
                    today: 'Vandaag',
                    yesterday: 'Gisteren',
                    deleteMessage: 'Bericht verwijderen',
                    cancel: 'Annuleren',
                    ok: 'OK',
                }
            };
        
            const t = translations[language];
            const isRTL = language === 'he' || language === 'yi';

            // Authentication flow with manual sign in/up
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            setDisplayName(userDocSnap.data().displayName);
                        } else {
                            const newDisplayName = username || `User${currentUser.uid.substring(0, 4)}`;
                            await setDoc(userDocRef, {
                                uid: currentUser.uid,
                                displayName: newDisplayName,
                                createdAt: serverTimestamp(),
                            });
                            setDisplayName(newDisplayName);
                        }
                    } else {
                        setUser(null);
                        setDisplayName('');
                    }
                    setIsAuthReady(true);
                    setLoading(false);
                });
                
                return () => unsubscribe();
            }, []);
        
            // Effect to update lastSeen timestamp on user document
            useEffect(() => {
                if (user && isAuthReady) {
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    const updateLastSeen = async () => {
                        await setDoc(userDocRef, { lastSeen: serverTimestamp() }, { merge: true });
                    };
                    updateLastSeen();
                    const intervalId = setInterval(updateLastSeen, 300000); // Update every 5 minutes
                    return () => clearInterval(intervalId);
                }
            }, [user, isAuthReady, db, appId]);
        
            // Helper function to format lastSeen timestamp
            const formatLastSeen = (timestamp) => {
                if (!timestamp) return '';
                const date = timestamp.toDate();
                const now = new Date();
                const diffMinutes = (now.getTime() - date.getTime()) / 60000;
                
                if (diffMinutes < 5) {
                    return t.online;
                }
                
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                
                const isToday = now.getDate() === date.getDate() && now.getMonth() === date.getMonth() && now.getFullYear() === date.getFullYear();
                const isYesterday = yesterday.getDate() === date.getDate() && yesterday.getMonth() === date.getMonth() && yesterday.getFullYear() === date.getFullYear();
                
                const timeString = date.toLocaleTimeString(language === 'he' ? 'he-IL' : language, { hour: '2-digit', minute: '2-digit' });
                
                if (isToday) {
                    return `${t.lastSeen} ${t.today} ${timeString}`;
                } else if (isYesterday) {
                    return `${t.lastSeen} ${t.yesterday} ${timeString}`;
                } else {
                    return `${t.lastSeen} ${date.toLocaleDateString(language === 'he' ? 'he-IL' : language)} ${timeString}`;
                }
            };
        
            // useEffect to listen for user list and messages, dependent on user state
            useEffect(() => {
                if (!isAuthReady || !user) {
                    setMessages([]);
                    setUsers([]);
                    return;
                }
        
                const usersCollection = collection(db, `/artifacts/${appId}/public/data/users`);
                const unsubscribeUsers = onSnapshot(usersCollection, (snapshot) => {
                    const fetchedUsers = snapshot.docs.map(doc => doc.data());
                    setUsers(fetchedUsers);
                    const partner = fetchedUsers.find(u => u.uid === selectedChatPartner?.uid);
                    if (partner) {
                        setLastSeenStatus(formatLastSeen(partner.lastSeen));
                    }
                }, (error) => {
                    console.error("Error fetching users:", error);
                    setStatusMessage(`Error fetching users: ${error.message}`);
                });
        
                let unsubscribeMessages;
                let q;
        
                if (isPublicChat) {
                    const messagesCollection = collection(db, `/artifacts/${appId}/public/data/messages`);
                    q = query(messagesCollection, orderBy('timestamp'));
                    unsubscribeMessages = onSnapshot(q, (snapshot) => {
                        const fetchedMessages = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setMessages(fetchedMessages);
                    }, (error) => {
                        console.error("Error fetching messages:", error);
                        setStatusMessage(`Error fetching messages: ${error.message}`);
                    });
                } else if (selectedChatPartner) {
                    const chatId = [user.uid, selectedChatPartner.uid].sort().join('_');
                    const messagesCollection = collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
                    q = query(messagesCollection, orderBy('timestamp'));
                    unsubscribeMessages = onSnapshot(q, (snapshot) => {
                        const fetchedMessages = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setMessages(fetchedMessages);
                    }, (error) => {
                        console.error("Error fetching private messages:", error);
                        setStatusMessage(`Error fetching private messages: ${error.message}`);
                    });
                }
        
                return () => {
                    unsubscribeUsers();
                    if (unsubscribeMessages) {
                        unsubscribeMessages();
                    }
                };
            }, [isAuthReady, user, isPublicChat, selectedChatPartner, language, db, appId]);
        
            // useEffect for automatic chat scroll to the bottom
            useEffect(() => {
                if (messageContainerRef.current) {
                    messageContainerRef.current.scrollTop = messageContainerRef.current.scrollHeight;
                }
            }, [messages]);
        
            // Function to handle Gemini API call with exponential backoff
            const callGeminiAPI = async (payload) => {
                const apiKey = "AIzaSyDf9xhLDyJsvp1PYxk1TJDsfcCp824D5O8"; // API key is provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let retryCount = 0;
                const maxRetries = 5;
                const baseDelay = 1000; // 1 second

                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                return result.candidates[0].content.parts[0].text;
                            } else {
                                throw new Error('Invalid Gemini API response structure.');
                            }
                        } else if (response.status === 429) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                        } else {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error("API call failed:", error);
                        return null;
                    }
                }
                setStatusMessage('Failed to get a response from the AI after multiple retries.');
                return null;
            };

            // Function to generate a smart reply based on chat history
            const handleGenerateSmartReply = async () => {
                if (!user || messages.length === 0) return;
                setLoadingGemini(true);
                setStatusMessage(t.smartReplyLoading);

                const chatHistory = messages.slice(-5).map(msg => `${msg.senderDisplayName}: ${msg.text}`).join('\n');
                const prompt = `Given the following chat history, provide a concise and relevant reply. Do not respond with an entire conversation or a question. Respond in the same language as the chat history. The chat history is:\n\n${chatHistory}`;
                
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }]
                };

                const reply = await callGeminiAPI(payload);
                if (reply) {
                    setMessage(reply);
                    setStatusMessage('');
                } else {
                    setStatusMessage('Failed to generate a smart reply.');
                }
                setLoadingGemini(false);
            };

            // Function to rewrite the current message
            const handleGenerateSmartRewrite = async () => {
                if (!user || message.trim() === '') return;
                setLoadingGemini(true);
                setStatusMessage(t.smartRewriteLoading);

                const prompt = `Rewrite the following text in a more creative and engaging way. Do not add any new information. Just rephrase the given text. The text is:\n\n"${message}"`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }]
                };

                const rewrittenText = await callGeminiAPI(payload);
                if (rewrittenText) {
                    setMessage(rewrittenText);
                    setStatusMessage('');
                } else {
                    setStatusMessage('Failed to rewrite the message.');
                }
                setLoadingGemini(false);
            };
        
            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (message.trim() === '' || !user) {
                    return;
                }
        
                try {
                    if (editingMessage) {
                        let messageDocRef;
                        if (isPublicChat) {
                            messageDocRef = doc(db, `/artifacts/${appId}/public/data/messages`, editingMessage.id);
                        } else {
                            const chatId = [user.uid, selectedChatPartner.uid].sort().join('_');
                            messageDocRef = doc(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`, editingMessage.id);
                        }
                        await updateDoc(messageDocRef, {
                            text: message,
                            editedAt: serverTimestamp()
                        });
                        setEditingMessage(null);
                    } else {
                        const messagePayload = {
                            text: message,
                            senderUid: user.uid,
                            senderDisplayName: displayName,
                            timestamp: serverTimestamp(),
                        };
        
                        if (isPublicChat) {
                            await addDoc(collection(db, `/artifacts/${appId}/public/data/messages`), messagePayload);
                        } else {
                            const chatId = [user.uid, selectedChatPartner.uid].sort().join('_');
                            await setDoc(doc(db, `/artifacts/${appId}/public/data/chats/${chatId}`), {
                                participants: [user.uid, selectedChatPartner.uid],
                                lastActive: serverTimestamp()
                            }, { merge: true });
                            await addDoc(collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`), messagePayload);
                        }
                    }
                    setMessage('');
                } catch (error) {
                    console.error("Error sending/updating message:", error);
                    setStatusMessage(t.sendUpdateError);
                }
            };
        
            const handleEditMessage = (msg) => {
                if (user && msg.senderUid === user.uid) {
                    setMessage(msg.text);
                    setEditingMessage(msg);
                }
            };

            const handleRequestDelete = (msgId) => {
                setShowDeleteConfirm(true);
                setMessageToDelete(msgId);
            };

            const handleDeleteMessage = async () => {
                setShowDeleteConfirm(false);
                if (messageToDelete) {
                    try {
                        if (isPublicChat) {
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/messages`, messageToDelete));
                        } else {
                            const chatId = [user.uid, selectedChatPartner.uid].sort().join('_');
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`, messageToDelete));
                        }
                    } catch (error) {
                    console.error("Error deleting message:", error);
                    setStatusMessage(t.deleteError);
                    }
                }
                setMessageToDelete(null);
            };
        
            const handleSelectChatPartner = (chatPartner) => {
                setSelectedChatPartner(chatPartner);
                setIsPublicChat(false);
                setMessages([]);
                const partner = users.find(u => u.uid === chatPartner.uid);
                if(partner) {
                    setLastSeenStatus(formatLastSeen(partner.lastSeen));
                }
            };
        
            const handleLogout = async () => {
                setLoading(true);
                try {
                    await signOut(auth);
                    setDisplayName('');
                    setStatusMessage(t.logoutSuccess);
                    setSelectedChatPartner(null);
                    setIsPublicChat(true);
                } catch (error) {
                    console.error("Logout Error:", error);
                    setStatusMessage("Error logging out.");
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    setStatusMessage(t.loginSuccess);
                    setEmail('');
                    setPassword('');
                } catch (error) {
                    console.error("Login Error:", error);
                    setStatusMessage(t.loginError + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, userCredential.user.uid);
                    await setDoc(userDocRef, {
                        uid: userCredential.user.uid,
                        displayName: username,
                        createdAt: serverTimestamp(),
                    });
                    setStatusMessage(t.signupSuccess);
                    setEmail('');
                    setPassword('');
                    setUsername('');
                } catch (error) {
                    console.error("Signup Error:", error);
                    setStatusMessage(t.signupError + error.message);
                } finally {
                    setLoading(false);
                }
            };
        
            // Voice recording functionality
            const handleStartRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });
                    
                    const chunks = [];
                    recorder.ondataavailable = (e) => {
                        chunks.push(e.data);
                    };
                    
                    recorder.onstop = async () => {
                        const audioBlob = new Blob(chunks, { type: 'audio/webm; codecs=opus' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async () => {
                            const base64data = reader.result;
                            const messagePayload = {
                                audioData: base64data,
                                senderUid: user.uid,
                                senderDisplayName: displayName,
                                timestamp: serverTimestamp(),
                            };
                            
                            if (isPublicChat) {
                                await addDoc(collection(db, `/artifacts/${appId}/public/data/messages`), messagePayload);
                            } else {
                                const chatId = [user.uid, selectedChatPartner.uid].sort().join('_');
                                await setDoc(doc(db, `/artifacts/${appId}/public/data/chats/${chatId}`), {
                                    participants: [user.uid, selectedChatPartner.uid],
                                    lastActive: serverTimestamp()
                                }, { merge: true });
                                await addDoc(collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`), messagePayload);
                            }
                        };
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                    };
                    
                    recorder.start();
                    setAudioRecorder(recorder);
                    setIsRecording(true);
                    setAudioChunks([]);
                } catch (err) {
                    console.error('Error starting audio recording:', err);
                    setStatusMessage('Error starting audio recording. Please check microphone permissions.');
                }
            };
            
            const handleStopRecording = () => {
                if (audioRecorder) {
                    audioRecorder.stop();
                    setIsRecording(false);
                }
            };

            const renderDeleteConfirmModal = () => (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl p-6 shadow-2xl dark:bg-gray-800 text-center max-w-sm w-full">
                        <h3 className="text-xl font-bold mb-4">{t.deleteMessage}</h3>
                        <p className="text-gray-600 dark:text-gray-400 mb-6">{t.confirmDelete}</p>
                        <div className="flex justify-center space-x-4">
                            <button
                                onClick={() => {
                                    setShowDeleteConfirm(false);
                                    setMessageToDelete(null);
                                }}
                                className="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-400 transition-colors"
                            >
                                {t.cancel}
                            </button>
                            <button
                                onClick={handleDeleteMessage}
                                className="bg-red-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-red-600 transition-colors"
                            >
                                {t.ok}
                            </button>
                        </div>
                    </div>
                </div>
            );
        
            if (loading && !isAuthReady) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="text-xl font-bold">{t.loading}</div>
                    </div>
                );
            }
        
            if (!user) {
                return (
                    <div dir={isRTL ? "rtl" : "ltr"} className="flex flex-col items-center justify-center h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 transition-all duration-500">
                        <div className="w-full max-w-sm bg-white/50 backdrop-blur-xl rounded-3xl shadow-2xl p-8 dark:bg-gray-800/50 transition-all duration-300 transform hover:scale-105">
                            <h1 className="text-5xl font-extrabold text-center mb-6 text-gray-900 dark:text-white transition-colors duration-300">
                                {isLoginMode ? t.login : t.signup}
                            </h1>
                            <form onSubmit={isLoginMode ? handleLogin : handleSignup} className="space-y-6">
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder={t.email}
                                    className="w-full px-5 py-3 rounded-2xl bg-white/70 text-gray-800 border-2 border-transparent focus:outline-none focus:ring-4 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300 dark:bg-gray-700/70 dark:text-gray-200"
                                    required
                                />
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder={t.password}
                                    className="w-full px-5 py-3 rounded-2xl bg-white/70 text-gray-800 border-2 border-transparent focus:outline-none focus:ring-4 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300 dark:bg-gray-700/70 dark:text-gray-200"
                                    required
                                />
                                {!isLoginMode && (
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        placeholder={t.username}
                                        className="w-full px-5 py-3 rounded-2xl bg-white/70 text-gray-800 border-2 border-transparent focus:outline-none focus:ring-4 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300 dark:bg-gray-700/70 dark:text-gray-200"
                                        required
                                    />
                                )}
                                <button
                                    type="submit"
                                    className="w-full px-6 py-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-700 text-white font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300"
                                >
                                    {isLoginMode ? t.login : t.signup}
                                </button>
                            </form>
                            <div className="mt-6 text-center">
                                <p className="text-sm">
                                    {isLoginMode ? t.or : t.or}
                                    <button onClick={() => setIsLoginMode(!isLoginMode)} className="ml-2 text-purple-700 hover:underline">
                                        {isLoginMode ? t.toggleSignup : t.toggleLogin}
                                    </button>
                                </p>
                            </div>
                            {statusMessage && (
                                <div className="mt-6 p-4 rounded-xl text-center bg-white/70 text-gray-800 shadow-sm dark:bg-gray-700/70 dark:text-gray-200">
                                    {statusMessage}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
        
            return (
                <div dir={isRTL ? "rtl" : "ltr"} className="flex flex-col h-screen font-sans antialiased">
                    <div className="flex justify-end p-4 space-x-2 space-x-reverse">
                        <button onClick={() => setLanguage('he')} className={`px-4 py-2 rounded-full transition-colors duration-300 ${language === 'he' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'}`}>
                            עברית
                        </button>
                        <button onClick={() => setLanguage('en')} className={`px-4 py-2 rounded-full transition-colors duration-300 ${language === 'en' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'}`}>
                            English
                        </button>
                        <button onClick={() => setLanguage('fr')} className={`px-4 py-2 rounded-full transition-colors duration-300 ${language === 'fr' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'}`}>
                            Français
                        </button>
                        <button onClick={() => setLanguage('yi')} className={`px-4 py-2 rounded-full transition-colors duration-300 ${language === 'yi' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'}`}>
                            ייִדיש
                        </button>
                        <button onClick={() => setLanguage('de')} className={`px-4 py-2 rounded-full transition-colors duration-300 ${language === 'de' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'}`}>
                            Deutsch
                        </button>
                        <button onClick={() => setLanguage('nl')} className={`px-4 py-2 rounded-full transition-colors duration-300 ${language === 'nl' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'}`}>
                            Nederlands
                        </button>
                        {/* Dark mode toggle button */}
                        <button
                            onClick={() => setDarkMode(!darkMode)}
                            className="px-4 py-2 rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors duration-300 dark:bg-gray-700 dark:text-gray-200"
                        >
                            {darkMode ? (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                            ) : (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                            )}
                        </button>
                    </div>
                    <div className="flex-1 flex flex-col md:flex-row p-4 md:p-8 space-y-4 md:space-y-0 md:space-x-4 md:space-x-reverse">
                        {/* User list and status */}
                        <div className="w-full md:w-1/4 bg-white rounded-2xl shadow-lg p-6 flex flex-col space-y-4 dark:bg-gray-800">
                            <h2 className="text-2xl font-bold border-b border-gray-200 pb-2 mb-2 dark:border-gray-700">{t.connectedUsers}</h2>
                            {user && (
                                <div className="flex-1 overflow-y-auto space-y-2">
                                    <button
                                        onClick={() => { setIsPublicChat(true); setSelectedChatPartner(null); }}
                                        className={`w-full text-right p-3 rounded-xl transition-colors duration-300 ${isPublicChat ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600'}`}
                                    >
                                        {t.publicChat}
                                    </button>
                                    <h3 className="text-lg font-semibold mt-4 mb-2">{t.privateChats}</h3>
                                    {users.filter(u => u.uid !== user.uid).length > 0 ? (
                                        <ul className="space-y-2">
                                            {users.filter(u => u.uid !== user.uid).map((u) => (
                                                <li key={u.uid}>
                                                    <button
                                                        onClick={() => handleSelectChatPartner(u)}
                                                        className={`w-full text-right p-3 rounded-xl transition-colors duration-300 ${!isPublicChat && selectedChatPartner?.uid === u.uid ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600'}`}
                                                    >
                                                        {u.displayName}
                                                    </button>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <div className="text-gray-500">{t.noOtherUsers}</div>
                                    )}
                                </div>
                            )}
                            {user && (
                                <div className="border-t border-gray-200 pt-4 mt-4 dark:border-gray-700">
                                    <p className="text-sm">{t.connectedAs}<br/> <span className="font-bold">{displayName}</span></p>
                                    <p className="text-sm mt-1">{t.uid}<br/> <span className="font-mono text-xs break-all">{user.uid}</span></p>
                                </div>
                            )}
                        </div>
        
                        {/* Main chat area */}
                        <div className="w-full md:w-3/4 flex flex-col bg-white rounded-2xl shadow-lg p-6 dark:bg-gray-800">
                            <div className="text-center font-bold text-2xl border-b border-gray-200 pb-2 mb-4 dark:border-gray-700">
                                <div className="flex flex-col items-center">
                                    <span>{isPublicChat ? t.publicChat : `${t.chatWith} ${selectedChatPartner?.displayName}`}</span>
                                    {!isPublicChat && selectedChatPartner && lastSeenStatus && (
                                        <span className="text-sm font-normal text-gray-500 mt-1 dark:text-gray-400">
                                            {lastSeenStatus}
                                        </span>
                                    )}
                                </div>
                                {isPublicChat && (
                                    <button
                                        onClick={handleGenerateSmartReply}
                                        disabled={loadingGemini}
                                        className="bg-purple-500 text-white text-sm px-4 py-2 rounded-full ml-4 hover:bg-purple-600 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {t.generateSmartReply}
                                    </button>
                                )}
                            </div>
                            <div className="flex-1 overflow-y-auto space-y-4 mb-4" ref={messageContainerRef}>
                                {messages.length > 0 ? (
                                    messages.map((msg) => (
                                        <div
                                            key={msg.id}
                                            className={`flex flex-col ${msg.senderUid === user?.uid ? 'items-end' : 'items-start'}`}
                                        >
                                            <div
                                                className={`p-3 rounded-xl max-w-[80%] md:max-w-[60%] shadow-md ${
                                                    msg.senderUid === user?.uid
                                                        ? 'bg-blue-500 text-white rounded-br-none'
                                                        : 'bg-gray-200 text-gray-900 rounded-bl-none dark:bg-gray-700 dark:text-gray-200'
                                                }`}
                                            >
                                                <div className="font-bold text-sm mb-1">{msg.senderDisplayName}</div>
                                                {msg.text && <div>{msg.text}</div>}
                                                {msg.audioData && <audio controls src={msg.audioData} className="w-full"></audio>}
                                                <div className="text-xs mt-1 opacity-70">
                                                    {msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleString() : '...'}
                                                    {msg.editedAt && (
                                                        <span className="ml-2">{t.edited}</span>
                                                    )}
                                                </div>
                                                {user && msg.senderUid === user.uid && (
                                                    <div className="flex justify-end space-x-2 space-x-reverse mt-2">
                                                        <button
                                                            onClick={() => handleEditMessage(msg)}
                                                            className="text-xs text-gray-800 hover:text-yellow-400 dark:text-gray-200 dark:hover:text-yellow-300"
                                                        >
                                                            {t.edit}
                                                        </button>
                                                        <button
                                                            onClick={() => handleRequestDelete(msg.id)}
                                                            className="text-xs text-red-400 hover:text-red-600"
                                                        >
                                                            {t.delete}
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center text-gray-500">{t.startConversation}</div>
                                )}
                            </div>
        
                            {user && (
                                <div className="flex space-x-2 space-x-reverse mt-auto">
                                    {isRecording ? (
                                        <button
                                            onClick={handleStopRecording}
                                            className="bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition-colors duration-300 shadow-md transform hover:scale-105"
                                            aria-label="Stop Recording"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <path d="M9 12h6"></path>
                                                <path d="M12 9v6"></path>
                                            </svg>
                                        </button>
                                    ) : (
                                        <form onSubmit={handleSendMessage} className="flex flex-1 space-x-2 space-x-reverse">
                                            <input
                                                type="text"
                                                value={message}
                                                onChange={(e) => setMessage(e.target.value)}
                                                placeholder={editingMessage ? t.editMessagePlaceholder : t.typeMessagePlaceholder}
                                                className="flex-1 p-3 rounded-full bg-gray-200 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 dark:bg-gray-700 dark:text-gray-200"
                                            />
                                            <button
                                                type="button"
                                                onClick={handleGenerateSmartRewrite}
                                                disabled={loadingGemini}
                                                className="bg-purple-500 text-white p-3 rounded-full hover:bg-purple-600 transition-colors duration-300 shadow-md transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                                aria-label={t.generateSmartRewrite}
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5A5.5 5.5 0 0 1 7.5 3c1.74 0 3.41.81 4.5 2.09A5.5 5.5 0 0 1 16.5 3c3.03 0 5.5 2.47 5.5 5.5 0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                                                </svg>
                                            </button>
                                            <button
                                                type="submit"
                                                className="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 transition-colors duration-300 shadow-md transform hover:scale-105"
                                                aria-label={t.sendMessage}
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    className="h-6 w-6"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    strokeWidth="2"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                >
                                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                                </svg>
                                            </button>
                                            <button
                                                type="button"
                                                onClick={handleStartRecording}
                                                className="bg-green-500 text-white p-3 rounded-full hover:bg-green-600 transition-colors duration-300 shadow-md transform hover:scale-105"
                                                aria-label="Start Recording"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
                                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                                    <line x1="12" y1="19" x2="12" y2="22"></line>
                                                </svg>
                                            </button>
                                            <button
                                                onClick={handleLogout}
                                                type="button"
                                                className="bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition-colors duration-300 shadow-md transform hover:scale-105"
                                                aria-label={t.logout}
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                                    <polyline points="16 17 21 12 16 7"></polyline>
                                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                                </svg>
                                            </button>
                                        </form>
                                    )}
                                </div>
                            )}
                            {statusMessage && (
                                <div className="mt-4 p-3 rounded-xl text-center bg-gray-200 text-gray-800 shadow-sm dark:bg-gray-700 dark:text-gray-200">
                                    {statusMessage}
                                </div>
                            )}
                        </div>
                    </div>
                    {showDeleteConfirm && renderDeleteConfirmModal()}
                </div>
            );
        };
        
        // Render the App component to the 'root' div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
