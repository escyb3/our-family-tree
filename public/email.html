public/email.html
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוא"ל פנימי</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 256px;
            background-color: #ffffff;
            padding: 1rem;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            border-top-right-radius: 1rem;
            border-bottom-right-radius: 1rem;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        .view-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        [dir="rtl"] .space-x-reverse > * + * {
            margin-left: 0;
            margin-right: 0.5rem;
        }
        [dir="rtl"] .space-x-reverse > *:not(:last-child) {
            margin-left: 0.5rem;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp
        };
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 font-sans" dir="rtl">
    <!-- Main Application Container -->
    <div id="app-container" class="container">
        <!-- Loader Screen (initial state) -->
        <div id="loader-view" class="flex items-center justify-center min-h-screen w-full">
            <svg class="animate-spin text-blue-500 w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <!-- Login View -->
        <div id="login-view" class="hidden flex items-center justify-center min-h-screen w-full p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                <div class="flex justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail text-blue-500"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                </div>
                <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">ברוכים הבאים</h1>
                <p class="text-center text-gray-600 mb-6">הכנס שם משתמש כדי לנהל את תיבת הדואר המשפחתית שלך.</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username-input" class="block text-sm font-medium text-gray-700">שם משתמש</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input
                                id="username-input"
                                name="username"
                                type="text"
                                class="flex-1 block w-full rounded-md sm:text-sm border-gray-300 focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-3"
                                placeholder="לדוגמה: יונתן"
                                required
                            />
                            <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                                @family.local
                            </span>
                        </div>
                    </div>
                    <button
                        type="submit"
                        id="login-button"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        התחבר
                    </button>
                </form>
                <p id="login-status-message" class="mt-4 text-center text-sm font-medium text-red-500"></p>
            </div>
        </div>

        <!-- Mailbox View -->
        <div id="mailbox-view" class="hidden container">
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar">
                <div class="flex items-center space-x-2 mb-8" dir="ltr">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail text-blue-500"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                    <span class="text-2xl font-bold text-gray-800">דוא"ל פנימי</span>
                </div>
                <button id="lang-toggle-button" class="flex items-center w-full px-4 py-2 rounded-md transition duration-150 ease-in-out text-gray-600 hover:bg-gray-100 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe ml-2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                    <span>English</span>
                </button>
                <p id="user-info" class="text-sm font-medium text-gray-600 mb-2"></p>
                <p id="email-info" class="text-xs text-gray-500 mb-2"></p>
                <p id="user-id-info" class="text-sm font-mono text-gray-700 mb-6"></p>

                <nav class="space-y-2 flex-1">
                    <button id="new-email-button" class="flex items-center w-full px-4 py-2 rounded-md transition duration-150 ease-in-out bg-blue-500 text-white font-semibold hover:bg-blue-600 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit ml-2"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        <span>הודעה חדשה</span>
                    </button>
                    <button id="inbox-button" class="flex items-center w-full px-4 py-2 rounded-md transition duration-150 ease-in-out bg-blue-100 text-blue-600 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-inbox ml-2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                        <span>דואר נכנס (<span id="inbox-count">0</span>)</span>
                    </button>
                    <button id="sent-button" class="flex items-center w-full px-4 py-2 rounded-md transition duration-150 ease-in-out text-gray-600 hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send ml-2"><path d="m22 2-7 19-3-9-9-3 19-7Z"/><path d="M11 11l-3 3"/></svg>
                        <span>נשלח (<span id="sent-count">0</span>)</span>
                    </button>
                </nav>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
                <div id="content-container" class="view-container">
                    <!-- Views will be dynamically rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // אובייקט עם כל הטקסטים בממשק בשתי שפות
        const lang = {
            he: {
                appName: "דוא\"ל פנימי",
                loginWelcome: "ברוכים הבאים",
                loginMessage: "הכנס שם משתמש כדי לנהל את תיבת הדואר המשפחתית שלך.",
                usernameLabel: "שם משתמש",
                usernamePlaceholder: "לדוגמה: יונתן",
                loginButton: "התחבר",
                loginStatusConnecting: "מתחבר...",
                loginError: "שגיאה בהתחברות. אנא נסה שוב.",
                sidebarWelcome: "ברוך הבא, ",
                yourEmail: "כתובת המייל שלך:",
                userId: "מזהה משתמש:",
                newEmailButton: "הודעה חדשה",
                inboxFolder: "דואר נכנס",
                sentFolder: "נשלח",
                searchPlaceholder: "חיפוש מיילים...",
                noEmailsFound: "לא נמצאו הודעות תואמות.",
                emailSubjectPlaceholder: "(ללא נושא)",
                composeTitle: "אימייל חדש",
                recipientLabel: "אל",
                composeBack: "חזרה לתיבת הדואר",
                subjectLabel: "נושא",
                bodyLabel: "הודעה",
                sendButton: "שלח",
                sendSuccess: "ההודעה נשלחה בהצלחה!",
                sendError: "שגיאה בשליחת ההודעה. אנא נסה שוב.",
                composeGeminiTitle: "צור טיוטה בעזרת Gemini AI",
                geminiPlaceholder: "לדוגמה: כתוב מייל קצר כדי להתנצל על איחור.",
                geminiButton: "צור טיוטה",
                geminiError: "אירעה שגיאה. אנא נסה שוב מאוחר יותר.",
                emailFrom: "מאת:",
                emailTo: "אל:",
                emailReply: "השב",
                emailBack: "חזרה",
                loading: "טוען...",
                noMessagesInFolder: "אין הודעות בתיקיה זו.",
                richTextNote: "הטקסט נשלח כ-HTML כדי לשמור על העיצוב. שימו לב: צירוף קבצים אינו נתמך כרגע ביישום.",
                editorToolbar: "סרגל עריכת טקסט"
            },
            en: {
                appName: "Internal Mail",
                loginWelcome: "Welcome",
                loginMessage: "Enter a username to manage your family's mailbox.",
                usernameLabel: "Username",
                usernamePlaceholder: "e.g., Jonathan",
                loginButton: "Login",
                loginStatusConnecting: "Connecting...",
                loginError: "Login error. Please try again.",
                sidebarWelcome: "Welcome, ",
                yourEmail: "Your email address:",
                userId: "User ID:",
                newEmailButton: "New Message",
                inboxFolder: "Inbox",
                sentFolder: "Sent",
                searchPlaceholder: "Search emails...",
                noEmailsFound: "No matching messages found.",
                emailSubjectPlaceholder: "(No Subject)",
                composeTitle: "New Email",
                recipientLabel: "To",
                composeBack: "Back to Mailbox",
                subjectLabel: "Subject",
                bodyLabel: "Message",
                sendButton: "Send",
                sendSuccess: "Message sent successfully!",
                sendError: "Error sending message. Please try again.",
                composeGeminiTitle: "Draft with Gemini AI",
                geminiPlaceholder: "e.g., Write a short email to apologize for being late.",
                geminiButton: "Draft",
                geminiError: "An error occurred. Please try again later.",
                emailFrom: "From:",
                emailTo: "To:",
                emailReply: "Reply",
                emailBack: "Back",
                loading: "Loading...",
                noMessagesInFolder: "No messages in this folder.",
                richTextNote: "The text is sent as HTML to preserve formatting. Note: File attachments are currently not supported in this app.",
                editorToolbar: "Text Editor Toolbar"
            }
        };

        // References to DOM elements
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const mailboxView = document.getElementById('mailbox-view');
        const loaderView = document.getElementById('loader-view');
        const contentContainer = document.getElementById('content-container');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const loginStatusMessage = document.getElementById('login-status-message');
        const userInfo = document.getElementById('user-info');
        const emailInfo = document.getElementById('email-info');
        const userIdInfo = document.getElementById('user-id-info');
        const inboxButton = document.getElementById('inbox-button');
        const sentButton = document.getElementById('sent-button');
        const newEmailButton = document.getElementById('new-email-button');
        const inboxCountSpan = document.getElementById('inbox-count');
        const sentCountSpan = document.getElementById('sent-count');
        const langToggleButton = document.getElementById('lang-toggle-button');

        // Application state
        let state = {
            currentView: 'loader',
            language: 'he',
            username: '',
            emailAddress: '',
            userId: '',
            inboxEmails: [],
            sentEmails: [],
            currentFolder: 'inbox',
            selectedEmail: null
        };
        
        let db, auth;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const initFirebase = async () => {
            const { initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } = firebase;
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = firebase.getFirestore(app);

            // Listen for auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.userId = user.uid;
                    // Start listening for emails only after auth is ready
                    listenForEmails();
                }
            });
            // Initial auth check
            const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialToken) {
                await signInWithCustomToken(auth, initialToken);
            } else {
                await signInAnonymously(auth);
            }

            state.currentView = 'login';
            renderView();
        };

        const listenForEmails = () => {
            if (!state.emailAddress) return;

            const inboxQuery = firebase.query(
                firebase.collection(db, `artifacts/${appId}/public/data/emails`),
                firebase.where('recipient', '==', state.emailAddress)
            );

            firebase.onSnapshot(inboxQuery, (snapshot) => {
                state.inboxEmails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.inboxEmails.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                inboxCountSpan.textContent = state.inboxEmails.length;
                renderView();
            });

            const sentQuery = firebase.query(
                firebase.collection(db, `artifacts/${appId}/public/data/emails`),
                firebase.where('sender', '==', state.emailAddress)
            );

            firebase.onSnapshot(sentQuery, (snapshot) => {
                state.sentEmails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.sentEmails.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                sentCountSpan.textContent = state.sentEmails.length;
                renderView();
            });
        };

        // Handle login form submission
        const handleLogin = async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (!username) return;

            state.username = username;
            state.emailAddress = `${username}@family.local`;
            loginStatusMessage.textContent = lang[state.language].loginStatusConnecting;
            loginForm.querySelector('button').disabled = true;

            try {
                // Auth is already handled by the onAuthStateChanged listener and init
                // We just need to wait for it to be ready
                const unsubscribe = firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        unsubscribe(); // Stop listening once we have a user
                        state.userId = user.uid;
                        state.currentView = 'mailbox';
                        renderView();
                    }
                });
            } catch (error) {
                console.error("Login error:", error);
                loginStatusMessage.textContent = lang[state.language].loginError;
            } finally {
                loginForm.querySelector('button').disabled = false;
            }
        };

        // Render functions based on state
        const renderView = () => {
            // Hide all views first
            loaderView.classList.add('hidden');
            loginView.classList.add('hidden');
            mailboxView.classList.add('hidden');

            switch (state.currentView) {
                case 'loader':
                    loaderView.classList.remove('hidden');
                    break;
                case 'login':
                    loginView.classList.remove('hidden');
                    loginStatusMessage.textContent = '';
                    break;
                case 'mailbox':
                    mailboxView.classList.remove('hidden');
                    updateSidebar();
                    renderMainContent();
                    break;
            }
            // Update icons after rendering
            lucide.createIcons();
            document.body.dir = state.language === 'he' ? 'rtl' : 'ltr';
        };

        const updateSidebar = () => {
            const t = lang[state.language];
            userInfo.textContent = `${t.sidebarWelcome}${state.username}!`;
            emailInfo.textContent = `${t.yourEmail} ${state.emailAddress}`;
            userIdInfo.textContent = `${t.userId} ${state.userId}`;
            inboxButton.querySelector('span').textContent = `${t.inboxFolder} (${state.inboxEmails.length})`;
            sentButton.querySelector('span').textContent = `${t.sentFolder} (${state.sentEmails.length})`;
            newEmailButton.querySelector('span').textContent = t.newEmailButton;
            langToggleButton.querySelector('span').textContent = state.language === 'he' ? 'English' : 'עברית';
            
            inboxButton.className = `flex items-center w-full px-4 py-2 rounded-md transition duration-150 ease-in-out ${state.currentFolder === 'inbox' ? 'bg-blue-100 text-blue-600 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`;
            sentButton.className = `flex items-center w-full px-4 py-2 rounded-md transition duration-150 ease-in-out ${state.currentFolder === 'sent' ? 'bg-blue-100 text-blue-600 font-semibold' : 'text-gray-600 hover:bg-gray-100'}`;
        };

        const renderMainContent = () => {
            const t = lang[state.language];
            let contentHTML = '';

            if (state.selectedEmail) {
                // Render email view
                contentHTML = `
                    <div class="p-4 flex flex-col h-full bg-white rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-800">${state.selectedEmail.subject}</h2>
                            <div class="flex space-x-2 space-x-reverse">
                                <button id="reply-button" class="flex items-center px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition duration-150 ease-in-out">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-corner-up-left ml-2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7.5a4.5 4.5 0 0 0-4.5-4.5H4"/></svg>
                                    <span>${t.emailReply}</span>
                                </button>
                                <button id="back-to-list-button" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300 transition duration-150 ease-in-out">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home ml-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    <span>${t.emailBack}</span>
                                </button>
                            </div>
                        </div>
                        <div class="mb-4 text-sm text-gray-600">
                            <span class="font-semibold text-gray-800">${t.emailFrom}</span> ${state.selectedEmail.sender}
                            <br/>
                            <span class="font-semibold text-gray-800">${t.emailTo}</span> ${state.selectedEmail.recipient}
                        </div>
                        <div class="text-gray-700 flex-1 overflow-y-auto">
                            <div class="whitespace-pre-wrap">${state.selectedEmail.body}</div>
                        </div>
                    </div>
                `;
            } else if (state.currentView === 'compose') {
                // Render compose view
                contentHTML = `
                    <div class="p-4 flex flex-col h-full bg-white rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-800">${t.composeTitle}</h2>
                            <button id="back-to-mailbox" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300 transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home ml-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                <span>${t.composeBack}</span>
                            </button>
                        </div>
                        <form id="compose-form" class="flex-1 flex flex-col space-y-4">
                            <div>
                                <label for="recipient-input" class="block text-sm font-medium text-gray-700">${t.recipientLabel}</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input id="recipient-input" name="recipient" type="text" class="flex-1 block w-full rounded-md sm:text-sm border-gray-300 focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2" placeholder="${t.usernamePlaceholder}" required />
                                    <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">@family.local</span>
                                </div>
                            </div>
                            <div>
                                <label for="subject-input" class="block text-sm font-medium text-gray-700">${t.subjectLabel}</label>
                                <input id="subject-input" name="subject" type="text" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm border-gray-300 focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2" />
                            </div>
                            <div class="flex flex-col flex-1">
                                <label for="rich-text-editor" class="block text-sm font-medium text-gray-700">${t.bodyLabel}</label>
                                <!-- Text editor toolbar -->
                                <div class="flex items-center space-x-2 space-x-reverse border-b border-gray-300 bg-gray-50 p-2 rounded-t-md">
                                    <button type="button" class="p-2 rounded-md hover:bg-gray-200 transition duration-150 ease-in-out" title="Bold" onclick="applyFormatting('bold')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold text-gray-700"><path d="M14 12a4 4 0 0 0 0-8H6v8"/><path d="M15 20a4 4 0 0 0 0-8H6v8Z"/></svg>
                                    </button>
                                    <button type="button" class="p-2 rounded-md hover:bg-gray-200 transition duration-150 ease-in-out" title="Italic" onclick="applyFormatting('italic')">
                                        <line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/>
                                    </svg>
                                    </button>
                                    <button type="button" class="p-2 rounded-md hover:bg-gray-200 transition duration-150 ease-in-out" title="Underline" onclick="applyFormatting('underline')">
                                        <path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/>
                                    </svg>
                                    </button>
                                </div>
                                <!-- Editable text area -->
                                <div id="rich-text-editor" contentEditable="true" class="mt-0 block w-full rounded-b-md shadow-sm sm:text-sm border border-gray-300 focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2 h-32 overflow-y-auto focus:outline-none"></div>
                                <p class="text-xs text-gray-500 mt-2">${t.richTextNote}</p>
                            </div>
                            <!-- Gemini AI Draft -->
                            <div class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-md font-bold text-gray-800">${t.composeGeminiTitle}</h3>
                                <div class="flex space-x-2 space-x-reverse">
                                    <input id="gemini-prompt-input" type="text" placeholder="${t.geminiPlaceholder}" class="flex-1 block w-full rounded-md shadow-sm sm:text-sm border-gray-300 focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2" />
                                    <button type="button" id="gemini-generate-button" class="px-4 py-2 bg-purple-500 text-white rounded-md shadow-sm hover:bg-purple-600 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                        <span id="gemini-button-text">${t.geminiButton}</span>
                                        <svg id="gemini-loader" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    </button>
                                </div>
                                <p id="gemini-status-message" class="hidden text-red-500 text-sm mt-2"></p>
                            </div>
                            <button id="send-email-button" type="submit" class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                                <span id="send-button-text">${t.sendButton}</span>
                                <svg id="send-loader" class="hidden animate-spin h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <p id="send-status-message" class="mt-4 text-center text-sm font-medium text-green-500 hidden"></p>
                        </form>
                    </div>
                `;
            } else {
                // Render email list view (inbox/sent)
                const emails = state.currentFolder === 'inbox' ? state.inboxEmails : state.sentEmails;
                const filteredEmails = emails.filter(email => {
                    const query = (document.getElementById('search-input')?.value || '').toLowerCase();
                    return email.subject?.toLowerCase().includes(query) ||
                           email.sender?.toLowerCase().includes(query) ||
                           email.body?.toLowerCase().includes(query);
                });

                contentHTML = `
                    <div class="p-4 flex flex-col h-full overflow-y-auto">
                        <div class="relative mb-4">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search text-gray-400"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            </div>
                            <input
                                type="text"
                                id="search-input"
                                placeholder="${t.searchPlaceholder}"
                                class="block w-full rounded-md border-gray-300 pr-10 focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2"
                            />
                        </div>
                        <div id="email-list" class="flex-1 space-y-2 overflow-y-auto">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">${t[state.currentFolder + 'Folder']}</h2>
                            ${filteredEmails.length > 0 ? filteredEmails.map(email => `
                                <div class="email-item flex flex-col p-4 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition duration-150 ease-in-out shadow-sm" data-email-id="${email.id}">
                                    <div class="flex justify-between items-center text-sm mb-1">
                                        <span class="font-semibold text-gray-800">${email.sender}</span>
                                        <span class="text-gray-500 text-xs">${new Date(email.timestamp?.seconds * 1000).toLocaleString(state.language === 'he' ? 'he-IL' : 'en-US', { dateStyle: 'short', timeStyle: 'short' })}</span>
                                    </div>
                                    <div class="text-sm font-medium text-gray-700 truncate">${email.subject}</div>
                                </div>
                            `).join('') : `<p class="text-center text-gray-500 mt-8">${t.noMessagesInFolder}</p>`}
                        </div>
                    </div>
                `;
            }
            contentContainer.innerHTML = contentHTML;
            attachEventListeners();
        };

        const attachEventListeners = () => {
            if (state.selectedEmail) {
                document.getElementById('reply-button')?.addEventListener('click', () => {
                    state.currentView = 'compose';
                    renderView();
                    document.getElementById('recipient-input').value = state.selectedEmail.sender.split('@')[0];
                    document.getElementById('subject-input').value = `Re: ${state.selectedEmail.subject}`;
                    document.getElementById('rich-text-editor').innerHTML = ''; // Clear for new reply
                });
                document.getElementById('back-to-list-button')?.addEventListener('click', () => {
                    state.selectedEmail = null;
                    renderView();
                });
            } else if (state.currentView === 'compose') {
                document.getElementById('back-to-mailbox')?.addEventListener('click', () => {
                    state.currentView = 'mailbox';
                    renderView();
                });
                document.getElementById('compose-form')?.addEventListener('submit', handleSendEmail);
                document.getElementById('gemini-generate-button')?.addEventListener('click', handleGeminiGenerate);
            } else {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', () => renderMainContent());
                }
                document.querySelectorAll('.email-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const emailId = e.currentTarget.dataset.emailId;
                        state.selectedEmail = (state.currentFolder === 'inbox' ? state.inboxEmails : state.sentEmails).find(email => email.id === emailId);
                        renderView();
                    });
                });
            }
        };

        const handleSendEmail = async (e) => {
            e.preventDefault();
            const t = lang[state.language];
            const recipient = document.getElementById('recipient-input').value.trim();
            const subject = document.getElementById('subject-input').value.trim() || t.emailSubjectPlaceholder;
            const body = document.getElementById('rich-text-editor').innerHTML;

            const sendButton = document.getElementById('send-email-button');
            const sendButtonText = document.getElementById('send-button-text');
            const sendLoader = document.getElementById('send-loader');
            const statusMessage = document.getElementById('send-status-message');

            sendButton.disabled = true;
            sendButtonText.classList.add('hidden');
            sendLoader.classList.remove('hidden');

            try {
                const newEmail = {
                    sender: state.emailAddress,
                    recipient: `${recipient}@family.local`,
                    subject: subject,
                    body: body,
                    timestamp: firebase.serverTimestamp(),
                };
                
                await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/emails`), newEmail);
                
                statusMessage.textContent = t.sendSuccess;
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-red-500');
                statusMessage.classList.add('text-green-500');

                // Clear form
                document.getElementById('recipient-input').value = '';
                document.getElementById('subject-input').value = '';
                document.getElementById('rich-text-editor').innerHTML = '';

                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                    state.currentView = 'mailbox';
                    renderView();
                }, 2000);

            } catch (error) {
                console.error("Error sending email:", error);
                statusMessage.textContent = t.sendError;
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('text-red-500');
                statusMessage.classList.remove('text-green-500');
            } finally {
                sendButton.disabled = false;
                sendButtonText.classList.remove('hidden');
                sendLoader.classList.add('hidden');
            }
        };

        const handleGeminiGenerate = async () => {
            const t = lang[state.language];
            const promptInput = document.getElementById('gemini-prompt-input');
            const prompt = promptInput.value.trim();
            if (!prompt) return;
            
            const geminiButton = document.getElementById('gemini-generate-button');
            const geminiButtonText = document.getElementById('gemini-button-text');
            const geminiLoader = document.getElementById('gemini-loader');
            const geminiStatusMessage = document.getElementById('gemini-status-message');
            const richTextEditor = document.getElementById('rich-text-editor');

            geminiButton.disabled = true;
            geminiButtonText.classList.add('hidden');
            geminiLoader.classList.remove('hidden');
            geminiStatusMessage.classList.add('hidden');

            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (generatedText) {
                            richTextEditor.innerHTML = generatedText.replace(/\n/g, '<br/>');
                        } else {
                            geminiStatusMessage.textContent = t.geminiError;
                            geminiStatusMessage.classList.remove('hidden');
                            console.error('Gemini API response was missing text.');
                        }
                        break;
                    } else {
                        console.error(`Gemini API error: ${response.status}`);
                        retries++;
                        const delay = initialDelay * Math.pow(2, retries - 1);
                        await new Promise(res => setTimeout(res, delay));
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    retries++;
                    const delay = initialDelay * Math.pow(2, retries - 1);
                    await new Promise(res => setTimeout(res, delay));
                }
            }

            if (retries === maxRetries) {
                geminiStatusMessage.textContent = t.geminiError;
                geminiStatusMessage.classList.remove('hidden');
            }

            geminiButton.disabled = false;
            geminiButtonText.classList.remove('hidden');
            geminiLoader.classList.add('hidden');
        };

        // Text formatting function
        const applyFormatting = (command) => {
            const richTextEditor = document.getElementById('rich-text-editor');
            if (richTextEditor) {
                document.execCommand(command, false, null);
                richTextEditor.focus();
            }
        };

        // Event Listeners for main buttons
        loginForm.addEventListener('submit', handleLogin);
        inboxButton.addEventListener('click', () => { state.currentFolder = 'inbox'; state.selectedEmail = null; renderView(); });
        sentButton.addEventListener('click', () => { state.currentFolder = 'sent'; state.selectedEmail = null; renderView(); });
        newEmailButton.addEventListener('click', () => { state.currentView = 'compose'; state.selectedEmail = null; renderView(); });
        langToggleButton.addEventListener('click', () => {
            state.language = state.language === 'he' ? 'en' : 'he';
            document.body.dir = state.language === 'he' ? 'rtl' : 'ltr';
            renderView();
        });

        // Initial app load
        window.onload = initFirebase;
    </script>
</body>
</html>
