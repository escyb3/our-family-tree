<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title-display">ğŸ“Š×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</title>
    
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Heebo Font link -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ×”×’×“×¨×ª ×”×¤×•× ×˜ ×”×¨××©×™ ×œ×›×œ ×”×“×£ */
        body { font-family: 'Heebo', sans-serif; }
        /* ×›×“×™ ×©×”×ª×¨×©×™××™× ×™×”×™×• ×¨×¡×¤×•× ×¡×™×‘×™×™× ×‘×ª×•×š ×”×›×¨×˜×™×¡×™× */
        canvas { max-width: 100%; height: auto; }
        /* ×¡×’× ×•×Ÿ ×›×œ×œ×™ ×œ×ª×•×•×™×•×ª ×”×ª×¨×©×™××™× */
        .chartjs-tooltip-key { 
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-left: 5px;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    
    <!-- ××–×•×¨ ×›×•×ª×¨×ª ×“×‘×™×§ (Sticky Header) ×•×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×©×¤×” -->
    <div class="sticky top-0 bg-gray-50 z-10 p-4 pt-8 md:pt-10 shadow-md sm:shadow-none">
        <div class="max-w-6xl mx-auto flex justify-between items-start">
            
            <!-- ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×©×¤×” (××©×××œ ×‘-RTL) -->
            <button id="lang-toggle-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1.5 px-4 rounded-lg shadow-md transition duration-300 text-sm order-2 sm:order-1">
                English
            </button>
            
            <!-- ×›×•×ª×¨×ª ×¨××©×™×ª ×•×”×•×“×¢×ª ×¡×˜×˜×•×¡ -->
            <header class="flex-grow text-center order-1 sm:order-2 mb-8 sm:mb-0">
                <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-l from-blue-700 to-indigo-600 mb-2 flex items-center justify-center gap-3 transition duration-500">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
                    </svg>
                    <span id="main-title-text" class="text-right">×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</span>
                </h1>
                <p class="status-message text-lg text-gray-600 font-medium mt-1" id="family-info" dir="rtl">×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...</p>
            </header>
            <div class="w-16 order-3 hidden sm:block"></div> <!-- Spacer to balance the button on wider screens -->
        </div>
    </div>

    
    <div class="max-w-6xl mx-auto mt-4">

        <!-- ××¡×š ×˜×¢×™× ×” -->
        <div id="loading" class="flex flex-col justify-center items-center h-40">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
            <span class="text-xl text-gray-700 mt-4" id="loading-text">×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.</span>
        </div>
        
        <!-- ×ª×•×›×Ÿ ×¨××©×™: ×™×•×¦×’ ×œ××—×¨ ×”×˜×¢×™× ×” -->
        <div id="main-content" class="space-y-10 transition duration-500 ease-in-out transform" style="display: none;">
            
            <!-- ×©×•×¨×” 1: ××’×“×¨ ×•×“×•×¨×•×ª (×¦×‘×¢×™ ×“××•×’×¨×¤×™×” - ×›×—×•×œ/×¡×’×•×œ) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ××’×“×¨ -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-indigo-200">
                    <h2 id="chartGenderTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-blue-500 pb-2">
                        ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)
                    </h2>
                    <canvas id="genderChart"></canvas>
                </div>
                
                <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ×“×•×¨×•×ª -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-indigo-200">
                    <h2 id="chartGenerationTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-indigo-500 pb-2">
                        ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)
                    </h2>
                    <canvas id="generationChart"></canvas>
                </div>
            </div>
            
            <!-- ×©×•×¨×” 2: ××•×¨×š ×—×™×™× ×××•×¦×¢ ×•×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨ (×¦×‘×¢×™ ×–××Ÿ/××—×–×•×¨ ×—×™×™× - ×™×¨×•×§/×›×ª×•×) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ××•×¨×š ×—×™×™× -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-emerald-200">
                    <h2 id="chartLifeExpectancyTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-emerald-500 pb-2">
                        ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)
                    </h2>
                    <canvas id="lifeExpectancyChart"></canvas>
                </div>

                <!-- ×›×¨×˜×™×¡ ××’××ª ×œ×™×“×•×ª -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-amber-200">
                    <h2 id="chartBirthTrendTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-amber-500 pb-2">
                        ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨
                    </h2>
                    <canvas id="birthTrendChart"></canvas>
                </div>
            </div>
            
            <!-- ×©×•×¨×” 3: ×××•×¦×¢ ×™×œ×“×™× ×•×”×ª×¤×œ×’×•×ª ×’×™×œ××™× (×¦×‘×¢×™ ××©×¤×—×”/××‘× ×” - ××“×•×/×¡×’×•×œ) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ×™×œ×“×™× -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-red-200">
                    <h2 id="chartAvgChildrenTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-red-500 pb-2">
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)
                        <span id="adults-note" class="text-sm font-normal text-gray-500 mr-2">(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)</span>
                    </h2>
                    <canvas id="avgChildrenChart"></canvas>
                </div>
                
                <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-purple-200">
                    <h2 id="chartAgeDistributionTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-purple-500 pb-2">
                        ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª
                    </h2>
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>

            <!-- ×©×•×¨×” 4: ××¦×‘ ××©×¤×—×ª×™ ×•×©××•×ª × ×¤×•×¦×™× (×¦×‘×¢×™ ×¤×¨×˜/×–×•×’×™×•×ª - ×•×¨×•×“/××™× ×“×™×’×•) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ××¦×‘ ××©×¤×—×ª×™ (×—×“×©) -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-pink-200">
                    <h2 id="chartMaritalStatusTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-pink-500 pb-2">
                        ğŸ’ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××¦×‘ ××©×¤×—×ª×™
                    </h2>
                    <canvas id="maritalStatusChart"></canvas>
                </div>

                <!-- ×›×¨×˜×™×¡ 10 ×”×©××•×ª ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨ (×—×“×©) -->
                <div class="chart-container bg-white p-6 rounded-2xl shadow-xl border border-gray-50 transition duration-300 hover:shadow-2xl hover:ring-2 hover:ring-indigo-200">
                    <h2 id="chartMostCommonNamesTitle" class="text-2xl font-extrabold text-gray-800 mb-6 border-b-4 border-opacity-70 border-indigo-600 pb-2">
                        ğŸ“› 10 ×”×©××•×ª ×”×¤×¨×˜×™×™× ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨
                    </h2>
                    <canvas id="mostCommonNamesChart"></canvas>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // --- ×”×’×“×¨×•×ª ×•×©×¤×ª ×××©×§ ---
        let currentLang = 'HE'; // ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ: ×¢×‘×¨×™×ª
        let cleanedData = []; // ××—×¡×•×Ÿ ×”× ×ª×•× ×™× ×”×× ×•×§×™×
        
        // ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª ×œ×ª×¨×©×™××™ Chart.js (××¨××” × ×§×™ ×•××•×“×¨× ×™)
        const CHART_GLOBAL_OPTIONS = {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
                duration: 800, // ×× ×™××¦×™×” ×—×œ×§×” ×™×•×ª×¨
                easing: 'easeInOutQuad'
            },
            layout: {
                padding: { top: 10 }
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { 
                    rtl: true, 
                    backgroundColor: 'rgba(30, 41, 59, 0.9)', // ×›×—×•×œ ×›×”×” (Slate)
                    titleFont: { weight: 'bold' },
                    bodyFont: { weight: 'normal' },
                    padding: 12,
                    displayColors: true,
                },
            },
            scales: {
                y: {
                    grid: { color: 'rgba(200, 200, 200, 0.2)', drawBorder: false },
                    ticks: { color: '#6b7280' }
                },
                x: {
                    grid: { color: 'rgba(200, 200, 200, 0.2)', drawBorder: false },
                    ticks: { color: '#6b7280' }
                }
            }
        };

        const translations = {
            'HE': {
                // ×›×•×ª×¨×•×ª
                'pageTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
                'mainTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
                'statusLoading': '×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...',
                'loadingText': '×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.',
                'chartGenderTitle': 'ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)',
                'chartGenerationTitle': 'ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)',
                'chartLifeExpectancyTitle': 'ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)',
                'chartBirthTrendTitle': 'ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨',
                'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)',
                'chartAgeDistributionTitle': 'ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª',
                'chartMaritalStatusTitle': 'ğŸ’ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××¦×‘ ××©×¤×—×ª×™',
                'chartMostCommonNamesTitle': 'ğŸ“› 10 ×”×©××•×ª ×”×¤×¨×˜×™×™× ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨',
                'adultsNote': '(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)',
                // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
                'genderMale': '×–×›×¨×™×',
                'genderFemale': '× ×§×‘×•×ª',
                'peopleCount': '××¡×¤×¨ ×× ×©×™×',
                'birthYears': '×©× ×•×ª ×œ×™×“×”',
                'avgLifeSpan': '××•×¨×š ×—×™×™× ×××•×¦×¢',
                'years': '×©× ×™×',
                'birthDecade': '×¢×©×•×¨ ×œ×™×“×”',
                'birthCount': '×›××•×ª ×œ×™×“×•×ª',
                'decade': '×¢×©×•×¨',
                'avgChildren': '×××•×¦×¢ ×™×œ×“×™×',
                'generation': '×“×•×¨ ×œ×™×“×”',
                'currentAge': '×’×™×œ × ×•×›×—×™ (×—×™×™×)',
                'ageAtDeath': '×’×™×œ ××•×•×ª (× ×¤×˜×¨×™×)',
                'ageBins': '×˜×•×•×— ×’×™×œ××™×',
                // ×œ×™×™×‘×œ×™× ×œ××¦×‘ ××©×¤×—×ª×™
                'statusM': '× ×©×•×™/×”',
                'statusS': '×¨×•×•×§/×”',
                'statusD': '×’×¨×•×©/×”',
                'statusW': '××œ××Ÿ/×”',
                'statusU': '××—×¨/×œ× ×™×“×•×¢',
                'firstName': '×©× ×¤×¨×˜×™',
                'langButton': 'English'    
            },
            'EN': {
                'pageTitle': 'Extended Family Tree Statistics',
                'mainTitle': 'Extended Family Tree Statistics',
                'statusLoading': 'Loading family side...',
                'loadingText': 'Loading data... Please wait.',
                'chartGenderTitle': 'ğŸ‘¤ Gender Distribution (Male vs. Female)',
                'chartGenerationTitle': 'ğŸ“… Distribution by Generation (25-year span)',
                'chartLifeExpectancyTitle': 'ğŸ’– Average Life Expectancy by Birth Period (Years)',
                'chartBirthTrendTitle': 'ğŸ“ˆ Birth Trend by Decade',
                'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Average Children Per Person (by Birth Generation)',
                'chartAgeDistributionTitle': 'ğŸ‘¶ Current Age and Age at Death Distribution',
                'chartMaritalStatusTitle': 'ğŸ’ Marital Status Distribution',
                'chartMostCommonNamesTitle': 'ğŸ“› Top 10 Most Common First Names',
                'adultsNote': '(Includes only generations who reached adulthood)',
                // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
                'genderMale': 'Males',
                'genderFemale': 'Females',
                'peopleCount': 'Number of People',
                'birthYears': 'Birth Years',
                'avgLifeSpan': 'Average Life Span',
                'years': 'Years',
                'birthDecade': 'Birth Decade',
                'birthCount': 'Birth Count',
                'decade': 'Decade',
                'avgChildren': 'Average Children',
                'generation': 'Birth Generation',
                'currentAge': 'Current Age (Living)',
                'ageAtDeath': 'Age at Death (Deceased)',
                'ageBins': 'Age Bins',
                // ×œ×™×™×‘×œ×™× ×œ××¦×‘ ××©×¤×—×ª×™
                'statusM': 'Married',
                'statusS': 'Single',
                'statusD': 'Divorced',
                'statusW': 'Widowed',
                'statusU': 'Other/Unknown',
                'firstName': 'First Name',
                'langButton': '×¢×‘×¨×™×ª'    
            }
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ×˜×§×¡×˜ ××ª×•×¨×’×
         */
        function T(key) {
            return translations[currentLang][key] || key;
        }
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×›×œ ×”×˜×§×¡×˜×™× ×”×¡×˜×˜×™×™× ×‘×”×ª×× ×œ×©×¤×” ×”× ×•×›×—×™×ª
         */
        function updateUI() {
            const texts = translations[currentLang];
            
            // ×”×’× ×” ××¤× ×™ null ×¢×œ ×›×œ ×”××œ×× ×˜×™× ×”× ×§×¨××™×
            if (document.getElementById('page-title-display')) {
                document.getElementById('page-title-display').textContent = texts.pageTitle;
            }
            if (document.getElementById('main-title-text')) {
                document.getElementById('main-title-text').textContent = texts.mainTitle;
            }
            if (document.getElementById('loading-text')) {
                document.getElementById('loading-text').textContent = texts.loadingText;
            }
            
            if (document.getElementById('chartGenderTitle')) {
                document.getElementById('chartGenderTitle').textContent = texts.chartGenderTitle;
            }
            if (document.getElementById('chartGenerationTitle')) {
                document.getElementById('chartGenerationTitle').textContent = texts.chartGenerationTitle;
            }
            if (document.getElementById('chartLifeExpectancyTitle')) {
                document.getElementById('chartLifeExpectancyTitle').textContent = texts.chartLifeExpectancyTitle;
            }
            if (document.getElementById('chartBirthTrendTitle')) {
                document.getElementById('chartBirthTrendTitle').textContent = texts.chartBirthTrendTitle;
            }
            if (document.getElementById('chartAvgChildrenTitle')) {
                document.getElementById('chartAvgChildrenTitle').textContent = texts.chartAvgChildrenTitle;
            }
            if (document.getElementById('chartAgeDistributionTitle')) {
                document.getElementById('chartAgeDistributionTitle').textContent = texts.chartAgeDistributionTitle;
            }
            if (document.getElementById('chartMaritalStatusTitle')) {
                document.getElementById('chartMaritalStatusTitle').textContent = texts.chartMaritalStatusTitle;
            }
            if (document.getElementById('chartMostCommonNamesTitle')) {
                document.getElementById('chartMostCommonNamesTitle').textContent = texts.chartMostCommonNamesTitle;
            }
            
            if (document.getElementById('adults-note')) {
                document.getElementById('adults-note').textContent = texts.adultsNote;
            }
            if (document.getElementById('lang-toggle-button')) {
                document.getElementById('lang-toggle-button').textContent = texts.langButton;
            }
            
            // ×¢×“×›×•×Ÿ ×›×™×•×•× ×™×•×ª ×”×“×£
            const isRTL = currentLang === 'HE';
            document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
            document.body.classList.toggle('text-right', isRTL);
            document.body.classList.toggle('text-left', !isRTL);
            
            // ×¢×“×›×•×Ÿ ×›×™×•×•× ×™×•×ª ×©×œ ×”×•×“×¢×ª ×”×¡×˜×˜×•×¡ ×”×¡×¤×¦×™×¤×™×ª
            const familyInfoElement = document.getElementById("family-info");
            if (familyInfoElement) {
                familyInfoElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
            }
            
            // ×¦×™×•×¨ ××—×“×© ×©×œ ×›×œ ×”×ª×¨×©×™××™×
            if (cleanedData.length > 0) {
                renderAllCharts(cleanedData, currentLang);
            }
        }
        
        function displayError(message) {
            const loadingElement = document.getElementById("loading");
            if (loadingElement) {
                loadingElement.style.display = "none";
            }
            const mainContent = document.getElementById("main-content");
            if (mainContent) {
                mainContent.style.display = "block";
            }
            
            const familyInfoElement = document.getElementById("family-info");
            if (familyInfoElement) {
                familyInfoElement.innerHTML = '<span class="text-red-600 font-bold bg-red-100 p-2 rounded">' + message + '</span>';
            }
            
            document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
            
            const mainTitle = document.querySelector('header h1'); 
            if (mainTitle) {
                mainTitle.style.display = "none";
            }
        }

        /**
         * ×¤×•× ×§×¦×™×” ×—×–×§×” ×œ×—×™×œ×•×¥ ××¢×¨×š JSON ×©×œ × ×ª×•× ×™× ××ª×•×š ×˜×§×¡×˜ ×’×•×œ××™ (×›×’×•×Ÿ ×§×•×‘×¥ HTML).
         * × ×ª×•× ×™ ×”-JSON ×—×™×™×‘×™× ×œ×”×™×•×ª ××•×¤×™×¢×™× ×›-`[...]` ×‘×˜×§×¡×˜.
         */
        function extractFamilyData(rawText) {
            
            // 1. ×—×™×¤×•×© ×•××¦×™××ª ×”-JSON ×‘×××¦×¢×•×ª Regular Expression
            // ××—×¤×© ××¢×¨×š JSON ×©××ª×—×™×œ ×‘-[ ×•× ×’××¨ ×‘-], ×•××›×™×œ ××•×‘×™×™×§×˜×™× {}.
            const jsonMatch = rawText.match(/(\s*\[\s*\{[\s\S]*\}\s*\]\s*)/);

            if (!jsonMatch) {
                throw new Error("×œ× × ××¦× ×‘×œ×•×§ × ×ª×•× ×™× (××¢×¨×š JSON) ×‘×˜×§×¡×˜ ×©×—×•×œ×¥.");
            }
            
            let jsonString = jsonMatch[1].trim(); 

            // 2. × ×™×§×•×™: ×”×¡×¨×ª ×ª×’×•×‘×•×ª
            jsonString = jsonString.replace(/<!--[\s\S]*?-->/g, '');
            jsonString = jsonString.replace(/\/\/[^\n]*\n/g, '\n'); 
            jsonString = jsonString.replace(/\/\/[^\n]*$/, ''); 

            // 3. × ×™×§×•×™: ×”×¡×¨×ª ×¤×¡×™×§×™× ××™×•×ª×¨×™× (×©×¢×©×•×™×™× ×œ×”×•×¤×™×¢ ×œ×¤× ×™ ×¡×•×’×¨ ×¡×•×’×¨ ××¨×•×‘×¢)
            jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

            // 4. × ×™×¡×™×•×Ÿ × ×™×ª×•×— JSON
            try {
                const data = JSON.parse(jsonString);
                
                if (Array.isArray(data) && data.length > 0) {
                    return data;
                }
                
                if (Array.isArray(data) && data.length === 0) {
                    throw new Error("××‘× ×” ×”-JSON × ××¦× ×ª×§×™×Ÿ, ××š ×”×•× ××¢×¨×š ×¨×™×§. (××™×Ÿ × ×ª×•× ×™×)");
                }
            } catch (e) {
                console.error("×©×’×™××ª × ×™×ª×•×— JSON ×œ××—×¨ ×—×™×œ×•×¥ ×•× ×™×§×•×™:", e);
                const errorSnippet = jsonString.substring(0, 200).replace(/(\n|\r|\t)/g, ' ').trim() + '...';
                throw new Error(`×©×’×™××ª JSON.parse: ×”××—×¨×•×–×ª ×©×—×•×œ×¦×” ("${errorSnippet}") ××™× ×” JSON ×ª×§×™×Ÿ. ×‘×“×•×§ ××ª ××‘× ×” ×”×§×•×‘×¥ ×”××§×•×¨×™.`);
            }
            
            throw new Error("× ×ª×•× ×™× ×—×•×œ×¦×• ××š ×œ× ×¢×‘×¨×• ××ª ×‘×“×™×§×ª ×”××¢×¨×š ×”×ª×§×™× ×”.");
        }
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×˜×™×¤×•×œ ×‘×©× ×•×ª ×œ×™×“×”/××•×•×ª ×›××¡×¤×¨.
         */
        function normalizeYear(year) {
            if (typeof year === 'number') return year;
            if (typeof year === 'string') {
                const num = parseInt(year.replace(/[^0-9]/g, ''), 10);
                return isNaN(num) ? null : num;
            }
            return null;
        }
        
        // --- ×¤×•× ×§×¦×™×•×ª ×™×¦×™×¨×ª ×ª×¨×©×™× ---
        
        let chartInstances = {}; // ××—×¡×•×Ÿ ××•×¤×¢×™ ×ª×¨×©×™××™× ×œ×˜×•×‘×ª ×¢×“×›×•×Ÿ/××—×™×§×”

        function renderGenderChart(data, lang) {
            const texts = translations[lang];
            const males = data.filter(p => p.gender === "M").length;
            const females = data.filter(p => p.gender === "F").length;
            
            // ×¦×‘×¢×™× ××¢×•×“×›× ×™×: ××™× ×“×™×’×• ×•×××¨×œ×“
            const GENDER_COLORS = ["#4f46e5", "#10b981"]; 

            if (chartInstances.gender) chartInstances.gender.destroy();
            const ctx = document.getElementById("genderChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.gender = new Chart(ctx, {
                type: "pie",
                data: {
                    labels: [texts.genderMale, texts.genderFemale],
                    datasets: [{
                        data: [males, females],
                        backgroundColor: GENDER_COLORS,
                        borderColor: '#ffffff',
                        borderWidth: 3, // ×¢×‘×” ×™×•×ª×¨
                        hoverOffset: 15
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    plugins: {
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        legend: { position: 'bottom', rtl: lang === 'HE' },
                        tooltip: { 
                            ...CHART_GLOBAL_OPTIONS.plugins.tooltip,
                            rtl: lang === 'HE',
                        }
                    }
                }
            });
        }

        function renderGenerationChart(data, lang) {
            const texts = translations[lang];
            const generations = {};
            const BASE_YEAR = 1800;
            const GENERATION_SPAN = 25;

            data.forEach(p => {
                const year = p.birth_year;
                if (typeof year !== 'number' || year === null || year < BASE_YEAR || year > new Date().getFullYear()) {
                    return;
                }
                const genIndex = Math.floor((year - BASE_YEAR) / GENERATION_SPAN); 
                generations[genIndex] = (generations[genIndex] || 0) + 1;
            });
            
            const sortedGenerations = Object.entries(generations).sort((a, b) => +a[0] - +b[0]);
            const genLabels = sortedGenerations.map(([index]) => {
                const startYear = BASE_YEAR + (+index * GENERATION_SPAN);
                const endYear = startYear + GENERATION_SPAN - 1;
                return startYear + ' - ' + endYear;
            });
            const genValues = sortedGenerations.map(([, count]) => count);
            const BAR_COLOR = "#6366f1"; // Indigo 500

            if (chartInstances.generation) chartInstances.generation.destroy();
            const ctx = document.getElementById("generationChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.generation = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: genLabels,
                    datasets: [{
                        label: texts.peopleCount,
                        data: genValues,
                        backgroundColor: BAR_COLOR,
                        borderColor: BAR_COLOR,
                        borderWidth: 0,
                        borderRadius: 4 // ××•×˜×•×ª ××¢×•×’×œ×™×
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    scales: {
                        y: { 
                            ...CHART_GLOBAL_OPTIONS.scales.y,
                            beginAtZero: true, 
                            title: { display: true, text: texts.peopleCount, color: '#4b5563' } 
                        },
                        x: { 
                            ...CHART_GLOBAL_OPTIONS.scales.x,
                            reverse: true, 
                            title: { display: true, text: texts.birthYears, color: '#4b5563' } 
                        } 
                    },
                    plugins: { 
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' } 
                    }
                }
            });
        }

        function renderLifeExpectancyChart(data, lang) {
            const texts = translations[lang];
            const lifeSpanData = data.filter(p => p.birth_year && p.death_year && p.death_year > p.birth_year);
            const lifeSpansByDecade = {};

            lifeSpanData.forEach(p => {
                const decade = Math.floor(p.birth_year / 10) * 10;
                const lifeSpan = p.death_year - p.birth_year;
                if (!lifeSpansByDecade[decade]) {
                    lifeSpansByDecade[decade] = { total: 0, count: 0 };
                }
                lifeSpansByDecade[decade].total += lifeSpan;
                lifeSpansByDecade[decade].count++;
            });

            const sortedLifeSpans = Object.entries(lifeSpansByDecade).sort((a, b) => +a[0] - +b[0]);
            const lifeSpanLabels = sortedLifeSpans.map(([decade]) => `${decade} - ${+decade + 9}`);
            const avgLifeSpans = sortedLifeSpans.map(([, data]) => (data.total / data.count).toFixed(1));
            const LIFESPAN_COLOR = "#059669"; // Emerald 600

            if (chartInstances.lifeExpectancy) chartInstances.lifeExpectancy.destroy();
            const ctx = document.getElementById("lifeExpectancyChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.lifeExpectancy = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: lifeSpanLabels,
                    datasets: [{
                        label: texts.avgLifeSpan,
                        data: avgLifeSpans,
                        backgroundColor: LIFESPAN_COLOR,
                        borderColor: LIFESPAN_COLOR,
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    scales: {
                        y: { 
                            ...CHART_GLOBAL_OPTIONS.scales.y,
                            beginAtZero: true, 
                            title: { display: true, text: texts.years, color: '#4b5563' } 
                        },
                        x: { 
                            ...CHART_GLOBAL_OPTIONS.scales.x,
                            reverse: true, 
                            title: { display: true, text: texts.birthDecade, color: '#4b5563' } 
                        } 
                    },
                    plugins: { 
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' } 
                    }
                }
            });
        }
        
        function renderBirthTrendChart(data, lang) {
            const texts = translations[lang];
            const birthTrend = {};
            data.forEach(p => {
                if (p.birth_year) {
                    const decade = Math.floor(p.birth_year / 10) * 10;
                    birthTrend[decade] = (birthTrend[decade] || 0) + 1;
                }
            });

            const sortedBirthTrend = Object.entries(birthTrend).sort((a, b) => +a[0] - +b[0]);
            const trendLabels = sortedBirthTrend.map(([decade]) => decade);
            const trendValues = sortedBirthTrend.map(([, count]) => count);
            const TREND_COLOR = "#f59e0b"; // Amber 500

            if (chartInstances.birthTrend) chartInstances.birthTrend.destroy();
            const ctx = document.getElementById("birthTrendChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.birthTrend = new Chart(ctx, {
                type: "line",
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: texts.birthCount,
                        data: trendValues,
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: TREND_COLOR,
                        borderWidth: 3, // ×¢×‘×” ×™×•×ª×¨
                        fill: true,
                        tension: 0.4, // ×§×• ×—×œ×§ ×™×•×ª×¨
                        pointRadius: 5,
                        pointBackgroundColor: TREND_COLOR,
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    scales: {
                        y: { 
                            ...CHART_GLOBAL_OPTIONS.scales.y,
                            beginAtZero: true, 
                            title: { display: true, text: texts.birthCount, color: '#4b5563' } 
                        },
                        x: { 
                            ...CHART_GLOBAL_OPTIONS.scales.x,
                            reverse: true, 
                            title: { display: true, text: texts.decade, color: '#4b5563' } 
                        } 
                    },
                    plugins: { 
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' } 
                    }
                }
            });
        }
        
        function renderAvgChildrenChart(data, lang) {
            const texts = translations[lang];
            const childrenAvg = {};
            const GENERATION_SPAN = 25;

            data.filter(p => p.is_adult_for_children_avg).forEach(p => {
                const genIndex = Math.floor(p.birth_year / GENERATION_SPAN); 
                const generationStartYear = genIndex * GENERATION_SPAN;
                
                if (!childrenAvg[generationStartYear]) {
                    childrenAvg[generationStartYear] = { totalChildren: 0, adultCount: 0 };
                }
                childrenAvg[generationStartYear].totalChildren += p.children_count;
                childrenAvg[generationStartYear].adultCount++;
            });

            const sortedChildrenAvg = Object.entries(childrenAvg).sort((a, b) => +a[0] - +b[0]);
            const avgChildrenLabels = sortedChildrenAvg.map(([year]) => `${year} - ${+year + GENERATION_SPAN - 1}`);
            const avgChildrenValues = sortedChildrenAvg.map(([, data]) => (data.totalChildren / data.adultCount).toFixed(1));
            const CHILDREN_COLOR = "#ef4444"; // Red 500

            if (chartInstances.avgChildren) chartInstances.avgChildren.destroy();
            const ctx = document.getElementById("avgChildrenChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.avgChildren = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: avgChildrenLabels,
                    datasets: [{
                        label: texts.avgChildren,
                        data: avgChildrenValues,
                        backgroundColor: CHILDREN_COLOR,
                        borderColor: CHILDREN_COLOR,
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    scales: {
                        y: { 
                            ...CHART_GLOBAL_OPTIONS.scales.y,
                            beginAtZero: true, 
                            title: { display: true, text: texts.avgChildren, color: '#4b5563' } 
                        },
                        x: { 
                            ...CHART_GLOBAL_OPTIONS.scales.x,
                            reverse: true, 
                            title: { display: true, text: texts.generation, color: '#4b5563' } 
                        } 
                    },
                    plugins: { 
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' } 
                    }
                }
            });
        }

        function renderAgeDistributionChart(data, lang) {
            const texts = translations[lang];
            // ×”×’×“×¨×ª ×˜×•×•×—×™ ×’×™×œ××™×
            const BINS = [0, 20, 40, 60, 80, 100]; 
            const binLabels = BINS.map((start, i) => 
                i === BINS.length - 1 ? `${start}+` : `${start}-${BINS[i+1]-1}`
            ).reverse(); 
            
            const currentAgeCounts = Array(BINS.length).fill(0);
            const ageAtDeathCounts = Array(BINS.length).fill(0);

            data.forEach(p => {
                let binIndex;
                // Current Age (Living)
                if (p.current_age !== undefined && p.current_age >= 0) {
                    binIndex = BINS.findIndex((start, i) => 
                        i === BINS.length - 1 ? p.current_age >= start : p.current_age >= start && p.current_age < BINS[i+1]
                    );
                    // ×©×™××•×© ×‘××™× ×“×§×¡ ×”××—×¨×•×Ÿ ×× ×”×•× ×œ× × ××¦×
                    const finalIndex = binIndex !== -1 ? binIndex : BINS.length - 1;
                    if (p.current_age >= 0) currentAgeCounts[finalIndex]++;
                }
                
                // Age at Death (Deceased)
                if (p.age_at_death !== undefined && p.age_at_death >= 0) {
                    binIndex = BINS.findIndex((start, i) => 
                        i === BINS.length - 1 ? p.age_at_death >= start : p.age_at_death >= start && p.age_at_death < BINS[i+1]
                    );
                    const finalIndex = binIndex !== -1 ? binIndex : BINS.length - 1;
                    if (p.age_at_death >= 0) ageAtDeathCounts[finalIndex]++;
                }
            });
            
            // ×”×™×¤×•×š ×¡×“×¨ ×”× ×ª×•× ×™× ×›×“×™ ×©×™×ª××™× ×œ×ª×•×•×™×•×ª ×”×”×¤×•×›×•×ª
            currentAgeCounts.reverse();
            ageAtDeathCounts.reverse();
            
            // ×¦×‘×¢×™× ××¢×•×“×›× ×™×: ×¡×’×•×œ ×•×›×ª×•×
            const CURRENT_AGE_COLOR = '#a855f7'; // Purple 500
            const AGE_AT_DEATH_COLOR = '#f97316'; // Orange 500

            if (chartInstances.ageDistribution) chartInstances.ageDistribution.destroy();
            const ctx = document.getElementById("ageDistributionChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.ageDistribution = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: binLabels,
                    datasets: [
                        {
                            label: texts.currentAge,
                            data: currentAgeCounts,
                            backgroundColor: CURRENT_AGE_COLOR, 
                            stack: 'stack0',
                            borderRadius: 4
                        },
                        {
                            label: texts.ageAtDeath,
                            data: ageAtDeathCounts,
                            backgroundColor: AGE_AT_DEATH_COLOR,
                            stack: 'stack0',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    scales: {
                        y: { 
                            ...CHART_GLOBAL_OPTIONS.scales.y,
                            beginAtZero: true, 
                            stacked: true,
                            title: { display: true, text: texts.peopleCount, color: '#4b5563' } 
                        },
                        x: { 
                            ...CHART_GLOBAL_OPTIONS.scales.x,
                            stacked: true,
                            title: { display: true, text: texts.ageBins, color: '#4b5563' } 
                        }
                    },
                    plugins: {
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' }
                    }
                }
            });
        }

        // --- ×¤×•× ×§×¦×™×” ×—×“×©×”: ×”×ª×¤×œ×’×•×ª ××¦×‘ ××©×¤×—×ª×™ ---
        function renderMaritalStatusChart(data, lang) {
            const texts = translations[lang];
            const maritalStatuses = { 'M': 0, 'S': 0, 'D': 0, 'W': 0, 'U': 0 };
            
            // ×¦×‘×¢×™× ××¢×•×“×›× ×™×: ×•×¨×•×“, ×™×¨×•×§, ×›×ª×•×, ××¤×•×¨ ×›×”×”, ××¤×•×¨ ×‘×”×™×¨
            const STATUS_COLORS = ["#ec4899", "#34d399", "#f97316", "#4b5563", "#9ca3af"]; 

            data.forEach(p => {
                const status = p.marital_status ? p.marital_status.toUpperCase() : 'U';
                if (maritalStatuses.hasOwnProperty(status)) {
                    maritalStatuses[status]++;
                } else {
                    maritalStatuses['U']++;
                }
            });

            const statusLabels = [
                texts.statusM, texts.statusS, texts.statusD, texts.statusW, texts.statusU
            ];
            const statusValues = [
                maritalStatuses.M, maritalStatuses.S, maritalStatuses.D, maritalStatuses.W, maritalStatuses.U
            ];
            
            // ×¡×™× ×•×Ÿ ××¤×¡×™× ××˜×¢××™ ×§×¨×™××•×ª
            const filteredLabels = statusLabels.filter((_, i) => statusValues[i] > 0);
            const filteredValues = statusValues.filter(v => v > 0);
            const filteredColors = STATUS_COLORS.filter((_, i) => statusValues[i] > 0);


            if (chartInstances.maritalStatus) chartInstances.maritalStatus.destroy();
            const ctx = document.getElementById("maritalStatusChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.maritalStatus = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredValues,
                        backgroundColor: filteredColors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 15
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    plugins: {
                        ...CHART_GLOBAL_OPTIONS.plugins,
                        legend: { position: 'bottom', rtl: lang === 'HE' },
                        tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' }
                    }
                }
            });
        }

        // --- ×¤×•× ×§×¦×™×” ×—×“×©×”: 10 ×”×©××•×ª ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨ ---
        function renderMostCommonNamesChart(data, lang) {
            const texts = translations[lang];
            const nameCounts = {};

            data.forEach(p => {
                if (p.first_name) {
                    const name = p.first_name.trim().toLowerCase();
                    nameCounts[name] = (nameCounts[name] || 0) + 1;
                }
            });

            const sortedNames = Object.entries(nameCounts)
                .sort((a, b) => b[1] - a[1]) // Sort descending by count
                .slice(0, 10); // Take top 10

            const nameLabels = sortedNames.map(([name]) => {
                // × ×¨××•×œ ×œ×”×¦×’×”: ×”×¤×™×›×ª ×”××•×ª ×”×¨××©×•× ×” ×œ×’×“×•×œ×”
                return name.charAt(0).toUpperCase() + name.slice(1);
            }).reverse(); // Reverse for Chart.js display order (highest at top)

            const nameValues = sortedNames.map(([, count]) => count).reverse();
            const NAME_COLOR = "#3730a3"; // Indigo 700

            if (chartInstances.mostCommonNames) chartInstances.mostCommonNames.destroy();
            const ctx = document.getElementById("mostCommonNamesChart")?.getContext("2d");
            if (!ctx) return;
            chartInstances.mostCommonNames = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: nameLabels,
                    datasets: [{
                        label: texts.peopleCount,
                        data: nameValues,
                        backgroundColor: NAME_COLOR,
                        borderColor: NAME_COLOR,
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...CHART_GLOBAL_OPTIONS,
                    indexAxis: 'y', // Horizontal bars
                    scales: {
                        x: { 
                            ...CHART_GLOBAL_OPTIONS.scales.x,
                            beginAtZero: true, 
                            title: { display: true, text: texts.peopleCount, color: '#4b5563' } 
                        },
                        y: { 
                            ...CHART_GLOBAL_OPTIONS.scales.y,
                            title: { display: true, text: texts.firstName, color: '#4b5563' } 
                        }
                    },
                    plugins: { ...CHART_GLOBAL_OPTIONS.plugins, tooltip: { ...CHART_GLOBAL_OPTIONS.plugins.tooltip, rtl: lang === 'HE' } }
                }
            });
        }


        function renderAllCharts(data, lang) {
            // ×¢×“×›×•×Ÿ ×›×™×•×•× ×™×•×ª ×”×’×œ×•×‘×œ×™×ª ×©×œ ×”×ª×¨×©×™××™×
            CHART_GLOBAL_OPTIONS.plugins.tooltip.rtl = lang === 'HE';
            CHART_GLOBAL_OPTIONS.plugins.legend.rtl = lang === 'HE';

            // ×ª×¨×©×™××™× ×§×™×™××™×
            renderGenderChart(data, lang);
            renderGenerationChart(data, lang);
            renderLifeExpectancyChart(data, lang);
            renderBirthTrendChart(data, lang);
            renderAvgChildrenChart(data, lang);
            renderAgeDistributionChart(data, lang); 

            // ×ª×¨×©×™××™× ×—×“×©×™×
            renderMaritalStatusChart(data, lang);
            renderMostCommonNamesChart(data, lang);
        }


        // --- ×¤×•× ×§×¦×™×” ×¨××©×™×ª ×œ××¨×’×•×Ÿ ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××”×©×¨×ª ---

        async function loadFamilyStats() {
            updateUI(); // ×¢×“×›×•×Ÿ UI ×¨××©×•× ×™ ×œ×©×¤×”
            
            const familyInfoElement = document.getElementById("family-info");
            const allFamilyData = [];
            const loadedFamilies = [];
            const failedFamilies = [];
            
            try {
                // 1. ×©×œ×™×¤×ª ×¤×¨×˜×™ ××©×ª××© ×•×§×‘×œ×ª ×¦×“ ××©×¤×—×” ×’×•×œ××™ ×- /api/user
                if (familyInfoElement) {
                    familyInfoElement.textContent = T('statusLoading');
                }
                
                // ×§×¨×™××ª ×¨×©×ª ×××™×ª×™×ª ×œ×©×¨×ª ×œ××™××•×ª ×•×§×‘×œ×ª ×©××•×ª ×”××©×¤×—×”
                const userResponse = await fetch('/api/user');
                if (!userResponse.ok) {
                    throw new Error(`×©×’×™××ª ×©×¨×ª (${userResponse.status}): ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×˜×™ ××©×ª××©. ×•×“× ×©×”× ×ª×™×‘ /api/user ××—×–×™×¨ JSON ×ª×§×™×Ÿ.`);
                }
                const userData = await userResponse.json();
                
                // ×”×”× ×—×” ×”×™× ×©×”× ×ª×•× ×™× ×—×•×–×¨×™× ×‘××‘× ×” { user: { familySide: "FamilyA,FamilyB" } }
                const rawFamilySide = userData.user?.familySide; 

                if (!rawFamilySide || typeof rawFamilySide !== 'string' || rawFamilySide.length === 0) {
                    throw new Error("×©×“×” 'familySide' ×—×¡×¨, ×œ× ×ª×§×™×Ÿ ××• ×œ× ××•×’×“×¨ ×‘×¤×¨×˜×™ ×”××©×ª××©. (× ×“×¨×© ×©× ××©×¤×—×” ××—×“ ××• ×™×•×ª×¨, ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×).");
                }
                
                // ×¤×™×¦×•×œ ×©××•×ª ×”××©×¤×—×” ×•× ×™×§×•×™ ×¨×•×•×—×™×
                const familyNames = rawFamilySide.split(',')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                if (familyNames.length === 0) {
                    throw new Error("×©×“×” 'familySide' ××›×™×œ ×ª×•×•×™×, ××š ×œ× × ××¦××• ×©××•×ª ××©×¤×—×” ×ª×§×™× ×™× ×œ×¢×™×‘×•×“ ×œ××—×¨ × ×™×§×•×™.");
                }

                // 2. ×©×œ×™×¤×ª ×§×‘×¦×™×, ×¦×‘×™×¨×” ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª
                for (const familySide of familyNames) {
                    const dataUrl = '/trees/' + familySide + '.html';
                    if (familyInfoElement) {
                        familyInfoElement.textContent = `×˜×•×¢×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨: ${familySide}...`;
                    }

                    try {
                        // ×§×¨×™××ª ×¨×©×ª ×××™×ª×™×ª ×œ×˜×¢×™× ×ª ×§×•×‘×¥ ×”-HTML ×©××›×™×œ ××ª × ×ª×•× ×™ ×”-JSON
                        const dataResponse = await fetch(dataUrl);
                        if (!dataResponse.ok) {
                            throw new Error(`×©×’×™××ª ×©×¨×ª (${dataResponse.status}): ×•×“× ×©×§×•×‘×¥ ${dataUrl} ×§×™×™× ×•××—×–×™×¨ × ×ª×•× ×™×.`);
                        }
                        const rawText = await dataResponse.text();
                        
                        // ×—×™×œ×•×¥ ××¢×¨×š ×”-JSON ××ª×•×š ×”×˜×§×¡×˜ (×§×•×‘×¥ HTML ××• ×’×•×œ××™)
                        const rawData = extractFamilyData(rawText); 

                        // ×¦×‘×™×¨×ª ×”× ×ª×•× ×™×
                        allFamilyData.push(...rawData);
                        loadedFamilies.push(familySide);

                    } catch (error) {
                        console.warn('×›×©×œ ×‘×˜×¢×™× ×ª ' + familySide + ': ' + error.message);
                        failedFamilies.push({ name: familySide, message: error.message });
                    }
                }

                if (allFamilyData.length === 0) {
                    let errorMsg = "×œ× × ××¦××• × ×ª×•× ×™× ×›×œ×œ ×œ×¢×™×‘×•×“ ×¡×˜×˜×™×¡×˜×™ ××›×œ ×”×§×‘×¦×™× ×©× ×™×¡×™×ª×™ ×œ×˜×¢×•×Ÿ.";
                    if (failedFamilies.length > 0) {
                        errorMsg += " (× ×›×©×œ×•: " + failedFamilies.map(f => f.name).join(', ') + ")";
                    }
                    throw new Error(errorMsg);
                }

                // 3. × ×™×§×•×™ ×•×¡×™× ×•×Ÿ × ×ª×•× ×™× ×•×”×›× ×” ×œ×ª×¨×©×™××™×
                if (familyInfoElement) {
                    familyInfoElement.textContent = "××—×œ×¥ ×•×× ×§×” × ×ª×•× ×™×...";
                }
                
                const CURRENT_YEAR = new Date().getFullYear();
                // ×”×›× ×ª × ×ª×•× ×™× - × ×™×¨××•×œ ×©× ×•×ª ×œ×™×“×”/××•×•×ª ×•×”×•×¡×¤×ª ×©×“×•×ª ×’×™×œ ×—×“×©×™×
                cleanedData = allFamilyData
                    .map(p => {
                        const birth_year = normalizeYear(p.birth_year);
                        const death_year = normalizeYear(p.death_year);
                        
                        const processed = {
                            ...p,
                            birth_year: birth_year,
                            death_year: death_year,
                            children_count: Array.isArray(p.children_ids) ? p.children_ids.length : 0,
                            // is_adult_for_children_avg: ×›×œ ××™ ×©× ×•×œ×“ ×œ×¤× ×™ 1970 × ×—×©×‘ ×›××‘×•×’×¨ ×¤×•×˜× ×¦×™××œ×™ ×œ×™×œ×“×™×
                            is_adult_for_children_avg: birth_year !== null && birth_year < 1970 
                        };
                        
                        // ×—×™×©×•×‘ ×’×™×œ ×‘××•×•×ª ×•×’×™×œ × ×•×›×—×™ (×œ×¦×•×¨×š ×”×ª×¨×©×™× ×”×—×“×©)
                        if (birth_year) {
                            if (death_year && death_year > birth_year) {
                                processed.age_at_death = death_year - birth_year;
                            }
                            if (!death_year || death_year >= CURRENT_YEAR) {
                                processed.current_age = CURRENT_YEAR - birth_year;
                            }
                        }
                        return processed;
                    })
                    // ×¡×™× ×•×Ÿ ×¨×§ ×©×œ ×¨×©×•××•×ª ×©×™×© ×‘×”×Ÿ ×œ×¤×—×•×ª ××™×“×¢ ××—×“ ×¨×œ×•×•× ×˜×™
                    .filter(p => p.gender || p.birth_year || p.marital_status || p.first_name); 

                if (cleanedData.length === 0) {
                    throw new Error('×”× ×ª×•× ×™× ×—×•×œ×¦×• ×‘×”×¦×œ×—×”, ××š ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×§×™× ×•×ª ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª (×›× ×¨××” ×©×“×•×ª ××’×“×¨/×©× ×ª ×œ×™×“×”/××¦×‘ ××©×¤×—×ª×™/×©× ×¤×¨×˜×™ ×—×¡×¨×™×) ××ª×•×š ' + allFamilyData.length + ' ×¨×©×•××•×ª ×’×•×œ××™×•×ª.');
                }

                // 4. ×™×¦×™×¨×ª ×”×ª×¨×©×™××™×
                renderAllCharts(cleanedData, currentLang);


                // 5. ×¡×™×•× ×˜×¢×™× ×”
                const loadingElement = document.getElementById("loading");
                const mainContentElement = document.getElementById("main-content");
                
                if (loadingElement) {
                    loadingElement.style.display = "none";
                }
                if (mainContentElement) {
                    mainContentElement.style.display = "block";
                }
                
                let statusMessage = '×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×¢×‘×•×¨ ×”××©×¤×—×•×ª: <b>' + loadedFamilies.join(', ') + '</b>. ×¡×š ×× ×©×™× ××¢×•×‘×“×™×: ' + cleanedData.length;
                
                if (failedFamilies.length > 0) {
                    statusMessage += '. <br><span class="text-yellow-600 font-bold">×©×™××• ×œ×‘: × ×›×©×œ×” ×˜×¢×™× ×” ×¢×‘×•×¨: ' + failedFamilies.map(f => f.name).join(', ') + '.</span>';
                }

                if (familyInfoElement) {
                    familyInfoElement.innerHTML = '<span class="text-green-700 font-semibold">' + statusMessage + '</span>';
                }


            } catch (error) {
                console.error("×©×’×™××” ×§×¨×™×˜×™×ª:", error);
                displayError('××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message);
            }
        }
        
        // --- ××™×ª×—×•×œ ×•×”×—×œ×¤×ª ×©×¤×” ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // ×”×•×¡×¤×ª Listener ×œ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×”×©×¤×”
            const langButton = document.getElementById('lang-toggle-button');
            if (langButton) {
                langButton.addEventListener('click', () => {
                    currentLang = currentLang === 'HE' ? 'EN' : 'HE';
                    updateUI();
                });
            }
            
            loadFamilyStats();
        });

    </script>
</body>
</html>
