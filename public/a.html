<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×¤×—×ª×™×•×ª ××•×¨×—×‘×•×ª</title>
Â Â 
Â  <!-- Tailwind CSS CDN for styling -->
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <!-- Heebo Font link -->
Â  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap" rel="stylesheet">
Â Â 
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â Â 
Â  <style>
Â  Â  /* ×”×’×“×¨×ª ×”×¤×•× ×˜ ×”×¨××©×™ ×œ×›×œ ×”×“×£ */
Â  Â  body { font-family: 'Heebo', sans-serif; }
Â  Â  /* ×›×“×™ ×©×”×ª×¨×©×™××™× ×™×”×™×• ×¨×¡×¤×•× ×¡×™×‘×™×™× ×‘×ª×•×š ×”×›×¨×˜×™×¡×™× */
Â  Â  canvas { max-width: 100%; height: auto; }
Â  </style>
</head>
<body class="bg-gray-50 min-h-screen text-right p-4 sm:p-8">
Â  <div class="max-w-6xl mx-auto">

Â  Â  <!-- ×›×•×ª×¨×ª ×¨××©×™×ª ×•×”×•×“×¢×ª ×¡×˜×˜×•×¡ -->
Â  Â  <header class="mb-10 text-center">
Â  Â  Â  Â  <h1 id="main-title" class="text-6xl font-extrabold text-blue-800 mb-3 flex items-center justify-center gap-3">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª
Â  Â  Â  Â  </h1>
Â  Â  Â  Â  <p class="status-message text-lg text-gray-600 font-medium" id="family-info">×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...</p>
Â  Â  </header>

Â  Â  <!-- ××¡×š ×˜×¢×™× ×” -->
Â  Â  <div id="loading" class="flex justify-center items-center h-40">
Â  Â  Â  Â  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
Â  Â  Â  Â  <span class="text-xl text-gray-700 mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.</span>
Â  Â  </div>
Â  Â Â 
Â  Â  <!-- ×ª×•×›×Ÿ ×¨××©×™: ×™×•×¦×’ ×œ××—×¨ ×”×˜×¢×™× ×” -->
Â  Â  <div id="main-content" class="space-y-10" style="display: none;">
Â  Â  Â Â 
Â  Â  Â  <!-- ×©×•×¨×” 1: ××’×“×¨ ×•×“×•×¨×•×ª -->
Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ××’×“×¨ -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
Â  Â  Â  Â  Â  Â  Â ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="genderChart"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ×“×•×¨×•×ª -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="generationChart"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
      
      <!-- ×©×•×¨×” 2: ××•×¨×š ×—×™×™× ×××•×¦×¢ ×•×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ××•×¨×š ×—×™×™× -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="lifeExpectancyChart"></canvas>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ××’××ª ×œ×™×“×•×ª -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="birthTrendChart"></canvas>
Â  Â  Â  Â  </div>
      </div>
      
      <!-- ×©×•×¨×” 3: ×××•×¦×¢ ×™×œ×“×™× -->
      <div class="grid grid-cols-1">
Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ×™×œ×“×™× -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-red-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)
Â  Â  Â  Â  Â  Â  <span class="text-sm font-normal text-gray-500">(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)</span>
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="avgChildrenChart"></canvas>
Â  Â  Â  Â  </div>
      </div>
      
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---

Â  Â  function displayError(message) {
Â  Â  Â  document.getElementById("loading").style.display = "none";
Â  Â  Â  const mainContent = document.getElementById("main-content");
Â  Â  Â  mainContent.style.display = "block";
Â  Â  Â Â 
Â  Â  Â  const familyInfoElement = document.getElementById("family-info");
Â  Â  Â  familyInfoElement.innerHTML = '<span class="text-red-600 font-bold bg-red-100 p-2 rounded">' + message + '</span>';
Â  Â  Â Â 
Â  Â  Â  document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
Â  Â  Â  document.getElementById("main-title").style.display = "none";
Â  Â  }

Â  Â  /**
Â  Â  Â * ×¤×•× ×§×¦×™×” ×—×–×§×” ×œ×—×™×œ×•×¥ ××¢×¨×š JSON ×©×œ × ×ª×•× ×™× ××ª×•×š ×˜×§×¡×˜ ×’×•×œ××™ (×›×’×•×Ÿ ×§×•×‘×¥ HTML).
Â  Â  Â */
Â  Â  function extractFamilyData(rawText) {
Â  Â  Â  
Â  Â  Â  // 1. ×—×™×¤×•×© ×•××¦×™××ª ×”-JSON ×‘×××¦×¢×•×ª Regular Expression
Â  Â  Â  // ××—×¤×© ××¢×¨×š ([...]) ×”××›×™×œ ×œ×¤×—×•×ª ××•×‘×™×™×§×˜ ×¤×ª×•×— ({), ×•××•×•×“× ×©×”×•× ×ª×•×¤×¡ ××ª ×”×‘×œ×•×§ ×›×•×œ×•.
Â  Â  Â  const jsonMatch = rawText.match(/(\s*\[\s*\{[\s\S]*\}\s*\]\s*)/);

Â  Â  Â  if (!jsonMatch) {
Â  Â  Â  Â  throw new Error("×œ× × ××¦× ×‘×œ×•×§ JSON ×ª×§×™×Ÿ (××¢×¨×š ×¤×ª×•×— ×”×›×•×œ×œ ××•×‘×™×™×§×˜ ××—×“ ×œ×¤×—×•×ª) ×‘×ª×•×š ×”×§×•×‘×¥.");
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  let jsonString = jsonMatch[1].trim(); 

Â  Â  Â  // 2. × ×™×§×•×™: ×”×¡×¨×ª ×ª×’×•×‘×•×ª ×§×•×“ ×©×¢×œ×•×œ×•×ª ×œ×”×™×•×ª ×›×œ×•××•×ª ×‘×ª×•×š ×”×‘×œ×•×§ ×©×—×•×œ×¥ (×‘×’×œ×œ ×©×”×‘×œ×•×§ × ×—×ª×š ××ª×•×š HTML)
      // ×”×¡×¨×ª ×ª×’×•×‘×•×ª HTML (<!-- ... -->)
      jsonString = jsonString.replace(/<!--[\s\S]*?-->/g, '');
      // ×”×¡×¨×ª ×ª×’×•×‘×•×ª JavaScript ×—×“-×©×•×¨×” (// ...), ×ª×•×š × ×™×§×•×™ ×§×• ×—×“×©
      jsonString = jsonString.replace(/\/\/[^\n]*\n/g, '\n'); 
      // ×˜×™×¤×•×œ ×‘×ª×’×•×‘×” ×‘×©×•×¨×” ×”××—×¨×•× ×”
      jsonString = jsonString.replace(/\/\/[^\n]*$/, ''); 

Â  Â  Â  // 3. × ×™×§×•×™: ×”×¡×¨×ª ×¤×¡×™×§×™× ××™×•×ª×¨×™× (Trailing Commas) - ×—×©×•×‘ ×œ-JSON ×œ× ×ª×§× ×™
Â  Â  Â  jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

Â  Â  Â  // 4. × ×™×¡×™×•×Ÿ × ×™×ª×•×— JSON
Â  Â  Â  try {
Â  Â  Â  Â  const data = JSON.parse(jsonString);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Array.isArray(data) && data.length > 0) {
Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Array.isArray(data) && data.length === 0) {
Â  Â  Â  Â      throw new Error("××‘× ×” ×”-JSON × ××¦× ×ª×§×™×Ÿ, ××š ×”×•× ××¢×¨×š ×¨×™×§. (××™×Ÿ × ×ª×•× ×™×)");
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("×©×’×™××ª × ×™×ª×•×— JSON ×œ××—×¨ ×—×™×œ×•×¥ ×•× ×™×§×•×™:", e);
Â  Â  Â  Â  // ××¦×™×’ ××ª ×ª×—×™×œ×ª ×”××—×¨×•×–×ª ×©×’×¨××” ×œ×©×’×™××” (200 ×ª×•×•×™×)
Â  Â  Â  Â  const errorSnippet = jsonString.substring(0, 200).replace(/(\n|\r|\t)/g, ' ').trim() + '...';
Â  Â  Â  Â  throw new Error(`×©×’×™××ª JSON.parse: ×”××—×¨×•×–×ª ×©×—×•×œ×¦×” ("${errorSnippet}") ××™× ×” JSON ×ª×§×™×Ÿ. ×‘×“×•×§ ××ª ××‘× ×” ×”×§×•×‘×¥ ×”××§×•×¨×™.`);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  throw new Error("× ×ª×•× ×™× ×—×•×œ×¦×• ××š ×œ× ×¢×‘×¨×• ××ª ×‘×“×™×§×ª ×”××¢×¨×š ×”×ª×§×™× ×”.");
Â  Â  }
    
    /**
     * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×˜×™×¤×•×œ ×‘×©× ×•×ª ×œ×™×“×”/××•×•×ª ×›××¡×¤×¨.
     */
    function normalizeYear(year) {
        if (typeof year === 'number') return year;
        if (typeof year === 'string') {
            const num = parseInt(year.replace(/[^0-9]/g, ''), 10);
            return isNaN(num) ? null : num;
        }
        return null;
    }


Â  Â  // --- ×¤×•× ×§×¦×™×” ×¨××©×™×ª ---

Â  Â  async function loadFamilyStats() {
Â  Â  Â  const familyInfoElement = document.getElementById("family-info");
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // 1. ×©×œ×™×¤×ª ×¤×¨×˜×™ ××©×ª××© ×•×§×‘×œ×ª ×¦×“ ××©×¤×—×” ×’×•×œ××™
Â  Â  Â  Â  familyInfoElement.textContent = "×©×•×œ×£ ×¤×¨×˜×™ ××©×ª××©...";
Â  Â  Â  Â  const userResponse = await fetch('/api/user');
Â  Â  Â  Â  if (!userResponse.ok) {
Â  Â  Â  Â  Â  throw new Error('×©×’×™××” ' + userResponse.status + ': ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×˜×™ ××©×ª××©.');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userData = await userResponse.json();
Â  Â  Â  Â  const rawFamilySide = userData.user?.familySide;Â 

Â  Â  Â  Â  if (!rawFamilySide || typeof rawFamilySide !== 'string' || rawFamilySide === '×œ× ××•×’×“×¨') {
Â  Â  Â  Â  Â  throw new Error("×©×“×” 'familySide' ×—×¡×¨, ×œ× ×ª×§×™×Ÿ ××• ×œ× ××•×’×“×¨ ×‘×¤×¨×˜×™ ×”××©×ª××©. (× ×“×¨×© ×©× ××©×¤×—×” ××—×“ ××• ×™×•×ª×¨, ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×).");
Â  Â  Â  Â  }
        
        // ×¤×™×¦×•×œ ×©××•×ª ×”××©×¤×—×” ×•× ×™×§×•×™ ×¨×•×•×—×™×
        const familyNames = rawFamilySide.split(',')
            .map(name => name.trim())
            .filter(name => name.length > 0);

Â  Â  Â  Â  if (familyNames.length === 0) {
Â  Â  Â  Â  Â  throw new Error("×©×“×” 'familySide' ××›×™×œ ×ª×•×•×™×, ××š ×œ× × ××¦××• ×©××•×ª ××©×¤×—×” ×ª×§×™× ×™× ×œ×¢×™×‘×•×“ ×œ××—×¨ × ×™×§×•×™.");
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. ×©×œ×™×¤×ª ×§×‘×¦×™×, ×¦×‘×™×¨×” ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª
Â  Â  Â  Â  const allFamilyData = [];
Â  Â  Â  Â  const loadedFamilies = [];
Â  Â  Â  Â  const failedFamilies = [];

        for (const familySide of familyNames) {
Â  Â  Â  Â  Â  Â  const dataUrl = '/trees/' + familySide + '.html';
Â  Â  Â  Â  Â  Â  familyInfoElement.textContent = '×˜×•×¢×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨: ' + familySide + '...';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataResponse = await fetch(dataUrl);
Â  Â  Â  Â  Â  Â  Â  Â  if (!dataResponse.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('×©×’×™××ª ×©×¨×ª: ' + dataResponse.status);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const rawText = await dataResponse.text();
Â  Â  Â  Â  Â  Â  Â  Â  const rawData = extractFamilyData(rawText);

Â  Â  Â  Â  Â  Â  Â  Â  // ×¦×‘×™×¨×ª ×”× ×ª×•× ×™×
Â  Â  Â  Â  Â  Â  Â  Â  allFamilyData.push(...rawData);
Â  Â  Â  Â  Â  Â  Â  Â  loadedFamilies.push(familySide);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('×›×©×œ ×‘×˜×¢×™× ×ª ' + familySide + ': ' + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  failedFamilies.push({ name: familySide, message: error.message });
Â  Â  Â  Â  Â  Â  }
        }

        if (allFamilyData.length === 0) {
             let errorMsg = "×œ× × ××¦××• × ×ª×•× ×™× ×›×œ×œ ×œ×¢×™×‘×•×“ ×¡×˜×˜×™×¡×˜×™ ××›×œ ×”×§×‘×¦×™× ×©× ×™×¡×™×ª×™ ×œ×˜×¢×•×Ÿ.";
             if (failedFamilies.length > 0) {
                 errorMsg += " (× ×›×©×œ×•: " + failedFamilies.map(f => f.name).join(', ') + ")";
             }
             throw new Error(errorMsg);
        }

Â  Â  Â  Â  // 3. × ×™×§×•×™ ×•×¡×™× ×•×Ÿ × ×ª×•× ×™× ×•×”×›× ×” ×œ×ª×¨×©×™××™×
Â  Â  Â  Â  familyInfoElement.textContent = "××—×œ×¥ ×•×× ×§×” × ×ª×•× ×™×...";
Â  Â  Â  Â 
        // ×”×›× ×ª × ×ª×•× ×™× - × ×™×¨××•×œ ×©× ×•×ª ×œ×™×“×”/××•×•×ª
Â  Â  Â  Â  const cleanedData = allFamilyData
            .map(p => ({
                ...p,
                birth_year: normalizeYear(p.birth_year),
                death_year: normalizeYear(p.death_year),
                children_count: Array.isArray(p.children_ids) ? p.children_ids.length : 0,
                // ×œ×˜×•×‘×ª ×××•×¦×¢ ×™×œ×“×™×, ×× ×™×—×™× ×©××“× × ×—×©×‘ "×‘×•×’×¨" ×× × ×•×œ×“ ×œ×¤× ×™ 1970
                is_adult_for_children_avg: normalizeYear(p.birth_year) !== null && normalizeYear(p.birth_year) < 1970 
            }))
            // ×¡×™× ×•×Ÿ ×¨×§ ×©×œ ×¨×©×•××•×ª ×©×™×© ×‘×”×Ÿ ×œ×¤×—×•×ª ××™×“×¢ ××—×“ ×¨×œ×•×•× ×˜×™
            .filter(p => p.gender || p.birth_year); 

Â  Â  Â  Â  if (cleanedData.length === 0) {
Â  Â  Â  Â  Â  Â  throw new Error('×”× ×ª×•× ×™× ×—×•×œ×¦×• ×‘×”×¦×œ×—×”, ××š ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×§×™× ×•×ª ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª (×›× ×¨××” ×©×“×•×ª ××’×“×¨/×©× ×ª ×œ×™×“×” ×—×¡×¨×™×) ××ª×•×š ' + allFamilyData.length + ' ×¨×©×•××•×ª ×’×•×œ××™×•×ª.');
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. ×™×¦×™×¨×ª ×”×ª×¨×©×™××™×

        // 4.1. --- × ×ª×•× ×™ ××’×“×¨ (Pie Chart) ---
Â  Â  Â  Â  const males = cleanedData.filter(p => p.gender === "M").length;
Â  Â  Â  Â  const females = cleanedData.filter(p => p.gender === "F").length;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const GENDER_COLORS = ["#3b82f6", "#10b981"];
Â  Â  Â  Â  const ctxGender = document.getElementById("genderChart").getContext("2d");
Â  Â  Â  Â  new Chart(ctxGender, {
Â  Â  Â  Â  Â  type: "pie",
Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: ["×–×›×¨×™×", "× ×§×‘×•×ª"],
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  data: [males, females],
Â  Â  Â  Â  Â  Â  Â  backgroundColor: GENDER_COLORS,
Â  Â  Â  Â  Â  Â  Â  borderColor: '#ffffff',
Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  hoverOffset: 15
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â responsive: true,
Â  Â  Â  Â  Â  Â  Â plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  legend: { position: 'bottom' },
Â  Â  Â  Â  Â  Â  Â  Â  tooltip: { rtl: true }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 4.2. --- × ×ª×•× ×™ ×“×•×¨×•×ª (Bar Chart) - ×œ×¤×™ ×—×œ×•×§×” ×©×œ 25 ×©× ×” ---
Â  Â  Â  Â  const generations = {};
Â  Â  Â  Â  const BASE_YEAR = 1800;
Â  Â  Â  Â  const GENERATION_SPAN = 25;
Â  Â  Â  Â Â 
Â  Â  Â  Â  cleanedData.forEach(p => {
Â  Â  Â  Â  Â  const year = p.birth_year;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (typeof year !== 'number' || year === null || year < BASE_YEAR || year > new Date().getFullYear()) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const genIndex = Math.floor((year - BASE_YEAR) / GENERATION_SPAN);Â 
Â  Â  Â  Â  Â  generations[genIndex] = (generations[genIndex] || 0) + 1;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sortedGenerations = Object.entries(generations).sort((a, b) => +a[0] - +b[0]);

Â  Â  Â  Â  const genLabels = sortedGenerations.map(([index, count]) => {
Â  Â  Â  Â  Â  Â  const startYear = BASE_YEAR + (+index * GENERATION_SPAN);
Â  Â  Â  Â  Â  Â  const endYear = startYear + GENERATION_SPAN - 1;
Â  Â  Â  Â  Â  Â  return startYear + ' - ' + endYear;
Â  Â  Â  Â  });
Â  Â  Â  Â  const genValues = sortedGenerations.map(([index, count]) => count);

Â  Â  Â  Â  const BAR_COLOR = "#4f46e5";
Â  Â  Â  Â  const ctxGeneration = document.getElementById("generationChart").getContext("2d");
Â  Â  Â  Â  new Chart(ctxGeneration, {
Â  Â  Â  Â  Â  type: "bar",
Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: genLabels,
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  label: "××¡×¤×¨ ×× ×©×™×",
Â  Â  Â  Â  Â  Â  Â  data: genValues,
Â  Â  Â  Â  Â  Â  Â  backgroundColor: BAR_COLOR,
Â  Â  Â  Â  Â  Â  Â  borderColor: BAR_COLOR,
Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  y: { beginAtZero: true, title: { display: true, text: '×›××•×ª ×× ×©×™×' } },
Â  Â  Â  Â  Â  Â  Â  x: { reverse: true, title: { display: true, text: '×©× ×•×ª ×œ×™×“×”' } }Â 
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  tooltip: { rtl: true }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

        // 4.3. --- ×××•×¦×¢ ××•×¨×š ×—×™×™× (Bar Chart) ---
        const lifeSpanData = cleanedData.filter(p => p.birth_year && p.death_year && p.death_year > p.birth_year);
        const lifeSpansByDecade = {};

        lifeSpanData.forEach(p => {
            const decade = Math.floor(p.birth_year / 10) * 10;
            const lifeSpan = p.death_year - p.birth_year;
            if (!lifeSpansByDecade[decade]) {
                lifeSpansByDecade[decade] = { total: 0, count: 0 };
            }
            lifeSpansByDecade[decade].total += lifeSpan;
            lifeSpansByDecade[decade].count++;
        });

        const sortedLifeSpans = Object.entries(lifeSpansByDecade).sort((a, b) => +a[0] - +b[0]);

        const lifeSpanLabels = sortedLifeSpans.map(([decade, data]) => `${decade} - ${+decade + 9}`);
        const avgLifeSpans = sortedLifeSpans.map(([decade, data]) => (data.total / data.count).toFixed(1));

        const LIFESPAN_COLOR = "#059669";
        const ctxLifeExpectancy = document.getElementById("lifeExpectancyChart").getContext("2d");
        new Chart(ctxLifeExpectancy, {
            type: "bar",
            data: {
                labels: lifeSpanLabels,
                datasets: [{
                    label: "××•×¨×š ×—×™×™× ×××•×¦×¢",
                    data: avgLifeSpans,
                    backgroundColor: LIFESPAN_COLOR,
                    borderColor: LIFESPAN_COLOR,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '×©× ×™×' } },
                    x: { reverse: true, title: { display: true, text: '×¢×©×•×¨ ×œ×™×“×”' } }Â 
                },
                plugins: {
                    tooltip: { rtl: true }
                }
            }
        });
        
        // 4.4. --- ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨ (Line Chart) ---
        const birthTrend = {};
        cleanedData.forEach(p => {
            if (p.birth_year) {
                const decade = Math.floor(p.birth_year / 10) * 10;
                birthTrend[decade] = (birthTrend[decade] || 0) + 1;
            }
        });

        const sortedBirthTrend = Object.entries(birthTrend).sort((a, b) => +a[0] - +b[0]);
        const trendLabels = sortedBirthTrend.map(([decade, count]) => decade);
        const trendValues = sortedBirthTrend.map(([decade, count]) => count);
        
        const TREND_COLOR = "#f59e0b";
        const ctxBirthTrend = document.getElementById("birthTrendChart").getContext("2d");
        new Chart(ctxBirthTrend, {
            type: "line",
            data: {
                labels: trendLabels,
                datasets: [{
                    label: "××¡×¤×¨ ×œ×™×“×•×ª",
                    data: trendValues,
                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                    borderColor: TREND_COLOR,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '×›××•×ª ×œ×™×“×•×ª' } },
                    x: { reverse: true, title: { display: true, text: '×¢×©×•×¨' } }Â 
                },
                plugins: {
                    tooltip: { rtl: true }
                }
            }
        });
        
        // 4.5. --- ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (Bar Chart) ---
        const childrenAvg = {};
        let totalChildrenCount = 0;
        let totalAdultsCount = 0;
        
        cleanedData.filter(p => p.is_adult_for_children_avg).forEach(p => {
            const genIndex = Math.floor(p.birth_year / GENERATION_SPAN); // ×”×©×ª××© ×‘×—×œ×•×§×” ×©×œ 25 ×©× ×” ×©×•×‘
            const generationStartYear = genIndex * GENERATION_SPAN;
            
            if (!childrenAvg[generationStartYear]) {
                childrenAvg[generationStartYear] = { totalChildren: 0, adultCount: 0 };
            }
            
            childrenAvg[generationStartYear].totalChildren += p.children_count;
            childrenAvg[generationStartYear].adultCount++;
        });

        const sortedChildrenAvg = Object.entries(childrenAvg).sort((a, b) => +a[0] - +b[0]);

        const avgChildrenLabels = sortedChildrenAvg.map(([year, data]) => `${year} - ${+year + GENERATION_SPAN - 1}`);
        const avgChildrenValues = sortedChildrenAvg.map(([year, data]) => (data.totalChildren / data.adultCount).toFixed(1));

        const CHILDREN_COLOR = "#ef4444";
        const ctxAvgChildren = document.getElementById("avgChildrenChart").getContext("2d");
        new Chart(ctxAvgChildren, {
            type: "bar",
            data: {
                labels: avgChildrenLabels,
                datasets: [{
                    label: "×××•×¦×¢ ×™×œ×“×™×",
                    data: avgChildrenValues,
                    backgroundColor: CHILDREN_COLOR,
                    borderColor: CHILDREN_COLOR,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '×××•×¦×¢ ×™×œ×“×™× ×œ××“×' } },
                    x: { reverse: true, title: { display: true, text: '×“×•×¨ ×œ×™×“×”' } }Â 
                },
                plugins: {
                    tooltip: { rtl: true }
                }
            }
        });


Â  Â  Â  Â  // 5. ×¡×™×•× ×˜×¢×™× ×”
Â  Â  Â  Â  document.getElementById("loading").style.display = "none";
Â  Â  Â  Â  document.getElementById("main-content").style.display = "block";
Â  Â  Â  Â  
        let statusMessage = '×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×¢×‘×•×¨ ×”××©×¤×—×•×ª: <b>' + loadedFamilies.join(', ') + '</b>. ×¡×š ×× ×©×™× ××¢×•×‘×“×™×: ' + cleanedData.length;
        
        if (failedFamilies.length > 0) {
            statusMessage += '. <br><span class="text-yellow-600 font-bold">×©×™××• ×œ×‘: × ×›×©×œ×” ×˜×¢×™× ×” ×¢×‘×•×¨: ' + failedFamilies.map(f => f.name).join(', ') + '.</span>';
        }

Â  Â  Â  Â  familyInfoElement.innerHTML = '<span class="text-green-700 font-semibold">' + statusMessage + '</span>';


Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("×©×’×™××” ×§×¨×™×˜×™×ª:", error);
Â  Â  Â  Â  displayError('××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message);
Â  Â  Â  }
Â  Â  }

Â  Â  // ×”×¤×¢×œ×ª ×”×¤×•× ×§×¦×™×” ×œ××—×¨ ×˜×¢×™× ×ª ×”×“×£
Â  Â  window.onload = loadFamilyStats;
Â  </script>
</body>
</html>
