<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title> 住住拽转 砖驻转转</title>

 <!-- Tailwind CSS CDN for styling -->
 <script src="https://cdn.tailwindcss.com"></script>
 <!-- Heebo Font link -->
 <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap" rel="stylesheet">

 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <style>
  /* 专转 驻 专砖  祝 */
  body { font-family: 'Heebo', sans-serif; }
  /*  砖转专砖  专住驻住 转 专住 */
  canvas { max-width: 100%; height: auto; }
 </style>
</head>
<body class="bg-gray-50 min-h-screen text-right p-4 sm:p-8">
 <div class="max-w-6xl mx-auto">

  <!-- 转专转 专砖转 注转 住住 -->
  <header class="mb-10 text-center">
    <h1 id="main-title" class="text-6xl font-extrabold text-blue-800 mb-3 flex items-center justify-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
      </svg>
      住住拽转 注抓 砖驻转
    </h1>
    <p class="status-message text-lg text-gray-600 font-medium" id="family-info">注 爪 砖驻...</p>
  </header>

  <!-- 住 注 -->
  <div id="loading" class="flex justify-center items-center h-40">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    <span class="text-xl text-gray-700 mr-4">注 转...  转.</span>
  </div>
 
  <!-- 转 专砖: 爪 专 注 -->
  <div id="main-content" class="space-y-10" style="display: none;">
  
   <!-- 拽专 转专砖 - 专砖转 专住驻住转: 专  驻, 砖 专 住  -->
   <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
   
    <!-- 专住 转专砖 专 -->
    <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
     <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
       转驻转 驻 专 (专  拽转)
     </h2>
     <canvas id="genderChart"></canvas>
    </div>
   
    <!-- 专住 转专砖 专转 -->
    <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
     <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
       转驻转 驻 专 ( 25 砖)
     </h2>
     <canvas id="generationChart"></canvas>
    </div>
   </div>
  </div>
 </div>

 <script>
  // --- 驻拽爪转 注专 ---

  function displayError(message) {
   document.getElementById("loading").style.display = "none";
   const mainContent = document.getElementById("main-content");
   mainContent.style.display = "block";
  
   const familyInfoElement = document.getElementById("family-info");
   familyInfoElement.innerHTML = '<span class="text-red-600 font-bold bg-red-100 p-2 rounded">' + message + '</span>';
  
   document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
   document.getElementById("main-title").style.display = "none";
  }

  /**
  * 驻拽爪 拽 抓 注专 JSON 砖 转 转 拽住  ( 拽抓 HTML).
  * 驻砖转 转 拽 "[...]"  拽 转注转  转 住祝 抓 转 -JSON.
  */
  function extractFamilyData(rawText) {
   
   // 1. 驻砖 爪转 -JSON 爪注转 Regular Expression
   // 驻砖 注专 ([...])  驻转 拽 驻转 ({)
   // s - 驻砖专 拽 砖转转  转  砖专转 砖转
   // ? - 驻 转 -* - (non-greedy), 专 转 -[...] 拽爪专 转专
   // Trim: 住专 专 驻 专.
   const jsonMatch = rawText.match(/(\s*\[\s*\{[\s\S]*\}\s*\]\s*)/);

   if (!jsonMatch) {
    throw new Error(" 爪 拽 JSON 转拽 (注专 驻转  拽  驻转) 转 拽抓.");
   }
  
   // 转驻住 转 转爪  砖 拽爪 专砖 (砖转 转  专 住 转 [])
   let jsonString = jsonMatch[1].trim(); 

   // 2. 拽: 住专转 转转 拽 砖注转 转 转 转 拽 砖抓 ( 砖拽 转 转 HTML)
      // 住专转 转转 HTML (<!-- ... -->)
      jsonString = jsonString.replace(/<!--[\s\S]*?-->/g, '');
      // 住专转 转转 JavaScript -砖专 (// ...), 转 拽 拽 砖
      jsonString = jsonString.replace(/\/\/[^\n]*\n/g, '\n'); 
      // 驻 转 砖专 专
      jsonString = jsonString.replace(/\/\/[^\n]*$/, ''); 

   // 3. 拽: 住专转 驻住拽 转专 (Trailing Commas) - 砖 -JSON  转拽
   jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

   // 4. 住 转 JSON
   try {
    const data = JSON.parse(jsonString);
   
    if (Array.isArray(data) && data.length > 0) {
     return data;
    }
   
    if (Array.isArray(data) && data.length === 0) {
        throw new Error(" -JSON 爪 转拽,   注专 专拽. ( 转)");
    }
   } catch (e) {
    console.error("砖转 转 JSON 专 抓 拽:", e);
    // 爪 转 转转 专转 砖专 砖 (200 转)
    const errorSnippet = jsonString.substring(0, 200).replace(/(\n|\r|\t)/g, ' ').trim() + '...';
    throw new Error(`砖转 JSON.parse: 专转 砖爪 ("${errorSnippet}")  JSON 转拽. 拽 转  拽抓 拽专.`);
   }
  
   throw new Error("转 爪   注专 转 拽转 注专 转拽.");
  }


  // --- 驻拽爪 专砖转 (注 拽 砖 专 拽爪) ---

  async function loadFamilyStats() {
   const familyInfoElement = document.getElementById("family-info");
  
   try {
    // 1. 砖驻转 驻专 砖转砖 拽转 爪 砖驻 
    familyInfoElement.textContent = "砖祝 驻专 砖转砖...";
    const userResponse = await fetch('/api/user');
    if (!userResponse.ok) {
     throw new Error('砖 ' + userResponse.status + ':  转 注 驻专 砖转砖.');
    }
   
    const userData = await userResponse.json();
    const rawFamilySide = userData.user?.familySide;

    if (!rawFamilySide || typeof rawFamilySide !== 'string' || rawFamilySide === ' 专') {
     throw new Error("砖 'familySide' 住专,  转拽   专 驻专 砖转砖. (专砖 砖 砖驻   转专, 驻专 驻住拽).");
    }
        
        // 驻爪 砖转 砖驻 拽 专
        const familyNames = rawFamilySide.split(',')
            .map(name => name.trim())
            .filter(name => name.length > 0);

    if (familyNames.length === 0) {
     throw new Error("砖 'familySide'  转,   爪 砖转 砖驻 转拽 注 专 拽.");
    }

    // 2. 砖驻转 拽爪, 爪专 驻 砖转
    const allFamilyData = [];
    const loadedFamilies = [];
    const failedFamilies = [];

        for (const familySide of familyNames) {
      const dataUrl = '/trees/' + familySide + '.html';
      familyInfoElement.textContent = '注 转 注专: ' + familySide + '...';

      try {
        const dataResponse = await fetch(dataUrl);
        if (!dataResponse.ok) {
          // 专 砖 拽抓 住驻爪驻,  专拽 Error  驻砖专 注转 拽爪 专
          throw new Error('砖转 砖专转: ' + dataResponse.status);
        }

        const rawText = await dataResponse.text();
        const rawData = extractFamilyData(rawText);

        // 爪专转 转
        allFamilyData.push(...rawData);
        loadedFamilies.push(familySide);

      } catch (error) {
        console.warn('砖 注转 ' + familySide + ': ' + error.message);
        failedFamilies.push({ name: familySide, message: error.message });
      }
        }

        if (allFamilyData.length === 0) {
             let errorMsg = " 爪 转  注 住住  拽爪 砖住转 注.";
             if (failedFamilies.length > 0) {
                 errorMsg += " (砖: " + failedFamilies.map(f => f.name).join(', ') + ")";
             }
             throw new Error(errorMsg);
        }

    // 3. 拽 住 转 - 爪注 注 注专  (allFamilyData)
    familyInfoElement.textContent = "抓 拽 转...";
   
    const cleanedData = allFamilyData.filter(p => {
     if (!p || typeof p !== 'object') return false;
    
     const hasValidGender = p.gender && (p.gender === "M" || p.gender === "F");
     const isBirthYearValid = typeof p.birth_year === 'number' && p.birth_year > 1500 && p.birth_year <= new Date().getFullYear();
    
     //  拽 砖转  专转 "c. 1850",  住 拽转 转 转 
     let birthYear = p.birth_year;
     if (typeof birthYear === 'string') {
      // 住 驻 专转 砖 转  拽 住驻专
      birthYear = parseInt(birthYear.replace(/[^0-9]/g, ''), 10);
     }
     
     p.birth_year = birthYear; // 注 转 拽 拽专 注 转 住驻专 拽
     
     return hasValidGender || (typeof birthYear === 'number' && birthYear > 1500);
    });

    if (cleanedData.length === 0) {
      throw new Error('转 爪 爪,   爪 专砖转 转拽转 住住拽转 (专 砖转 专/砖转  住专) 转 ' + allFamilyData.length + ' 专砖转 转.');
    }

    // 4. 注 爪转 转专砖 (砖转砖 -cleanedData )
   
    // --- 转 专 (Pie Chart) ---
    const males = cleanedData.filter(p => p.gender === "M").length;
    const females = cleanedData.filter(p => p.gender === "F").length;
   
    const GENDER_COLORS = ["#3b82f6", "#10b981"];
    const ctxGender = document.getElementById("genderChart").getContext("2d");
    new Chart(ctxGender, {
     type: "pie",
     data: {
      labels: ["专", "拽转"],
      datasets: [{
       data: [males, females],
       backgroundColor: GENDER_COLORS,
       borderColor: '#ffffff',
       borderWidth: 2,
       hoverOffset: 15
      }]
     },
     options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { rtl: true }
      }
     }
    });

    // --- 转 专转 (Bar Chart) ---
    const generations = {};
    const BASE_YEAR = 1800;
    const GENERATION_SPAN = 25;
   
    cleanedData.forEach(p => {
     const year = p.birth_year;
    
     if (typeof year !== 'number' || year === null || year < BASE_YEAR || year > new Date().getFullYear()) {
      return;
     }

     const genIndex = Math.floor((year - BASE_YEAR) / GENERATION_SPAN);
     generations[genIndex] = (generations[genIndex] || 0) + 1;
    });
   
    const sortedGenerations = Object.entries(generations).sort((a, b) => +a[0] - +b[0]);

    const genLabels = sortedGenerations.map(([index, count]) => {
      const startYear = BASE_YEAR + (+index * GENERATION_SPAN);
      const endYear = startYear + GENERATION_SPAN - 1;
      return startYear + ' - ' + endYear;
    });
    const genValues = sortedGenerations.map(([index, count]) => count);

    const BAR_COLOR = "#4f46e5";
    const ctxGeneration = document.getElementById("generationChart").getContext("2d");
    new Chart(ctxGeneration, {
     type: "bar",
     data: {
      labels: genLabels,
      datasets: [{
       label: "住驻专 砖",
       data: genValues,
       backgroundColor: BAR_COLOR,
       borderColor: BAR_COLOR,
       borderWidth: 1
      }]
     },
     options: {
      responsive: true,
      scales: {
       y: { beginAtZero: true },
       x: { reverse: true }
      },
      plugins: {
       tooltip: { rtl: true }
      }
     }
    });

    // 5. 住 注
    document.getElementById("loading").style.display = "none";
    document.getElementById("main-content").style.display = "block";
    
        let statusMessage = '转 注 爪 注专 砖驻转: <b>' + loadedFamilies.join(', ') + '</b>. 住 砖 注: ' + cleanedData.length;
        
        if (failedFamilies.length > 0) {
            statusMessage += '. <br><span class="text-yellow-600 font-bold">砖 : 砖 注 注专: ' + failedFamilies.map(f => f.name).join(', ') + '.</span>';
        }

    familyInfoElement.innerHTML = '<span class="text-green-700 font-semibold">' + statusMessage + '</span>';


   } catch (error) {
    console.error("砖 拽专转:", error);
    displayError('专注 砖 注转 转: ' + error.message);
   }
  }

  // 驻注转 驻拽爪 专 注转 祝
  window.onload = loadFamilyStats;
 </script>
</body>
</html>
