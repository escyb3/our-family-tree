<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title-display">ğŸ“Š×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</title>
    
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Heebo Font link -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js V4.x -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* ×”×’×“×¨×ª ×”×¤×•× ×˜ ×”×¨××©×™ ×œ×›×œ ×”×“×£ */
        body { font-family: 'Heebo', sans-serif; }
        /* ×›×“×™ ×©×”×ª×¨×©×™××™× ×™×”×™×• ×¨×¡×¤×•× ×¡×™×‘×™×™× ×‘×ª×•×š ×”×›×¨×˜×™×¡×™× */
        canvas { max-width: 100%; height: auto; }
        
        /* ×¡×’× ×•×Ÿ ×œ××¡×š ×”×˜×¢×™× ×” ×”×—×“×© - ××¨×›×– ××ª ×”×›×œ ×•××‘×˜×™×— ××¨××” × ×§×™ */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.5s ease;
        }

        /* ×¢×™×¦×•×‘ ×¡×¤×™× ×¨ (Spinner) ××•×ª×× */
        .loading-animation {
            border: 6px solid #e0e7ff; /* Light indigo */
            border-top: 6px solid #4f46e5; /* Main indigo */
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ×”×•×¡×¤×ª ×›×™×•×•× ×™×•×ª ×˜×§×¡×˜ ×›×œ×œ×™×ª, × ×“×¨×©×ª ×‘××™×•×—×“ ×œ×˜×§×¡×˜ ×× ×’×œ×™×ª ×‘×¡×‘×™×‘×” ×¢×‘×¨×™×ª */
        .ltr { direction: ltr; }
        .rtl { direction: rtl; }

        /* ×¡×’× ×•×Ÿ ×œ×›×¨×˜×™×¡×™ ×”×ª×¨×©×™× */
        .chart-container {
            border-radius: 1.5rem; /* rounded-3xl */
            transition: all 0.3s ease-in-out;
            border: 1px solid #f3f4f6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }
        .chart-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }
        
        /* ×¡×’× ×•×Ÿ ×œ×›×•×ª×¨×•×ª ×”×ª×¨×©×™××™× */
        .chart-container h2 {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 800; /* font-extrabold */
            line-height: 1.2;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-right rtl">
    
    <!-- ××¡×š ×˜×¢×™× ×” - ××•×¤×™×¢ ×¨××©×•×Ÿ ×•××›×¡×” ××ª ×›×œ ×”××¡×š -->
    <div id="loading">
        <div class="loading-animation mb-6"></div>
        <span class="text-2xl font-semibold text-gray-700" id="loading-text">×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.</span>
    </div>

    <!-- ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×©×¤×” (×§×‘×•×¢ ×œ××¢×œ×” ××™××™×Ÿ ××• ××©×××œ ×œ×¤×™ ×›×™×•×•×Ÿ) -->
    <div class="fixed top-4 right-4 z-20">
        <button id="lang-toggle-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
            English
        </button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-8">

        <!-- ×›×•×ª×¨×ª ×¨××©×™×ª ×•×”×•×“×¢×ª ×¡×˜×˜×•×¡ -->
        <header class="mb-12 text-center bg-white p-6 md:p-10 rounded-3xl shadow-xl">
            <h1 id="main-title" class="text-6xl font-extrabold text-indigo-900 mb-4 flex items-center justify-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
                </svg>
                <span id="main-title-text">×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</span>
            </h1>
            <p class="status-message text-xl text-gray-700 font-medium" id="family-info">×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...</p>
        </header>

        
        <!-- ×ª×•×›×Ÿ ×¨××©×™: ×™×•×¦×’ ×œ××—×¨ ×”×˜×¢×™× ×” -->
        <div id="main-content" class="space-y-12" style="display: none;">
            
            <!-- ×©×•×¨×” ×—×“×©×”: ×¡×™×›×•× × ×ª×•× ×™× ×›×œ×œ×™ (Data Summary) -->
            <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-6 lg:gap-8">
                <!-- ×”×›×¨×˜×™×¡×™× ×™××•×œ××• ×¢"×™ JS -->
            </div>
            
            <!-- ×©×•×¨×” 1: ××’×“×¨ ×•×“×•×¨×•×ª -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ××’×“×¨ -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartGenderTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-indigo-200">
                        ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)
                    </h2>
                    <canvas id="genderChart"></canvas>
                </div>
                
                <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ×“×•×¨×•×ª -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartGenerationTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-indigo-200">
                        ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)
                    </h2>
                    <canvas id="generationChart"></canvas>
                </div>
            </div>
            
            <!-- ×©×•×¨×” 2: ××•×¨×š ×—×™×™× ×××•×¦×¢ ×•×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ××•×¨×š ×—×™×™× -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartLifeExpectancyTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-green-200">
                        ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)
                    </h2>
                    <canvas id="lifeExpectancyChart"></canvas>
                </div>

                <!-- ×›×¨×˜×™×¡ ××’××ª ×œ×™×“×•×ª -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartBirthTrendTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-green-200">
                        ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨
                    </h2>
                    <canvas id="birthTrendChart"></canvas>
                </div>
            </div>
            
            <!-- ×©×•×¨×” 3: ×××•×¦×¢ ×™×œ×“×™× ×•×”×ª×¤×œ×’×•×ª ×’×™×œ××™× -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ×™×œ×“×™× -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartAvgChildrenTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-red-200">
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)
                        <span id="adults-note" class="text-sm font-normal text-gray-500 block mt-1">(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)</span>
                    </h2>
                    <canvas id="avgChildrenChart"></canvas>
                </div>
                
                <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× (×—×“×©) -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartAgeDistributionTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-purple-200">
                        ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª
                    </h2>
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>

            <!-- ×©×•×¨×” 4: ×¡×˜×˜×™×¡×˜×™×§×•×ª ×—×“×©×•×ª - ××¦×‘ ××©×¤×—×ª×™ ×•×©××•×ª × ×¤×•×¦×™× -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ××¦×‘ ××©×¤×—×ª×™ (×—×“×©) -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartMaritalStatusTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-pink-200">
                        ğŸ’ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××¦×‘ ××©×¤×—×ª×™
                    </h2>
                    <canvas id="maritalStatusChart"></canvas>
                </div>

                <!-- ×›×¨×˜×™×¡ 10 ×”×©××•×ª ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨ (×—×“×©) -->
                <div class="chart-container bg-white p-6 shadow-xl">
                    <h2 id="chartMostCommonNamesTitle" class="text-3xl font-extrabold text-gray-800 border-b-4 border-yellow-200">
                        ğŸ“› 10 ×”×©××•×ª ×”×¤×¨×˜×™×™× ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨
                    </h2>
                    <canvas id="mostCommonNamesChart"></canvas>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        // --- ×”×’×“×¨×•×ª ×•×©×¤×ª ×××©×§ ---
        let currentLang = 'HE'; // ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ: ×¢×‘×¨×™×ª
        let cleanedData = []; // ××—×¡×•×Ÿ ×”× ×ª×•× ×™× ×”×× ×•×§×™×
        let summaryData = {}; // ××—×¡×•×Ÿ × ×ª×•× ×™ ×¡×™×›×•× ×›×œ×œ×™×™×
        let chartInstances = {}; // ××—×¡×•×Ÿ ××•×¤×¢×™ ×ª×¨×©×™××™× ×œ×˜×•×‘×ª ×¢×“×›×•×Ÿ/××—×™×§×”

        
        // ×¤×œ×˜×ª ×¦×‘×¢×™× ×’× ×¨×™×ª ××•×ª×××ª ×œ-Tailwind
        const COLOR_PALETTE = {
            PRIMARY: '#4f46e5', // Indigo-600
            SECONDARY: '#10b981', // Emerald-500 (Green)
            TERTIARY: '#ef4444', // Red-500
            ACCENT: '#f59e0b', // Amber-500 (Orange/Yellow)
            PIE_MALE: '#3b82f6', // Blue-500
            PIE_FEMALE: '#ec4899', // Pink-500
            PIE_DIVORCED: '#f97316', // Orange-500
            PIE_WIDOWED: '#6b7280', // Gray-500
            PIE_OTHER: '#9ca3af', // Gray-400
            PIE_MARRIED: '#4f46e5', // Indigo-600
            PIE_SINGLE: '#10b981', // Emerald-500
            AGE_CURRENT: '#8b5cf6', // Violet-500
            AGE_DEATH: '#f87171', // Red-400
            NAME_BARS: ['#4f46e5', '#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#ec4899', '#f97316', '#6b7280', '#8b5cf6', '#f87171']
        };

        const translations = {
            'HE': {
                // ×›×•×ª×¨×•×ª
                'pageTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
                'mainTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
                'statusLoading': '×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...',
                'loadingText': '×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.',
                'chartGenderTitle': 'ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)',
                'chartGenerationTitle': 'ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)',
                'chartLifeExpectancyTitle': 'ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)',
                'chartBirthTrendTitle': 'ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨',
                'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)',
                'chartAgeDistributionTitle': 'ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª',
                'chartMaritalStatusTitle': 'ğŸ’ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××¦×‘ ××©×¤×—×ª×™', 
                'chartMostCommonNamesTitle': 'ğŸ“› 10 ×”×©××•×ª ×”×¤×¨×˜×™×™× ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨', 
                'adultsNote': '(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)',
                // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
                'genderMale': '×–×›×¨×™×',
                'genderFemale': '× ×§×‘×•×ª',
                'peopleCount': '××¡×¤×¨ ×× ×©×™×',
                'birthYears': '×©× ×•×ª ×œ×™×“×”',
                'avgLifeSpan': '××•×¨×š ×—×™×™× ×××•×¦×¢',
                'years': '×©× ×™×',
                'birthDecade': '×¢×©×•×¨ ×œ×™×“×”',
                'birthCount': '×›××•×ª ×œ×™×“×•×ª',
                'decade': '×¢×©×•×¨',
                'avgChildren': '×××•×¦×¢ ×™×œ×“×™×',
                'generation': '×“×•×¨ ×œ×™×“×”',
                'currentAge': '×’×™×œ × ×•×›×—×™ (×—×™×™×)',
                'ageAtDeath': '×’×™×œ ××•×•×ª (× ×¤×˜×¨×™×)',
                'ageBins': '×˜×•×•×— ×’×™×œ××™×',
                // ×œ×™×™×‘×œ×™× ×œ××¦×‘ ××©×¤×—×ª×™
                'statusM': '× ×©×•×™/×”',
                'statusS': '×¨×•×•×§/×”',
                'statusD': '×’×¨×•×©/×”',
                'statusW': '××œ××Ÿ/×”',
                'statusU': '××—×¨/×œ× ×™×“×•×¢',
                'firstName': '×©× ×¤×¨×˜×™',
                'langButton': 'English',
                // ×¡×™×›×•× × ×ª×•× ×™× ×›×œ×œ×™
                'sumTotalPeople': '×¡×š ×× ×©×™×',
                'sumAvgCurrentAge': '×’×™×œ ×××•×¦×¢ × ×•×›×—×™',
                'sumAvgDeathAge': '×’×™×œ ×××•×¦×¢ ×‘××•×•×ª',
                'sumPercentFemale': '××—×•×– × ×§×‘×•×ª'
            },
            'EN': {
                'pageTitle': 'Extended Family Tree Statistics',
                'mainTitle': 'Extended Family Tree Statistics',
                'statusLoading': 'Loading family side...',
                'loadingText': 'Loading data... Please wait.',
                'chartGenderTitle': 'ğŸ‘¤ Gender Distribution (Male vs. Female)',
                'chartGenerationTitle': 'ğŸ“… Distribution by Generation (25-year span)',
                'chartLifeExpectancyTitle': 'ğŸ’– Average Life Expectancy by Birth Period (Years)',
                'chartBirthTrendTitle': 'ğŸ“ˆ Birth Trend by Decade',
                'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Average Children Per Person (by Birth Generation)',
                'chartAgeDistributionTitle': 'ğŸ‘¶ Current Age and Age at Death Distribution',
                'chartMaritalStatusTitle': 'ğŸ’ Marital Status Distribution', 
                'chartMostCommonNamesTitle': 'ğŸ“› Top 10 Most Common First Names', 
                'adultsNote': '(Includes only generations who reached adulthood)',
                // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
                'genderMale': 'Males',
                'genderFemale': 'Females',
                'peopleCount': 'Number of People',
                'birthYears': 'Birth Years',
                'avgLifeSpan': 'Average Life Span',
                'years': 'Years',
                'birthDecade': 'Birth Decade',
                'birthCount': 'Birth Count',
                'decade': 'Decade',
                'avgChildren': 'Average Children',
                'generation': 'Birth Generation',
                'currentAge': 'Current Age (Living)',
                'ageAtDeath': 'Age at Death (Deceased)',
                'ageBins': 'Age Bins',
                // ×œ×™×™×‘×œ×™× ×œ××¦×‘ ××©×¤×—×ª×™
                'statusM': 'Married',
                'statusS': 'Single',
                'statusD': 'Divorced',
                'statusW': 'Widowed',
                'statusU': 'Other/Unknown',
                'firstName': 'First Name',
                'langButton': '×¢×‘×¨×™×ª',
                // ×¡×™×›×•× × ×ª×•× ×™× ×›×œ×œ×™
                'sumTotalPeople': 'Total People',
                'sumAvgCurrentAge': 'Avg Current Age',
                'sumAvgDeathAge': 'Avg Age at Death',
                'sumPercentFemale': 'Percent Female'
            }
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•-UI ---
        
        function T(key) { return translations[currentLang][key] || key; }
        
        function updateUI() {
            const texts = translations[currentLang];
            // ×¢×“×›×•×Ÿ ×˜×§×¡×˜×™× ×§×‘×•×¢×™×
            if (document.getElementById('page-title-display')) document.getElementById('page-title-display').textContent = texts.pageTitle;
            if (document.getElementById('main-title-text')) document.getElementById('main-title-text').textContent = texts.mainTitle;
            if (document.getElementById('loading-text')) document.getElementById('loading-text').textContent = texts.loadingText;
            
            // ×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª ×ª×¨×©×™××™× (×¤×—×•×ª ×¨×œ×•×•× ×˜×™ ××‘×œ ×˜×•×‘ ×œ×©××™×¨×”)
            if (document.getElementById('chartGenderTitle')) document.getElementById('chartGenderTitle').textContent = texts.chartGenderTitle;
            if (document.getElementById('chartGenerationTitle')) document.getElementById('chartGenerationTitle').textContent = texts.chartGenerationTitle;
            if (document.getElementById('chartLifeExpectancyTitle')) document.getElementById('chartLifeExpectancyTitle').textContent = texts.chartLifeExpectancyTitle;
            if (document.getElementById('chartBirthTrendTitle')) document.getElementById('chartBirthTrendTitle').textContent = texts.chartBirthTrendTitle;
            if (document.getElementById('chartAvgChildrenTitle')) document.getElementById('chartAvgChildrenTitle').textContent = texts.chartAvgChildrenTitle;
            if (document.getElementById('chartAgeDistributionTitle')) document.getElementById('chartAgeDistributionTitle').textContent = texts.chartAgeDistributionTitle;
            if (document.getElementById('chartMaritalStatusTitle')) document.getElementById('chartMaritalStatusTitle').textContent = texts.chartMaritalStatusTitle; 
            if (document.getElementById('chartMostCommonNamesTitle')) document.getElementById('chartMostCommonNamesTitle').textContent = texts.chartMostCommonNamesTitle; 
            
            if (document.getElementById('adults-note')) document.getElementById('adults-note').textContent = texts.adultsNote;
            if (document.getElementById('lang-toggle-button')) document.getElementById('lang-toggle-button').textContent = texts.langButton;
            
            // ×¢×“×›×•×Ÿ ×›×™×•×•× ×™×•×ª ×”×“×£
            const dir = currentLang === 'HE' ? 'rtl' : 'ltr';
            document.documentElement.setAttribute('dir', dir);
            document.body.classList.remove('rtl', 'ltr');
            document.body.classList.add(dir);
            document.body.classList.toggle('text-right', currentLang === 'HE');
            document.body.classList.toggle('text-left', currentLang === 'EN');
            
            // ×¦×™×•×¨ ××—×“×© ×©×œ ×›×œ ×”×ª×¨×©×™××™× ×•×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×”×¡×™×›×•×
            if (cleanedData.length > 0) {
                renderSummaryCards(summaryData, currentLang); // ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×”×¡×™×›×•×
                renderAllCharts(cleanedData, currentLang);
            }
        }
        
        function displayError(message) {
            const loadingElement = document.getElementById("loading");
            if (loadingElement) loadingElement.style.display = "none";
            
            const mainContent = document.getElementById("main-content");
            if (mainContent) mainContent.style.display = "block";
            
            const familyInfoElement = document.getElementById("family-info");
            if (familyInfoElement) familyInfoElement.innerHTML = '<span class="text-red-600 font-bold bg-red-100 p-3 rounded-xl shadow-inner inline-block">' + message + '</span>';
            
            const mainTitleElement = document.getElementById("main-title");
            if (mainTitleElement) mainTitleElement.style.display = "none";

            document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
            const summaryCardsElement = document.getElementById('summary-cards');
            if (summaryCardsElement) summaryCardsElement.style.display = 'none';
        }

        /**
         * ×¤×•× ×§×¦×™×” ×—×–×§×” ×œ×—×™×œ×•×¥ ××¢×¨×š JSON ×©×œ × ×ª×•× ×™× ××ª×•×š ×˜×§×¡×˜ ×’×•×œ××™ (×©×œ ×§×•×‘×¥ HTML ×—×™×¦×•× ×™).
         * @param {string} rawText - ×›×œ ×”×˜×§×¡×˜ ×©×œ ×§×•×‘×¥ ×”-HTML ×©× ×˜×¢×Ÿ.
         */
        function extractFamilyData(rawText) {
            // 1. ×—×™×¤×•×© ×•××¦×™××ª ×”-JSON ×‘×××¦×¢×•×ª Regular Expression
            // ××—×¤×© ××¢×¨×š JSON ×¤×ª×•×— ( [ { ) ×•×¡×’×•×¨ ( } ] )
            const jsonMatch = rawText.match(/(\[\s*\{[\s\S]*\}\s*\])/);
            
            let jsonString;
            
            if (jsonMatch) {
                jsonString = jsonMatch[1].trim(); 
            } else {
                // ×× ×œ× × ××¦× ×‘×œ×•×§, × × ×™×— ×©×”×§×•×‘×¥ ×›×•×œ×• ×”×•× JSON ×˜×”×•×¨ (× ×™×¡×™×•×Ÿ ×—×™×œ×•×¥ × ×•×¡×£)
                jsonString = rawText.trim();
            }

            // 2. × ×™×§×•×™: ×”×¡×¨×ª ×ª×’×•×‘×•×ª (×›×“×™ ×œ×”×ª××•×“×“ ×¢× JSON ×‘×ª×•×š ×”×¢×¨×•×ª HTML)
            jsonString = jsonString.replace(/<!--[\s\S]*?-->/g, ''); // ×”×¡×¨×ª ×”×¢×¨×•×ª HTML
            jsonString = jsonString.replace(/\/\/[^\n]*\n/g, '\n'); // ×”×¡×¨×ª ×”×¢×¨×•×ª JS ×—×“-×©×•×¨×”
            jsonString = jsonString.replace(/\/\/[^\n]*$/, ''); // ×”×¡×¨×ª ×”×¢×¨×ª JS ××—×¨×•× ×”
            jsonString = jsonString.replace(/\/\*[\s\S]*?\*\//g, ''); // ×”×¡×¨×ª ×”×¢×¨×•×ª ××¨×•×‘×•×ª-×©×•×¨×•×ª

            // 3. × ×™×§×•×™: ×”×¡×¨×ª ×¤×¡×™×§×™× ××™×•×ª×¨×™× (×›×“×™ ×œ××¤×©×¨ JSON ×’××™×© ×™×•×ª×¨)
            jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

            // 4. × ×™×¡×™×•×Ÿ × ×™×ª×•×— JSON
            try {
                const data = JSON.parse(jsonString);
                
                if (Array.isArray(data) && data.length > 0) {
                    return data;
                }
                
                if (Array.isArray(data) && data.length === 0) {
                    return []; // ××¢×¨×š JSON ×¨×™×§ ×”×•× ×ª×§×™×Ÿ, ×¨×§ ×©××™×Ÿ × ×ª×•× ×™×
                }
            } catch (e) {
                console.error("×©×’×™××ª × ×™×ª×•×— JSON ×œ××—×¨ ×—×™×œ×•×¥ ×•× ×™×§×•×™:", e);
                const errorSnippet = jsonString.substring(0, 200).replace(/(\n|\r|\t)/g, ' ').trim() + '...';
                throw new Error(`×©×’×™××ª JSON.parse: ×•×“× ×©×”× ×ª×•× ×™× ×”× ×‘×¤×•×¨××˜ JSON ×ª×§×™×Ÿ. ×”×—×œ ×: "${errorSnippet}"`);
            }
            
            throw new Error("×”× ×ª×•× ×™× ×—×•×œ×¦×• ××š ×œ× ×¢×‘×¨×• ××ª ×‘×“×™×§×ª ×”××¢×¨×š ×”×ª×§×™× ×”. ××•×œ×™ ××“×•×‘×¨ ×‘-JSON ×œ× × ×›×•×Ÿ.");
        }
        
        function normalizeYear(year) {
            if (typeof year === 'number') return year;
            if (typeof year === 'string') {
                const num = parseInt(year.replace(/[^0-9]/g, ''), 10);
                const CURRENT_YEAR = new Date().getFullYear();
                if (isNaN(num) || num < 1000 || num > (CURRENT_YEAR + 1)) {
                    return null;
                }
                return num;
            }
            return null;
        }
        
        function cleanAndEnrichData(data) {
            const CURRENT_YEAR = new Date().getFullYear();
            
            return data.map(p => {
                const birthYear = normalizeYear(p.birth_year);
                const deathYear = normalizeYear(p.death_year);
                let currentAge = null;
                let ageAtDeath = null;

                if (birthYear) {
                    if (deathYear) {
                        ageAtDeath = deathYear - birthYear;
                    } else {
                        currentAge = CURRENT_YEAR - birthYear;
                    }
                }

                // × ×™×§×•×™ ×•×”×©×œ××ª ××™×“×¢
                const maritalStatus = (p.marital_status || 'U').toUpperCase().charAt(0); // U/S/M/D/W
                const firstName = (p.name || '').split(' ')[0] || '';
                
                return {
                    id: p.id,
                    name: p.name || 'Unknown',
                    gender: (p.gender || 'U').toUpperCase().charAt(0), // M/F/U
                    birth_year: birthYear,
                    death_year: deathYear,
                    current_age: currentAge,
                    age_at_death: ageAtDeath,
                    children_count: Array.isArray(p.children_ids) ? p.children_ids.length : 0,
                    marital_status: ['M', 'S', 'D', 'W'].includes(maritalStatus) ? maritalStatus : 'U',
                    first_name: firstName
                };
            }).filter(p => p.birth_year !== null); // ××¡× × ×™× ×”×—×•×¦×” ×× ×©×™× ×œ×œ× ×©× ×ª ×œ×™×“×” ×—×•×§×™×ª
        }

        function calculateSummaryData(data) {
            // ... (×—×™×©×•×‘ × ×ª×•× ×™× × ×©××¨ ×–×”×”)
            const totalPeople = data.length;
            const males = data.filter(p => p.gender === "M").length;
            const females = data.filter(p => p.gender === "F").length;
            
            const livingAges = data
                .map(p => p.current_age)
                .filter(age => typeof age === 'number' && age > 0);
            
            const deathAges = data
                .map(p => p.age_at_death)
                .filter(age => typeof age === 'number' && age > 0);
                
            const avgCurrentAge = livingAges.length > 0 
                ? (livingAges.reduce((sum, age) => sum + age, 0) / livingAges.length).toFixed(1) 
                : 'N/A';
            
            const avgDeathAge = deathAges.length > 0 
                ? (deathAges.reduce((sum, age) => sum + age, 0) / deathAges.length).toFixed(1) 
                : 'N/A';
                
            const percentFemale = totalPeople > 0 
                ? ((females / totalPeople) * 100).toFixed(1) 
                : 'N/A';
            
            summaryData = {
                totalPeople, avgCurrentAge, avgDeathAge, percentFemale, females, males
            };
            return summaryData;
        }
        
        // --- ×¤×•× ×§×¦×™×•×ª ×œ×•×’×™×§×ª ×˜×¢×™× ×ª ×¨×©×ª (NETWORK LOADING LOGIC) ---
        
        /**
         * ×¤×•× ×§×¦×™×” ××“×•××” ×œ×§×‘×œ×ª ×¦×“×“×™ ×”××©×¤×—×” ×©×œ ×”××©×ª××© ××”×©×¨×ª
         */
        async function fetchUserFamilySides() {
            
            // ×”×§×¨×™××” ×”×××™×ª×™×ª:
             const response = await fetch('/api/user');
             if (!response.ok) throw new Error('Failed to fetch user data');
             const userData = await response.json();
             return userData.familySide || ""; // userData.familySide should be a string like "×›×”×Ÿ, ×œ×•×™"

            // --- ×¡×™××•×œ×¦×™×” ×›×“×™ ×©×”×§×•×“ ×™×”×™×” ×¨×¥ ---
            console.log("××“××” ×§×¨×™××” ×œ- /api/user...");
            await new Promise(resolve => setTimeout(resolve, 500)); 
            
            // ××—×¨×•×–×ª ×œ×“×•×’××” ×”××“××” ××©×¤×—×•×ª × ×˜×¢× ×•×ª ×•××©×¤×—×” ××—×ª ×›×•×©×œ×ª
            return "×›×”×Ÿ, ×œ×•×™, ×©×’×™××”-×˜×¢×™× ×”";
        }
        

        /
        async function loadFamilyFile(familySide) {
            const filePath = `trees/${familySide}.html`;
            let responseText = null;

            try {
                // --- ×œ×•×’×™×§×ª ×˜×¢×™× ×ª ×§×•×‘×¥ ×××™×ª×™×ª ---
                
                // ×‘×™×™×©×•× ×××™×ª×™, × ×©×ª××© ×¨×§ ×‘-fetch:
                const response = await fetch(filePath);
                
                // ×× ×”×§×¨×™××” ×”×××™×ª×™×ª × ×›×©×œ×”, × ×©×ª××© ×‘×¡×™××•×œ×¦×™×” ×›×‘×¨×™×¨×ª ××—×“×œ
                if (!response.ok) {
                    // --- ×œ×•×’×™×§×ª ×”×¡×™××•×œ×¦×™×” ×œ×”×¤×™×›×ª ×”×§×•×“ ×œÖ¸×¨Ö¸×¥ ---
                    const mockContent = getMockFamilyFileContent(familySide);
                    if (mockContent) {
                        responseText = mockContent;
                    } else if (familySide === '×©×’×™××”-×˜×¢×™× ×”') {
                        throw new Error("×§×•×‘×¥ ×œ× ×§×™×™× (404/×©×’×™××ª ×©×¨×ª).");
                    } else {
                        throw new Error(`×©×’×™××ª HTTP: ${response.status} ×¢×‘×•×¨ ${filePath}. ××™×Ÿ ×ª×•×›×Ÿ ××“×•××”.`);
                    }
                    // --- ×¡×•×£ ×œ×•×’×™×§×ª ×”×¡×™××•×œ×¦×™×” ---
                } else {
                    responseText = await response.text();
                }

                // × ×™×ª×•×— ×”-JSON ××ª×•×š ×ª×•×›×Ÿ ×”-HTML
                const rawData = extractFamilyData(responseText);
                
                return { name: familySide, data: rawData, status: 'success' };
                
            } catch (e) {
                console.warn(`×©×’×™××” ×‘×˜×¢×™× ×ª ${familySide} ×: ${filePath}: ${e.message}`);
                return { name: familySide, data: [], status: 'fail', error: e.message };
            }
        }
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×”×¨××©×™×ª
         */
        async function loadFamilyStats() {
            try {
                // 1. ×§×‘×œ×ª ×¦×“×“×™ ×”××©×¤×—×” ××”×©×¨×ª (/api/user)
                const familySidesString = await fetchUserFamilySides();
                const familySides = familySidesString.split(',').map(s => s.trim()).filter(s => s.length > 0);
                
                if (familySides.length === 0) {
                    throw new Error("×”×©×¨×ª ×œ× ×”×—×–×™×¨ ×¦×“×“×™ ××©×¤×—×” ×œ×¢×™×‘×•×“. (familySide is empty)");
                }
                
                let allFamilyData = [];
                let loadedFamilies = [];
                let failedFamilies = [];
                
                // 2. ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×œ×›×œ ×¦×“ ××©×¤×—×” ×‘××§×‘×™×œ
                const loadPromises = familySides.map(side => loadFamilyFile(side));
                const results = await Promise.all(loadPromises);

                results.forEach(res => {
                    if (res.status === 'success') {
                        allFamilyData.push(...res.data); // ××™×–×•×’ × ×ª×•× ×™×
                        loadedFamilies.push(res.name);
                    } else {
                        failedFamilies.push(res);
                    }
                });
                
                if (allFamilyData.length === 0) {
                     throw new Error("×œ× × ×˜×¢× ×• × ×ª×•× ×™× ×××£ ×§×•×‘×¥ ××©×¤×—×”. ×•×“× × ×ª×™×‘×™× ×•×ª×•×›×Ÿ ×ª×§×™× ×™×.");
                }

                // 3. ×¢×™×‘×•×“ ×•×¦×™×•×¨
                cleanedData = cleanAndEnrichData(allFamilyData);
                calculateSummaryData(cleanedData);
                renderSummaryCards(summaryData, currentLang);
                updateUI(); 

                // 4. ×¡×™×•× ×˜×¢×™× ×” ×•×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
                const loadingElement = document.getElementById("loading");
                if (loadingElement) {
                    loadingElement.style.opacity = '0';
                    setTimeout(() => {
                        loadingElement.style.display = "none";
                        const mainContent = document.getElementById("main-content");
                        if (mainContent) mainContent.style.display = "grid"; 
                    }, 500); 
                }
                
                let statusMessage = `×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×¢×‘×•×¨ ×”××©×¤×—×•×ª: <b>${loadedFamilies.join(', ')}</b>. ×¡×š ×× ×©×™× ××¢×•×‘×“×™×: ${cleanedData.length}.`;
                
                if (failedFamilies.length > 0) {
                    statusMessage += `. <br><span class="text-yellow-600 font-bold">×©×™××• ×œ×‘: × ×›×©×œ×” ×˜×¢×™× ×” ×¢×‘×•×¨: ${failedFamilies.map(f => f.name).join(', ')}.</span>`;
                }

                const familyInfoElement = document.getElementById("family-info");
                if (familyInfoElement) familyInfoElement.innerHTML = `<span class="text-green-700 font-semibold">${statusMessage}</span>`;


            } catch (error) {
                console.error("×©×’×™××” ×§×¨×™×˜×™×ª:", error);
                displayError('××™×¨×¢×” ×©×’×™××” ×§×¨×™×˜×™×ª ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message);
            }
        }
        
        // --- ×¤×•× ×§×¦×™×•×ª ×™×¦×™×¨×ª ×ª×¨×©×™× (Chart.js V4) ---
        
        function createChart(id, config) {
            if (chartInstances[id]) { chartInstances[id].destroy(); }
            const ctx = document.getElementById(id)?.getContext("2d");
            if (ctx) { chartInstances[id] = new Chart(ctx, config); }
        }
        
        function getChartOptions(type, lang, overrides = {}) {
            // ... (×”×’×“×¨×•×ª Chart.js × ×©××¨×•×ª ×–×”×•×ª)
            const isRTL = lang === 'HE';
            
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        rtl: isRTL,
                        labels: {
                            font: { size: 14, family: 'Heebo, sans-serif' },
                            padding: 20, 
                            usePointStyle: true 
                        }
                    },
                    tooltip: {
                        rtl: isRTL,
                        bodyFont: { family: 'Heebo, sans-serif' },
                        titleFont: { family: 'Heebo, sans-serif' },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: type !== 'pie' && type !== 'doughnut'
                    }
                },
                scales: type.includes('bar') || type.includes('line') ? {
                    x: {
                        reverse: isRTL, 
                        ticks: { font: { family: 'Heebo, sans-serif', size: 12 } },
                        title: { display: false } 
                    },
                    y: {
                        ticks: { font: { family: 'Heebo, sans-serif', size: 12 } },
                        title: { display: false }, 
                        grid: { color: '#f3f4f6' } 
                    }
                } : {},
                ...overrides
            };
            
            if (isRTL && (type === 'bar' || type === 'line')) {
                if (baseOptions.scales && baseOptions.scales.x) {
                    baseOptions.scales.x.reverse = false; 
                }
            }
            
            return baseOptions;
        }

        function renderSummaryCards(summary, lang) {
            // ... (×¤×•× ×§×¦×™×™×ª ×›×¨×˜×™×¡×™ ×¡×™×›×•× × ×©××¨×ª ×–×”×”)
            const texts = translations[lang];
            const summaryContainer = document.getElementById('summary-cards');
            if (!summaryContainer) return;

            summaryContainer.innerHTML = ''; // × ×™×§×•×™

            const cards = [
                { title: texts.sumTotalPeople, value: summary.totalPeople || 0, icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-indigo-600"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>', color: 'indigo' },
                { title: texts.sumAvgCurrentAge, value: summary.avgCurrentAge, icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>', color: 'blue' },
                { title: texts.sumAvgDeathAge, value: summary.avgDeathAge, icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.055-4.393 2.502a4.496 4.496 0 00-1.077 1.838A4.5 4.5 0 003.75 8.25c0 2.485 2.099 4.5 4.688 4.5h.374a2.25 2.25 0 012.238 2.35L12 18.75m0 0l3.75-3.75M12 18.75V11.25" /></svg>', color: 'red' },
                { title: texts.sumPercentFemale, value: summary.percentFemale + (summary.percentFemale !== 'N/A' ? '%' : ''), icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-pink-600"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v2.25m-18 0v-2.25M10.5 7.5L9.75 3 7.5 7.5m3 0l.75-4.5M10.5 7.5h6.75M4.5 9h15" /></svg>', color: 'pink' }
            ];
            
            cards.forEach(card => {
                const html = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center justify-center transition duration-300 hover:shadow-2xl transform hover:scale-[1.02] cursor-default">
                        <div class="p-3 mb-2 rounded-xl bg-${card.color}-100">
                            ${card.icon}
                        </div>
                        <p class="text-sm font-semibold text-gray-500 mb-1 whitespace-nowrap">${card.title}</p>
                        <p class="text-4xl font-extrabold text-gray-800">${card.value}</p>
                    </div>
                `;
                summaryContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¦×™×•×¨ ×ª×¨×©×™××™× (× ×©××¨×•×ª ×›××¢×˜ ×–×”×•×ª) ---

        function renderGenderChart(data, lang) {
            const texts = translations[lang];
            const males = data.filter(p => p.gender === "M").length;
            const females = data.filter(p => p.gender === "F").length;
            const GENDER_COLORS = [COLOR_PALETTE.PIE_MALE, COLOR_PALETTE.PIE_FEMALE];

            createChart("genderChart", {
                type: "pie",
                data: {
                    labels: [texts.genderMale, texts.genderFemale],
                    datasets: [{
                        data: [males, females],
                        backgroundColor: GENDER_COLORS,
                        borderColor: '#ffffff',
                        borderWidth: 4,
                        hoverOffset: 20
                    }]
                },
                options: getChartOptions('pie', lang, { 
                    plugins: { 
                        tooltip: { 
                            callbacks: { 
                                label: (context) => `${context.label}: ${context.formattedValue} (${(context.dataset.data[context.dataIndex] / data.length * 100).toFixed(1)}%)`
                            } 
                        } 
                    } 
                })
            });
        }

        function renderGenerationChart(data, lang) {
            const texts = translations[lang];
            const generations = {};
            const BASE_YEAR = 1800;
            const GENERATION_SPAN = 25;

            data.forEach(p => {
                const year = p.birth_year;
                if (typeof year === 'number') {
                    const startYear = Math.floor((year - BASE_YEAR) / GENERATION_SPAN) * GENERATION_SPAN + BASE_YEAR;
                    const endYear = startYear + GENERATION_SPAN - 1;
                    const label = `${startYear}-${endYear}`;
                    generations[label] = (generations[label] || 0) + 1;
                }
            });

            const sortedLabels = Object.keys(generations).sort();
            const counts = sortedLabels.map(label => generations[label]);

            createChart("generationChart", {
                type: "bar",
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: texts.peopleCount,
                        data: counts,
                        backgroundColor: COLOR_PALETTE.PRIMARY,
                        borderColor: COLOR_PALETTE.PRIMARY,
                        borderWidth: 1,
                        borderRadius: 6, 
                    }]
                },
                options: getChartOptions('bar', lang, {
                    scales: {
                        x: { title: { display: true, text: texts.birthYears, font: { size: 14 } } },
                        y: { title: { display: true, text: texts.peopleCount, font: { size: 14 } }, beginAtZero: true }
                    }
                })
            });
        }

        function renderLifeExpectancyChart(data, lang) {
            const texts = translations[lang];
            const deceased = data.filter(p => p.age_at_death !== null && p.birth_year !== null);
            const lifeSpanByDecade = {};

            deceased.forEach(p => {
                const decade = Math.floor(p.birth_year / 10) * 10;
                lifeSpanByDecade[decade] = lifeSpanByDecade[decade] || { totalAge: 0, count: 0 };
                lifeSpanByDecade[decade].totalAge += p.age_at_death;
                lifeSpanByDecade[decade].count++;
            });

            const sortedDecades = Object.keys(lifeSpanByDecade)
                .map(Number)
                .sort((a, b) => a - b);

            const avgLifeSpans = sortedDecades.map(decade => 
                (lifeSpanByDecade[decade].totalAge / lifeSpanByDecade[decade].count).toFixed(1)
            );

            createChart("lifeExpectancyChart", {
                type: "line",
                data: {
                    labels: sortedDecades.map(d => `${d}s`),
                    datasets: [{
                        label: texts.avgLifeSpan,
                        data: avgLifeSpans,
                        borderColor: COLOR_PALETTE.SECONDARY,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: COLOR_PALETTE.SECONDARY, 
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: getChartOptions('line', lang, {
                    scales: {
                        x: { title: { display: true, text: texts.birthDecade, font: { size: 14 } } },
                        y: { title: { display: true, text: texts.years, font: { size: 14 } }, beginAtZero: false }
                    }
                })
            });
        }

        function renderBirthTrendChart(data, lang) {
            const texts = translations[lang];
            const birthByDecade = {};
            
            data.filter(p => p.birth_year !== null).forEach(p => {
                const decade = Math.floor(p.birth_year / 10) * 10;
                birthByDecade[decade] = (birthByDecade[decade] || 0) + 1;
            });

            const sortedDecades = Object.keys(birthByDecade)
                .map(Number)
                .sort((a, b) => a - b)
                .filter(d => d >= 1900); 

            const counts = sortedDecades.map(d => birthByDecade[d]);

            createChart("birthTrendChart", {
                type: "bar",
                data: {
                    labels: sortedDecades.map(d => texts.decade + ' ' + d),
                    datasets: [{
                        label: texts.birthCount,
                        data: counts,
                        backgroundColor: COLOR_PALETTE.TERTIARY,
                        borderColor: COLOR_PALETTE.TERTIARY,
                        borderWidth: 1,
                        borderRadius: 6,
                    }]
                },
                options: getChartOptions('bar', lang, {
                    scales: {
                        x: { title: { display: true, text: texts.decade, font: { size: 14 } } },
                        y: { title: { display: true, text: texts.birthCount, font: { size: 14 } }, beginAtZero: true }
                    }
                })
            });
        }
        
        function renderAvgChildrenChart(data, lang) {
            const texts = translations[lang];
            const childrenByGeneration = {};
            const BASE_YEAR = 1800;
            const GENERATION_SPAN = 25;
            const ADULT_AGE = 18;
            const CURRENT_YEAR = new Date().getFullYear();

            data
                .filter(p => p.birth_year && p.birth_year <= (CURRENT_YEAR - ADULT_AGE)) 
                .forEach(p => {
                    const year = p.birth_year;
                    const startYear = Math.floor((year - BASE_YEAR) / GENERATION_SPAN) * GENERATION_SPAN + BASE_YEAR;
                    const endYear = startYear + GENERATION_SPAN - 1;
                    const label = `${startYear}-${endYear}`;

                    childrenByGeneration[label] = childrenByGeneration[label] || { totalChildren: 0, count: 0 };
                    childrenByGeneration[label].totalChildren += p.children_count;
                    childrenByGeneration[label].count++;
                });

            const sortedLabels = Object.keys(childrenByGeneration).sort();
            const avgChildren = sortedLabels.map(label => 
                (childrenByGeneration[label].totalChildren / childrenByGeneration[label].count).toFixed(2)
            );

            createChart("avgChildrenChart", {
                type: "bar",
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: texts.avgChildren,
                        data: avgChildren,
                        backgroundColor: COLOR_PALETTE.ACCENT,
                        borderColor: COLOR_PALETTE.ACCENT,
                        borderWidth: 1,
                        borderRadius: 6,
                    }]
                },
                options: getChartOptions('bar', lang, {
                    scales: {
                        x: { title: { display: true, text: texts.generation, font: { size: 14 } } },
                        y: { title: { display: true, text: texts.avgChildren, font: { size: 14 } }, beginAtZero: true }
                    }
                })
            });
        }
        
        function renderAgeDistributionChart(data, lang) {
            const texts = translations[lang];
            const ageBins = Array.from({ length: 11 }, (_, i) => i * 10); 
            const currentAgeCounts = new Array(ageBins.length).fill(0);
            const deathAgeCounts = new Array(ageBins.length).fill(0);

            data.forEach(p => {
                if (p.current_age !== null) {
                    const binIndex = Math.min(Math.floor(p.current_age / 10), ageBins.length - 1);
                    currentAgeCounts[binIndex]++;
                }
                if (p.age_at_death !== null) {
                    const binIndex = Math.min(Math.floor(p.age_at_death / 10), ageBins.length - 1);
                    deathAgeCounts[binIndex]++;
                }
            });

            const labels = ageBins.slice(0, -1).map((bin, i) => i === ageBins.length - 2 ? `${bin}+` : `${bin}-${bin + 9}`);
            
            createChart("ageDistributionChart", {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: texts.currentAge,
                            data: currentAgeCounts.slice(0, -1),
                            backgroundColor: COLOR_PALETTE.AGE_CURRENT,
                            borderColor: COLOR_PALETTE.AGE_CURRENT,
                            borderWidth: 1,
                            borderRadius: 6,
                        },
                        {
                            label: texts.ageAtDeath,
                            data: deathAgeCounts.slice(0, -1),
                            backgroundColor: COLOR_PALETTE.AGE_DEATH,
                            borderColor: COLOR_PALETTE.AGE_DEATH,
                            borderWidth: 1,
                            borderRadius: 6,
                        }
                    ]
                },
                options: getChartOptions('bar', lang, {
                    scales: {
                        x: { title: { display: true, text: texts.ageBins, font: { size: 14 } } },
                        y: { title: { display: true, text: texts.peopleCount, font: { size: 14 } }, beginAtZero: true }
                    }
                })
            });
        }
        
        function renderMaritalStatusChart(data, lang) {
            const texts = translations[lang];
            const statusCounts = {};
            const livingAdults = data.filter(p => p.current_age !== null && p.current_age >= 18);
            
            livingAdults.forEach(p => {
                statusCounts[p.marital_status] = (statusCounts[p.marital_status] || 0) + 1;
            });
            
            const labels = ['M', 'S', 'D', 'W', 'U'].map(key => texts['status' + key]);
            const statusMap = { 'M': 0, 'S': 1, 'D': 2, 'W': 3, 'U': 4 };
            const counts = labels.map((_, i) => statusCounts[Object.keys(statusMap)[i]] || 0);

            const MARITAL_COLORS = [COLOR_PALETTE.PIE_MARRIED, COLOR_PALETTE.PIE_SINGLE, COLOR_PALETTE.PIE_DIVORCED, COLOR_PALETTE.PIE_WIDOWED, COLOR_PALETTE.PIE_OTHER];

            createChart("maritalStatusChart", {
                type: "doughnut",
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: MARITAL_COLORS,
                        borderColor: '#ffffff',
                        borderWidth: 4,
                        hoverOffset: 20
                    }]
                },
                options: getChartOptions('doughnut', lang, { 
                    cutout: '70%', 
                    plugins: { 
                        tooltip: { 
                            callbacks: { 
                                label: (context) => `${context.label}: ${context.formattedValue} (${(context.dataset.data[context.dataIndex] / livingAdults.length * 100).toFixed(1)}%)`
                            } 
                        } 
                    } 
                })
            });
        }

        function renderMostCommonNamesChart(data, lang) {
            const texts = translations[lang];
            const nameCounts = {};
            
            data.forEach(p => {
                if (p.first_name) {
                    const name = p.first_name;
                    nameCounts[name] = (nameCounts[name] || 0) + 1;
                }
            });

            const sortedNames = Object.entries(nameCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10); 

            const labels = sortedNames.map(([name]) => name);
            const counts = sortedNames.map(([, count]) => count);

            createChart("mostCommonNamesChart", {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: texts.peopleCount,
                        data: counts,
                        backgroundColor: COLOR_PALETTE.NAME_BARS,
                        borderColor: COLOR_PALETTE.NAME_BARS,
                        borderWidth: 1,
                        borderRadius: 6,
                    }]
                },
                options: getChartOptions('bar', lang, {
                    scales: {
                        x: { title: { display: true, text: texts.firstName, font: { size: 14 } } },
                        y: { title: { display: true, text: texts.peopleCount, font: { size: 14 } }, beginAtZero: true }
                    }
                })
            });
        }
        
        function renderAllCharts(data, lang) {
            // ... (×§×¨×™××” ×œ×›×œ ×¤×•× ×§×¦×™×•×ª ×”×¦×™×•×¨)
            renderGenderChart(data, lang);
            renderGenerationChart(data, lang);
            renderLifeExpectancyChart(data, lang);
            renderBirthTrendChart(data, lang);
            renderAvgChildrenChart(data, lang);
            renderAgeDistributionChart(data, lang);
            renderMaritalStatusChart(data, lang);
            renderMostCommonNamesChart(data, lang);
        }
        
        // --- ××™×ª×—×•×œ ×•×”×—×œ×¤×ª ×©×¤×” ---
        
        document.addEventListener('DOMContentLoaded', () => {
            const langButton = document.getElementById('lang-toggle-button');
            if (langButton) {
                langButton.addEventListener('click', () => {
                    currentLang = currentLang === 'HE' ? 'EN' : 'HE';
                    updateUI();
                });
            }
            
            loadFamilyStats();
        });

    </script>
</body>
</html>
