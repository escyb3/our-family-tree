<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title-display">ğŸ“Š×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™</title>
    
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Heebo Font link -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ×”×’×“×¨×ª ×”×¤×•× ×˜ ×”×¨××©×™ ×œ×›×œ ×”×“×£ */
        body { font-family: 'Heebo', sans-serif; }
        /* ×›×“×™ ×©×”×ª×¨×©×™××™× ×™×”×™×• ×¨×¡×¤×•× ×¡×™×‘×™×™× ×‘×ª×•×š ×”×›×¨×˜×™×¡×™× */
        canvas { max-width: 100%; height: auto; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-right p-4 sm:p-8">
    
    <!-- ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×©×¤×” (×§×‘×•×¢ ×œ××¢×œ×” ××™××™×Ÿ ××• ××©×××œ ×œ×¤×™ ×›×™×•×•×Ÿ) -->
    <div class="fixed top-4 right-4 z-10">
        <button id="lang-toggle-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300">
            English
        </button>
    </div>
    
    <div class="max-w-6xl mx-auto">

        <!-- ×›×•×ª×¨×ª ×¨××©×™×ª ×•×”×•×“×¢×ª ×¡×˜×˜×•×¡ -->
        <header class="mb-10 text-center">
            <h1 id="main-title" class="text-6xl font-extrabold text-blue-800 mb-3 flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
                </svg>
                <span id="main-title-text">×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</span>
            </h1>
            <p class="status-message text-lg text-gray-600 font-medium" id="family-info">×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...</p>
        </header>

        <!-- ××¡×š ×˜×¢×™× ×” -->
        <div id="loading" class="flex justify-center items-center h-40">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <span class="text-xl text-gray-700 mr-4" id="loading-text">×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.</span>
        </div>
        
        <!-- ×ª×•×›×Ÿ ×¨××©×™: ×™×•×¦×’ ×œ××—×¨ ×”×˜×¢×™× ×” -->
        <div id="main-content" class="space-y-10" style="display: none;">
            
            <!-- ×©×•×¨×” 1: ××’×“×¨ ×•×“×•×¨×•×ª -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ××’×“×¨ -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartGenderTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
                        ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)
                    </h2>
                    <canvas id="genderChart"></canvas>
                </div>
                
                <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ×“×•×¨×•×ª -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartGenerationTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
                        ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)
                    </h2>
                    <canvas id="generationChart"></canvas>
                </div>
            </div>
            
            <!-- ×©×•×¨×” 2: ××•×¨×š ×—×™×™× ×××•×¦×¢ ×•×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ××•×¨×š ×—×™×™× -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartLifeExpectancyTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-100 pb-3">
                        ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)
                    </h2>
                    <canvas id="lifeExpectancyChart"></canvas>
                </div>

                <!-- ×›×¨×˜×™×¡ ××’××ª ×œ×™×“×•×ª -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartBirthTrendTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-100 pb-3">
                        ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨
                    </h2>
                    <canvas id="birthTrendChart"></canvas>
                </div>
            </div>
            
            <!-- ×©×•×¨×” 3: ×××•×¦×¢ ×™×œ×“×™× ×•×”×ª×¤×œ×’×•×ª ×’×™×œ××™× -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ×™×œ×“×™× -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartAvgChildrenTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-red-100 pb-3">
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)
                        <span id="adults-note" class="text-sm font-normal text-gray-500">(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)</span>
                    </h2>
                    <canvas id="avgChildrenChart"></canvas>
                </div>
                
                <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× (×—×“×©) -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartAgeDistributionTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-purple-100 pb-3">
                        ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª
                    </h2>
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>

            <!-- ×©×•×¨×” 4: ×¡×˜×˜×™×¡×˜×™×§×•×ª ×—×“×©×•×ª - ××¦×‘ ××©×¤×—×ª×™ ×•×©××•×ª × ×¤×•×¦×™× -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ××¦×‘ ××©×¤×—×ª×™ (×—×“×©) -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartMaritalStatusTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-pink-100 pb-3">
                        ğŸ’ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××¦×‘ ××©×¤×—×ª×™
                    </h2>
                    <canvas id="maritalStatusChart"></canvas>
                </div>

                <!-- ×›×¨×˜×™×¡ 10 ×”×©××•×ª ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨ (×—×“×©) -->
                <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
                    <h2 id="chartMostCommonNamesTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-100 pb-3">
                        ğŸ“› 10 ×”×©××•×ª ×”×¤×¨×˜×™×™× ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨
                    </h2>
                    <canvas id="mostCommonNamesChart"></canvas>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // --- ×”×’×“×¨×•×ª ×•×©×¤×ª ×××©×§ ---
        let currentLang = 'HE'; // ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ: ×¢×‘×¨×™×ª
        let cleanedData = []; // ××—×¡×•×Ÿ ×”× ×ª×•× ×™× ×”×× ×•×§×™×

        const translations = {
            'HE': {
                // ×›×•×ª×¨×•×ª
                'pageTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
                'mainTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
                'statusLoading': '×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...',
                'loadingText': '×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.',
                'chartGenderTitle': 'ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)',
                'chartGenerationTitle': 'ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)',
                'chartLifeExpectancyTitle': 'ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)',
                'chartBirthTrendTitle': 'ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨',
                'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)',
                'chartAgeDistributionTitle': 'ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª',
                'chartMaritalStatusTitle': 'ğŸ’ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××¦×‘ ××©×¤×—×ª×™', // ×—×“×©
                'chartMostCommonNamesTitle': 'ğŸ“› 10 ×”×©××•×ª ×”×¤×¨×˜×™×™× ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨', // ×—×“×©
                'adultsNote': '(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)',
                // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
                'genderMale': '×–×›×¨×™×',
                'genderFemale': '× ×§×‘×•×ª',
                'peopleCount': '××¡×¤×¨ ×× ×©×™×',
                'birthYears': '×©× ×•×ª ×œ×™×“×”',
                'avgLifeSpan': '××•×¨×š ×—×™×™× ×××•×¦×¢',
                'years': '×©× ×™×',
                'birthDecade': '×¢×©×•×¨ ×œ×™×“×”',
                'birthCount': '×›××•×ª ×œ×™×“×•×ª',
                'decade': '×¢×©×•×¨',
                'avgChildren': '×××•×¦×¢ ×™×œ×“×™×',
                'generation': '×“×•×¨ ×œ×™×“×”',
                'currentAge': '×’×™×œ × ×•×›×—×™ (×—×™×™×)',
                'ageAtDeath': '×’×™×œ ××•×•×ª (× ×¤×˜×¨×™×)',
                'ageBins': '×˜×•×•×— ×’×™×œ××™×',
                // ×œ×™×™×‘×œ×™× ×œ××¦×‘ ××©×¤×—×ª×™ (×—×“×©)
                'statusM': '× ×©×•×™/×”',
                'statusS': '×¨×•×•×§/×”',
                'statusD': '×’×¨×•×©/×”',
                'statusW': '××œ××Ÿ/×”',
                'statusU': '××—×¨/×œ× ×™×“×•×¢',
                'firstName': '×©× ×¤×¨×˜×™',
                'langButton': 'English'    
            },
            'EN': {
                'pageTitle': 'Extended Family Tree Statistics',
                'mainTitle': 'Extended Family Tree Statistics',
                'statusLoading': 'Loading family side...',
                'loadingText': 'Loading data... Please wait.',
                'chartGenderTitle': 'ğŸ‘¤ Gender Distribution (Male vs. Female)',
                'chartGenerationTitle': 'ğŸ“… Distribution by Generation (25-year span)',
                'chartLifeExpectancyTitle': 'ğŸ’– Average Life Expectancy by Birth Period (Years)',
                'chartBirthTrendTitle': 'ğŸ“ˆ Birth Trend by Decade',
                'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Average Children Per Person (by Birth Generation)',
                'chartAgeDistributionTitle': 'ğŸ‘¶ Current Age and Age at Death Distribution',
                'chartMaritalStatusTitle': 'ğŸ’ Marital Status Distribution', // New
                'chartMostCommonNamesTitle': 'ğŸ“› Top 10 Most Common First Names', // New
                'adultsNote': '(Includes only generations who reached adulthood)',
                // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
                'genderMale': 'Males',
                'genderFemale': 'Females',
                'peopleCount': 'Number of People',
                'birthYears': 'Birth Years',
                'avgLifeSpan': 'Average Life Span',
                'years': 'Years',
                'birthDecade': 'Birth Decade',
                'birthCount': 'Birth Count',
                'decade': 'Decade',
                'avgChildren': 'Average Children',
                'generation': 'Birth Generation',
                'currentAge': 'Current Age (Living)',
                'ageAtDeath': 'Age at Death (Deceased)',
                'ageBins': 'Age Bins',
                // ×œ×™×™×‘×œ×™× ×œ××¦×‘ ××©×¤×—×ª×™ (×—×“×©)
                'statusM': 'Married',
                'statusS': 'Single',
                'statusD': 'Divorced',
                'statusW': 'Widowed',
                'statusU': 'Other/Unknown',
                'firstName': 'First Name',
                'langButton': '×¢×‘×¨×™×ª'    
            }
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ×˜×§×¡×˜ ××ª×•×¨×’×
         */
        function T(key) {
            return translations[currentLang][key] || key;
        }
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×›×œ ×”×˜×§×¡×˜×™× ×”×¡×˜×˜×™×™× ×‘×”×ª×× ×œ×©×¤×” ×”× ×•×›×—×™×ª
         */
        function updateUI() {
            const texts = translations[currentLang];
            document.getElementById('page-title-display').textContent = texts.pageTitle;
            document.getElementById('main-title-text').textContent = texts.mainTitle;
            document.getElementById('loading-text').textContent = texts.loadingText;
            
            document.getElementById('chartGenderTitle').textContent = texts.chartGenderTitle;
            document.getElementById('chartGenerationTitle').textContent = texts.chartGenerationTitle;
            document.getElementById('chartLifeExpectancyTitle').textContent = texts.chartLifeExpectancyTitle;
            document.getElementById('chartBirthTrendTitle').textContent = texts.chartBirthTrendTitle;
            document.getElementById('chartAvgChildrenTitle').textContent = texts.chartAvgChildrenTitle;
            document.getElementById('chartAgeDistributionTitle').textContent = texts.chartAgeDistributionTitle;
            document.getElementById('chartMaritalStatusTitle').textContent = texts.chartMaritalStatusTitle; // ×—×“×©
            document.getElementById('chartMostCommonNamesTitle').textContent = texts.chartMostCommonNamesTitle; // ×—×“×©
            
            document.getElementById('adults-note').textContent = texts.adultsNote;
            document.getElementById('lang-toggle-button').textContent = texts.langButton;
            
            // ×¢×“×›×•×Ÿ ×›×™×•×•× ×™×•×ª ×”×“×£
            document.documentElement.setAttribute('dir', currentLang === 'HE' ? 'rtl' : 'ltr');
            document.body.classList.toggle('text-right', currentLang === 'HE');
            document.body.classList.toggle('text-left', currentLang === 'EN');
            
            // ×¦×™×•×¨ ××—×“×© ×©×œ ×›×œ ×”×ª×¨×©×™××™×
            if (cleanedData.length > 0) {
                renderAllCharts(cleanedData, currentLang);
            }
        }
        
        function displayError(message) {
            document.getElementById("loading").style.display = "none";
            const mainContent = document.getElementById("main-content");
            mainContent.style.display = "block";
            
            const familyInfoElement = document.getElementById("family-info");
            familyInfoElement.innerHTML = '<span class="text-red-600 font-bold bg-red-100 p-2 rounded">' + message + '</span>';
            
            document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
            document.getElementById("main-title").style.display = "none";
        }

        /**
         * ×¤×•× ×§×¦×™×” ×—×–×§×” ×œ×—×™×œ×•×¥ ××¢×¨×š JSON ×©×œ × ×ª×•× ×™× ××ª×•×š ×˜×§×¡×˜ ×’×•×œ××™ (×›×’×•×Ÿ ×§×•×‘×¥ HTML).
         */
        function extractFamilyData(rawText) {
            
            // 1. ×—×™×¤×•×© ×•××¦×™××ª ×”-JSON ×‘×××¦×¢×•×ª Regular Expression
            const jsonMatch = rawText.match(/(\s*\[\s*\{[\s\S]*\}\s*\]\s*)/);

            if (!jsonMatch) {
                throw new Error("×œ× × ××¦× ×‘×œ×•×§ × ×ª×•× ×™× (××¢×¨×š JSON) ×‘×˜×§×¡×˜ ×©×—×•×œ×¥.");
            }
            
            let jsonString = jsonMatch[1].trim(); 

            // 2. × ×™×§×•×™: ×”×¡×¨×ª ×ª×’×•×‘×•×ª
            jsonString = jsonString.replace(/<!--[\s\S]*?-->/g, '');
            jsonString = jsonString.replace(/\/\/[^\n]*\n/g, '\n'); 
            jsonString = jsonString.replace(/\/\/[^\n]*$/, ''); 

            // 3. × ×™×§×•×™: ×”×¡×¨×ª ×¤×¡×™×§×™× ××™×•×ª×¨×™× 
            jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

            // 4. × ×™×¡×™×•×Ÿ × ×™×ª×•×— JSON
            try {
                const data = JSON.parse(jsonString);
                
                if (Array.isArray(data) && data.length > 0) {
                    return data;
                }
                
                if (Array.isArray(data) && data.length === 0) {
                    throw new Error("××‘× ×” ×”-JSON × ××¦× ×ª×§×™×Ÿ, ××š ×”×•× ××¢×¨×š ×¨×™×§. (××™×Ÿ × ×ª×•× ×™×)");
                }
            } catch (e) {
                console.error("×©×’×™××ª × ×™×ª×•×— JSON ×œ××—×¨ ×—×™×œ×•×¥ ×•× ×™×§×•×™:", e);
                const errorSnippet = jsonString.substring(0, 200).replace(/(\n|\r|\t)/g, ' ').trim() + '...';
                throw new Error(`×©×’×™××ª JSON.parse: ×”××—×¨×•×–×ª ×©×—×•×œ×¦×” ("${errorSnippet}") ××™× ×” JSON ×ª×§×™×Ÿ. ×‘×“×•×§ ××ª ××‘× ×” ×”×§×•×‘×¥ ×”××§×•×¨×™.`);
            }
            
            throw new Error("× ×ª×•× ×™× ×—×•×œ×¦×• ××š ×œ× ×¢×‘×¨×• ××ª ×‘×“×™×§×ª ×”××¢×¨×š ×”×ª×§×™× ×”.");
        }
        
        /**
         * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×˜×™×¤×•×œ ×‘×©× ×•×ª ×œ×™×“×”/××•×•×ª ×›××¡×¤×¨.
         */
        function normalizeYear(year) {
            if (typeof year === 'number') return year;
            if (typeof year === 'string') {
                const num = parseInt(year.replace(/[^0-9]/g, ''), 10);
                return isNaN(num) ? null : num;
            }
            return null;
        }
        
        // --- ×¤×•× ×§×¦×™×•×ª ×™×¦×™×¨×ª ×ª×¨×©×™× ---
        
        let chartInstances = {}; // ××—×¡×•×Ÿ ××•×¤×¢×™ ×ª×¨×©×™××™× ×œ×˜×•×‘×ª ×¢×“×›×•×Ÿ/××—×™×§×”

        function renderGenderChart(data, lang) {
            const texts = translations[lang];
            const males = data.filter(p => p.gender === "M").length;
            const females = data.filter(p => p.gender === "F").length;
            const GENDER_COLORS = ["#3b82f6", "#10b981"];

            if (chartInstances.gender) chartInstances.gender.destroy();
            const ctx = document.getElementById("genderChart").getContext("2d");
            chartInstances.gender = new Chart(ctx, {
                type: "pie",
                data: {
                    labels: [texts.genderMale, texts.genderFemale],
                    datasets: [{
                        data: [males, females],
                        backgroundColor: GENDER_COLORS,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', rtl: lang === 'HE' },
                        tooltip: { rtl: lang === 'HE' }
                    }
                }
            });
        }

        function renderGenerationChart(data, lang) {
            const texts = translations[lang];
            const generations = {};
            const BASE_YEAR = 1800;
            const GENERATION_SPAN = 25;

            data.forEach(p => {
                const year = p.birth_year;
                if (typeof year !== 'number' || year === null || year < BASE_YEAR || year > new Date().getFullYear()) {
                    return;
                }
                const genIndex = Math.floor((year - BASE_YEAR) / GENERATION_SPAN); 
                generations[genIndex] = (generations[genIndex] || 0) + 1;
            });
            
            const sortedGenerations = Object.entries(generations).sort((a, b) => +a[0] - +b[0]);
            const genLabels = sortedGenerations.map(([index]) => {
                const startYear = BASE_YEAR + (+index * GENERATION_SPAN);
                const endYear = startYear + GENERATION_SPAN - 1;
                return startYear + ' - ' + endYear;
            });
            const genValues = sortedGenerations.map(([, count]) => count);
            const BAR_COLOR = "#4f46e5";

            if (chartInstances.generation) chartInstances.generation.destroy();
            const ctx = document.getElementById("generationChart").getContext("2d");
            chartInstances.generation = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: genLabels,
                    datasets: [{
                        label: texts.peopleCount,
                        data: genValues,
                        backgroundColor: BAR_COLOR,
                        borderColor: BAR_COLOR,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: texts.peopleCount } },
                        x: { reverse: true, title: { display: true, text: texts.birthYears } } 
                    },
                    plugins: { tooltip: { rtl: lang === 'HE' } }
                }
            });
        }
        
        function renderLifeExpectancyChart(data, lang) {
            const texts = translations[lang];
            const lifeSpanData = data.filter(p => p.birth_year && p.death_year && p.death_year > p.birth_year);
            const lifeSpansByDecade = {};

            lifeSpanData.forEach(p => {
                const decade = Math.floor(p.birth_year / 10) * 10;
                const lifeSpan = p.death_year - p.birth_year;
                if (!lifeSpansByDecade[decade]) {
                    lifeSpansByDecade[decade] = { total: 0, count: 0 };
                }
                lifeSpansByDecade[decade].total += lifeSpan;
                lifeSpansByDecade[decade].count++;
            });

            const sortedLifeSpans = Object.entries(lifeSpansByDecade).sort((a, b) => +a[0] - +b[0]);
            const lifeSpanLabels = sortedLifeSpans.map(([decade]) => `${decade} - ${+decade + 9}`);
            const avgLifeSpans = sortedLifeSpans.map(([, data]) => (data.total / data.count).toFixed(1));
            const LIFESPAN_COLOR = "#059669";

            if (chartInstances.lifeExpectancy) chartInstances.lifeExpectancy.destroy();
            const ctx = document.getElementById("lifeExpectancyChart").getContext("2d");
            chartInstances.lifeExpectancy = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: lifeSpanLabels,
                    datasets: [{
                        label: texts.avgLifeSpan,
                        data: avgLifeSpans,
                        backgroundColor: LIFESPAN_COLOR,
                        borderColor: LIFESPAN_COLOR,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: texts.years } },
                        x: { reverse: true, title: { display: true, text: texts.birthDecade } } 
                    },
                    plugins: { tooltip: { rtl: lang === 'HE' } }
                }
            });
        }
        
        function renderBirthTrendChart(data, lang) {
            const texts = translations[lang];
            const birthTrend = {};
            data.forEach(p => {
                if (p.birth_year) {
                    const decade = Math.floor(p.birth_year / 10) * 10;
                    birthTrend[decade] = (birthTrend[decade] || 0) + 1;
                }
            });

            const sortedBirthTrend = Object.entries(birthTrend).sort((a, b) => +a[0] - +b[0]);
            const trendLabels = sortedBirthTrend.map(([decade]) => decade);
            const trendValues = sortedBirthTrend.map(([, count]) => count);
            const TREND_COLOR = "#f59e0b";

            if (chartInstances.birthTrend) chartInstances.birthTrend.destroy();
            const ctx = document.getElementById("birthTrendChart").getContext("2d");
            chartInstances.birthTrend = new Chart(ctx, {
                type: "line",
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: texts.birthCount,
                        data: trendValues,
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: TREND_COLOR,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: texts.birthCount } },
                        x: { reverse: true, title: { display: true, text: texts.decade } } 
                    },
                    plugins: { tooltip: { rtl: lang === 'HE' } }
                }
            });
        }
        
        function renderAvgChildrenChart(data, lang) {
            const texts = translations[lang];
            const childrenAvg = {};
            const GENERATION_SPAN = 25;

            data.filter(p => p.is_adult_for_children_avg).forEach(p => {
                const genIndex = Math.floor(p.birth_year / GENERATION_SPAN); 
                const generationStartYear = genIndex * GENERATION_SPAN;
                
                if (!childrenAvg[generationStartYear]) {
                    childrenAvg[generationStartYear] = { totalChildren: 0, adultCount: 0 };
                }
                childrenAvg[generationStartYear].totalChildren += p.children_count;
                childrenAvg[generationStartYear].adultCount++;
            });

            const sortedChildrenAvg = Object.entries(childrenAvg).sort((a, b) => +a[0] - +b[0]);
            const avgChildrenLabels = sortedChildrenAvg.map(([year]) => `${year} - ${+year + GENERATION_SPAN - 1}`);
            const avgChildrenValues = sortedChildrenAvg.map(([, data]) => (data.totalChildren / data.adultCount).toFixed(1));
            const CHILDREN_COLOR = "#ef4444";

            if (chartInstances.avgChildren) chartInstances.avgChildren.destroy();
            const ctx = document.getElementById("avgChildrenChart").getContext("2d");
            chartInstances.avgChildren = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: avgChildrenLabels,
                    datasets: [{
                        label: texts.avgChildren,
                        data: avgChildrenValues,
                        backgroundColor: CHILDREN_COLOR,
                        borderColor: CHILDREN_COLOR,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: texts.avgChildren } },
                        x: { reverse: true, title: { display: true, text: texts.generation } } 
                    },
                    plugins: { tooltip: { rtl: lang === 'HE' } }
                }
            });
        }

        function renderAgeDistributionChart(data, lang) {
            const texts = translations[lang];
            // ×”×’×“×¨×ª ×˜×•×•×—×™ ×’×™×œ××™×
            const BINS = [0, 20, 40, 60, 80]; 
            const binLabels = BINS.map((start, i) => 
                i === BINS.length - 1 ? `${start}+` : `${start}-${BINS[i+1]-1}`
            ).reverse(); // ×”×¦×’×” ××”×’×™×œ××™× ×”××‘×•×’×¨×™× ×œ×¦×¢×™×¨×™× ×œ×©× ××—×™×“×•×ª ×¢× ×¦×™×¨×™× ××—×¨×™×
            
            const currentAgeCounts = Array(BINS.length).fill(0);
            const ageAtDeathCounts = Array(BINS.length).fill(0);

            data.forEach(p => {
                let binIndex;
                // Current Age (Living)
                if (p.current_age !== undefined && p.current_age >= 0) {
                    binIndex = BINS.findIndex((start, i) => 
                        i === BINS.length - 1 ? p.current_age >= start : p.current_age >= start && p.current_age < BINS[i+1]
                    );
                    if (binIndex !== -1) currentAgeCounts[binIndex]++;
                }
                
                // Age at Death (Deceased)
                if (p.age_at_death !== undefined && p.age_at_death >= 0) {
                    binIndex = BINS.findIndex((start, i) => 
                        i === BINS.length - 1 ? p.age_at_death >= start : p.age_at_death >= start && p.age_at_death < BINS[i+1]
                    );
                    if (binIndex !== -1) ageAtDeathCounts[binIndex]++;
                }
            });
            
            // ×”×™×¤×•×š ×¡×“×¨ ×”× ×ª×•× ×™× ×›×“×™ ×©×™×ª××™× ×œ×ª×•×•×™×•×ª ×”×”×¤×•×›×•×ª
            currentAgeCounts.reverse();
            ageAtDeathCounts.reverse();

            if (chartInstances.ageDistribution) chartInstances.ageDistribution.destroy();
            const ctx = document.getElementById("ageDistributionChart").getContext("2d");
            chartInstances.ageDistribution = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: binLabels,
                    datasets: [
                        {
                            label: texts.currentAge,
                            data: currentAgeCounts,
                            backgroundColor: '#8b5cf6', // Purple
                            stack: 'stack0',
                        },
                        {
                            label: texts.ageAtDeath,
                            data: ageAtDeathCounts,
                            backgroundColor: '#f97316', // Orange
                            stack: 'stack0',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: texts.peopleCount } 
                        },
                        x: { 
                            title: { display: true, text: texts.ageBins } 
                        }
                    },
                    plugins: {
                        tooltip: { rtl: lang === 'HE' }
                    }
                }
            });
        }

        // --- ×¤×•× ×§×¦×™×” ×—×“×©×”: ×”×ª×¤×œ×’×•×ª ××¦×‘ ××©×¤×—×ª×™ ---
        function renderMaritalStatusChart(data, lang) {
            const texts = translations[lang];
            const maritalStatuses = { 'M': 0, 'S': 0, 'D': 0, 'W': 0, 'U': 0 };
            const STATUS_COLORS = ["#ec4899", "#34d399", "#f97316", "#6b7280", "#9ca3af"]; // Pink, Green, Orange, Gray

            data.forEach(p => {
                const status = p.marital_status ? p.marital_status.toUpperCase() : 'U';
                if (maritalStatuses.hasOwnProperty(status)) {
                    maritalStatuses[status]++;
                } else {
                    maritalStatuses['U']++;
                }
            });

            const statusLabels = [
                texts.statusM, texts.statusS, texts.statusD, texts.statusW, texts.statusU
            ];
            const statusValues = [
                maritalStatuses.M, maritalStatuses.S, maritalStatuses.D, maritalStatuses.W, maritalStatuses.U
            ];
            
            // ×¡×™× ×•×Ÿ ××¤×¡×™× ××˜×¢××™ ×§×¨×™××•×ª
            const filteredLabels = statusLabels.filter((_, i) => statusValues[i] > 0);
            const filteredValues = statusValues.filter(v => v > 0);
            const filteredColors = STATUS_COLORS.filter((_, i) => statusValues[i] > 0);


            if (chartInstances.maritalStatus) chartInstances.maritalStatus.destroy();
            const ctx = document.getElementById("maritalStatusChart").getContext("2d");
            chartInstances.maritalStatus = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredValues,
                        backgroundColor: filteredColors,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', rtl: lang === 'HE' },
                        tooltip: { rtl: lang === 'HE' }
                    }
                }
            });
        }

        // --- ×¤×•× ×§×¦×™×” ×—×“×©×”: 10 ×”×©××•×ª ×”× ×¤×•×¦×™× ×‘×™×•×ª×¨ ---
        function renderMostCommonNamesChart(data, lang) {
            const texts = translations[lang];
            const nameCounts = {};

            data.forEach(p => {
                if (p.first_name) {
                    const name = p.first_name.trim().toLowerCase();
                    nameCounts[name] = (nameCounts[name] || 0) + 1;
                }
            });

            const sortedNames = Object.entries(nameCounts)
                .sort((a, b) => b[1] - a[1]) // Sort descending by count
                .slice(0, 10); // Take top 10

            const nameLabels = sortedNames.map(([name]) => {
                // × ×¨××•×œ ×œ×”×¦×’×”: ×”×¤×™×›×ª ×”××•×ª ×”×¨××©×•× ×” ×œ×’×“×•×œ×”
                return name.charAt(0).toUpperCase() + name.slice(1);
            }).reverse(); // Reverse for Chart.js display order (highest at top)

            const nameValues = sortedNames.map(([, count]) => count).reverse();
            const NAME_COLOR = "#4338ca"; // Indigo dark

            if (chartInstances.mostCommonNames) chartInstances.mostCommonNames.destroy();
            const ctx = document.getElementById("mostCommonNamesChart").getContext("2d");
            chartInstances.mostCommonNames = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: nameLabels,
                    datasets: [{
                        label: texts.peopleCount,
                        data: nameValues,
                        backgroundColor: NAME_COLOR,
                        borderColor: NAME_COLOR,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: texts.peopleCount } },
                        y: { title: { display: true, text: texts.firstName } }
                    },
                    plugins: { tooltip: { rtl: lang === 'HE' } }
                }
            });
        }


        function renderAllCharts(data, lang) {
            // ×ª×¨×©×™××™× ×§×™×™××™×
            renderGenderChart(data, lang);
            renderGenerationChart(data, lang);
            renderLifeExpectancyChart(data, lang);
            renderBirthTrendChart(data, lang);
            renderAvgChildrenChart(data, lang);
            renderAgeDistributionChart(data, lang); 

            // ×ª×¨×©×™××™× ×—×“×©×™×
            renderMaritalStatusChart(data, lang);
            renderMostCommonNamesChart(data, lang);
        }


        // --- ×¤×•× ×§×¦×™×” ×¨××©×™×ª ---

        async function loadFamilyStats() {
            updateUI(); // ×¢×“×›×•×Ÿ UI ×¨××©×•× ×™
            
            const familyInfoElement = document.getElementById("family-info");
            const allFamilyData = [];
            const loadedFamilies = [];
            const failedFamilies = [];
            
            try {
                // 1. ×©×œ×™×¤×ª ×¤×¨×˜×™ ××©×ª××© ×•×§×‘×œ×ª ×¦×“ ××©×¤×—×” ×’×•×œ××™
                familyInfoElement.textContent = T('statusLoading');
                const userResponse = await fetch('/api/user');
                if (!userResponse.ok) {
                    throw new Error('×©×’×™××” ' + userResponse.status + ': ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×˜×™ ××©×ª××©.');
                }
                
                const userData = await userResponse.json();
                const rawFamilySide = userData.user?.familySide; 

                if (!rawFamilySide || typeof rawFamilySide !== 'string' || rawFamilySide === '×œ× ××•×’×“×¨') {
                    throw new Error("×©×“×” 'familySide' ×—×¡×¨, ×œ× ×ª×§×™×Ÿ ××• ×œ× ××•×’×“×¨ ×‘×¤×¨×˜×™ ×”××©×ª××©. (× ×“×¨×© ×©× ××©×¤×—×” ××—×“ ××• ×™×•×ª×¨, ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×).");
                }
                
                // ×¤×™×¦×•×œ ×©××•×ª ×”××©×¤×—×” ×•× ×™×§×•×™ ×¨×•×•×—×™×
                const familyNames = rawFamilySide.split(',')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                if (familyNames.length === 0) {
                    throw new Error("×©×“×” 'familySide' ××›×™×œ ×ª×•×•×™×, ××š ×œ× × ××¦××• ×©××•×ª ××©×¤×—×” ×ª×§×™× ×™× ×œ×¢×™×‘×•×“ ×œ××—×¨ × ×™×§×•×™.");
                }

                // 2. ×©×œ×™×¤×ª ×§×‘×¦×™×, ×¦×‘×™×¨×” ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª
                for (const familySide of familyNames) {
                    const dataUrl = '/trees/' + familySide + '.html';
                    familyInfoElement.textContent = `×˜×•×¢×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨: ${familySide}...`;

                    try {
                        const dataResponse = await fetch(dataUrl);
                        if (!dataResponse.ok) {
                            throw new Error('×©×’×™××ª ×©×¨×ª: ' + dataResponse.status);
                        }

                        const rawText = await dataResponse.text();
                        const rawData = extractFamilyData(rawText);

                        // ×¦×‘×™×¨×ª ×”× ×ª×•× ×™×
                        allFamilyData.push(...rawData);
                        loadedFamilies.push(familySide);

                    } catch (error) {
                        console.warn('×›×©×œ ×‘×˜×¢×™× ×ª ' + familySide + ': ' + error.message);
                        failedFamilies.push({ name: familySide, message: error.message });
                    }
                }

                if (allFamilyData.length === 0) {
                    let errorMsg = "×œ× × ××¦××• × ×ª×•× ×™× ×›×œ×œ ×œ×¢×™×‘×•×“ ×¡×˜×˜×™×¡×˜×™ ××›×œ ×”×§×‘×¦×™× ×©× ×™×¡×™×ª×™ ×œ×˜×¢×•×Ÿ.";
                    if (failedFamilies.length > 0) {
                        errorMsg += " (× ×›×©×œ×•: " + failedFamilies.map(f => f.name).join(', ') + ")";
                    }
                    throw new Error(errorMsg);
                }

                // 3. × ×™×§×•×™ ×•×¡×™× ×•×Ÿ × ×ª×•× ×™× ×•×”×›× ×” ×œ×ª×¨×©×™××™×
                familyInfoElement.textContent = "××—×œ×¥ ×•×× ×§×” × ×ª×•× ×™×...";
                
                const CURRENT_YEAR = new Date().getFullYear();
                // ×”×›× ×ª × ×ª×•× ×™× - × ×™×¨××•×œ ×©× ×•×ª ×œ×™×“×”/××•×•×ª ×•×”×•×¡×¤×ª ×©×“×•×ª ×’×™×œ ×—×“×©×™×
                cleanedData = allFamilyData
                    .map(p => {
                        const birth_year = normalizeYear(p.birth_year);
                        const death_year = normalizeYear(p.death_year);
                        
                        const processed = {
                            ...p,
                            birth_year: birth_year,
                            death_year: death_year,
                            children_count: Array.isArray(p.children_ids) ? p.children_ids.length : 0,
                            // is_adult_for_children_avg: ×›×œ ××™ ×©× ×•×œ×“ ×œ×¤× ×™ 1970 × ×—×©×‘ ×›××‘×•×’×¨ ×¤×•×˜× ×¦×™××œ×™ ×œ×™×œ×“×™×
                            is_adult_for_children_avg: birth_year !== null && birth_year < 1970 
                        };
                        
                        // ×—×™×©×•×‘ ×’×™×œ ×‘××•×•×ª ×•×’×™×œ × ×•×›×—×™ (×œ×¦×•×¨×š ×”×ª×¨×©×™× ×”×—×“×©)
                        if (birth_year) {
                            if (death_year && death_year > birth_year) {
                                processed.age_at_death = death_year - birth_year;
                            }
                            if (!death_year || death_year >= CURRENT_YEAR) {
                                processed.current_age = CURRENT_YEAR - birth_year;
                            }
                        }
                        return processed;
                    })
                    // ×¡×™× ×•×Ÿ ×¨×§ ×©×œ ×¨×©×•××•×ª ×©×™×© ×‘×”×Ÿ ×œ×¤×—×•×ª ××™×“×¢ ××—×“ ×¨×œ×•×•× ×˜×™
                    .filter(p => p.gender || p.birth_year || p.marital_status || p.first_name); 

                if (cleanedData.length === 0) {
                    throw new Error('×”× ×ª×•× ×™× ×—×•×œ×¦×• ×‘×”×¦×œ×—×”, ××š ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×§×™× ×•×ª ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª (×›× ×¨××” ×©×“×•×ª ××’×“×¨/×©× ×ª ×œ×™×“×”/××¦×‘ ××©×¤×—×ª×™/×©× ×¤×¨×˜×™ ×—×¡×¨×™×) ××ª×•×š ' + allFamilyData.length + ' ×¨×©×•××•×ª ×’×•×œ××™×•×ª.');
                }

                // 4. ×™×¦×™×¨×ª ×”×ª×¨×©×™××™×
                renderAllCharts(cleanedData, currentLang);


                // 5. ×¡×™×•× ×˜×¢×™× ×”
                document.getElementById("loading").style.display = "none";
                document.getElementById("main-content").style.display = "block";
                
                let statusMessage = '×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×¢×‘×•×¨ ×”××©×¤×—×•×ª: <b>' + loadedFamilies.join(', ') + '</b>. ×¡×š ×× ×©×™× ××¢×•×‘×“×™×: ' + cleanedData.length;
                
                if (failedFamilies.length > 0) {
                    statusMessage += '. <br><span class="text-yellow-600 font-bold">×©×™××• ×œ×‘: × ×›×©×œ×” ×˜×¢×™× ×” ×¢×‘×•×¨: ' + failedFamilies.map(f => f.name).join(', ') + '.</span>';
                }

                familyInfoElement.innerHTML = '<span class="text-green-700 font-semibold">' + statusMessage + '</span>';


            } catch (error) {
                console.error("×©×’×™××” ×§×¨×™×˜×™×ª:", error);
                displayError('××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message);
            }
        }
        
        // --- ××™×ª×—×•×œ ×•×”×—×œ×¤×ª ×©×¤×” ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // ×”×•×¡×¤×ª Listener ×œ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×”×©×¤×”
            document.getElementById('lang-toggle-button').addEventListener('click', () => {
                currentLang = currentLang === 'HE' ? 'EN' : 'HE';
                updateUI();
            });
            
            loadFamilyStats();
        });

    </script>
</body>
</html>
