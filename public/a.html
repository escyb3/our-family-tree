<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title id="page-title-display">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</title>
Â Â 
Â  <!-- Tailwind CSS CDN for styling -->
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <!-- Heebo Font link -->
Â  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap" rel="stylesheet">
Â Â 
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â Â 
Â  <style>
Â  Â  /* ×”×’×“×¨×ª ×”×¤×•× ×˜ ×”×¨××©×™ ×œ×›×œ ×”×“×£ */
Â  Â  body { font-family: 'Heebo', sans-serif; }
Â  Â  /* ×›×“×™ ×©×”×ª×¨×©×™××™× ×™×”×™×• ×¨×¡×¤×•× ×¡×™×‘×™×™× ×‘×ª×•×š ×”×›×¨×˜×™×¡×™× */
Â  Â  canvas { max-width: 100%; height: auto; }
Â  </style>
</head>
<body class="bg-gray-50 min-h-screen text-right p-4 sm:p-8">
Â  Â  
    <!-- ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×©×¤×” (×§×‘×•×¢ ×œ××¢×œ×” ××™××™×Ÿ ××• ××©×××œ ×œ×¤×™ ×›×™×•×•×Ÿ) -->
    <div class="fixed top-4 right-4 z-10">
        <button id="lang-toggle-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300">
            English
        </button>
    </div>
    
Â  <div class="max-w-6xl mx-auto">

Â  Â  <!-- ×›×•×ª×¨×ª ×¨××©×™×ª ×•×”×•×“×¢×ª ×¡×˜×˜×•×¡ -->
Â  Â  <header class="mb-10 text-center">
Â  Â  Â  Â  <h1 id="main-title" class="text-6xl font-extrabold text-blue-800 mb-3 flex items-center justify-center gap-3">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <span id="main-title-text">×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª</span>
Â  Â  Â  Â  </h1>
Â  Â  Â  Â  <p class="status-message text-lg text-gray-600 font-medium" id="family-info">×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...</p>
Â  Â  </header>

Â  Â  <!-- ××¡×š ×˜×¢×™× ×” -->
Â  Â  <div id="loading" class="flex justify-center items-center h-40">
Â  Â  Â  Â  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
Â  Â  Â  Â  <span class="text-xl text-gray-700 mr-4" id="loading-text">×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.</span>
Â  Â  </div>
Â  Â Â 
Â  Â  <!-- ×ª×•×›×Ÿ ×¨××©×™: ×™×•×¦×’ ×œ××—×¨ ×”×˜×¢×™× ×” -->
Â  Â  <div id="main-content" class="space-y-10" style="display: none;">
Â  Â  Â Â 
Â  Â  Â  <!-- ×©×•×¨×” 1: ××’×“×¨ ×•×“×•×¨×•×ª -->
Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ××’×“×¨ -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 id="chartGenderTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
Â  Â  Â  Â  Â  Â  Â ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="genderChart"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×ª×¨×©×™× ×“×•×¨×•×ª -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 id="chartGenerationTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="generationChart"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
      
      <!-- ×©×•×¨×” 2: ××•×¨×š ×—×™×™× ×××•×¦×¢ ×•×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ××•×¨×š ×—×™×™× -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 id="chartLifeExpectancyTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="lifeExpectancyChart"></canvas>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ××’××ª ×œ×™×“×•×ª -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 id="chartBirthTrendTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="birthTrendChart"></canvas>
Â  Â  Â  Â  </div>
      </div>
      
      <!-- ×©×•×¨×” 3: ×××•×¦×¢ ×™×œ×“×™× ×•×”×ª×¤×œ×’×•×ª ×’×™×œ××™× -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
Â  Â  Â  Â  <!-- ×›×¨×˜×™×¡ ×××•×¦×¢ ×™×œ×“×™× -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 id="chartAvgChildrenTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-red-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)
Â  Â  Â  Â  Â  Â  <span id="adults-note" class="text-sm font-normal text-gray-500">(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)</span>
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="avgChildrenChart"></canvas>
Â  Â  Â  Â  </div>
        
        <!-- ×›×¨×˜×™×¡ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× (×—×“×©) -->
Â  Â  Â  Â  <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
Â  Â  Â  Â  Â  <h2 id="chartAgeDistributionTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-purple-100 pb-3">
Â  Â  Â  Â  Â  Â  ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª
Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  <canvas id="ageDistributionChart"></canvas>
Â  Â  Â  Â  </div>

      </div>
      
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // --- ×”×’×“×¨×•×ª ×•×©×¤×ª ×××©×§ ---
    let currentLang = 'HE'; // ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ: ×¢×‘×¨×™×ª
    let cleanedData = []; // ××—×¡×•×Ÿ ×”× ×ª×•× ×™× ×”×× ×•×§×™×

    const translations = {
        'HE': {
            // ×›×•×ª×¨×•×ª
            'pageTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
            'mainTitle': '×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×¥ ××©×¤×—×ª×™ ××•×¨×—×‘×•×ª',
            'statusLoading': '×˜×•×¢×Ÿ ×¦×“ ××©×¤×—×”...',
            'loadingText': '×˜×•×¢×Ÿ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ.',
            'chartGenderTitle': 'ğŸ‘¤ ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ××’×“×¨ (×–×›×¨×™× ××•×œ × ×§×‘×•×ª)',
            'chartGenerationTitle': 'ğŸ“… ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×“×•×¨ (×›×œ 25 ×©× ×”)',
            'chartLifeExpectancyTitle': 'ğŸ’– ×××•×¦×¢ ××•×¨×š ×—×™×™× ×œ×¤×™ ×ª×§×•×¤×ª ×œ×™×“×” (×©× ×™×)',
            'chartBirthTrendTitle': 'ğŸ“ˆ ××’××ª ×œ×™×“×•×ª ×œ×¤×™ ×¢×©×•×¨',
            'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×××•×¦×¢ ×™×œ×“×™× ×œ××“× (×œ×¤×™ ×“×•×¨ ×œ×™×“×”)',
            'chartAgeDistributionTitle': 'ğŸ‘¶ ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª',
            'adultsNote': '(×›×•×œ×œ ×¨×§ ×“×•×¨×•×ª ×©×”×’×™×¢×• ×œ×‘×’×¨×•×ª)',
            // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
            'genderMale': '×–×›×¨×™×',
            'genderFemale': '× ×§×‘×•×ª',
            'peopleCount': '××¡×¤×¨ ×× ×©×™×',
            'birthYears': '×©× ×•×ª ×œ×™×“×”',
            'avgLifeSpan': '××•×¨×š ×—×™×™× ×××•×¦×¢',
            'years': '×©× ×™×',
            'birthDecade': '×¢×©×•×¨ ×œ×™×“×”',
            'birthCount': '×›××•×ª ×œ×™×“×•×ª',
            'decade': '×¢×©×•×¨',
            'avgChildren': '×××•×¦×¢ ×™×œ×“×™×',
            'generation': '×“×•×¨ ×œ×™×“×”',
            'currentAge': '×’×™×œ × ×•×›×—×™ (×—×™×™×)',
            'ageAtDeath': '×’×™×œ ××•×•×ª (× ×¤×˜×¨×™×)',
            'ageBins': '×˜×•×•×— ×’×™×œ××™×',
            'langButton': 'English' 
        },
        'EN': {
            'pageTitle': 'Extended Family Tree Statistics',
            'mainTitle': 'Extended Family Tree Statistics',
            'statusLoading': 'Loading family side...',
            'loadingText': 'Loading data... Please wait.',
            'chartGenderTitle': 'ğŸ‘¤ Gender Distribution (Male vs. Female)',
            'chartGenerationTitle': 'ğŸ“… Distribution by Generation (25-year span)',
            'chartLifeExpectancyTitle': 'ğŸ’– Average Life Expectancy by Birth Period (Years)',
            'chartBirthTrendTitle': 'ğŸ“ˆ Birth Trend by Decade',
            'chartAvgChildrenTitle': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Average Children Per Person (by Birth Generation)',
            'chartAgeDistributionTitle': 'ğŸ‘¶ Current Age and Age at Death Distribution',
            'adultsNote': '(Includes only generations who reached adulthood)',
            // ×œ×™×™×‘×œ×™× ×•×¦×™×¨×™×
            'genderMale': 'Males',
            'genderFemale': 'Females',
            'peopleCount': 'Number of People',
            'birthYears': 'Birth Years',
            'avgLifeSpan': 'Average Life Span',
            'years': 'Years',
            'birthDecade': 'Birth Decade',
            'birthCount': 'Birth Count',
            'decade': 'Decade',
            'avgChildren': 'Average Children',
            'generation': 'Birth Generation',
            'currentAge': 'Current Age (Living)',
            'ageAtDeath': 'Age at Death (Deceased)',
            'ageBins': 'Age Bins',
            'langButton': '×¢×‘×¨×™×ª' 
        }
    };

    // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
    
    /**
     * ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ×˜×§×¡×˜ ××ª×•×¨×’×
     */
    function T(key) {
        return translations[currentLang][key] || key;
    }
    
    /**
     * ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×›×œ ×”×˜×§×¡×˜×™× ×”×¡×˜×˜×™×™× ×‘×”×ª×× ×œ×©×¤×” ×”× ×•×›×—×™×ª
     */
    function updateUI() {
        const texts = translations[currentLang];
        document.getElementById('page-title-display').textContent = texts.pageTitle;
        document.getElementById('main-title-text').textContent = texts.mainTitle;
        document.getElementById('loading-text').textContent = texts.loadingText;
        
        document.getElementById('chartGenderTitle').textContent = texts.chartGenderTitle;
        document.getElementById('chartGenerationTitle').textContent = texts.chartGenerationTitle;
        document.getElementById('chartLifeExpectancyTitle').textContent = texts.chartLifeExpectancyTitle;
        document.getElementById('chartBirthTrendTitle').textContent = texts.chartBirthTrendTitle;
        document.getElementById('chartAvgChildrenTitle').textContent = texts.chartAvgChildrenTitle;
        document.getElementById('chartAgeDistributionTitle').textContent = texts.chartAgeDistributionTitle;
        
        document.getElementById('adults-note').textContent = texts.adultsNote;
        document.getElementById('lang-toggle-button').textContent = texts.langButton;
        
        // ×¢×“×›×•×Ÿ ×›×™×•×•× ×™×•×ª ×”×“×£
        document.documentElement.setAttribute('dir', currentLang === 'HE' ? 'rtl' : 'ltr');
        document.body.classList.toggle('text-right', currentLang === 'HE');
        document.body.classList.toggle('text-left', currentLang === 'EN');
        
        // ×¦×™×•×¨ ××—×“×© ×©×œ ×›×œ ×”×ª×¨×©×™××™×
        if (cleanedData.length > 0) {
            renderAllCharts(cleanedData, currentLang);
        }
    }
    
    function displayError(message) {
Â  Â  Â  document.getElementById("loading").style.display = "none";
Â  Â  Â  const mainContent = document.getElementById("main-content");
Â  Â  Â  mainContent.style.display = "block";
Â  Â  Â Â 
Â  Â  Â  const familyInfoElement = document.getElementById("family-info");
Â  Â  Â  familyInfoElement.innerHTML = '<span class="text-red-600 font-bold bg-red-100 p-2 rounded">' + message + '</span>';
Â  Â  Â Â 
Â  Â  Â  document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
Â  Â  Â  document.getElementById("main-title").style.display = "none";
Â  Â  }

Â  Â  /**
Â  Â  Â * ×¤×•× ×§×¦×™×” ×—×–×§×” ×œ×—×™×œ×•×¥ ××¢×¨×š JSON ×©×œ × ×ª×•× ×™× ××ª×•×š ×˜×§×¡×˜ ×’×•×œ××™ (×›×’×•×Ÿ ×§×•×‘×¥ HTML).
Â  Â  Â */
Â  Â  function extractFamilyData(rawText) {
Â  Â  Â  
Â  Â  Â  // 1. ×—×™×¤×•×© ×•××¦×™××ª ×”-JSON ×‘×××¦×¢×•×ª Regular Expression
Â  Â  Â  const jsonMatch = rawText.match(/(\s*\[\s*\{[\s\S]*\}\s*\]\s*)/);

Â  Â  Â  if (!jsonMatch) {
Â  Â  Â  Â  throw new Error(T('errorNoJsonBlock')); // ×©×™××•×© ×‘×¤×•× ×§×¦×™×™×ª ×ª×¨×’×•× (× × ×™×— ×©×™×© Error key)
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  let jsonString = jsonMatch[1].trim(); 

Â  Â  Â  // 2. × ×™×§×•×™: ×”×¡×¨×ª ×ª×’×•×‘×•×ª
      jsonString = jsonString.replace(/<!--[\s\S]*?-->/g, '');
      jsonString = jsonString.replace(/\/\/[^\n]*\n/g, '\n'); 
      jsonString = jsonString.replace(/\/\/[^\n]*$/, ''); 

Â  Â  Â  // 3. × ×™×§×•×™: ×”×¡×¨×ª ×¤×¡×™×§×™× ××™×•×ª×¨×™× 
Â  Â  Â  jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

Â  Â  Â  // 4. × ×™×¡×™×•×Ÿ × ×™×ª×•×— JSON
Â  Â  Â  try {
Â  Â  Â  Â  const data = JSON.parse(jsonString);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Array.isArray(data) && data.length > 0) {
Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Array.isArray(data) && data.length === 0) {
Â  Â  Â  Â      throw new Error("××‘× ×” ×”-JSON × ××¦× ×ª×§×™×Ÿ, ××š ×”×•× ××¢×¨×š ×¨×™×§. (××™×Ÿ × ×ª×•× ×™×)");
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("×©×’×™××ª × ×™×ª×•×— JSON ×œ××—×¨ ×—×™×œ×•×¥ ×•× ×™×§×•×™:", e);
Â  Â  Â  Â  const errorSnippet = jsonString.substring(0, 200).replace(/(\n|\r|\t)/g, ' ').trim() + '...';
Â  Â  Â  Â  throw new Error(`×©×’×™××ª JSON.parse: ×”××—×¨×•×–×ª ×©×—×•×œ×¦×” ("${errorSnippet}") ××™× ×” JSON ×ª×§×™×Ÿ. ×‘×“×•×§ ××ª ××‘× ×” ×”×§×•×‘×¥ ×”××§×•×¨×™.`);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  throw new Error("× ×ª×•× ×™× ×—×•×œ×¦×• ××š ×œ× ×¢×‘×¨×• ××ª ×‘×“×™×§×ª ×”××¢×¨×š ×”×ª×§×™× ×”.");
Â  Â  }
    
    /**
     * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×˜×™×¤×•×œ ×‘×©× ×•×ª ×œ×™×“×”/××•×•×ª ×›××¡×¤×¨.
     */
    function normalizeYear(year) {
        if (typeof year === 'number') return year;
        if (typeof year === 'string') {
            const num = parseInt(year.replace(/[^0-9]/g, ''), 10);
            return isNaN(num) ? null : num;
        }
        return null;
    }
    
    // --- ×¤×•× ×§×¦×™×•×ª ×™×¦×™×¨×ª ×ª×¨×©×™× ---
    
    let chartInstances = {}; // ××—×¡×•×Ÿ ××•×¤×¢×™ ×ª×¨×©×™××™× ×œ×˜×•×‘×ª ×¢×“×›×•×Ÿ/××—×™×§×”

    function renderGenderChart(data, lang) {
        const texts = translations[lang];
        const males = data.filter(p => p.gender === "M").length;
        const females = data.filter(p => p.gender === "F").length;
        const GENDER_COLORS = ["#3b82f6", "#10b981"];

        if (chartInstances.gender) chartInstances.gender.destroy();
        const ctx = document.getElementById("genderChart").getContext("2d");
        chartInstances.gender = new Chart(ctx, {
            type: "pie",
            data: {
                labels: [texts.genderMale, texts.genderFemale],
                datasets: [{
                    data: [males, females],
                    backgroundColor: GENDER_COLORS,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', rtl: lang === 'HE' },
                    tooltip: { rtl: lang === 'HE' }
                }
            }
        });
    }

    function renderGenerationChart(data, lang) {
        const texts = translations[lang];
        const generations = {};
        const BASE_YEAR = 1800;
        const GENERATION_SPAN = 25;

        data.forEach(p => {
            const year = p.birth_year;
            if (typeof year !== 'number' || year === null || year < BASE_YEAR || year > new Date().getFullYear()) {
                return;
            }
            const genIndex = Math.floor((year - BASE_YEAR) / GENERATION_SPAN);Â 
            generations[genIndex] = (generations[genIndex] || 0) + 1;
        });
        
        const sortedGenerations = Object.entries(generations).sort((a, b) => +a[0] - +b[0]);
        const genLabels = sortedGenerations.map(([index]) => {
            const startYear = BASE_YEAR + (+index * GENERATION_SPAN);
            const endYear = startYear + GENERATION_SPAN - 1;
            return startYear + ' - ' + endYear;
        });
        const genValues = sortedGenerations.map(([, count]) => count);
        const BAR_COLOR = "#4f46e5";

        if (chartInstances.generation) chartInstances.generation.destroy();
        const ctx = document.getElementById("generationChart").getContext("2d");
        chartInstances.generation = new Chart(ctx, {
            type: "bar",
            data: {
                labels: genLabels,
                datasets: [{
                    label: texts.peopleCount,
                    data: genValues,
                    backgroundColor: BAR_COLOR,
                    borderColor: BAR_COLOR,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: texts.peopleCount } },
                    x: { reverse: true, title: { display: true, text: texts.birthYears } }Â 
                },
                plugins: { tooltip: { rtl: lang === 'HE' } }
            }
        });
    }
    
    function renderLifeExpectancyChart(data, lang) {
        const texts = translations[lang];
        const lifeSpanData = data.filter(p => p.birth_year && p.death_year && p.death_year > p.birth_year);
        const lifeSpansByDecade = {};

        lifeSpanData.forEach(p => {
            const decade = Math.floor(p.birth_year / 10) * 10;
            const lifeSpan = p.death_year - p.birth_year;
            if (!lifeSpansByDecade[decade]) {
                lifeSpansByDecade[decade] = { total: 0, count: 0 };
            }
            lifeSpansByDecade[decade].total += lifeSpan;
            lifeSpansByDecade[decade].count++;
        });

        const sortedLifeSpans = Object.entries(lifeSpansByDecade).sort((a, b) => +a[0] - +b[0]);
        const lifeSpanLabels = sortedLifeSpans.map(([decade]) => `${decade} - ${+decade + 9}`);
        const avgLifeSpans = sortedLifeSpans.map(([, data]) => (data.total / data.count).toFixed(1));
        const LIFESPAN_COLOR = "#059669";

        if (chartInstances.lifeExpectancy) chartInstances.lifeExpectancy.destroy();
        const ctx = document.getElementById("lifeExpectancyChart").getContext("2d");
        chartInstances.lifeExpectancy = new Chart(ctx, {
            type: "bar",
            data: {
                labels: lifeSpanLabels,
                datasets: [{
                    label: texts.avgLifeSpan,
                    data: avgLifeSpans,
                    backgroundColor: LIFESPAN_COLOR,
                    borderColor: LIFESPAN_COLOR,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: texts.years } },
                    x: { reverse: true, title: { display: true, text: texts.birthDecade } }Â 
                },
                plugins: { tooltip: { rtl: lang === 'HE' } }
            }
        });
    }
    
    function renderBirthTrendChart(data, lang) {
        const texts = translations[lang];
        const birthTrend = {};
        data.forEach(p => {
            if (p.birth_year) {
                const decade = Math.floor(p.birth_year / 10) * 10;
                birthTrend[decade] = (birthTrend[decade] || 0) + 1;
            }
        });

        const sortedBirthTrend = Object.entries(birthTrend).sort((a, b) => +a[0] - +b[0]);
        const trendLabels = sortedBirthTrend.map(([decade]) => decade);
        const trendValues = sortedBirthTrend.map(([, count]) => count);
        const TREND_COLOR = "#f59e0b";

        if (chartInstances.birthTrend) chartInstances.birthTrend.destroy();
        const ctx = document.getElementById("birthTrendChart").getContext("2d");
        chartInstances.birthTrend = new Chart(ctx, {
            type: "line",
            data: {
                labels: trendLabels,
                datasets: [{
                    label: texts.birthCount,
                    data: trendValues,
                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                    borderColor: TREND_COLOR,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: texts.birthCount } },
                    x: { reverse: true, title: { display: true, text: texts.decade } }Â 
                },
                plugins: { tooltip: { rtl: lang === 'HE' } }
            }
        });
    }
    
    function renderAvgChildrenChart(data, lang) {
        const texts = translations[lang];
        const childrenAvg = {};
        const GENERATION_SPAN = 25;

        data.filter(p => p.is_adult_for_children_avg).forEach(p => {
            const genIndex = Math.floor(p.birth_year / GENERATION_SPAN); 
            const generationStartYear = genIndex * GENERATION_SPAN;
            
            if (!childrenAvg[generationStartYear]) {
                childrenAvg[generationStartYear] = { totalChildren: 0, adultCount: 0 };
            }
            childrenAvg[generationStartYear].totalChildren += p.children_count;
            childrenAvg[generationStartYear].adultCount++;
        });

        const sortedChildrenAvg = Object.entries(childrenAvg).sort((a, b) => +a[0] - +b[0]);
        const avgChildrenLabels = sortedChildrenAvg.map(([year]) => `${year} - ${+year + GENERATION_SPAN - 1}`);
        const avgChildrenValues = sortedChildrenAvg.map(([, data]) => (data.totalChildren / data.adultCount).toFixed(1));
        const CHILDREN_COLOR = "#ef4444";

        if (chartInstances.avgChildren) chartInstances.avgChildren.destroy();
        const ctx = document.getElementById("avgChildrenChart").getContext("2d");
        chartInstances.avgChildren = new Chart(ctx, {
            type: "bar",
            data: {
                labels: avgChildrenLabels,
                datasets: [{
                    label: texts.avgChildren,
                    data: avgChildrenValues,
                    backgroundColor: CHILDREN_COLOR,
                    borderColor: CHILDREN_COLOR,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: texts.avgChildren } },
                    x: { reverse: true, title: { display: true, text: texts.generation } }Â 
                },
                plugins: { tooltip: { rtl: lang === 'HE' } }
            }
        });
    }

    // --- ×¤×•× ×§×¦×™×” ×—×“×©×”: ×”×ª×¤×œ×’×•×ª ×’×™×œ××™× × ×•×›×—×™×ª ×•×’×™×œ ××•×•×ª ---
    function renderAgeDistributionChart(data, lang) {
        const texts = translations[lang];
        // ×”×’×“×¨×ª ×˜×•×•×—×™ ×’×™×œ××™×
        const BINS = [0, 20, 40, 60, 80]; 
        const binLabels = BINS.map((start, i) => 
            i === BINS.length - 1 ? `${start}+` : `${start}-${BINS[i+1]-1}`
        ).reverse(); // ×”×¦×’×” ××”×’×™×œ××™× ×”××‘×•×’×¨×™× ×œ×¦×¢×™×¨×™× ×œ×©× ××—×™×“×•×ª ×¢× ×¦×™×¨×™× ××—×¨×™×
        
        const currentAgeCounts = Array(BINS.length).fill(0);
        const ageAtDeathCounts = Array(BINS.length).fill(0);

        data.forEach(p => {
            let binIndex;
            // Current Age (Living)
            if (p.current_age !== undefined && p.current_age >= 0) {
                binIndex = BINS.findIndex((start, i) => 
                    i === BINS.length - 1 ? p.current_age >= start : p.current_age >= start && p.current_age < BINS[i+1]
                );
                if (binIndex !== -1) currentAgeCounts[binIndex]++;
            }
            
            // Age at Death (Deceased)
            if (p.age_at_death !== undefined && p.age_at_death >= 0) {
                binIndex = BINS.findIndex((start, i) => 
                    i === BINS.length - 1 ? p.age_at_death >= start : p.age_at_death >= start && p.age_at_death < BINS[i+1]
                );
                if (binIndex !== -1) ageAtDeathCounts[binIndex]++;
            }
        });
        
        // ×”×™×¤×•×š ×¡×“×¨ ×”× ×ª×•× ×™× ×›×“×™ ×©×™×ª××™× ×œ×ª×•×•×™×•×ª ×”×”×¤×•×›×•×ª
        currentAgeCounts.reverse();
        ageAtDeathCounts.reverse();

        if (chartInstances.ageDistribution) chartInstances.ageDistribution.destroy();
        const ctx = document.getElementById("ageDistributionChart").getContext("2d");
        chartInstances.ageDistribution = new Chart(ctx, {
            type: "bar",
            data: {
                labels: binLabels,
                datasets: [
                    {
                        label: texts.currentAge,
                        data: currentAgeCounts,
                        backgroundColor: '#8b5cf6', // Purple
                        stack: 'stack0',
                    },
                    {
                        label: texts.ageAtDeath,
                        data: ageAtDeathCounts,
                        backgroundColor: '#f97316', // Orange
                        stack: 'stack0',
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: texts.peopleCount } 
                    },
                    x: { 
                        title: { display: true, text: texts.ageBins }Â 
                    }
                },
                plugins: {
                    tooltip: { rtl: lang === 'HE' }
                }
            }
        });
    }

    function renderAllCharts(data, lang) {
        renderGenderChart(data, lang);
        renderGenerationChart(data, lang);
        renderLifeExpectancyChart(data, lang);
        renderBirthTrendChart(data, lang);
        renderAvgChildrenChart(data, lang);
        renderAgeDistributionChart(data, lang); // ×”×ª×¨×©×™× ×”×—×“×©
    }


Â  Â  // --- ×¤×•× ×§×¦×™×” ×¨××©×™×ª ---

Â  Â  async function loadFamilyStats() {
Â  Â  Â  Â  updateUI(); // ×¢×“×›×•×Ÿ UI ×¨××©×•× ×™
Â  Â  Â  Â  
Â  Â  Â  Â  const familyInfoElement = document.getElementById("family-info");
Â  Â  Â  Â  const allFamilyData = [];
Â  Â  Â  Â  const loadedFamilies = [];
Â  Â  Â  Â  const failedFamilies = [];
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // 1. ×©×œ×™×¤×ª ×¤×¨×˜×™ ××©×ª××© ×•×§×‘×œ×ª ×¦×“ ××©×¤×—×” ×’×•×œ××™
Â  Â  Â  Â  familyInfoElement.textContent = T('statusLoadingUser'); // × × ×™×— ×©×™×© ××¤×ª×— ×›×–×”
Â  Â  Â  Â  const userResponse = await fetch('/api/user');
Â  Â  Â  Â  if (!userResponse.ok) {
Â  Â  Â  Â  Â  throw new Error('×©×’×™××” ' + userResponse.status + ': ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¤×¨×˜×™ ××©×ª××©.');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userData = await userResponse.json();
Â  Â  Â  Â  const rawFamilySide = userData.user?.familySide;Â 

Â  Â  Â  Â  if (!rawFamilySide || typeof rawFamilySide !== 'string' || rawFamilySide === '×œ× ××•×’×“×¨') {
Â  Â  Â  Â  Â  throw new Error("×©×“×” 'familySide' ×—×¡×¨, ×œ× ×ª×§×™×Ÿ ××• ×œ× ××•×’×“×¨ ×‘×¤×¨×˜×™ ×”××©×ª××©. (× ×“×¨×© ×©× ××©×¤×—×” ××—×“ ××• ×™×•×ª×¨, ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×).");
Â  Â  Â  Â  }
        
        // ×¤×™×¦×•×œ ×©××•×ª ×”××©×¤×—×” ×•× ×™×§×•×™ ×¨×•×•×—×™×
        const familyNames = rawFamilySide.split(',')
            .map(name => name.trim())
            .filter(name => name.length > 0);

Â  Â  Â  Â  if (familyNames.length === 0) {
Â  Â  Â  Â  Â  throw new Error("×©×“×” 'familySide' ××›×™×œ ×ª×•×•×™×, ××š ×œ× × ××¦××• ×©××•×ª ××©×¤×—×” ×ª×§×™× ×™× ×œ×¢×™×‘×•×“ ×œ××—×¨ × ×™×§×•×™.");
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. ×©×œ×™×¤×ª ×§×‘×¦×™×, ×¦×‘×™×¨×” ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª
        for (const familySide of familyNames) {
Â  Â  Â  Â  Â  Â  const dataUrl = '/trees/' + familySide + '.html';
Â  Â  Â  Â  Â  Â  familyInfoElement.textContent = `×˜×•×¢×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨: ${familySide}...`;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataResponse = await fetch(dataUrl);
Â  Â  Â  Â  Â  Â  Â  Â  if (!dataResponse.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('×©×’×™××ª ×©×¨×ª: ' + dataResponse.status);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const rawText = await dataResponse.text();
Â  Â  Â  Â  Â  Â  Â  Â  const rawData = extractFamilyData(rawText);

Â  Â  Â  Â  Â  Â  Â  Â  // ×¦×‘×™×¨×ª ×”× ×ª×•× ×™×
Â  Â  Â  Â  Â  Â  Â  Â  allFamilyData.push(...rawData);
Â  Â  Â  Â  Â  Â  Â  Â  loadedFamilies.push(familySide);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('×›×©×œ ×‘×˜×¢×™× ×ª ' + familySide + ': ' + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  failedFamilies.push({ name: familySide, message: error.message });
Â  Â  Â  Â  Â  Â  }
        }

        if (allFamilyData.length === 0) {
             let errorMsg = "×œ× × ××¦××• × ×ª×•× ×™× ×›×œ×œ ×œ×¢×™×‘×•×“ ×¡×˜×˜×™×¡×˜×™ ××›×œ ×”×§×‘×¦×™× ×©× ×™×¡×™×ª×™ ×œ×˜×¢×•×Ÿ.";
             if (failedFamilies.length > 0) {
                 errorMsg += " (× ×›×©×œ×•: " + failedFamilies.map(f => f.name).join(', ') + ")";
             }
             throw new Error(errorMsg);
        }

Â  Â  Â  Â  // 3. × ×™×§×•×™ ×•×¡×™× ×•×Ÿ × ×ª×•× ×™× ×•×”×›× ×” ×œ×ª×¨×©×™××™×
Â  Â  Â  Â  familyInfoElement.textContent = "××—×œ×¥ ×•×× ×§×” × ×ª×•× ×™×...";
Â  Â  Â  Â 
        const CURRENT_YEAR = new Date().getFullYear();
        // ×”×›× ×ª × ×ª×•× ×™× - × ×™×¨××•×œ ×©× ×•×ª ×œ×™×“×”/××•×•×ª ×•×”×•×¡×¤×ª ×©×“×•×ª ×’×™×œ ×—×“×©×™×
Â  Â  Â  Â  cleanedData = allFamilyData
            .map(p => {
                const birth_year = normalizeYear(p.birth_year);
                const death_year = normalizeYear(p.death_year);
                
                const processed = {
                    ...p,
                    birth_year: birth_year,
                    death_year: death_year,
                    children_count: Array.isArray(p.children_ids) ? p.children_ids.length : 0,
                    is_adult_for_children_avg: birth_year !== null && birth_year < 1970 
                };
                
                // ×—×™×©×•×‘ ×’×™×œ ×‘××•×•×ª ×•×’×™×œ × ×•×›×—×™ (×œ×¦×•×¨×š ×”×ª×¨×©×™× ×”×—×“×©)
                if (birth_year) {
                    if (death_year && death_year > birth_year) {
                        processed.age_at_death = death_year - birth_year;
                    }
                    if (!death_year || death_year >= CURRENT_YEAR) {
                        processed.current_age = CURRENT_YEAR - birth_year;
                    }
                }
                return processed;
            })
            // ×¡×™× ×•×Ÿ ×¨×§ ×©×œ ×¨×©×•××•×ª ×©×™×© ×‘×”×Ÿ ×œ×¤×—×•×ª ××™×“×¢ ××—×“ ×¨×œ×•×•× ×˜×™
            .filter(p => p.gender || p.birth_year); 

Â  Â  Â  Â  if (cleanedData.length === 0) {
Â  Â  Â  Â  Â  Â  throw new Error('×”× ×ª×•× ×™× ×—×•×œ×¦×• ×‘×”×¦×œ×—×”, ××š ×œ× × ××¦××• ×¨×©×•××•×ª ×ª×§×™× ×•×ª ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª (×›× ×¨××” ×©×“×•×ª ××’×“×¨/×©× ×ª ×œ×™×“×” ×—×¡×¨×™×) ××ª×•×š ' + allFamilyData.length + ' ×¨×©×•××•×ª ×’×•×œ××™×•×ª.');
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. ×™×¦×™×¨×ª ×”×ª×¨×©×™××™×
        renderAllCharts(cleanedData, currentLang);


Â  Â  Â  Â  // 5. ×¡×™×•× ×˜×¢×™× ×”
Â  Â  Â  Â  document.getElementById("loading").style.display = "none";
Â  Â  Â  Â  document.getElementById("main-content").style.display = "block";
Â  Â  Â  Â  
        let statusMessage = '×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×¢×‘×•×¨ ×”××©×¤×—×•×ª: <b>' + loadedFamilies.join(', ') + '</b>. ×¡×š ×× ×©×™× ××¢×•×‘×“×™×: ' + cleanedData.length;
        
        if (failedFamilies.length > 0) {
            statusMessage += '. <br><span class="text-yellow-600 font-bold">×©×™××• ×œ×‘: × ×›×©×œ×” ×˜×¢×™× ×” ×¢×‘×•×¨: ' + failedFamilies.map(f => f.name).join(', ') + '.</span>';
        }

Â  Â  Â  Â  familyInfoElement.innerHTML = '<span class="text-green-700 font-semibold">' + statusMessage + '</span>';


Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("×©×’×™××” ×§×¨×™×˜×™×ª:", error);
Â  Â  Â  Â  displayError('××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message);
Â  Â  Â  }
Â  Â  }
    
    // --- ××™×ª×—×•×œ ×•×”×—×œ×¤×ª ×©×¤×” ---
    
    document.addEventListener('DOMContentLoaded', () => {
        // ×”×•×¡×¤×ª Listener ×œ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×”×©×¤×”
        document.getElementById('lang-toggle-button').addEventListener('click', () => {
            currentLang = currentLang === 'HE' ? 'EN' : 'HE';
            updateUI();
        });
        
        loadFamilyStats();
    });

Â  </script>
</body>
</html>
