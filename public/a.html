<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📊 סטטיסטיקות משפחתיות</title>
  
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Heebo Font link -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* הגדרת הפונט הראשי לכל הדף */
    body { font-family: 'Heebo', sans-serif; }
    /* כדי שהתרשימים יהיו רספונסיביים בתוך הכרטיסים */
    canvas { max-width: 100%; height: auto; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-right p-4 sm:p-8">
  <div class="max-w-6xl mx-auto">

    <!-- כותרת ראשית והודעת סטטוס -->
    <header class="mb-10 text-center">
        <h1 id="main-title" class="text-6xl font-extrabold text-blue-800 mb-3 flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 text-yellow-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h12.75M3 17.25h12.75M3 21h12.75" />
            </svg>
            סטטיסטיקות עץ משפחתי
        </h1>
        <p class="status-message text-lg text-gray-600 font-medium" id="family-info">טוען צד משפחה...</p>
    </header>

    <!-- מסך טעינה -->
    <div id="loading" class="flex justify-center items-center h-40">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <span class="text-xl text-gray-700 mr-4">טוען נתונים... אנא המתן.</span>
    </div>
    
    <!-- תוכן ראשי: יוצג לאחר הטעינה -->
    <div id="main-content" class="space-y-10" style="display: none;">
      
      <!-- קונטיינר לתרשימים - רשת רספונסיבית: טור אחד בטלפון, שני טורים במסך גדול -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- כרטיס תרשים מגדר -->
        <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
             👤 התפלגות לפי מגדר (זכרים מול נקבות)
          </h2>
          <canvas id="genderChart"></canvas>
        </div>
        
        <!-- כרטיס תרשים דורות -->
        <div class="chart-container bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-2xl">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-100 pb-3">
            📅 התפלגות לפי דור (כל 25 שנה)
          </h2>
          <canvas id="generationChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- פונקציות עזר ---

    function displayError(message) {
      document.getElementById("loading").style.display = "none";
      const mainContent = document.getElementById("main-content");
      mainContent.style.display = "block";
      
      const familyInfoElement = document.getElementById("family-info");
      familyInfoElement.innerHTML = `<span class="text-red-600 font-bold bg-red-100 p-2 rounded">${message}</span>`;
      
      document.querySelectorAll('.chart-container').forEach(el => el.style.display = 'none');
      document.getElementById("main-title").style.display = "none";
    }

    /**
     * פונקציה משופרת לחילוץ מערך JSON של נתונים מתוך טקסט גולמי מעורב.
     * כוללת ניקוי של "פסיקים מיותרים" (Trailing Commas) שאינם חוקיים ב-JSON
     * @param {string} rawText - הטקסט הגולמי של הקובץ (למשל, קובץ HTML).
     * @returns {Array<Object>} מערך האובייקטים של האנשים.
     * @throws {Error} אם לא נמצא JSON תקין.
     */
    function extractFamilyData(rawText) {
      // 1. ביטוי רגולרי גרידי לחיפוש מערך שמתחיל ב- '[' ואחריו לפחות אובייקט אחד שמתחיל ב- '{' ומסתיים ב- '}]'
      // [[\s\S]*] - מחפש את הבלוק הגדול ביותר בין הסוגריים המרובעים החיצוניים.
      const jsonRegex = /(\[\s*\{[\s\S]*\}\s*\])/; 
      const match = rawText.match(jsonRegex);

      if (match && match[1]) {
        let jsonString = match[1].trim();

        // 2. ניקוי: הסרת פסיקים מיותרים (Trailing Commas) הנפוצים ב-JS אך לא חוקיים ב-JSON.
        // מחפש פסיק ואחריו רווחים ואז סוגר מסולסל/מרובע.
        jsonString = jsonString.replace(/,\s*([\]}])/g, '$1');

        try {
          const data = JSON.parse(jsonString);
          
          if (Array.isArray(data) && data.length > 0) {
            return data;
          }
        } catch (e) {
          console.error("שגיאת ניתוח JSON לאחר חילוץ וניקוי:", e);
          // ניתן להציג חלקיק מהמחרוזת שנכשלה לצורך איתור באגים נוסף
          // console.log("JSON String that failed to parse (first 500 chars):", jsonString.substring(0, 500));
          throw new Error("הנתונים חולצו אך עדיין אינם במבנה JSON תקין, גם לאחר ניקוי פסיקים מיותרים. בדוק את מבנה הקובץ המקורי.");
        }
      }
      
      throw new Error("לא נמצא מבנה נתונים JSON (מערך אנשים) בקובץ שנטען. ייתכן שהנתונים אינם במבנה: [{...}].");
    }


    // --- פונקציה ראשית ---

    async function loadFamilyStats() {
      const familyInfoElement = document.getElementById("family-info");
      
      try {
        // 1. שליפת פרטי משתמש וצד משפחה (familySide)
        familyInfoElement.textContent = "שולף פרטי משתמש...";
        const userResponse = await fetch('/api/user');
        if (!userResponse.ok) {
          throw new Error(`שגיאה ${userResponse.status}: לא ניתן לטעון פרטי משתמש.`);
        }
        
        const userData = await userResponse.json();
        const familySide = userData.user?.familySide; 

        if (!familySide || typeof familySide !== 'string' || familySide === 'לא מוגדר') {
          throw new Error("שדה 'familySide' חסר, לא תקין או לא מוגדר בפרטי המשתמש.");
        }

        // 2. שליפת קובץ הנתונים כטקסט
        const dataUrl = `/trees/${familySide}.html`;
        familyInfoElement.textContent = `טוען קובץ גולמי עבור המשפחה: ${familySide} מ: ${dataUrl}...`;
        
        const dataResponse = await fetch(dataUrl);
        if (!dataResponse.ok) {
          throw new Error(`שגיאה ${dataResponse.status}: קובץ הנתונים ${familySide}.html לא נמצא בשרת.`);
        }
        
        // טוען את כל הקובץ כטקסט (כדי לחלץ את ה-JSON מתוכו)
        const rawText = await dataResponse.text();
        
        // 3. חילוץ נתונים קפדני
        familyInfoElement.textContent = "מחלץ ומנקה נתונים...";
        const rawData = extractFamilyData(rawText);

        // סינון נתונים - ודא שיש שדה 'gender' או שדה 'birth_year'
        const cleanedData = rawData.filter(p => {
          if (!p || typeof p !== 'object') return false;
          
          const hasValidGender = p.gender && (p.gender === "M" || p.gender === "F");
          // birth_year נחשב תקין אם הוא מספר בין 1500 לשנה הנוכחית.
          const isBirthYearValid = typeof p.birth_year === 'number' && p.birth_year > 1500 && p.birth_year <= new Date().getFullYear();
          
          return hasValidGender || isBirthYearValid;
        });

        if (cleanedData.length === 0 && rawData.length > 0) {
          console.warn("Raw data length:", rawData.length);
          throw new Error(`הנתונים חולצו בהצלחה, אך לא נמצאו רשומות תקינות לסטטיסטיקות (כנראה שדות מגדר/שנת לידה חסרים).`);
        } else if (cleanedData.length === 0) {
          throw new Error("לא נמצאו נתונים כלל לעיבוד סטטיסטי.");
        }

        // 4. עיבוד והצגת התרשימים
        
        // --- נתוני מגדר (Pie Chart) ---
        const males = cleanedData.filter(p => p.gender === "M").length;
        const females = cleanedData.filter(p => p.gender === "F").length;
        
        const GENDER_COLORS = ["#3b82f6", "#10b981"];
        const ctxGender = document.getElementById("genderChart").getContext("2d");
        new Chart(ctxGender, {
          type: "pie",
          data: {
            labels: ["זכרים", "נקבות"],
            datasets: [{
              data: [males, females],
              backgroundColor: GENDER_COLORS,
              borderColor: '#ffffff',
              borderWidth: 2,
              hoverOffset: 15
            }]
          },
          options: {
             responsive: true,
             plugins: {
                legend: { position: 'bottom' },
                tooltip: { rtl: true }
             }
          }
        });

        // --- נתוני דורות (Bar Chart) - משתמש ב-birth_year ---
        const generations = {};
        const BASE_YEAR = 1800;
        const GENERATION_SPAN = 25;
        
        cleanedData.forEach(p => {
          const year = p.birth_year;
          
          // רק אנשים עם שנת לידה מספרית תקינה נכנסים לסטטיסטיקת דורות
          if (typeof year !== 'number' || year === null || year < BASE_YEAR || year > new Date().getFullYear()) {
            return;
          }

          const genIndex = Math.floor((year - BASE_YEAR) / GENERATION_SPAN); 
          generations[genIndex] = (generations[genIndex] || 0) + 1;
        });
        
        const sortedGenerations = Object.entries(generations).sort((a, b) => +a[0] - +b[0]);

        const genLabels = sortedGenerations.map(([index, count]) => {
            const startYear = BASE_YEAR + (+index * GENERATION_SPAN);
            const endYear = startYear + GENERATION_SPAN - 1;
            return `${startYear} - ${endYear}`;
        });
        const genValues = sortedGenerations.map(([index, count]) => count);

        const BAR_COLOR = "#4f46e5";
        const ctxGeneration = document.getElementById("generationChart").getContext("2d");
        new Chart(ctxGeneration, {
          type: "bar",
          data: {
            labels: genLabels,
            datasets: [{
              label: "מספר אנשים",
              data: genValues,
              backgroundColor: BAR_COLOR,
              borderColor: BAR_COLOR,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
              x: { reverse: true } 
            },
            plugins: {
              tooltip: { rtl: true }
            }
          }
        });

        // 5. סיום טעינה
        document.getElementById("loading").style.display = "none";
        document.getElementById("main-content").style.display = "block";
        familyInfoElement.innerHTML = `<span class="text-green-700 font-semibold">הנתונים נטענו בהצלחה עבור המשפחה: <b>${familySide}</b>. סך אנשים מעובדים: ${cleanedData.length}</span>`;


      } catch (error) {
        console.error("שגיאה קריטית:", error);
        displayError(`אירעה שגיאה בטעינת הנתונים: ${error.message}`);
      }
    }

    // הפעלת הפונקציה לאחר טעינת הדף
    window.onload = loadFamilyStats;
  </script>
</body>
</html>
