<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט גנאולוגי חכם</title>
    <!-- טעינת Tailwind CSS מה-CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <!-- CSS מותאם אישית עבור גלילה ועיצוב כללי -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        #chat-box::-webkit-scrollbar { width: 8px; }
        #chat-box::-webkit-scrollbar-track { background: #f1f5e9; }
        #chat-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #chat-box::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-content.active { display: flex; }
        .tab-content { display: none; }
        .chat-message.user {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-radius: 1rem 1rem 0 1rem;
            align-self: flex-end;
            margin-bottom: 0.5rem;
            max-width: 66.666667%; /* max-w-2/3 */
            padding: 0.75rem; /* p-3 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
        }
        .chat-message.ai {
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #1f2937; /* text-gray-800 */
            border-radius: 1rem 1rem 1rem 0;
            align-self: flex-start;
            margin-bottom: 0.5rem;
            max-width: 66.666667%; /* max-w-2/3 */
            padding: 0.75rem; /* p-3 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col p-4">

    <!-- Header -->
    <header class="bg-blue-800 text-white p-4 rounded-lg shadow-lg flex justify-between items-center mb-4">
        <h1 class="text-xl md:text-2xl font-bold" data-i18n="title">🧠 צ'אט גנאולוגי חכם</h1>
        <button id="langToggle" class="bg-white text-blue-800 font-semibold py-1 px-3 rounded-md shadow-md hover:bg-slate-200 transition-colors">English</button>
    </header>

    <!-- Main Container -->
    <div class="container bg-white p-6 rounded-lg shadow-xl flex-grow flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">
        
        <!-- Tabs Navigation -->
        <div class="md:w-1/4 flex md:flex-col gap-2 p-2 rounded-lg bg-slate-50 border border-slate-200">
            <button class="tab-button active w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 bg-white shadow-sm border border-slate-200 hover:bg-slate-100 transition-colors" data-tab="chat-tab" data-i18n="smartChat">🗣️ שיחה חכמה</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="relation-tab" data-i18n="relationCheck">🔗 בדיקת קשר</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="file-tab" data-i18n="fileAnalysis">📄 ניתוח מסמך</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="add-person-tab" data-i18n="addPerson">➕ הוספת אדם</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="autofill-tab" data-i18n="autofill">⚙️ השלמה אוטומטית</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="suggest-tab" data-i18n="suggest">🕸️ הצעת קשרים</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="story-tab" data-i18n="storyGen">✨ יצירת סיפור</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="quiz-tab" data-i18n="quizGen">🎲 יצירת חידון</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="biography-tab" data-i18n="biographyGen">📜 יצירת ביוגרפיה</button>
            <button class="tab-button w-full py-3 px-4 rounded-lg text-right font-semibold text-gray-700 hover:bg-slate-100 transition-colors" data-tab="historical-tab" data-i18n="historicalGen">🧭 הקשר היסטורי</button>
        </div>

        <!-- Tab Content -->
        <div class="md:w-3/4 flex flex-col flex-grow">
            
            <!-- Chat Tab -->
            <div id="chat-tab" class="tab-content active flex flex-col h-full">
                <div id="chat-box" class="flex-grow overflow-y-auto p-4 bg-slate-50 rounded-lg border border-slate-200 mb-4 flex flex-col-reverse">
                    <div class="flex items-center justify-center h-full text-slate-400 text-center">
                        <span data-i18n="chatPlaceholder">שאל שאלה על אילן היוחסין</span>
                    </div>
                </div>
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="user-input" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="askFamily" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="sendBtn">שלח</button>
                </form>
            </div>

            <!-- Relation Check Tab -->
            <div id="relation-tab" class="tab-content">
                <form id="relation-form" class="flex flex-col md:flex-row gap-4 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="name1" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="firstName" required />
                    <input type="text" id="name2" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="secondName" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="checkRelation">בדוק קשר</button>
                </form>
                <div id="relation-result" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[100px]"></div>
            </div>

            <!-- File Analysis Tab -->
            <div id="file-tab" class="tab-content">
                <form id="file-form" class="flex flex-col gap-4 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="file" id="doc-file" accept="image/*,.pdf" class="p-3 bg-white rounded-lg border border-slate-300" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="analyzeFile">נתח קובץ</button>
                </form>
                <div id="file-result" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[100px]"></div>
            </div>

            <!-- Add Person Tab -->
            <div id="add-person-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="addPerson">➕ הוספת אדם חדש</h2>
                <form id="add-person-form" class="flex flex-col md:flex-row gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="new-person-name" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="שם מלא" required />
                    <input type="text" id="new-person-details" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="פרטים נוספים (לידה, הורים וכו')" />
                    <button type="submit" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors" data-i18n="addBtn">הוסף</button>
                </form>
            </div>

            <!-- Autofill Details Tab -->
            <div id="autofill-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="autofill">⚙️ השלמה אוטומטית של פרטים</h2>
                <form id="autofill-form" class="flex gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="partial-name" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="name" />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="complete">השלם</button>
                </form>
                <div id="autofill-result" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[50px] mb-4"></div>
            </div>

            <!-- Suggest Relations Tab -->
            <div id="suggest-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="suggest">🕸️ הצעת קשרים חסרים</h2>
                <form id="suggest-form" class="flex gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="suggest-name" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-i18n-placeholder="suggestName" />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="suggestBtn">הצע קשרים</button>
                </form>
                <div id="suggest-result" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[50px] mb-4"></div>
            </div>

            <!-- Story Generation Tab -->
            <div id="story-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="storyGen">✨ יצירת סיפור</h2>
                <form id="story-form" class="flex gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="story-name" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="שם האדם לסיפור" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="storyBtn">יצירת סיפור</button>
                </form>
                <div id="story-result-container" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[50px] mb-4">
                    <div id="story-result" class="mb-2"></div>
                    <button id="story-audio-btn" class="hidden bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors w-full" data-i18n="readAloudBtn">🔊 הקרא לי</button>
                </div>
            </div>

            <!-- Quiz Generation Tab -->
            <div id="quiz-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="quizGen">🎲 יצירת חידון</h2>
                <button id="quiz-btn" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors w-full md:w-auto" data-i18n="quizBtn">יצירת חידון</button>
                <div id="quiz-result" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[50px] mt-4"></div>
            </div>

            <!-- Biography Generation Tab -->
            <div id="biography-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="biographyGen">📜 יצירת ביוגרפיה</h2>
                <form id="biography-form" class="flex gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="biography-name" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="שם האדם לביוגרפיה" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="biographyBtn">יצירת ביוגרפיה</button>
                </form>
                <div id="biography-result-container" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[50px] mb-4">
                    <div id="biography-result" class="mb-2"></div>
                    <button id="biography-audio-btn" class="hidden bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors w-full" data-i18n="readAloudBtn">🔊 הקרא לי</button>
                </div>
            </div>

            <!-- NEW: Historical Context Tab -->
            <div id="historical-tab" class="tab-content">
                <h2 class="text-lg font-bold text-gray-700 mb-2" data-i18n="historicalGen">🧭 הקשר היסטורי</h2>
                <form id="historical-form" class="flex gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="text" id="historical-name" class="flex-grow p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="שם האדם" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" data-i18n="historicalBtn">קבל הקשר היסטורי</button>
                </form>
                <div id="historical-result" class="p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[50px] mb-4"></div>
            </div>

        </div>
    </div>

<script type="module">
    // Import Firebase libraries
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables
    let db;
    let auth;
    let userId;
    let familyTreeData = [];
    let audioPlayer = null;

  // A single, unified declaration using 'let' so it can be reassigned
let firebaseConfig = null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Check if the global variable exists before parsing it.
if (typeof __firebase_config !== 'undefined' && __firebase_config) {
    try {
        firebaseConfig = JSON.parse(__firebase_config);
        console.log("Using global Firebase config.");
    } catch (e) {
        console.error("Error parsing Firebase config from global variable:", e);
    }
}

// If the global config wasn't found or was invalid, use a static fallback.
if (!firebaseConfig) {
    console.warn("Global Firebase config not found or invalid. Using static fallback.");
    firebaseConfig = {
        apiKey: "AIzaSyD7f9DqeBe-3BQ8-GzS0S2wgGEPfsA82L0",
        authDomain: "aichat-app-bf26f.firebaseapp.com",
        projectId: "aichat-app-bf26f",
        storageBucket: "aichat-app-bf26f.firebasestorage.app",
        messagingSenderId: "1067740756856",
        appId: "1:1067740756856:web:53d985cfcb4c723e23268d",
        measurementId: "G-QKCJEVFKYF"
    };
}

// Now you can use the firebaseConfig and appId variables safely.
// For example:
// initializeApp(firebaseConfig);

    // Initialize Firebase
    async function initFirebase() {
        try {
            // Only initialize if firebaseConfig is available
            if (!firebaseConfig || !Object.keys(firebaseConfig).length) {
                console.error("Initialization failed: Firebase config is missing or empty.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Sign in anonymously if no custom token is available
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            userId = auth.currentUser?.uid || crypto.randomUUID();
            console.log("Firebase initialized. User ID:", userId);

            // You can add more code here to start fetching data after initialization
        } catch (error) {
            console.error("Error initializing Firebase:", error);
        }
    }

    initFirebase();

        // Translation texts
        const translations = {
            he: {
                title: "🧠 צ'אט גנאולוגי חכם",
                smartChat: "🗣️ שיחה חכמה",
                relationCheck: "🔗 בדיקת קשר",
                fileAnalysis: "📄 ניתוח מסמך",
                addPerson: "➕ הוספת אדם",
                autofill: "⚙️ השלמה אוטומטית",
                suggest: "🕸️ הצעת קשרים",
                storyGen: "✨ יצירת סיפור",
                quizGen: "🎲 יצירת חידון",
                biographyGen: "📜 יצירת ביוגרפיה",
                historicalGen: "🧭 הקשר היסטורי",
                addBtn: "הוסף",
                sendBtn: "שלח",
                checkRelation: "בדוק קשר",
                analyzeFile: "נתח קובץ",
                firstName: "שם ראשון",
                secondName: "שם שני",
                askFamily: "שאל על אילן היוחסין...",
                chatPlaceholder: "שאל שאלה על אילן היוחסין",
                name: "שם",
                complete: "השלם",
                ocr: "🧠 זיהוי קשרים מתוך תמונה או מסמך (OCR)",
                suggestName: "הזן שם לבדיקה",
                suggestBtn: "הצע קשרים",
                storyBtn: "יצירת סיפור",
                quizBtn: "יצירת חידון",
                biographyBtn: "יצירת ביוגרפיה",
                historicalBtn: "קבל הקשר היסטורי",
                readAloudBtn: "🔊 הקרא לי",
                loading: "טוען...",
                error: "אירעה שגיאה. נסה שוב.",
                noInfo: "אין מידע זמין בנושא באילן היוחסין.",
                fileError: "אירעה שגיאה בטעינת הקובץ.",
                ocrResult: "תוצאת זיהוי טקסט ותמונות (OCR) מהקובץ:",
                simulated: "זוהי הדגמה בלבד. התשובה מבוססת על נתונים מוגדרים מראש ואינה מחוברת למאגר מידע אמיתי.",
                relationResult: "🔍 תוצאת בדיקת הקשר:",
                autofillResult: "השלמת פרטים:",
                suggestResult: "הצעות לקשרים חסרים:",
                storyResult: "תוצאת יצירת סיפור:",
                quizResult: "שאלות החידון:",
                biographyResult: "תוצאת יצירת ביוגרפיה:",
                historicalResult: "סיכום היסטורי:",
            },
            en: {
                title: "🧠 Smart Genealogy Chatbot",
                smartChat: "🗣️ Smart Chat",
                relationCheck: "🔗 Check Relation",
                fileAnalysis: "📄 Analyze Document",
                addPerson: "➕ Add Person",
                autofill: "⚙️ Autofill",
                suggest: "🕸️ Suggest Relations",
                storyGen: "✨ Story Generation",
                quizGen: "🎲 Quiz Generation",
                biographyGen: "📜 Biography Generation",
                historicalGen: "🧭 Historical Context",
                addBtn: "Add",
                sendBtn: "Send",
                checkRelation: "Check Relation",
                analyzeFile: "Analyze File",
                firstName: "First Name",
                secondName: "Second Name",
                askFamily: "Ask about the family tree...",
                chatPlaceholder: "Ask a question about the family tree",
                name: "Name",
                complete: "Complete",
                ocr: "🧠 Identify Relations from a Document (OCR)",
                suggestName: "Enter name to check",
                suggestBtn: "Suggest Connections",
                storyBtn: "Generate Story",
                quizBtn: "Generate Quiz",
                biographyBtn: "Generate Biography",
                historicalBtn: "Get Historical Context",
                readAloudBtn: "🔊 Read Aloud",
                loading: "Loading...",
                error: "An error occurred. Please try again.",
                noInfo: "No information available on this topic in the family tree.",
                fileError: "An error occurred while loading the file.",
                ocrResult: "OCR and image analysis result from the file:",
                simulated: "This is a demonstration only. The answer is based on pre-defined data and is not connected to a real database.",
                relationResult: "🔍 Relation Check Result:",
                autofillResult: "Details Autofill:",
                suggestResult: "Suggestions for missing connections:",
                storyResult: "Story Generation Result:",
                quizResult: "Quiz Questions:",
                biographyResult: "Biography Generation Result:",
                historicalResult: "Historical Summary:",
            }
        };

        let currentLang = "he";

        // --- UI and Language Logic ---

        // Function to apply translations based on current language
        function applyTranslations(lang) {
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === "he" ? "rtl" : "ltr";
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
                const key = el.getAttribute("data-i18n-placeholder");
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
        }

        // Function to show a loading message
        function setLoadingState(elementId) {
            document.getElementById(elementId).innerHTML = `<p class="text-gray-500">${translations[currentLang].loading}</p>`;
        }

        // Function to display a result
        function displayResult(elementId, titleKey, text) {
            const resultDiv = document.getElementById(elementId);
            const title = translations[currentLang][titleKey];
            resultDiv.innerHTML = `<h3 class="text-blue-800 font-bold">${title}</h3><p>${text}</p>`;
        }

        // Function to display an error message
        function displayError(elementId, errorKey) {
            document.getElementById(elementId).innerHTML = `<p class="text-red-500">${translations[currentLang][errorKey]}</p>`;
        }

        // --- API and Core Application Logic ---

        /**
         * Function to call the Gemini API
         * @param {string} prompt - The text prompt for the query.
         * @param {string|null} base64Image - Base64 encoded image data.
         * @param {string|null} responseMimeType - Optional MIME type for structured responses (e.g., 'application/json')
         * @returns {Promise<string>} The AI's response text.
         */
        async function callGeminiAPI(prompt, base64Image = null, responseMimeType = null) {
            const apiKey = ""; // API key is provided at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];

            if (base64Image) {
                chatHistory[0].parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: base64Image
                    }
                });
            }

            const payload = { contents: chatHistory };
            if (responseMimeType) {
                payload.generationConfig = { responseMimeType };
            }

            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            return translations[currentLang].error;
        }

        /**
         * Function to call the Gemini TTS API
         * @param {string} text - The text to convert to speech.
         * @returns {Promise<AudioBuffer>} The audio data as an AudioBuffer.
         */
        async function callGeminiTtsAPI(text) {
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = ""; // API key is provided at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`TTS API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);

                    // Create a new AudioBuffer with the same properties
                    const audioBuffer = audioContext.createBuffer(1, pcm16.length, sampleRate);
                    const nowBuffering = audioBuffer.getChannelData(0);
                    for (let i = 0; i < pcm16.length; i++) {
                        // Normalize 16-bit PCM to float32 range [-1, 1]
                        nowBuffering[i] = pcm16[i] / 32768;
                    }

                    return audioBuffer;
                } else {
                    throw new Error("Invalid TTS API response structure.");
                }
            } catch (error) {
                console.error("TTS API error:", error);
                throw error;
            }
        }

        /**
         * Helper function to convert base64 to ArrayBuffer
         * @param {string} base64 - Base64 encoded string.
         * @returns {ArrayBuffer} ArrayBuffer containing decoded data.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Function to load initial data into the database if it's empty
        async function loadInitialData() {
            const treeData = [
                { name: "יצחק לוי", details: "תאריך לידה: 1945, מקום לידה: צפת, בן של אליהו וחנה. נשוי לרבקה." },
                { name: "רבקה לוי", details: "תאריך לידה: 1948, מקום לידה: תל אביב, בת של שמואל ואסתר. נשואה ליצחק." },
                { name: "דוד לוי", details: "תאריך לידה: 1975, מקום לידה: חיפה, בנם של יצחק ורבקה. נשוי למירב." },
                { name: "מירב לוי (לבית כהן)", details: "תאריך לידה: 1978, מקום לידה: נתניה, בת של יוסי ושושנה. נשואה לדוד." },
                { name: "נועה לוי", details: "תאריך לידה: 2002, מקום לידה: ראשון לציון, בתם של דוד ומירב." },
                { name: "אליהו לוי", details: "תאריך לידה: 1915, מקום לידה: ירושלים." },
                { name: "חנה לוי", details: "תאריך לידה: 1920, מקום לידה: יפו." },
                { name: "שמואל כהן", details: "תאריך לידה: 1925, מקום לידה: ורשה." },
                { name: "אסתר כהן", details: "תאריך לידה: 1928, מקום לידה: קרקוב." },
                { name: "יוסי כהן", details: "תאריך לידה: 1950, מקום לידה: נתניה, בנם של שמואל ואסתר. נשוי לשושנה." },
                { name: "שושנה כהן", details: "תאריך לידה: 1953, מקום לידה: תל אביב." },
            ];

            const treeRef = collection(db, `/artifacts/${appId}/users/${userId}/family_tree`);
            const snapshot = await getDocs(treeRef);
            if (snapshot.empty) {
                for (const person of treeData) {
                    await addDoc(treeRef, person);
                }
            }
        }

        // Function to add a new person to the database
        async function addPersonToDB(name, details) {
            if (!db || !userId) return;
            const treeRef = collection(db, `/artifacts/${appId}/users/${userId}/family_tree`);
            try {
                await addDoc(treeRef, { name: name, details: details });
                document.getElementById("new-person-name").value = "";
                document.getElementById("new-person-details").value = "";
                alert("האדם נוסף בהצלחה!");
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("אירעה שגיאה בהוספת האדם.");
            }
        }

        // Function to prepare the family tree context from the database data
        function prepareFamilyTreeContext() {
            let context = "אילן יוחסין:\n";
            familyTreeData.forEach(person => {
                context += `- שם: ${person.name}, ${person.details}\n`;
            });
            return context;
        }

        // --- Event Handlers ---

        document.addEventListener("DOMContentLoaded", async () => {
            applyTranslations(currentLang);
            document.getElementById("langToggle").textContent = "English";
            
            // Initialize Firebase and authenticate
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid;
                if (!userId) {
                    console.error("User ID not available.");
                    return;
                }
                
                // Load initial data if the database is empty
                await loadInitialData();

                // Listen for real-time changes to the family tree
                const treeRef = collection(db, `/artifacts/${appId}/users/${userId}/family_tree`);
                onSnapshot(treeRef, (snapshot) => {
                    const treeList = [];
                    snapshot.forEach(doc => {
                        treeList.push({ id: doc.id, ...doc.data() });
                    });
                    familyTreeData = treeList;
                    console.log("Family tree data updated:", familyTreeData);
                });

            } catch (e) {
                console.error("Firebase initialization failed: ", e);
            }
        });

        document.getElementById("langToggle").addEventListener("click", () => {
            currentLang = currentLang === "he" ? "en" : "he";
            document.getElementById("langToggle").textContent = currentLang === "he" ? "English" : "עברית";
            applyTranslations(currentLang);
        });

        // Tab switching logic
        document.querySelectorAll(".tab-button").forEach(button => {
            button.addEventListener("click", () => {
                document.querySelectorAll(".tab-button").forEach(btn => {
                    btn.classList.remove("active", "bg-white", "shadow-sm", "border");
                    btn.classList.add("hover:bg-slate-100");
                });
                document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
                button.classList.add("active", "bg-white", "shadow-sm", "border");
                button.classList.remove("hover:bg-slate-100");
                const tabId = button.getAttribute("data-tab");
                document.getElementById(tabId).classList.add("active");
            });
        });

        // Add person form
        document.getElementById("add-person-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("new-person-name").value.trim();
            const details = document.getElementById("new-person-details").value.trim();
            if (name) {
                await addPersonToDB(name, details);
            }
        });

        // Chat form
        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const userInput = document.getElementById("user-input");
            const chatBox = document.getElementById("chat-box");
            const question = userInput.value.trim();
            if (!question) return;

            // Display user message
            chatBox.insertAdjacentHTML('afterbegin', `<div class="chat-message user">${question}</div>`);
            userInput.value = "";
            
            // Display AI loading message
            const loadingMsg = document.createElement("div");
            loadingMsg.className = "chat-message ai";
            loadingMsg.textContent = translations[currentLang].loading;
            chatBox.insertAdjacentElement('afterbegin', loadingMsg);

            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `אתה צ'אט בוט גנאולוגי מומחה. ענה על השאלה הבאה בהתבסס על אילן היוחסין הנתון. אם המידע אינו זמין, ציין זאת במפורש. הנתונים הם:
            ${familyTreeContext}
            שאלת המשתמש: ${question}`;

            try {
                const answer = await callGeminiAPI(prompt);
                loadingMsg.textContent = answer;
            } catch (error) {
                loadingMsg.textContent = translations[currentLang].error;
            }
        });

        // Relation check form
        document.getElementById("relation-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name1 = document.getElementById("name1").value.trim();
            const name2 = document.getElementById("name2").value.trim();
            setLoadingState("relation-result");
            
            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `בהתבסס על אילן היוחסין הבא, מה הקשר המשפחתי בין ${name1} ל-${name2}? אם המידע לא קיים, ציין זאת.
            ${familyTreeContext}`;
            
            try {
                const answer = await callGeminiAPI(prompt);
                displayResult("relation-result", "relationResult", answer);
            } catch (error) {
                displayError("relation-result", "error");
            }
        });

        // File analysis form (OCR)
        document.getElementById("file-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById("doc-file");
            setLoadingState("file-result");
            
            const file = fileInput.files[0];
            if (!file) {
                displayError("file-result", "fileError");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const base64Image = event.target.result.split(',')[1];
                    const prompt = `בצע זיהוי תווים אופטי (OCR) על המסמך הזה. מצא שמות, תאריכים, ומקומות לידה. נתח כל קשר משפחתי אפשרי שמופיע בטקסט.`;
                    const answer = await callGeminiAPI(prompt, base64Image);
                    document.getElementById("file-result").innerHTML = `<h3 class="text-blue-800 font-bold">${translations[currentLang].ocrResult}</h3><p>${answer}</p><p class="text-sm text-gray-400 mt-2">${translations[currentLang].simulated}</p>`;
                } catch (error) {
                    displayError("file-result", "error");
                }
            };
            reader.onerror = () => {
                displayError("file-result", "fileError");
            };
            reader.readAsDataURL(file);
        });

        // Autofill form
        document.getElementById("autofill-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("partial-name").value.trim();
            setLoadingState("autofill-result");
            
            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `בהתבסס על אילן היוחסין הבא, השלם את כל הפרטים החסרים עבור האדם ששמו הוא ${name}. אם האדם לא נמצא, ציין זאת.
            ${familyTreeContext}`;
            
            try {
                const answer = await callGeminiAPI(prompt);
                displayResult("autofill-result", "autofillResult", answer);
            } catch (error) {
                displayError("autofill-result", "error");
            }
        });

        // Suggest relations form
        document.getElementById("suggest-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("suggest-name").value.trim();
            setLoadingState("suggest-result");
            
            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `בהתבסס על אילן היוחסין הבא, הצע קשרים פוטנציאליים או חסרים עבור ${name}. התמקד בקשרים חסרים שאפשר להסיק מהנתונים.
            ${familyTreeContext}`;
            
            try {
                const answer = await callGeminiAPI(prompt);
                displayResult("suggest-result", "suggestResult", answer);
            } catch (error) {
                displayError("suggest-result", "error");
            }
        });

        // Story Generation form
        document.getElementById("story-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("story-name").value.trim();
            const resultDiv = document.getElementById("story-result");
            const audioBtn = document.getElementById("story-audio-btn");
            setLoadingState("story-result");
            
            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `בהתבסס על אילן היוחסין הבא, כתוב סיפור קצר על האדם בשם ${name}. אם אין מספיק מידע, השתמש בדמיון כדי להשלים את הסיפור באופן הגיוני. הנתונים הם:
            ${familyTreeContext}`;
            
            try {
                const answer = await callGeminiAPI(prompt);
                resultDiv.innerHTML = `<h3 class="text-blue-800 font-bold">${translations[currentLang].storyResult}</h3><p>${answer}</p>`;
                audioBtn.classList.remove('hidden');
            } catch (error) {
                displayError("story-result", "error");
                audioBtn.classList.add('hidden');
            }
        });

        // Quiz Generation button
        document.getElementById("quiz-btn").addEventListener("click", async () => {
            setLoadingState("quiz-result");
            
            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `בהתבסס על אילן היוחסין הבא, יצר חידון עם 3 שאלות טריוויה על נתוני אילן היוחסין. לכל שאלה, תן 3 תשובות אפשריות (אחת נכונה ושתיים שגויות). התשובה הנכונה צריכה להיות הראשונה. ענה רק עם קוד JSON במבנה הבא:
            { "questions": [ { "question": "שאלה 1", "options": ["תשובה נכונה", "תשובה שגויה 1", "תשובה שגויה 2"] }, ... ] }
            ${familyTreeContext}`;
            
            try {
                const answer = await callGeminiAPI(prompt, null, 'application/json');
                const quiz = JSON.parse(answer);
                let quizHtml = '';
                quiz.questions.forEach((q, index) => {
                    quizHtml += `<p class="font-semibold mt-2">שאלה ${index + 1}: ${q.question}</p>`;
                    quizHtml += `<ul class="list-disc list-inside">`;
                    // Shuffle the options to make it a real quiz
                    const shuffledOptions = q.options.sort(() => Math.random() - 0.5);
                    shuffledOptions.forEach(opt => {
                        quizHtml += `<li>${opt}</li>`;
                    });
                    quizHtml += `</ul>`;
                });
                displayResult("quiz-result", "quizResult", quizHtml);
            } catch (error) {
                displayError("quiz-result", "error");
            }
        });

        // Biography Generation form
        document.getElementById("biography-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("biography-name").value.trim();
            const resultDiv = document.getElementById("biography-result");
            const audioBtn = document.getElementById("biography-audio-btn");
            setLoadingState("biography-result");
            
            const familyTreeContext = prepareFamilyTreeContext();
            const prompt = `בהתבסס על אילן היוחסין הבא, כתוב ביוגרפיה מורחבת ומעניינת על האדם בשם ${name}. הרחב על עובדות, קשרים משפחתיים, וכל פרט רלוונטי שניתן להסיק. אם אין מספיק מידע, השתמש בדמיון כדי להשלים את הביוגרפיה באופן הגיוני וסביר. הנתונים הם:
            ${familyTreeContext}`;
            
            try {
                const answer = await callGeminiAPI(prompt);
                resultDiv.innerHTML = `<h3 class="text-blue-800 font-bold">${translations[currentLang].biographyResult}</h3><p>${answer}</p>`;
                audioBtn.classList.remove('hidden');
            } catch (error) {
                displayError("biography-result", "error");
                audioBtn.classList.add('hidden');
            }
        });

        // NEW: Historical Context form
        document.getElementById("historical-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("historical-name").value.trim();
            setLoadingState("historical-result");

            const person = familyTreeData.find(p => p.name.includes(name));
            if (!person || !person.details.includes('תאריך לידה')) {
                displayError("historical-result", "noInfo");
                return;
            }

            const birthYearMatch = person.details.match(/תאריך לידה: (\d{4})/);
            const birthYear = birthYearMatch ? birthYear[1] : null;

            if (!birthYear) {
                displayError("historical-result", "noInfo");
                return;
            }

            const prompt = `מהם האירועים ההיסטוריים והתרבותיים המרכזיים שהתרחשו בעולם בשנה ${birthYear}? ספק סיכום תמציתי.`;
            
            try {
                const answer = await callGeminiAPI(prompt);
                displayResult("historical-result", "historicalResult", answer);
            } catch (error) {
                displayError("historical-result", "error");
            }
        });

        // Audio playback logic for stories and biographies
        async function playAudio(sourceElementId) {
            const textElement = document.getElementById(sourceElementId);
            const text = textElement.textContent.trim();
            if (!text) return;

            // Stop any currently playing audio
            if (audioPlayer) {
                audioPlayer.stop();
                audioPlayer = null;
            }

            try {
                // Get the button element that triggered this
                const button = document.getElementById(sourceElementId.replace('-result', '-audio-btn'));
                button.textContent = "טוען...";
                button.disabled = true;

                const audioBuffer = await callGeminiTtsAPI(text);
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                audioPlayer = audioContext.createBufferSource();
                audioPlayer.buffer = audioBuffer;
                audioPlayer.connect(audioContext.destination);
                audioPlayer.start(0);

                // Update button state while playing
                button.textContent = "🔊 הפסק";
                button.disabled = false;
                audioPlayer.onended = () => {
                    button.textContent = "🔊 הקרא לי";
                    audioPlayer = null;
                };

            } catch (e) {
                console.error("Audio playback error:", e);
                const button = document.getElementById(sourceElementId.replace('-result', '-audio-btn'));
                button.textContent = "שגיאה בהקראה";
                button.disabled = false;
            }
        }

        document.getElementById("story-audio-btn").addEventListener("click", () => {
            if (audioPlayer) {
                audioPlayer.stop();
                audioPlayer = null;
                document.getElementById("story-audio-btn").textContent = "🔊 הקרא לי";
            } else {
                playAudio("story-result");
            }
        });

        document.getElementById("biography-audio-btn").addEventListener("click", () => {
            if (audioPlayer) {
                audioPlayer.stop();
                audioPlayer = null;
                document.getElementById("biography-audio-btn").textContent = "🔊 הקרא לי";
            } else {
                playAudio("biography-result");
            }
        });
    </script>
</body>
</html>
