<html>
  <script>
# make_singlefile_flipbook_from_pdf.py
# Usage: python make_singlefile_flipbook_from_pdf.py input.pdf output.html
# Requires: pip install pymupdf
import sys, pathlib, fitz, base64, gc

def main():
    if len(sys.argv) < 3:
        print("Usage: python make_singlefile_flipbook_from_pdf.py input.pdf output.html")
        return
    pdf_path = pathlib.Path(sys.argv[1])
    out_html = pathlib.Path(sys.argv[2])

    if not pdf_path.exists():
        print("PDF not found:", pdf_path)
        return

    doc = fitz.open(str(pdf_path))
    n = doc.page_count
    print("Pages:", n)

    entries = []
    for i in range(n):
        page = doc.load_page(i)
        # change matrix for quality/size tradeoff: try 1.4 or 1.6
        mat = fitz.Matrix(1.6, 1.6)
        pix = page.get_pixmap(matrix=mat, alpha=False)
        img_bytes = pix.tobytes(output="png")
        b64 = base64.b64encode(img_bytes).decode("ascii")
        entries.append(f'"data:image/png;base64,{b64}"')
        print(f"Processed page {i+1}/{n}")
        del pix, img_bytes, b64
        gc.collect()

    pages_js = ",\n".join(entries)

    html = f"""<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Family Book — Single-file</title>
<style>
:root{{--bg:#f6f6f8;--card:#fff;--accent:#2b6cb0;}}
html,body{{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}}
.container{{max-width:1100px;margin:18px auto;padding:12px;display:flex;flex-direction:column;gap:12px;}}
.header{{display:flex;justify-content:space-between;align-items:center;}}
.viewer{{position:relative;background:var(--card);border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.12);overflow:hidden;}}
.page{{width:100%;height:80vh;display:flex;align-items:center;justify-content:center;background:#ddd;}}
.page img{{max-width:100%;max-height:100%;display:block;}}
.controls{{display:flex;justify-content:center;gap:8px;padding:8px;}}
.button{{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer;}}
.button:disabled{{opacity:0.4;cursor:default}}
.info{{text-align:center;color:#333}}
.footer{{font-size:13px;color:#666;text-align:center;padding:8px}}
.page.turn{{animation:turn 500ms ease forwards}}
@keyframes turn{{0%{{transform:rotateY(0deg);}}50%{{transform:rotateY(-20deg) scaleX(0.99);}}100%{{transform:rotateY(0deg);}}}}
</style>
</head><body>
<div class="container">
  <div class="header"><h1>Family Book — Single-file</h1><div>Pages: <span id="total">0</span></div></div>
  <div class="viewer" id="viewer" tabindex="0" aria-label="Flipbook viewer"><div class="page" id="page"><img id="pageImg" src="" alt="Page image" /></div></div>
  <div class="controls">
    <button id="first" class="button">« First</button>
    <button id="prev" class="button">◀ Prev</button>
    <div class="info"><span id="pageNum">0</span> / <span id="pageTotal">0</span></div>
    <button id="next" class="button">Next ▶</button>
    <button id="last" class="button">Last »</button>
  </div>
  <div class="footer">Offline single-file flipbook. Use ← → arrows or swipe on touch devices.</div>
</div>
  <script>

<script>
const pages = [
{pages_js}
];
let idx = 0;
const pageImg = document.getElementById('pageImg');
const pageNum = document.getElementById('pageNum');
const pageTotal = document.getElementById('pageTotal');
const totalSpan = document.getElementById('total');
totalSpan.textContent = pages.length;
pageTotal.textContent = pages.length;
function show(i, animate=true){
  if(i<0) i=0;
  if(i>=pages.length) i=pages.length-1;
  idx = i;
  pageNum.textContent = idx+1;
  if(animate){
    const p = document.getElementById('page'); p.classList.remove('turn'); void p.offsetWidth; p.classList.add('turn');
  }
  pageImg.src = pages[idx];
  document.getElementById('prev').disabled = (idx===0);
  document.getElementById('first').disabled = (idx===0);
  document.getElementById('next').disabled = (idx===pages.length-1);
  document.getElementById('last').disabled = (idx===pages.length-1);
}
document.getElementById('prev').addEventListener('click',()=>show(idx-1));
document.getElementById('next').addEventListener('click',()=>show(idx+1));
document.getElementById('first').addEventListener('click',()=>show(0));
document.getElementById('last').addEventListener('click',()=>show(pages.length-1));
window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') show(idx-1); if(e.key==='ArrowRight') show(idx+1); if(e.key==='Home') show(0); if(e.key==='End') show(pages.length-1); });
let startX=0; const viewer=document.getElementById('viewer'); viewer.addEventListener('touchstart', e=>{ startX=e.changedTouches[0].clientX; }); viewer.addEventListener('touchend', e=>{ const dx=e.changedTouches[0].clientX-startX; if(Math.abs(dx)>40){ if(dx<0) show(idx+1); else show(idx-1); } });
show(0,false);
</script>

    out_html.write_text(html, encoding="utf-8")
    print("Wrote:", out_html)

if __name__ == "__main__":
    main()
</body>
</html>
